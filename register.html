<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New User Registration</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: #181c2a !important;
    }
    .register-form {
      background: linear-gradient(135deg, #232946 80%, #181c2a 100%) !important;
      color: #fff !important;
      border-radius: 16px;
      box-shadow: 0 8px 32px #00000033, 0 1.5px 6px #00ff8840;
      padding: 16px;
    }
    .register-form label,
    .register-form-title {
      color: #a786ff !important;
    }
    .register-form input,
    .register-form-input {
      background: #232946 !important;
      color: #fff !important;
      border: 1.5px solid #444;
    }
    .register-form input:focus {
      border-color: #00ff88;
      background: #232946;
      color: #fff;
    }
    .info-box {
      background: rgba(28,28,40,0.97) !important;
      color: #fff !important;
      border: 1px solid #444;
      box-shadow: 0 2px 8px #00ff8840;
    }
    .register-btn, .buy-btn {
      background: linear-gradient(90deg,#00ff88,#a786ff) !important;
      color: #232946 !important;
      font-weight: bold;
      border-radius: 10px;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #a786ff22;
    }
    .register-btn:active, .buy-btn:active {
      background: linear-gradient(90deg,#a786ff,#00ff88) !important;
    }
    .register-form-status {
      color: #fff !important;
    }
    .form-group {
      margin-bottom: 10px !important;
    }
    .form-group label {
      margin-bottom: 3px !important;
      font-size: 0.9rem !important;
    }
    .register-form-input {
      padding: 8px 12px !important;
      font-size: 0.9rem !important;
    }
    .avatar-row {
      margin-bottom: 8px !important;
    }
    .avatar-choice {
      font-size: 1.5rem !important;
      padding: 4px !important;
    }
  </style>
</head>
<body>
  <script src="js/navbar.js"></script>
  <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--ios-background);">
    <form class="register-form" autocomplete="off" style="max-width:400px;width:100%;margin:0 auto;">
      <h2 class="register-form-title" style="text-align:center;margin-bottom:10px;font-size:1.2rem;">New User Registration</h2>
      <div class="register-form-status info" id="connection-status"></div>
      <div class="register-form-status warning" id="register-suggestion" style="display:none;"></div>
      
      <div class="form-group">
        <label for="index-search">Referrer Index</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <input type="text" id="index-search" class="register-form-input" placeholder="Enter referrer index" autocomplete="off" value="" style="flex: 1; min-width: 0;">
          <button type="button" id="apply-index-btn" class="register-btn" style="padding: 8px 12px; font-size: 0.85rem; white-space: nowrap;">Apply</button>
        </div>
      </div>
      
      <div class="form-group">
        <label for="referrer-address">Referrer Address</label>
        <input type="text" id="referrer-address" class="register-form-input" placeholder="Referrer address (0x...)" autocomplete="off" value="" style="background-color: #232946; color: #fff;">
      </div>
      
      <div class="form-group">
        <label for="new-user-address">New User Address</label>
        <input type="text" id="new-user-address" class="register-form-input" placeholder="Subordinate wallet address" autocomplete="off">
      </div>
      
      <script>
    // Function to show general messages
    function showMessageBox(message, type = 'info') {
        const existingBox = document.getElementById('message-box');
        if (existingBox) {
            existingBox.remove();
        }
        
        const messageBox = document.createElement('div');
        messageBox.id = 'message-box';
        messageBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: ${type === 'error' ? 'rgba(255, 0, 0, 0.95)' : type === 'success' ? 'rgba(0, 255, 136, 0.95)' : 'rgba(167, 134, 255, 0.95)'};
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            max-width: 400px;
            text-align: center;
            font-size: 14px;
            line-height: 1.5;
            backdrop-filter: blur(10px);
            border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
        `;
        
        const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        
        messageBox.innerHTML = `
            <div style="margin-bottom: 10px; font-size: 24px;">${icon}</div>
            <div style="margin-bottom: 15px;">${message}</div>
            <button onclick="this.parentElement.remove()" style="
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.3s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                Close
            </button>
        `;
        
        document.body.appendChild(messageBox);
        
        setTimeout(() => {
            if (messageBox.parentElement) {
                messageBox.remove();
            }
        }, 5000);
    }

    // Function to show temporary messages
    function showTempMessage(message, type = 'info', duration = 3000) {
        const tempBox = document.createElement('div');
        tempBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? 'rgba(255, 0, 0, 0.9)' : type === 'success' ? 'rgba(0, 255, 136, 0.9)' : 'rgba(167, 134, 255, 0.9)'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            font-size: 13px;
            max-width: 300px;
            backdrop-filter: blur(8px);
            border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
            animation: slideIn 0.3s ease;
        `;
        
        const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        tempBox.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(tempBox);
        
        setTimeout(() => {
            if (tempBox.parentElement) {
                tempBox.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => tempBox.remove(), 300);
            }
        }, duration);
    }

    // Add CSS animations
    if (!document.getElementById('message-box-styles')) {
        const style = document.createElement('style');
        style.id = 'message-box-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

         document.addEventListener('DOMContentLoaded', function() {
           const addressInput = document.getElementById('new-user-address');
           
           addressInput.addEventListener('click', async function() {
             if (!addressInput.readOnly) {
               try {
                 const clipboardText = await navigator.clipboard.readText();
                 
                 if (clipboardText.match(/^0x[a-fA-F0-9]{40}$/)) {
                   addressInput.value = clipboardText;
                   showTempMessage('‚úÖ Address inserted from clipboard!', 'success');
                 } else {
                   showTempMessage('‚ùå Invalid Ethereum address', 'error');
                 }
               } catch (err) {
                 console.error('Error accessing clipboard:', err);
                 showTempMessage('‚ùå Error accessing clipboard', 'error');
               }
             }
           });
         });
       </script>
      
      <div class="info-box" id="register-info" style="background:rgba(28,28,40,0.97);color:#fff;font-size:0.85rem;box-shadow:0 2px 8px #a786ff22;margin-bottom:10px;padding:10px;">
        <div style="margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid rgba(167,134,255,0.3);">
          <div style="color:#a786ff;font-size:0.8rem;">üìä Registration Information:</div>
        </div>
        <div style="margin-bottom:3px;">üéØ Referrer Index: <b id="parent-index">...</b></div>
        <div style="margin-bottom:3px;">üìç Position Index: <b id="empty-index">...</b></div>
        <div style="margin-bottom:3px;">üí∞ Cost: <b id="register-cost" style="color:#00ff88;">...</b></div>
        
        <div style="margin-top:6px;padding-top:4px;border-top:1px solid rgba(167,134,255,0.3);">
          <div style="color:#a786ff;font-size:0.8rem;margin-bottom:4px;">üí≥ Balance:</div>
          <div style="display:flex;flex-direction:column;gap:3px;align-items:center;">
            <span>üî∑ MATIC: <b id="matic-balance">...</b></span>
            <span>üíé IAM: <b id="IAM-balance">...</b></span>
          </div>
        </div>
      </div>
      
      <div class="avatar-row" style="margin-bottom:8px;">
        <span class="avatar-choice selected" data-avatar="man">üë®‚Äçüíº</span>
        <span class="avatar-choice" data-avatar="woman">üë©‚Äçüíº</span>
        <span class="avatar-choice" data-avatar="student-man">üë®‚Äçüéì</span>
        <span class="avatar-choice" data-avatar="student-woman">üë©‚Äçüéì</span>
      </div>
      
      <button class="register-btn buy-btn" id="register-btn" type="button" style="width:100%;margin-top:10px;">Register</button>
      <div class="register-form-status" id="status-message"></div>
      
      <div style="margin-top:12px;padding:8px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:6px;text-align:center;font-size:0.8rem;color:#ffc107;">
          ‚ö†Ô∏è You need sufficient IAM and MATIC balance for registration
      </div>
    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="js/config.js"></script>
  <script>
    let selectedAvatar = 'man';
    let isConnected = false;
    // Define input variables before each use
    const indexInput = document.getElementById('index-search');
    const refInput = document.getElementById('referrer-address');
     const newUserInput = document.getElementById('new-user-address');
    const defaultGuide = '';
    
                                                // Function to check if target index is in current user's subtree
          function isIndexInUserSubtree(targetIndex, currentUserIndex) {
            console.log(`üîç Checking: target index=${targetIndex}, current user=${currentUserIndex}`);
            
            if (targetIndex === currentUserIndex) {
              console.log(`‚ùå Cannot be subordinate of itself`);
              return false;
            }
            
            // Check if target index is in current user's subtree
            let checkIndex = targetIndex;
            while (checkIndex > currentUserIndex) {
              checkIndex = Math.floor(checkIndex / 2);
              console.log(`üîç Checking path: ${checkIndex}`);
              if (checkIndex === currentUserIndex) {
                console.log(`‚úÖ In subtree`);
                return true;
              }
            }
            
            // Additional check: if target index is less than current user, not in subtree
            if (targetIndex < currentUserIndex) {
              console.log(`‚ùå Target index is less than current user`);
              return false;
            }
            
            console.log(`‚ùå Not in subtree`);
            return false;
                    }
      

      
     // Avatar selection
    document.querySelectorAll('.avatar-choice').forEach(el => {
      el.onclick = function() {
        document.querySelectorAll('.avatar-choice').forEach(e2 => e2.classList.remove('selected'));
        this.classList.add('selected');
        selectedAvatar = this.getAttribute('data-avatar');
      };
    });

            // Initial information loading
    async function loadRegisterInfo() {
      const status = document.getElementById('status-message');
      const connStatus = document.getElementById('connection-status');
      status.textContent = '';
      connStatus.textContent = 'Connecting to wallet...';
      isConnected = false;
      let myAddress = null;
      let contract = null;
      let connection = null;
      try {
                 connection = await window.connectWallet();
         contract = connection.contract;
         myAddress = connection.address;
         window.currentUserAddress = myAddress; // Save address for use in other functions
         isConnected = true;
        connStatus.textContent = '';
        document.getElementById('register-info').style.display = '';
        document.getElementById('register-btn').disabled = false;
        document.querySelectorAll('input').forEach(i=>i.disabled=false);
        
        // Check user status
        const refInput = document.getElementById('referrer-address');
        const indexInput = document.getElementById('index-search');
        const newUserInput = document.getElementById('new-user-address');
        let user;
        let parentIndex = '...';
        
        try {
          user = await contract.users(myAddress);
          console.log(`üîç User status:`, user);
          
          if (user && user.index && BigInt(user.index) > 0n) {
            // User is registered - can only register subordinates
            console.log(`‚úÖ User is active: index=${user.index}`);
            
            // Referrer by default: current user address
            refInput.value = myAddress;
            refInput.readOnly = true; // Disable referrer editing
            
            // New user address: editable for subordinate
            newUserInput.value = '';
            newUserInput.readOnly = false; // Enable user address editing
            newUserInput.placeholder = 'Enter subordinate wallet address or click';
            
            // Show guide message
            const suggestionDiv = document.getElementById('register-suggestion');
            suggestionDiv.style.display = '';
            suggestionDiv.innerHTML = `
              <div style="background: rgba(167,134,255,0.1); border: 1px solid rgba(167,134,255,0.3); border-radius: 8px; padding: 12px; margin: 10px 0;">
                <strong style="color: #a786ff;">üë• Subordinate Registration:</strong><br>
                ‚Ä¢ Referrer: <span style="color: #a786ff;">${myAddress}</span> (You)<br>
                ‚Ä¢ Enter new user address or click field to read from clipboard<br>
                ‚Ä¢ You can only register your subordinates
              </div>
            `;
            
            // Set parent-index
            parentIndex = user.index.toString();
            
            // Set default index field value
            let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
            indexInput.value = IAMId;
            indexInput.style.background = '';
            indexInput.style.color = '';
            indexInput.style.opacity = '';
            
          } else {
            // User is not registered - automatic mode
            console.log(`‚ö†Ô∏è User not registered - automatic mode`);
            
                         // Referrer by default: empty address (user must enter manually)
            refInput.value = '';
            refInput.readOnly = false; // Enable referrer editing
            
            // New user address: connected wallet
            newUserInput.value = myAddress;
            newUserInput.readOnly = true; // Disable user address editing
            
            // Show guide message
            const suggestionDiv = document.getElementById('register-suggestion');
            suggestionDiv.style.display = '';
            suggestionDiv.innerHTML = `
              <div style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px; padding: 12px; margin: 10px 0;">
                <strong style="color: #ffc107;">üìù Manual Registration:</strong><br>
                ‚Ä¢ Please enter referrer index<br>
                ‚Ä¢ Referrer address will be set automatically<br>
                ‚Ä¢ New user: <span style="color: #a786ff;">${myAddress}</span><br>
                ‚Ä¢ After entering index, click "Register" button
              </div>
            `;
            
            // Set parent-index
            parentIndex = '...'; // User must enter manually
            
            // Set default index field value
            indexInput.value = '';
            indexInput.style.background = '';
            indexInput.style.color = '';
            indexInput.style.opacity = '';
          }
                 } catch (e) {
           console.log(`Error checking user status:`, e);
           // If error occurred, apply empty state
           refInput.value = '';
           refInput.readOnly = false;
           newUserInput.value = myAddress;
           newUserInput.readOnly = true;
           parentIndex = '...';
           indexInput.value = '';
         }
        
        document.getElementById('parent-index').textContent = parentIndex;
        
        
        
                 // Set empty-index and position-info (suggested)
         let emptyIndex = '...';
         let positionInfo = '...';
         if (parentIndex !== '...') {
           let left = await contract.getLeftAddress(parentIndex);
           let right = await contract.getRightAddress(parentIndex);
           if (left === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n).toString();
             positionInfo = `Left - Index ${emptyIndex}`;
           } else if (right === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n + 1n).toString();
             positionInfo = `Right - Index ${emptyIndex}`;
           } else {
             emptyIndex = 'Full';
             positionInfo = 'Both positions filled';
           }
         }
         document.getElementById('empty-index').textContent = emptyIndex;
         document.getElementById('position-info').textContent = positionInfo;
        // Registration cost
        let regCost = '...';
        if (window.getRegPrice) {
          let cost = await window.getRegPrice(contract);
          if (cost) {
            let costValue = typeof ethers !== 'undefined' ? ethers.formatEther(cost) : (Number(cost)/1e18);
            regCost = Math.round(parseFloat(costValue)).toString(); // Remove decimals and round
          }
        }
        document.getElementById('register-cost').textContent = regCost + ' IAM';
        // MATIC balance
        let maticBalance = '...';
        if (isConnected && contract && myAddress) {
          try {
            let bal = await connection.provider.getBalance(myAddress);
            maticBalance = bal ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(bal)).toFixed(2) : (Number(bal)/1e18).toFixed(2)) : '0.00';
          } catch (e) {
            maticBalance = '0.00';
          }
        }
        document.getElementById('matic-balance').textContent = maticBalance;
        // IAM balance
        let IAMBalance = '...';
        if (isConnected && contract && myAddress && typeof contract.balanceOf === 'function') {
          try {
            let IAM = await contract.balanceOf(myAddress);
            IAMBalance = IAM ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(IAM)).toFixed(2) : (Number(IAM)/1e18).toFixed(2)) : '0.00';
            
            // Check IAM balance sufficiency for registration
            const IAMBalanceElement = document.getElementById('IAM-balance');
            const registerCostElement = document.getElementById('register-cost');
            try {
              // Get registration cost
              let requiredIAM = 0; // Required IAM amount
              if (window.getRegPrice && contract) {
                let cost = await window.getRegPrice(contract);
                if (cost) {
                  let costValue = typeof ethers !== 'undefined' ? ethers.formatEther(cost) : (Number(cost)/1e18);
                  requiredIAM = Math.round(parseFloat(costValue));
                }
              }
              
              // Color balance and cost based on IAM balance sufficiency
              if (parseFloat(IAMBalance) >= requiredIAM) {
                IAMBalanceElement.style.color = '#00ff88'; // Green: sufficient
                if (registerCostElement) registerCostElement.style.color = '#00ff88';
              } else {
                IAMBalanceElement.style.color = '#ff453a'; // Red: insufficient  
                if (registerCostElement) registerCostElement.style.color = '#ff453a';
              }
            } catch (e) {
              console.log('Error checking balance sufficiency:', e);
            }
          } catch (e) {
            IAMBalance = '0.00';
          }
        }
        document.getElementById('IAM-balance').textContent = IAMBalance;
      } catch (e) {
        isConnected = false;
        showTempMessage('‚ùå Wallet connection failed: ' + (e.message || e), 'error');
        document.getElementById('register-info').style.display = 'none';
        document.getElementById('register-btn').disabled = true;
        document.querySelectorAll('input').forEach(i=>i.disabled=true);
      }
    }
         window.addEventListener('DOMContentLoaded', loadRegisterInfo);
     
     // Listen to wallet changes
     if (window.ethereum) {
       window.ethereum.on('accountsChanged', async function (accounts) {
         console.log('üîÑ Wallet changed:', accounts);
         if (accounts.length > 0) {
           window.currentUserAddress = accounts[0];
           await loadRegisterInfo(); // Reload information
         }
       });
     }

         

    // --- Manual index application with button ---
    // Add button click handler for manual index application
    document.getElementById('apply-index-btn').addEventListener('click', async function() {
      const value = indexInput.value.trim();
      console.log(`üîç Manual index application: ${value}`);
      
      if (!value || value === defaultGuide) {
        alert('Please enter a valid index');
        return;
      }
      
      // Format index to IAM format if it's a number
      let formattedValue = value;
      if (/^\d+$/.test(value)) {
        let IAMId = '';
        if (value.length === 1) {
          IAMId = 'IAM' + value.padStart(5, '0');
        } else if (value.length === 2) {
          IAMId = 'IAM' + value.padStart(4, '0');
        } else if (value.length === 3) {
          IAMId = 'IAM' + value.padStart(3, '0');
        } else if (value.length === 4) {
          IAMId = 'IAM' + value.padStart(2, '0');
        } else {
          IAMId = 'IAM' + value;
        }
        formattedValue = IAMId;
        indexInput.value = IAMId;
      }
      
      // Apply the index
      await checkIndexReferralLine();
    });
    
    // Keep only Enter key support for convenience
    indexInput.addEventListener('keypress', async function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('apply-index-btn').click();
      }
    });
     

     
                  // Function to check referral line for index
       async function checkIndexReferralLine() {
         let index = '';
         // If starts with IAM, get only numbers
         if (indexInput.value.startsWith('IAM')) {
           index = indexInput.value.replace('IAM', '').replace(/^0+/, '') || '0';
         } else {
           // If only number, use directly
           index = indexInput.value.trim();
         }
         console.log(`üîç Checking index: "${indexInput.value}" -> "${index}"`);
         if (!index) {
           console.log(`‚ùå Index is empty`);
           return;
         }
        
        try {
          console.log(`üîó Connecting to contract...`);
          if (!window.contractConfig || !window.contractConfig.contract) {
            console.log(`üîó Reconnecting to wallet...`);
            await window.connectWallet();
          }
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          console.log(`üîó Contract ready:`, contract ? 'Yes' : 'No');
          
          // ŸÖÿ±ÿ≠ŸÑŸá 1: ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ¨ŸàÿØ ÿß€åŸÜÿØ⁄©ÿ≥ ÿØÿ± ÿ¥ÿ®⁄©Ÿá
          let addr = null;
          try {
            addr = await contract.indexToAddress(index);
            console.log(`üìç ÿ¢ÿØÿ±ÿ≥ ÿß€åŸÜÿØ⁄©ÿ≥ ${index}:`, addr);
          } catch (e) {
            console.log(`‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿØÿ±ÿ≥ ÿß€åŸÜÿØ⁄©ÿ≥ ${index}:`, e);
            refInput.value = '';
            status.style.color = '#d32f2f';
            showTempMessage(`ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿØÿ±ÿ≥ ÿß€åŸÜÿØ⁄©ÿ≥ ${index}: ${e.message || e}`, 'error');
            return;
          }
          
          // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ÿ¢ÿØÿ±ÿ≥ ÿÆÿßŸÑ€å ÿßÿ≥ÿ™
          if (!addr || addr === '0x0000000000000000000000000000000000000000') {
            refInput.value = '';
            refInput.style.backgroundColor = '#232946';
            refInput.style.color = '#fff';
            status.style.color = '#d32f2f';
            showTempMessage(`‚ùå Index ${index} does not exist in network. Please enter a valid index.`, 'error');
            return;
          }
          
          // ŸÖÿ±ÿ≠ŸÑŸá 2: ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿß€åŸÜ ÿß€åŸÜÿØ⁄©ÿ≥ ŸÅÿπÿßŸÑ ÿßÿ≥ÿ™
          try {
            const userAtAddress = await contract.users(addr);
            console.log(`üë§ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿß€åŸÜÿØ⁄©ÿ≥ ${index}:`, userAtAddress);
            
                      // ÿ®ÿ±ÿ±ÿ≥€å ŸÅÿπÿßŸÑ ÿ®ŸàÿØŸÜ ⁄©ÿßÿ±ÿ®ÿ±
          const isActive = userAtAddress && userAtAddress.index && BigInt(userAtAddress.index) > 0n;
          
          if (!isActive) {
            refInput.value = '';
            refInput.style.backgroundColor = '#232946';
            refInput.style.color = '#fff';
            status.style.color = '#d32f2f';
            showTempMessage(`User at index ${index} is not active. Please enter an active user index.`, 'error');
            return;
          }
          } catch (e) {
            console.log(`‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ∂ÿπ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ±:`, e);
            refInput.value = '';
            status.style.color = '#d32f2f';
            showTempMessage(`ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ∂ÿπ€åÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿß€åŸÜÿØ⁄©ÿ≥ ${index}. ŸÑÿ∑ŸÅÿßŸã ŸÖÿ¨ÿØÿØÿßŸã ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.`, 'error');
            return;
          }
          
          // ÿ™ŸÜÿ∏€åŸÖ ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ ÿØÿ± ŸÅ€åŸÑÿØ
          refInput.readOnly = false;
          refInput.disabled = false;
          refInput.value = addr;
          refInput.style.backgroundColor = '#232946';
          refInput.style.color = '#fff';
          
                     // ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ ŸÖŸàŸÅŸÇ€åÿ™
           status.style.color = '#388e3c';
           showTempMessage(`‚úÖ Referrer address set automatically: ${addr}`, 'success');
           
           // ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¨ÿß€å⁄ØÿßŸá ÿ¨ÿØ€åÿØ
           try {
             let left = await contract.getLeftAddress(index);
             let right = await contract.getRightAddress(index);
             let newEmptyIndex = '...';
             let newPositionInfo = '...';
             
             if (left === '0x0000000000000000000000000000000000000000') {
               newEmptyIndex = (BigInt(index) * 2n).toString();
               newPositionInfo = `Left - Index ${newEmptyIndex}`;
             } else if (right === '0x0000000000000000000000000000000000000000') {
               newEmptyIndex = (BigInt(index) * 2n + 1n).toString();
               newPositionInfo = `Right - Index ${newEmptyIndex}`;
             } else {
               newEmptyIndex = 'Full';
               newPositionInfo = 'Both positions filled';
             }
             
             document.getElementById('empty-index').textContent = newEmptyIndex;
             document.getElementById('position-info').textContent = newPositionInfo;
             document.getElementById('parent-index').textContent = index;
             
             console.log(`üîÑ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¨ÿß€å⁄ØÿßŸá ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ: ${newPositionInfo}`);
           } catch (e) {
             console.log(`ÿÆÿ∑ÿß ÿØÿ± ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¨ÿß€å⁄ØÿßŸá:`, e);
           }
           
           // ÿßÿ™ŸÖÿßŸÖ ŸÖŸàŸÅŸÇ€åÿ™‚Äåÿ¢ŸÖ€åÿ≤
           console.log(`‚úÖ ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ ÿ™ŸÜÿ∏€åŸÖ ÿ¥ÿØ: ${addr}`);
          
        } catch (e) {
          const status = document.getElementById('status-message');
          refInput.value = '';
          status.style.color = '#d32f2f';
          showTempMessage(`ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜÿØ⁄©ÿ≥ ${index}: ` + (e.message || e), 'error');
        }
      }
         // ŸàŸÇÿ™€å ÿ¢ÿØÿ±ÿ≥ ÿ™ÿ∫€å€åÿ± ŸÖ€å‚Äå⁄©ŸÜÿØÿå ÿß€åŸÜÿØ⁄©ÿ≥ ÿ±ÿß ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ ⁄©ŸÜ Ÿà ÿ®ÿ±ÿ±ÿ≥€å ÿÆÿ∑ ÿ±ŸÅÿ±ÿßŸÑ
     refInput.addEventListener('change', async function() {
       await checkReferralLine();
     });
     
     // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ event listener ÿ®ÿ±ÿß€å input Ÿà paste
     refInput.addEventListener('input', async function() {
       await checkReferralLine();
     });
     
     refInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkReferralLine();
       }, 100);
     });
     
           // ÿ™ÿßÿ®ÿπ ÿ®ÿ±ÿ±ÿ≥€å ÿÆÿ∑ ÿ±ŸÅÿ±ÿßŸÑ
      async function checkReferralLine() {
        const address = refInput.value.trim();
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) return;
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          
          // ŸÖÿ±ÿ≠ŸÑŸá 1: ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ¨ŸàÿØ ÿ¢ÿØÿ±ÿ≥ ÿØÿ± ÿ¥ÿ®⁄©Ÿá Ÿà ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ±
          console.log(`üîç ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ¨ŸàÿØ ÿ¢ÿØÿ±ÿ≥ ${address} ÿØÿ± ÿ¥ÿ®⁄©Ÿá...`);
          let user = null;
          try {
            user = await contract.users(address);
            console.log(`üë§ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿ¢ÿØÿ±ÿ≥ ${address}:`, user);
          } catch (e) {
            console.log(`‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ±:`, e);
            status.style.color = '#d32f2f';
            status.textContent = 'ÿ¢ÿØÿ±ÿ≥ Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá ÿØÿ± ÿ¥ÿ®⁄©Ÿá Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ.';
            return;
          }
          
          // ŸÖÿ±ÿ≠ŸÑŸá 2: ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ⁄©ÿßÿ±ÿ®ÿ± ŸÅÿπÿßŸÑ ÿßÿ≥ÿ™
          if (!user || !(user.index && BigInt(user.index) > 0n)) {
            status.style.color = '#d32f2f';
            status.textContent = `⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿ¢ÿØÿ±ÿ≥ ${address} ŸÅÿπÿßŸÑ ŸÜ€åÿ≥ÿ™ €åÿß Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ŸÅÿπÿßŸÑ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.`;
            return;
          }
          
          // ŸÖÿ±ÿ≠ŸÑŸá 3: ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ⁄©ÿßÿ±ÿ®ÿ± ÿß€åŸÜÿØ⁄©ÿ≥ ÿØÿßÿ±ÿØ
          if (!user.index) {
            status.style.color = '#d32f2f';
            status.textContent = `⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿ¢ÿØÿ±ÿ≥ ${address} ÿß€åŸÜÿØ⁄©ÿ≥ ŸÜÿØÿßÿ±ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ÿØŸá Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.`;
            return;
          }
          
          // ŸÖÿ±ÿ≠ŸÑŸá 4: ÿ™ŸÜÿ∏€åŸÖ ÿß€åŸÜÿØ⁄©ÿ≥ ÿØÿ± ŸÅ€åŸÑÿØ ŸÖÿ±ÿ®Ÿàÿ∑Ÿá
          let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
          indexInput.value = IAMId;
          indexInput.style.background = '';
          indexInput.style.color = '';
          indexInput.style.opacity = '';
          console.log(`‚úÖ ÿß€åŸÜÿØ⁄©ÿ≥ ŸÖÿπÿ±ŸÅ ÿ™ŸÜÿ∏€åŸÖ ÿ¥ÿØ:`, IAMId);
          
          // ŸÖÿ±ÿ≠ŸÑŸá 5: ÿ®ÿ±ÿ±ÿ≥€å ÿµŸÑÿßÿ≠€åÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å
          let myAddress = null, currentUser = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
              currentUser = await contract.users(myAddress);
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                currentUser = await contract.users(myAddress);
                window.currentUserAddress = myAddress;
              }
            }
          } catch (e) {
            console.log(`ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å:`, e);
          }
          
          console.log(`üîç ÿ®ÿ±ÿ±ÿ≥€å ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å:`, currentUser);
          if (currentUser && (currentUser.index && BigInt(currentUser.index) > 0n) && currentUser.index) {
            const currentUserIndex = parseInt(currentUser.index);
            const targetIndex = parseInt(user.index);
            console.log(`üîç ÿ®ÿ±ÿ±ÿ≥€å ÿµŸÑÿßÿ≠€åÿ™: ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å=${currentUserIndex}, ŸáÿØŸÅ=${targetIndex}`);
            
            if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
              status.style.color = '#d32f2f';
              status.textContent = `ÿ¥ŸÖÿß ŸÖÿ¨ÿßÿ≤ ÿ®Ÿá ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ ŸÜ€åÿ≥ÿ™€åÿØ. ŸÅŸÇÿ∑ ÿß€åŸÜÿØ⁄©ÿ≥‚ÄåŸáÿß€å ÿ≤€åÿ±ŸÖÿ¨ŸÖŸàÿπŸá ÿ¥ŸÖÿß ŸÖÿ¨ÿßÿ≤ Ÿáÿ≥ÿ™ŸÜÿØ.`;
              return;
            } else {
              status.style.color = '#388e3c';
              status.textContent = `ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ ŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™ Ÿà ÿØÿ± ÿ≤€åÿ±ŸÖÿ¨ŸÖŸàÿπŸá ÿ¥ŸÖÿß ŸÇÿ±ÿßÿ± ÿØÿßÿ±ÿØ. ÿß€åŸÜÿØ⁄©ÿ≥ ŸÖÿπÿ±ŸÅ: ${IAMId}`;
            }
          } else {
            console.log(`‚ö†Ô∏è ⁄©ÿßÿ±ÿ®ÿ± ŸÅÿπÿßŸÑ ŸÜ€åÿ≥ÿ™ €åÿß ÿß€åŸÜÿØ⁄©ÿ≥ ŸÜÿØÿßÿ±ÿØ:`, currentUser);
            status.style.color = '#d32f2f';
            status.textContent = `ÿ¥ŸÖÿß ÿ®ÿß€åÿØ ÿßÿ®ÿ™ÿØÿß ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ⁄©ŸÜ€åÿØ ÿ™ÿß ÿ®ÿ™ŸàÿßŸÜ€åÿØ ÿ®ÿ±ÿß€å ÿØ€å⁄Øÿ±ÿßŸÜ ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿßŸÜÿ¨ÿßŸÖ ÿØŸá€åÿØ.`;
            return;
          }
          
        } catch (e) {
          const status = document.getElementById('status-message');
          status.style.color = '#d32f2f';
          status.textContent = `ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿ±ÿ±ÿ≥€å ÿ¢ÿØÿ±ÿ≥ ÿ±ŸÅÿ±ÿßŸÑ ${address}: ` + (e.message || e);
        }
      }
     

     
     // ŸàŸÇÿ™€å ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ ÿ™ÿ∫€å€åÿ± ŸÖ€å‚Äå⁄©ŸÜÿØÿå ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ
     newUserInput.addEventListener('change', async function() {
       await checkNewUserAddress();
     });
     
     // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ event listener ÿ®ÿ±ÿß€å input Ÿà paste
     newUserInput.addEventListener('input', async function() {
       await checkNewUserAddress();
     });
     
     newUserInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkNewUserAddress();
       }, 100);
     });
     
           // ÿ™ÿßÿ®ÿπ ÿ®ÿ±ÿ±ÿ≥€å ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ
      async function checkNewUserAddress() {
        const address = newUserInput.value.trim();
        const status = document.getElementById('status-message');
        
        // ÿß⁄Øÿ± ÿ¢ÿØÿ±ÿ≥ ÿÆÿßŸÑ€å ÿßÿ≥ÿ™ÿå Ÿæ€åÿßŸÖ ÿ±ÿß Ÿæÿß⁄© ⁄©ŸÜ
        if (!address) {
          status.textContent = '';
          return;
        }
        
        // ÿ®ÿ±ÿ±ÿ≥€å ŸÅÿ±ŸÖÿ™ ÿ¢ÿØÿ±ÿ≥
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
          status.style.color = '#d32f2f';
          status.textContent = `ÿ¢ÿØÿ±ÿ≥ ${address} ŸÅÿ±ŸÖÿ™ ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿØÿßÿ±ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿ¢ÿØÿ±ÿ≥ ÿßÿ™ÿ±€åŸàŸÖ ÿµÿ≠€åÿ≠ (0x...) Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.`;
          return;
        }
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          
          // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ ŸÇÿ®ŸÑÿßŸã ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ÿØŸá ÿßÿ≥ÿ™
          const user = await contract.users(address);
          if (user && (user.index && BigInt(user.index) > 0n)) {
            status.style.color = '#d32f2f';
            status.textContent = `ÿ¢ÿØÿ±ÿ≥ ${address} ŸÇÿ®ŸÑÿßŸã ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ÿØŸá ÿßÿ≥ÿ™. ŸÑÿ∑ŸÅÿßŸã ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.`;
            return;
          }
          
          // ÿß⁄Øÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ŸÜÿ¥ÿØŸáÿå Ÿæ€åÿßŸÖ ŸÖŸàŸÅŸÇ€åÿ™
          status.style.color = '#388e3c';
          status.textContent = `ÿ¢ÿØÿ±ÿ≥ ${address} ŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™ Ÿà ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ŸàÿØ.`;
          
          // ŸÜŸÖÿß€åÿ¥ ÿß€åŸÜÿØ⁄©ÿ≥ ŸÖÿ±ÿ®Ÿàÿ∑ ÿ®Ÿá ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ (ÿß⁄Øÿ± Ÿàÿ¨ŸàÿØ ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØ)
          try {
            // ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ÿß€åŸÜÿØ⁄©ÿ≥‚ÄåŸáÿß€å ŸÖŸàÿ¨ŸàÿØ ÿ®ÿ±ÿß€å €åÿßŸÅÿ™ŸÜ ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥
            let foundIndex = null;
            for (let i = 1; i <= 1000; i++) { // ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± 1000 ÿß€åŸÜÿØ⁄©ÿ≥ ÿßŸàŸÑ
              try {
                const addrAtIndex = await contract.indexToAddress(i);
                if (addrAtIndex.toLowerCase() === address.toLowerCase()) {
                  foundIndex = i;
                  break;
                }
              } catch (e) {
                // ÿß⁄Øÿ± ÿß€åŸÜÿØ⁄©ÿ≥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØÿå ÿßÿØÿßŸÖŸá ÿ®ÿØŸá
                continue;
              }
            }
            
            if (foundIndex) {
              status.textContent += ` (ÿß€åŸÜÿØ⁄©ÿ≥ ŸÖŸàÿ¨ŸàÿØ: ${foundIndex})`;
            }
          } catch (e) {
            // ÿß⁄Øÿ± ÿÆÿ∑ÿß ÿØÿ± ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ÿß€åŸÜÿØ⁄©ÿ≥ ÿØÿßÿ¥ÿ™€åŸÖÿå ŸÜÿßÿØ€åÿØŸá ÿ®⁄Ø€åÿ±
          }
        } catch (e) {
          status.style.color = '#d32f2f';
          status.textContent = `ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿ±ÿ±ÿ≥€å ÿ¢ÿØÿ±ÿ≥ ${address}: ` + (e.message || e);
        }
      }
      


    // ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ
    document.getElementById('register-btn').onclick = async function() {
      const status = document.getElementById('status-message');
      if (!isConnected) {
        status.style.color = '#d32f2f';
        showTempMessage('Please connect your wallet first.', 'error');
        return;
      }
      
      status.style.color = '#1976d2';
              showTempMessage('Checking information and validation...', 'info');
      this.disabled = true;
      
      try {
        if (!window.contractConfig || !window.contractConfig.contract) {
          await loadRegisterInfo();
        }
        const contract = window.contractConfig.contract;
        if (!contract) throw new Error('Contract connection failed. Please try again.');
        
        let myAddress = null, user = null;
        try {
          if (window.currentUserAddress) {
            myAddress = window.currentUserAddress;
            user = await contract.users(myAddress);
          } else {
            myAddress = contract.signer ? await contract.signer.getAddress() : null;
            if (myAddress) {
              user = await contract.users(myAddress);
              window.currentUserAddress = myAddress;
            }
          }
        } catch (e) {
          console.log(`ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ:`, e);
        }
        
        console.log(`üîç ÿ®ÿ±ÿ±ÿ≥€å ⁄©ÿßÿ±ÿ®ÿ± ÿØÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ:`, user);
        
        if (user && user.index && BigInt(user.index) > 0n) {
          // ⁄©ÿßÿ±ÿ®ÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ÿØŸá ÿßÿ≥ÿ™ - ŸÅŸÇÿ∑ ŸÖ€å‚Äåÿ™ŸàÿßŸÜÿØ ÿ≤€åÿ±ŸÖÿ¨ŸÖŸàÿπŸá ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ⁄©ŸÜÿØ
          const newUser = document.getElementById('new-user-address').value.trim();
          
          if (!newUser || !/^0x[a-fA-F0-9]{40}$/.test(newUser)) {
            throw new Error('ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ ŸÖÿπÿ™ÿ®ÿ± ŸÜ€åÿ≥ÿ™');
          }
          
          // ŸÖÿπÿ±ŸÅ: ÿ¢ÿØÿ±ÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá ÿØÿ± ŸÅ€åŸÑÿØ referrer-address
          const referrerAddress = document.getElementById('referrer-address').value.trim();
          
          // ÿ®ÿ±ÿ±ÿ≥€å ŸÖÿπÿ™ÿ®ÿ± ÿ®ŸàÿØŸÜ ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ
          if (!referrerAddress || !/^0x[a-fA-F0-9]{40}$/.test(referrerAddress)) {
            throw new Error('ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ ŸÖÿπÿ™ÿ®ÿ± ŸÜ€åÿ≥ÿ™');
          }
          
          // ÿ®ÿ±ÿ±ÿ≥€å ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ŸÜÿ®ŸàÿØŸÜ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ
          const newUserData = await contract.users(newUser);
          if (newUserData && newUserData.index && BigInt(newUserData.index) > 0n) {
            throw new Error('ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ ŸÇÿ®ŸÑÿßŸã ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ⁄©ÿ±ÿØŸá ÿßÿ≥ÿ™');
          }
          
          showTempMessage('Sending subordinate registration request to network...', 'info');
          localStorage.setItem('avatar_' + newUser, selectedAvatar);
          const tx = await contract.registerAndActivate(referrerAddress, newUser);
          showTempMessage('Waiting for transaction confirmation by network...', 'info');
          await tx.wait();
          showMessageBox('Subordinate registration completed successfully!', 'success');
          
        } else {
                     // ⁄©ÿßÿ±ÿ®ÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™ - ÿ≠ÿßŸÑÿ™ ÿØÿ≥ÿ™€å
           let referrerAddress = document.getElementById('referrer-address').value.trim();
           if (!referrerAddress) {
             throw new Error('ŸÑÿ∑ŸÅÿßŸã ÿ¢ÿØÿ±ÿ≥ ŸÖÿπÿ±ŸÅ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
           }
          const userAddress = myAddress; // ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ: ⁄©€åŸÅ ŸæŸàŸÑ ŸÖÿ™ÿµŸÑ
          
          showTempMessage('Sending automatic registration request to network...', 'info');
          localStorage.setItem('avatar_' + userAddress, selectedAvatar);
          const tx = await contract.registerAndActivate(referrerAddress, userAddress);
          showTempMessage('Waiting for transaction confirmation by network...', 'info');
          await tx.wait();
          showMessageBox('Registration completed successfully! Welcome to IAM family.', 'success');
        }
        
        setTimeout(loadRegisterInfo, 1500);
        
      } catch (e) {
        let errorMsg = e && (e.reason || (e.revert && e.revert.args && e.revert.args[0]) || e.message || e);
        if (typeof errorMsg !== 'string') errorMsg = JSON.stringify(errorMsg);
        if (/already registered|Already registered/i.test(errorMsg)) {
          showTempMessage('This address is already registered.', 'error');
        } else if (/not active|inactive|ŸÅÿπÿßŸÑ ŸÜ€åÿ≥ÿ™/i.test(errorMsg)) {
          showTempMessage('Selected referrer is not active. Please enter an active referrer.', 'error');
        } else if (/invalid referrer|referrer/i.test(errorMsg)) {
          showTempMessage('Referrer address is invalid or does not exist.', 'error');
        } else if (/insufficient|balance|ŸÖŸàÿ¨ŸàÿØ€å/i.test(errorMsg)) {
          showTempMessage('Your wallet balance is insufficient for registration.', 'error');
        } else if (/user rejected|reject|ŸÑÿ∫Ÿà ÿ¥ÿØ/i.test(errorMsg)) {
          showTempMessage('Registration process was cancelled by you.', 'error');
        } else if (/execution reverted/i.test(errorMsg)) {
          const match = errorMsg.match(/reverted: "([^"]+)"/);
          if (match && match[1]) {
            showTempMessage('Error: ' + match[1], 'error');
          } else {
            showTempMessage('Transaction was cancelled by contract. Please check inputs.', 'error');
          }
        } else {
          showMessageBox('‚ùå Registration error: ' + (errorMsg.length > 120 ? errorMsg.slice(0,120)+'...' : errorMsg), 'error');
        }
      }
      this.disabled = false;
    };

    // Clear faded guide on focus for index input
    indexInput.addEventListener('focus', function() {
      // No default guide behavior needed
    });
    indexInput.addEventListener('blur', function() {
      // No default guide behavior needed
    });
  </script>
  
  <!-- Floating Token Growth Card -->
  <script src="js/floating-token-card.js"></script>
</body>
</html> 