<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Register - IAMPHOENIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=1.1">
  <link rel="stylesheet" href="css/mobile-responsive.css">
  <link rel="stylesheet" href="css/modern-theme.css">
  <script src="js/mobile-optimizer.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0a0f1c, #1a1f2e);
      min-height: 100vh;
      margin: 0;
      padding: 1rem;
      font-family: 'Noto Sans Arabic', sans-serif;
    }
    .main-container {
      max-width: 600px;
      margin: 0 auto;
      background: #1a1f2e;
      border-radius: 15px;
      padding: 1rem;
      border: 1px solid #00ff88;
      margin-top: 4rem;
    }
    
    .register-form {
      background: linear-gradient(135deg, #232946 80%, #181c2a 100%) !important;
      color: #fff !important;
      border-radius: 16px;
      box-shadow: 0 8px 32px #00000033, 0 1.5px 6px #00ff8840;
      padding: 16px 12px 12px 12px;
    }
    
    /* Back Button Styles */
    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, #a786ff, #00ff88);
      color: #0a0f1c;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(167, 134, 255, 0.3);
      z-index: 1000;
    }
    
    .back-btn:hover {
      background: linear-gradient(135deg, #00ff88, #a786ff);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(167, 134, 255, 0.4);
    }
    .register-form label,
    .register-form-title {
      color: #a786ff !important;
    }
    .register-form input,
    .register-form-input {
      background: #232946 !important;
      color: #fff !important;
      border: 1px solid #444;
    }
    .register-form input:focus {
      border-color: #00ff88;
      background: #232946;
      color: #fff;
    }
    .info-box {
      background: rgba(28,28,40,0.97) !important;
      color: #fff !important;
      border: 1px solid #444;
      box-shadow: 0 2px 8px #00ff8840;
    }
    /* Tab buttons - separate from main register button */
    .tab-btn {
      background: transparent;
      color: #a786ff;
      font-weight: bold;
      border-radius: 6px;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    /* Normal tab active styles */
    .tab-btn.active[id="normal-tab"] {
      background: linear-gradient(90deg,#00ff88,#00cc66) !important;
      color: #232946 !important;
      box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3) !important;
      font-size: 0.9rem !important;
      padding: 8px 12px !important;
    }
    
    /* Reserve tab active styles */
    .tab-btn.active[id="free-tab"] {
      background: linear-gradient(90deg,#ffd700,#ffa500) !important;
      color: #232946 !important;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3) !important;
      font-size: 0.8rem !important;
      padding: 6px 10px !important;
    }
    
    /* Main register button */
    .register-btn, .buy-btn {
      background: linear-gradient(90deg,#00ff88,#00cc66) !important;
      color: #232946 !important;
      font-weight: bold;
      border-radius: 10px;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
    }
    .register-btn:active, .buy-btn:active {
      background: linear-gradient(90deg,#00cc66,#00ff88) !important;
    }
    .register-form-status {
      color: #fff !important;
    }
    .form-group {
       margin-bottom: 4px;
    }
    .form-group label {
       margin-bottom: 1px;
       font-size: 0.7rem;
    }
    .register-form-input {
       padding: 2px 4px;
       font-size: 0.45rem;
       word-break: break-all;
       line-height: 1.0;
       font-family: monospace;
       font-style: italic;
    }
    
    /* Index Input - Full Width */
    .index-input {
      width: 100%;
      margin-bottom: 4px;
      padding: 10px 12px;
      font-size: 1rem;
      font-weight: bold;
    }
    
    .apply-btn {
      width: auto;
      padding: 3px 6px;
      font-size: 0.6rem;
      margin-bottom: 3px;
    }
    .avatar-row {
       margin-bottom: 3px;
    }
    .avatar-choice {
       font-size: 1rem;
       padding: 1px;
     }
     .register-form {
       padding: 12px 8px 8px 8px;
     }
     .register-form-title {
       margin-bottom: 4px;
       font-size: 1rem;
    }
    
    /* Register Status Styles */
    .register-form-status {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .register-form-status.success {
      background: rgba(0, 255, 136, 0.1);
      color: #00ff88;
      border: 0.5px solid rgba(0, 255, 136, 0.3);
    }
    
    .register-form-status.error {
      background: rgba(255, 68, 68, 0.1);
      color: #ff4444;
      border: 0.5px solid rgba(255, 68, 68, 0.3);
    }
    
    .register-form-status.loading {
      background: rgba(167, 134, 255, 0.1);
      color: #a786ff;
      border: 0.5px solid rgba(167, 134, 255, 0.3);
    }
    
    /* Address Input Group Styles */
    .address-input-group {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.3rem;
      align-items: center;
    }
    
    .address-input-group input {
      flex: 1;
      font-size: 0.7rem;
      padding: 0.4rem 0.5rem;
    }
    
    .address-input-group .apply-btn {
      padding: 0.3rem 0.5rem;
      font-size: 0.55rem;
      white-space: nowrap;
      min-width: 40px;
    }
    
    .address-field {
      font-size: 0.35rem;
      padding: 0.2rem 0.3rem;
      background: rgba(35, 41, 70, 0.8) !important;
      border: 0.5px solid #555 !important;
      color: #ccc !important;
      word-break: break-all;
      line-height: 1.0;
      font-family: monospace;
      font-style: italic;
    }
    
    .input-with-button {
      display: flex;
      align-items: center;
      width: 100%;
    }
    
    .input-with-button input {
      flex: 0 0 83.33%;
      padding-right: 0.3rem;
    }
    
    .paste-btn-inside {
      flex: 0 0 16.67%;
      background: rgba(52, 152, 219, 0.8);
      border: none;
      border-radius: 4px;
      padding: 0.2rem 0.4rem;
      font-size: 0.6rem;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.2rem;
    }
    
    .paste-btn-inside:hover {
      background: rgba(52, 152, 219, 1);
      transform: scale(1.05);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .address-input-group {
        gap: 0.2rem;
        margin-bottom: 0.2rem;
      }
      
      .address-input-group input {
        flex: 0 0 83.33%;
        font-size: 0.65rem;
        padding: 0.3rem 0.4rem;
      }
      
      .address-input-group .apply-btn {
        flex: 0 0 16.67%;
        padding: 0.25rem 0.4rem;
        font-size: 0.5rem;
        min-width: auto;
        width: 100%;
      }
      
      /* Upper index Apply button - 1/6 of screen width */
      .input-with-button input {
        flex: 0 0 83.33%;
        padding-right: 0.2rem;
        font-size: 0.45rem;
        word-break: break-all;
        line-height: 1.0;
        font-family: monospace;
        font-style: italic;
      }
      
      .input-with-button .paste-btn-inside {
        flex: 0 0 16.67%;
        font-size: 0.55rem;
        padding: 0.15rem 0.3rem;
        margin-left: 0.1rem;
      }
      
      .address-field {
        font-size: 0.3rem;
        padding: 0.15rem 0.25rem;
        word-break: break-all;
        line-height: 0.9;
        font-family: monospace;
        font-style: italic;
      }
      
      .input-with-button input {
        flex: 0 0 83.33%;
        padding-right: 0.2rem;
        font-size: 0.65rem;
      }
      
      .paste-btn-inside {
        flex: 0 0 16.67%;
        font-size: 0.55rem;
        padding: 0.15rem 0.3rem;
        margin-left: 0.1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Back Button -->
  <a href="index.html" class="back-btn">‚Üê Back</a>

  <!-- Main Content -->
  <div class="main-container">
         <form class="register-form" autocomplete="off">
               <!-- Registration tabs -->
        <div style="display: flex; margin-bottom: 4px; background: rgba(35, 41, 70, 0.5); border-radius: 8px; padding: 2px;">
          <button type="button" id="normal-tab" class="tab-btn active" style="flex: 3; padding: 8px 12px; background: linear-gradient(90deg,#00ff88,#00cc66); color: #232946; border: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3); position: relative;">Normal Registration <span style="position: absolute; top: -8px; right: -8px; background: #00ff88; color: #232946; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚≠ê</span></button>
          <button type="button" id="free-tab" class="tab-btn" style="flex: 1; padding: 6px 8px; background: rgba(255, 215, 0, 0.1); color: #ffd700; border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; font-weight: bold; font-size: 0.7rem; cursor: pointer; opacity: 0.7;">Reserve <span style="font-size: 0.6rem; margin-left: 2px;">‚ö†Ô∏è</span></button>
        </div>
       

        

       

      

      
      <div class="register-form-status info" id="connection-status"></div>
       <div class="register-form-status warning" id="metamask-status" style="display:none;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);color:#ffc107;">
         ‚ö†Ô∏è MetaMask is required. Please install MetaMask extension and refresh the page.
       </div>
      <div class="register-form-status warning" id="register-suggestion" style="display:none;"></div>
      <!-- Referrer Index -->
      <div class="form-group">
        <label for="referrer-index">Referrer Index</label>
        <div class="input-with-button">
          <input type="text" id="referrer-index" class="register-form-input" placeholder="e.g. 123 or IAM123" autocomplete="off">
          <button type="button" id="apply-referrer-index-btn" class="paste-btn-inside">Apply</button>
        </div>
        <input type="text" id="referrer-address-display" class="register-form-input address-field" placeholder="0x..." autocomplete="off" readonly>
        <div id="referrer-validation-status" class="register-form-status" style="display:none; margin-top: 4px; font-size: 0.7rem;"></div>
      </div>

      <!-- Upper Address with Index -->
      <div class="form-group">
        <label for="upper-index" id="upper-label">Upper Index</label>
        <div class="input-with-button">
          <input type="text" id="upper-index" class="register-form-input" placeholder="e.g. 123" autocomplete="off">
          <button type="button" id="apply-upper-index-btn" class="paste-btn-inside">Apply</button>
        </div>
        <input type="text" id="upper-address" class="register-form-input address-field" placeholder="0x..." autocomplete="off" value="root" readonly>
        <div id="upper-validation-status" class="register-form-status" style="display:none; margin-top: 4px; font-size: 0.7rem;"></div>
        <div id="placement-info" class="register-form-status" style="display:none; margin-top: 4px; font-size: 0.7rem; background: rgba(167, 134, 255, 0.1); border: 1px solid rgba(167, 134, 255, 0.3); color: #a786ff;"></div>
      </div>

      <!-- New User Address -->
      <div class="form-group">
        <label for="new-user-address">New User Address</label>
        <input type="text" id="new-user-address" class="register-form-input index-input" placeholder="0x..." autocomplete="off">
        <div id="new-user-address-info" class="register-form-status" style="display:none; margin-top: 4px; font-size: 0.7rem; background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); color: #00ff88;"></div>
      </div>
       
                       <button class="register-btn buy-btn" id="register-btn" type="button" style="width:100%;margin-top:6px;">Register</button>
      
      <script>
         // Function to display general messages
     function showMessageBox(message, type = 'info') {
         // Remove previous message box if exists
         const existingBox = document.getElementById('message-box');
         if (existingBox) {
             existingBox.remove();
         }
         
         // Create new message box
         const messageBox = document.createElement('div');
         messageBox.id = 'message-box';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: ${type === 'error' ? 'rgba(255, 0, 0, 0.95)' : type === 'success' ? 'rgba(0, 255, 136, 0.95)' : 'rgba(167, 134, 255, 0.95)'};
             color: white;
             padding: 20px 30px;
             border-radius: 12px;
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
             z-index: 10000;
             max-width: 400px;
             text-align: center;
             font-size: 14px;
             line-height: 1.5;
             backdrop-filter: blur(10px);
             border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
         `;
         
         // Icon based on message type
         const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
         
         messageBox.innerHTML = `
             <div style="margin-bottom: 10px; font-size: 24px;">${icon}</div>
             <div style="margin-bottom: 15px;">${message}</div>
             <button onclick="this.parentElement.remove()" style="
                 background: rgba(255, 255, 255, 0.2);
                 border: 1px solid rgba(255, 255, 255, 0.3);
                 color: white;
                 padding: 8px 20px;
                 border-radius: 6px;
                 cursor: pointer;
                 font-size: 13px;
                 transition: all 0.3s ease;
             " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                 Close
             </button>
         `;
         
         document.body.appendChild(messageBox);
         
         // Auto remove after 5 seconds
         setTimeout(() => {
             if (messageBox.parentElement) {
                 messageBox.remove();
             }
         }, 5000);
     }

     // Function to display message box for index checking (without exit button)
     function showIndexCheckMessage(message, type = 'info') {
         // Remove previous message box if exists
         const existingBox = document.getElementById('index-check-message');
         if (existingBox) {
             existingBox.remove();
         }
         
         // Determine color and icon based on type
         let bgColor, borderColor, icon;
         if (type === 'error') {
             bgColor = 'rgba(255, 0, 0, 0.95)';
             borderColor = 'rgba(255, 0, 0, 0.3)';
             icon = '‚ùå';
         } else if (type === 'success') {
             bgColor = 'rgba(0, 255, 136, 0.95)';
             borderColor = 'rgba(0, 255, 136, 0.3)';
             icon = '‚úÖ';
         } else if (type === 'warning') {
             bgColor = 'rgba(255, 165, 0, 0.95)';
             borderColor = 'rgba(255, 165, 0, 0.3)';
             icon = '‚ö†Ô∏è';
         } else {
             bgColor = 'rgba(0, 123, 255, 0.95)';
             borderColor = 'rgba(0, 123, 255, 0.3)';
             icon = '‚ÑπÔ∏è';
         }
         
         // Create new message box
         const messageBox = document.createElement('div');
         messageBox.id = 'index-check-message';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: ${bgColor};
             color: white;
             padding: 25px 30px;
             border-radius: 16px;
             box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
             z-index: 10000;
             max-width: 90vw;
             width: 350px;
             text-align: center;
             font-size: 16px;
             line-height: 1.6;
             backdrop-filter: blur(15px);
             border: 2px solid ${borderColor};
             font-weight: 500;
         `;
         
         messageBox.innerHTML = `
             <div style="margin-bottom: 15px; font-size: 32px;">${icon}</div>
             <div style="margin-bottom: 20px; font-size: 18px; font-weight: bold;">Index Check Result</div>
             <div style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">${message}</div>
         `;
         
         document.body.appendChild(messageBox);
         
         // Auto remove after 4 seconds
         setTimeout(() => {
             if (messageBox.parentElement) {
                 messageBox.style.animation = 'fadeOut 0.5s ease';
                 setTimeout(() => messageBox.remove(), 500);
             }
         }, 4000);
     }

         // Function to display reserve information
     function showReserveInfoMessage() {
         const messageBox = document.createElement('div');
         messageBox.id = 'reserve-info-message';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: linear-gradient(135deg, rgba(255, 107, 107, 0.95), rgba(255, 165, 0, 0.95));
             color: white;
             padding: 20px 25px;
             border-radius: 16px;
             box-shadow: 0 12px 40px rgba(255, 107, 107, 0.4);
             z-index: 10000;
             max-width: 90vw;
             width: 320px;
             text-align: center;
             font-size: 15px;
             line-height: 1.5;
             backdrop-filter: blur(15px);
             border: 2px solid rgba(255, 165, 0, 0.5);
         `;
        
                                   messageBox.innerHTML = `
              <div style="margin-bottom: 12px; font-size: 24px;">üîÑ</div>
              <div style="margin-bottom: 15px; font-size: 16px; font-weight: bold; color: #fff;">Reserve Registration</div>
              
              <div style="text-align: left; margin-bottom: 12px; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                  <div style="margin-bottom: 6px; font-weight: bold; color: #fff; font-size: 14px;">üìã Features:</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Cost: $23 IAM tokens</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Type: Reserve (inactive)</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Status: Waiting mode</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Activation: Extra payment needed</div>
              </div>
              
              <div style="text-align: left; margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                  <div style="margin-bottom: 6px; font-weight: bold; color: #fff; font-size: 14px;">‚ö†Ô∏è Important:</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ User not active</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Extra payment for activation</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Position reservation only</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">‚Ä¢ Activation cost separate</div>
              </div>
              
              <div style="margin-top: 15px;">
                  <button onclick="this.parentElement.parentElement.remove()" style="
                      background: rgba(255, 255, 255, 0.2);
                      border: 2px solid rgba(255, 255, 255, 0.4);
                      color: white;
                      padding: 10px 20px;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 13px;
                      font-weight: bold;
                      transition: all 0.3s ease;
                      width: 100%;
                  " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                      I Understand
                  </button>
              </div>
          `;
        
        document.body.appendChild(messageBox);
        
                 // Auto remove after 15 seconds
        setTimeout(() => {
            if (messageBox.parentElement) {
                messageBox.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => messageBox.remove(), 500);
            }
        }, 15000);
    }

    // Function to display temporary messages (for validation)
    function showTempMessage(message, type = 'info', duration = 3000) {
        const tempBox = document.createElement('div');
        tempBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? 'rgba(255, 0, 0, 0.9)' : type === 'success' ? 'rgba(0, 255, 136, 0.9)' : 'rgba(167, 134, 255, 0.9)'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            font-size: 13px;
            max-width: 300px;
            backdrop-filter: blur(8px);
            border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
            animation: slideIn 0.3s ease;
        `;
        
        const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        tempBox.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(tempBox);
        
        setTimeout(() => {
            if (tempBox.parentElement) {
                tempBox.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => tempBox.remove(), 300);
            }
        }, duration);
    }

    // Add CSS animations
    if (!document.getElementById('message-box-styles')) {
        const style = document.createElement('style');
        style.id = 'message-box-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    }

         document.addEventListener('DOMContentLoaded', function() {
           const newUserInput = document.getElementById('new-user-address');
           const referrerDisplay = document.getElementById('referrer-address-display');
           const referrerIndexInput = document.getElementById('referrer-index');
           const upperInput = document.getElementById('upper-address');
           const upperIndexInput = document.getElementById('upper-index');
           
           // Set up all event listeners here
           setupEventListeners();
           
           function setupEventListeners() {
             // Referrer index application
             document.getElementById('apply-referrer-index-btn').addEventListener('click', async function() {
               await applyIndexToAddress(referrerIndexInput, referrerDisplay, 'referrer');
             });
             
             // Upper index application
             document.getElementById('apply-upper-index-btn').addEventListener('click', async function() {
               await applyIndexToAddress(upperIndexInput, upperInput, 'upper');
             });
             
             // Enter key support for referrer index field
             referrerIndexInput.addEventListener('keypress', async function(e) {
               if (e.key === 'Enter') {
                 e.preventDefault();
                 document.getElementById('apply-referrer-index-btn').click();
               }
             });

             // Enter key support for upper index
             upperIndexInput.addEventListener('keypress', async function(e) {
               if (e.key === 'Enter') {
                 e.preventDefault();
                 document.getElementById('apply-upper-index-btn').click();
               }
             });
             
             // Address field event listeners (for manual editing)
             refDisplay.addEventListener('change', async function() {
               await checkAddressValidity(refDisplay, 'referrer');
               await validateUpperAgainstReferrer();
               await calculatePlacementForNewUser();
             });
             
             referrerIndexInput.addEventListener('change', async function() {
               // Only validate if it's a valid index format
               const value = this.value.trim();
               if (value && (value.match(/^\d+$/) || value.match(/^IAM\d+$/))) {
                 await checkAddressValidity(referrerIndexInput, 'referrer');
                 await validateUpperAgainstReferrer();
                 await calculatePlacementForNewUser();
               }
             });
             
             upperInput.addEventListener('change', async function() {
               await checkAddressValidity(upperInput, 'upper');
               await validateUpperAgainstReferrer();
             });
           }
           
           
           
          // When user clicks on referrer index input
           referrerIndexInput.addEventListener('click', async function() {
               try {
              // Read clipboard content
                 const clipboardText = await navigator.clipboard.readText();
                 
              // Check if copied text looks like a number or IAM format
                 if (clipboardText.match(/^(\d+|IAM\d+)$/)) {
                   referrerIndexInput.value = clipboardText;
                
                                 // Display success message (optional)
                 alert('Referrer index copied from clipboard successfully!');
                 }
               } catch (err) {
                           console.error('Error accessing clipboard:', err);
             // If needed, you can display an error message to user
             }
           });

          // When user clicks on upper input
           upperInput.addEventListener('click', async function() {
               try {
              // Read clipboard content
                 const clipboardText = await navigator.clipboard.readText();
                 
              // Check if copied text looks like Ethereum address
                 if (clipboardText.match(/^0x[a-fA-F0-9]{40}$/)) {
                   upperInput.value = clipboardText;
                
                                 // Display success message (optional)
                 alert('Upper address copied from clipboard successfully!');
                 }
               } catch (err) {
                           console.error('Error accessing clipboard:', err);
             // If needed, you can display an error message to user
             }
           });

          // When user clicks on upper index input
           upperIndexInput.addEventListener('click', async function() {
               try {
              // Read clipboard content
                 const clipboardText = await navigator.clipboard.readText();
                 
              // Check if copied text looks like a number or IAM format
                 if (clipboardText.match(/^(\d+|IAM\d+)$/)) {
                   upperIndexInput.value = clipboardText;
                
                                 // Display success message (optional)
                 alert('Upper index copied from clipboard successfully!');
                 }
               } catch (err) {
                           console.error('Error accessing clipboard:', err);
             // If needed, you can display an error message to user
             }
           });
         });
       </script>
             <div class="info-box" id="register-info" style="background:rgba(28,28,40,0.97);color:#fff;font-size:0.8rem;box-shadow:0 2px 8px #a786ff22;margin-bottom:6px;padding:6px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span>Cost: <b id="register-cost" style="color:#00ff88;">...</b></span>
          <span>Type: <b id="registration-type" style="color:#a786ff;">Normal</b></span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;">
          <span>MATIC: <b id="matic-balance">...</b></span>
          <span>IAM: <b id="IAM-balance">...</b></span>
        </div>
             </div>
              <div class="avatar-row" style="margin-bottom:0.3em;">
        <span class="avatar-choice selected" data-avatar="man">üë®‚Äçüíº</span>
        <span class="avatar-choice" data-avatar="woman">üë©‚Äçüíº</span>
        <span class="avatar-choice" data-avatar="student-man">üë®‚Äçüéì</span>
        <span class="avatar-choice" data-avatar="student-woman">üë©‚Äçüéì</span>
      </div>
      <div class="register-form-status" id="status-message"></div>
      

    </form>
  </div>
  <!-- Web3 and Ethers.js - Load first -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  
  <!-- Ensure ethers is loaded -->
  <script>
      if (typeof ethers === 'undefined') {
          console.error('‚ùå Ethers.js not loaded properly');
      } else {
          console.log('‚úÖ Ethers.js loaded:', ethers.version);
      }
  </script>
  
  <script src="js/config.js"></script>
  <script>
    let selectedAvatar = 'man';
    let isConnected = false;
    
    // Contract addresses
    const IAM_ADDRESS_NEW = '0x2D3923A5ba62B2bec13b9181B1E9AE0ea2C8118D'; // New contract
    
    // Default to new contract (override global if exists)
    window.IAM_ADDRESS = IAM_ADDRESS_NEW;
    
    // Define input variables before any use
    const upperIndexInput = document.getElementById('upper-index');
    const refInput = document.getElementById('referrer-address');
    const upperInput = document.getElementById('upper-address');
    const newUserInput = document.getElementById('new-user-address');
    


    // Show status message
    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('status-message');
        if (!statusEl) return;
        
        let className = 'register-form-status';
        let icon = '';
        
        switch(type) {
            case 'success':
                className += ' success';
                icon = '‚úÖ ';
                break;
            case 'error':
                className += ' error';
                icon = '‚ùå ';
                break;
            case 'loading':
                className += ' loading';
                icon = '‚è≥ ';
                break;
            default:
                className += ' info';
                icon = '‚ÑπÔ∏è ';
        }
        
        statusEl.className = className;
        statusEl.textContent = icon + message;
    }

                                                // Function to check if target index is in current user's subtree
          function isIndexInUserSubtree(targetIndex, currentUserIndex) {
            console.log(`üîç Checking: target index=${targetIndex}, current user=${currentUserIndex}`);
            
            if (targetIndex === currentUserIndex) {
              console.log(`‚ùå Cannot be a subtree of itself`);
              return false;
            }
            
            // Check if target index is in current user's subtree
            let checkIndex = targetIndex;
            while (checkIndex > currentUserIndex) {
              checkIndex = Math.floor(checkIndex / 2);
              console.log(`üîç Checking path: ${checkIndex}`);
              if (checkIndex === currentUserIndex) {
                console.log(`‚úÖ Is in subtree`);
                return true;
              }
            }
            
            // Additional check: if target index is less than current user, it's not in subtree
            if (targetIndex < currentUserIndex) {
              console.log(`‚ùå Target index is less than current user`);
              return false;
            }
            
            console.log(`‚ùå Not in subtree`);
            return false;
                    }

    // Function to validate referrer and upper relationship
    async function validateReferrerUpperRelationship(contract, referrer, upper) {
      console.log(`üîç Validating referrer-upper relationship: referrer=${referrer}, upper=${upper}`);
      
      // If referrer and upper are the same, it's valid
      if (referrer.toLowerCase() === upper.toLowerCase()) {
        console.log(`‚úÖ Referrer and upper are the same - valid`);
        return;
      }
      
      try {
        // Get referrer user data
        const referrerUser = await contract.users(referrer);
        if (!referrerUser || !(referrerUser.index && BigInt(referrerUser.index) > 0n)) {
          throw new Error('Referrer is not active or does not exist');
        }
        
        // Get upper user data
        const upperUser = await contract.users(upper);
        if (!upperUser || !(upperUser.index && BigInt(upperUser.index) > 0n)) {
          throw new Error('Upper address is not active or does not exist');
        }
        
        const referrerIndex = Number(referrerUser.index);
        const upperIndex = Number(upperUser.index);
        
        console.log(`üîç Referrer index: ${referrerIndex}, Upper index: ${upperIndex}`);
        
        // Check if upper is in referrer's subtree
        if (isIndexInUserSubtree(upperIndex, referrerIndex)) {
          console.log(`‚úÖ Upper address is in referrer's subtree - valid`);
          return;
        } else {
          throw new Error('Upper address must be either the same as referrer or a descendant of referrer in the tree structure');
        }
        
      } catch (error) {
        console.error(`‚ùå Validation error:`, error);
        throw error;
      }
    }
      

      
          // Avatar selection
    document.querySelectorAll('.avatar-choice').forEach(el => {
      el.onclick = function() {
        document.querySelectorAll('.avatar-choice').forEach(e2 => e2.classList.remove('selected'));
        this.classList.add('selected');
        selectedAvatar = this.getAttribute('data-avatar');
      };
    });

     // Change registration type based on selected tab
     let currentRegistrationType = 'normal';
     
     // Event listener for normal registration tab
     document.getElementById('normal-tab').addEventListener('click', function() {
       currentRegistrationType = 'normal';
       
               // Change tab appearance using CSS classes
        document.getElementById('normal-tab').classList.add('active');
        document.getElementById('normal-tab').innerHTML = 'Normal Registration <span style="position: absolute; top: -8px; right: -8px; background: #00ff88; color: #232946; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚≠ê</span>';
        document.getElementById('normal-tab').style.flex = '3';
        document.getElementById('free-tab').classList.remove('active');
        document.getElementById('free-tab').innerHTML = 'Reserve <span style="font-size: 0.6rem; margin-left: 2px;">‚ö†Ô∏è</span>';
        document.getElementById('free-tab').style.flex = '1';
       
               // Change button text
        document.getElementById('register-btn').textContent = 'Register';
        document.getElementById('register-btn').style.background = 'linear-gradient(90deg,#00ff88,#00cc66) !important';
       
       // Change information
       document.getElementById('registration-type').textContent = 'Normal';
       document.getElementById('registration-type').style.color = '#00ff88';

       // Change upper label for normal registration
       document.getElementById('upper-label').textContent = 'Upper Index';
       document.getElementById('upper-index').placeholder = 'e.g. 123';
       document.getElementById('upper-address').placeholder = '0x...';
       
       // Enable referrer index field for normal registration
       document.getElementById('referrer-index').disabled = false;
       document.getElementById('referrer-index').placeholder = 'e.g. 123 or IAM123';
       document.getElementById('apply-referrer-index-btn').disabled = false;
       document.getElementById('apply-referrer-index-btn').style.opacity = '1';
       document.getElementById('apply-referrer-index-btn').style.cursor = 'pointer';
       
       // Enable upper fields for normal registration
       document.getElementById('upper-index').disabled = false;
       document.getElementById('upper-address').disabled = false;
       document.getElementById('apply-upper-index-btn').disabled = false;
       document.getElementById('apply-upper-index-btn').style.opacity = '1';
       document.getElementById('apply-upper-index-btn').style.cursor = 'pointer';
       
       // Clear placement info
       document.getElementById('placement-info').style.display = 'none';
       document.getElementById('upper-validation-status').style.display = 'none';

       // Update placement info for reserve
       if (window.contractConfig && window.contractConfig.contract) {
         setTimeout(async () => {
           await validateUpperAgainstReferrer();
         }, 100);
       }
       
       // Update cost
       updateRegistrationCost();
     });
     
     // Event listener for free registration tab
     document.getElementById('free-tab').addEventListener('click', function() {
       currentRegistrationType = 'free';
       
       // Change tab appearance using CSS classes
       document.getElementById('free-tab').classList.add('active');
       document.getElementById('free-tab').innerHTML = 'Reserve <span style="font-size: 0.6rem; margin-left: 2px;">‚ö†Ô∏è</span>';
       document.getElementById('free-tab').style.flex = '1';
       document.getElementById('normal-tab').classList.remove('active');
       document.getElementById('normal-tab').innerHTML = 'Normal Registration <span style="position: absolute; top: -8px; right: -8px; background: #00ff88; color: #232946; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">‚≠ê</span>';
       document.getElementById('normal-tab').style.flex = '3';
       
               // Change button text
        document.getElementById('register-btn').textContent = 'Register Reserve';
        document.getElementById('register-btn').style.background = 'linear-gradient(90deg,#ffa500,#ff8c00) !important';
       
       // Change information
       document.getElementById('registration-type').textContent = 'Reserve';
       document.getElementById('registration-type').style.color = '#ff6b6b';

       // Change upper label for reserve registration
       document.getElementById('upper-label').textContent = 'Upper Address (Auto-filled)';
       document.getElementById('upper-index').placeholder = 'Auto-calculated';
       document.getElementById('upper-address').placeholder = 'Auto-filled from connected wallet';
       
       // Disable referrer index field for reserve (read-only)
       document.getElementById('referrer-index').disabled = true;
       document.getElementById('referrer-index').placeholder = 'Auto-filled from connected wallet';
       document.getElementById('apply-referrer-index-btn').disabled = true;
       document.getElementById('apply-referrer-index-btn').style.opacity = '0.5';
       document.getElementById('apply-referrer-index-btn').style.cursor = 'not-allowed';
       
       // Disable upper fields for reserve (read-only)
       document.getElementById('upper-index').disabled = true;
       document.getElementById('upper-address').disabled = true;
       document.getElementById('apply-upper-index-btn').disabled = true;
       document.getElementById('apply-upper-index-btn').style.opacity = '0.5';
       document.getElementById('apply-upper-index-btn').style.cursor = 'not-allowed';
       
       // Clear placement info
       document.getElementById('placement-info').style.display = 'none';
       document.getElementById('upper-validation-status').style.display = 'none';

       // Update placement info for reserve
       if (window.contractConfig && window.contractConfig.contract) {
         setTimeout(async () => {
           await validateUpperAgainstReferrer();
         }, 100);
       }
       
       // Display message box with reserve information
       showReserveInfoMessage();
       
       // Update cost
       updateRegistrationCost();
     });
     
     // Function to update registration cost
     async function updateRegistrationCost() {
       if (currentRegistrationType === 'free') {
         // Reserve mode: equivalent to $23 tokens
         try {
           if (window.contractConfig && window.contractConfig.contract) {
             const contract = window.contractConfig.contract;
             if (typeof contract.getTokenPrice === 'function') {
               const tokenPrice = await contract.getTokenPrice();
               const tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
               const requiredAmount = (23 / tokenPriceNum);
               document.getElementById('register-cost').textContent = `${requiredAmount.toFixed(2)} IAM`;
             } else {
               document.getElementById('register-cost').textContent = '23 IAM';
             }
           } else {
             document.getElementById('register-cost').textContent = 'Equivalent to $23';
           }
         } catch (e) {
           document.getElementById('register-cost').textContent = '23 IAM';
         }
                } else {
           // Normal mode: use regPrice function
           try {
           if (window.contractConfig && window.contractConfig.contract) {
             const contract = window.contractConfig.contract;
             if (typeof window.getRegPrice === 'function') {
               const regPrice = await window.getRegPrice(contract);
               if (regPrice) {
                 const regPriceNum = Number(ethers.formatUnits(regPrice, 18));
                 document.getElementById('register-cost').textContent = `${regPriceNum.toFixed(2)} IAM`;
               } else {
                 document.getElementById('register-cost').textContent = 'RegPrice not available';
               }
             } else {
               document.getElementById('register-cost').textContent = 'RegPrice function not available';
             }
           } else {
             document.getElementById('register-cost').textContent = 'Contract not available';
           }
         } catch (e) {
           document.getElementById('register-cost').textContent = 'Error loading regPrice';
         }
       }
     }



         // Initialize information
    async function loadRegisterInfo() {
      const status = document.getElementById('status-message');
      const connStatus = document.getElementById('connection-status');
       const metamaskStatus = document.getElementById('metamask-status');
      status.textContent = '';
      connStatus.textContent = 'Connecting to wallet...';
       metamaskStatus.style.display = 'none';
      isConnected = false;
      let myAddress = null;
      let contract = null;
      let connection = null;
      try {
                 connection = await window.connectWallet();
         // Use selected contract address
         if (connection.signer) {
             contract = new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, connection.signer);
             connection.contract = contract;
         } else {
             contract = connection.contract;
         }
         myAddress = connection.address;
         
         // Update global config with new contract
         window.contractConfig = {
             contract: contract,
             address: myAddress,
             signer: connection.signer,
             provider: connection.provider
         };
         window.currentUserAddress = myAddress; // Save address for use in other functions
         isConnected = true;
        connStatus.textContent = '';
        const registerInfoElement = document.getElementById('register-info');
        if (registerInfoElement) {
          registerInfoElement.style.display = '';
        }
        document.getElementById('register-btn').disabled = false;
        document.querySelectorAll('input').forEach(i=>i.disabled=false);
                 // Initialize referrer (parent) and parent-index only after user initialization
        const refDisplay = document.getElementById('referrer-address-display');
        const upperInput = document.getElementById('upper-address');
        let user;
        let parentIndex = '...';
        try {
          user = await contract.users(myAddress);
          console.log(`üîç User status:`, user);
          console.log(`üîç myAddress: ${myAddress}`);
          console.log(`üîç User index:`, user ? user.index : 'No user data');
          
          // If user is not active, show registration suggestion message
          const suggestionDiv = document.getElementById('register-suggestion');
          if (user && !(user.index && BigInt(user.index) > 0n)) {
            console.log(`‚ö†Ô∏è User registered but not active`);
            suggestionDiv.style.display = '';
            suggestionDiv.textContent = 'You have not registered yet. Please do a reserve registration.';
          } else if (!user) {
            console.log(`‚ö†Ô∏è User not registered at all`);
            suggestionDiv.style.display = '';
            suggestionDiv.textContent = 'You have not registered yet. Please do a reserve registration.';
          } else {
            console.log(`‚úÖ User is active: index=${user.index}`);
            suggestionDiv.style.display = 'none';
          }
                     
          // Handle referrer and upper based on user registration status
          const isUserActive = user && user.index && BigInt(user.index) > 0n;
          console.log(`üîç isUserActive: ${isUserActive}`);
          
          if (isUserActive) {
            // User is registered and active - set referrer to connected wallet
            console.log(`‚úÖ User is active, setting referrer to connected wallet`);
            refDisplay.value = myAddress;
            refDisplay.setAttribute('data-full-address', myAddress);
            updateAddressDisplay(refDisplay);
            
            // For registered users, set new user address to their wallet (self-registration)
            const newUserInputElement = document.getElementById('new-user-address');
            if (newUserInputElement) {
              newUserInputElement.value = myAddress;
              newUserInputElement.style.backgroundColor = '#232946';
              newUserInputElement.style.color = '#fff';
              newUserInputElement.style.opacity = '0.8';
              
              // Show info message for registered users
              const newUserInfo = document.getElementById('new-user-address-info');
              if (newUserInfo) {
                newUserInfo.style.display = '';
                newUserInfo.textContent = '‚úÖ Set to your wallet address (you can change this to register others)';
              }
              
              console.log(`‚úÖ Set new user address to registered user's wallet: ${myAddress}`);
            }
            
            // Set upper address based on registration type
            if (currentRegistrationType === 'normal') {
              upperInput.value = myAddress; // Set upper address same as referrer initially
              upperInput.setAttribute('data-full-address', myAddress);
              updateAddressDisplay(upperInput);
            } else if (currentRegistrationType === 'free') {
              // For reserve, upper is the connected wallet (parent for placement calculation)
              upperInput.value = myAddress;
              upperInput.setAttribute('data-full-address', myAddress);
              updateAddressDisplay(upperInput);
              
              // Set upper index for reserve
              const upperIndex = user.index.toString();
              upperIndexInput.value = upperIndex;
            }
          } else {
            // User is not registered - clear fields and allow manual input
            console.log(`‚ö†Ô∏è User not registered, clearing fields for manual input`);
            console.log(`üîç About to set new user address - myAddress: ${myAddress}`);
            
            refDisplay.value = '';
            refDisplay.removeAttribute('data-full-address');
            referrerIndexInput.value = '';
            
            upperInput.value = '';
            upperInput.removeAttribute('data-full-address');
            upperIndexInput.value = '';
            
            // Set new user address to connected wallet for unregistered users
            const newUserInputElement = document.getElementById('new-user-address');
            console.log(`üîç newUserInputElement:`, newUserInputElement);
            
            if (myAddress && newUserInputElement) {
              console.log(`üîç Setting new user address to: ${myAddress}`);
              
              // Try to set immediately first
              newUserInputElement.value = myAddress;
              newUserInputElement.style.backgroundColor = '#232946';
              newUserInputElement.style.color = '#fff';
              newUserInputElement.style.opacity = '0.8';
              
              // Also try with setTimeout as fallback
              setTimeout(() => {
                newUserInputElement.value = myAddress;
                newUserInputElement.style.backgroundColor = '#232946';
                newUserInputElement.style.color = '#fff';
                newUserInputElement.style.opacity = '0.8';
                
                console.log(`üîç After timeout - Final value in input: ${newUserInputElement.value}`);
              }, 100);
              
              // Show info message
              const newUserInfo = document.getElementById('new-user-address-info');
              if (newUserInfo) {
                newUserInfo.style.display = '';
                newUserInfo.textContent = '‚úÖ Auto-filled with your connected wallet address (for self-registration)';
                console.log(`üîç Info message shown`);
              }
              
              console.log(`‚úÖ Set new user address to connected wallet: ${myAddress}`);
              console.log(`üîç Immediate value in input: ${newUserInputElement.value}`);
            } else {
              console.log(`‚ùå Cannot set new user address - myAddress: ${myAddress}, element exists: ${!!newUserInputElement}`);
            }
            
            // Enable referrer index field for unregistered users
            document.getElementById('referrer-index').disabled = false;
            document.getElementById('referrer-index').placeholder = 'e.g. 123 or IAM123';
            document.getElementById('apply-referrer-index-btn').disabled = false;
            document.getElementById('apply-referrer-index-btn').style.opacity = '1';
            document.getElementById('apply-referrer-index-btn').style.cursor = 'pointer';
          }
                     // Initialize parent-index
          parentIndex = user.index ? user.index.toString() : '';
                 } catch (e) {
          // If we had an error, keep empty values
          refDisplay.value = '';
          referrerIndexInput.value = '';
          
          const newUserInputElement = document.getElementById('new-user-address');
          if (newUserInputElement) {
            newUserInputElement.value = '';
          }
          
          // Hide info message
          const newUserInfo = document.getElementById('new-user-address-info');
          if (newUserInfo) {
            newUserInfo.style.display = 'none';
          }
          
           parentIndex = '';
         }
        const parentIndexElement = document.getElementById('parent-index');
        if (parentIndexElement) {
          parentIndexElement.textContent = parentIndex;
        }
        
        
        
                 // Initialize empty-index (suggested)
         let emptyIndex = '...';
         if (parentIndex !== '...') {
           let left = await contract.getLeftAddress(parentIndex);
           let right = await contract.getRightAddress(parentIndex);
           if (left === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n).toString();
           } else if (right === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n + 1n).toString();
                       } else {
             emptyIndex = 'Full';
            }
         }
         const emptyIndexElement = document.getElementById('empty-index');
         if (emptyIndexElement) {
           emptyIndexElement.textContent = emptyIndex;
         }
        
                 // Update registration cost
         await updateRegistrationCost();
        
                 // MATIC balance
        let maticBalance = '...';
        if (isConnected && contract && myAddress) {
          try {
            let bal = await connection.provider.getBalance(myAddress);
            maticBalance = bal ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(bal)).toFixed(2) : (Number(bal)/1e18).toFixed(2)) : '0.00';
          } catch (e) {
            maticBalance = '0.00';
          }
        }
        const maticBalanceElement = document.getElementById('matic-balance');
        if (maticBalanceElement) {
          maticBalanceElement.textContent = maticBalance;
        }
                 // IAM balance
        let IAMBalance = '...';
        if (isConnected && contract && myAddress && typeof contract.balanceOf === 'function') {
          try {
            let IAM = await contract.balanceOf(myAddress);
            IAMBalance = IAM ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(IAM)).toFixed(2) : (Number(IAM)/1e18).toFixed(2)) : '0.00';
            
                         // Check IAM balance sufficiency based on current registration type
            const IAMBalanceElement = document.getElementById('IAM-balance');
            try {
              let requiredIAM = 0;
              
                             if (currentRegistrationType === 'free') {
                 // Reserve mode: equivalent to $23 tokens
                                 let tokenPriceNum = 1; // Default price $1
                if (typeof contract.getTokenPrice === 'function') {
                  const tokenPrice = await contract.getTokenPrice();
                  tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
                }
                requiredIAM = parseFloat((23 / tokenPriceNum).toFixed(2));
                             } else {
                 // Normal mode: use regPrice function
                if (typeof window.getRegPrice === 'function') {
                  const regPrice = await window.getRegPrice(contract);
                  if (regPrice) {
                    requiredIAM = parseFloat(Number(ethers.formatUnits(regPrice, 18)).toFixed(2));
                                   } else {
                   requiredIAM = 0; // If regPrice is not available
                 }
               } else {
                 requiredIAM = 0; // If getRegPrice function is not available
               }
              }
              
                             // IAM balance color
              if (parseFloat(IAMBalance) >= requiredIAM) {
                                 IAMBalanceElement.style.color = '#00ff88'; // Green: sufficient
               } else {
                 IAMBalanceElement.style.color = '#ff453a'; // Red: insufficient
               }
              
                             // Registration cost color based on balance sufficiency
              const registerCostElement = document.getElementById('register-cost');
              if (registerCostElement) {
                                 if (parseFloat(IAMBalance) >= requiredIAM) {
                   registerCostElement.style.color = '#00ff88'; // Green: balance sufficient
               } else {
                   registerCostElement.style.color = '#ff453a'; // Red: balance insufficient
                 }
              }
                         } catch (e) {
               console.log('Error checking balance sufficiency:', e);
             }
          } catch (e) {
            IAMBalance = '0.00';
          }
        }
        const IAMBalanceElement = document.getElementById('IAM-balance');
        if (IAMBalanceElement) {
          IAMBalanceElement.textContent = IAMBalance;
        }
      } catch (e) {
        isConnected = false;
        console.error('Connection error in loadRegisterInfo:', e);
         
         // MetaMask error check - improved
         if (e.message && (
           e.message.includes('MetaMask is not installed') ||
           e.message.includes('Cannot read properties of undefined') ||
           e.message.includes('window.ethereum') ||
           !window.ethereum
         )) {
           metamaskStatus.style.display = '';
           metamaskStatus.textContent = '‚ö†Ô∏è MetaMask is not installed. Please install MetaMask extension to use this application.';
           connStatus.textContent = '';
         } else {
           connStatus.textContent = '‚ùå Failed to connect wallet: ' + (e.message || e);
         }
         
        const registerInfoElement = document.getElementById('register-info');
        if (registerInfoElement) {
          registerInfoElement.style.display = 'none';
        }
        document.getElementById('register-btn').disabled = true;
        document.querySelectorAll('input').forEach(i=>i.disabled=true);
      }
    }
         window.addEventListener('DOMContentLoaded', loadRegisterInfo);
     
     // Listen to wallet changes
     if (window.ethereum) {
       window.ethereum.on('accountsChanged', async function (accounts) {
         console.log('üîÑ Wallet changed:', accounts);
         if (accounts.length > 0) {
           window.currentUserAddress = accounts[0];
           await loadRegisterInfo(); // Reload information
         }
       });
     }

         

    // --- Manual index application with button ---
    // Event listeners are now set up in the main DOMContentLoaded function

    // Function to apply index to address field
    async function applyIndexToAddress(indexInput, addressInput, type) {
      const value = indexInput.value.trim();
      console.log(`üîç Applying ${type} index: ${value}`);
      
      if (!value) {
        showTempMessage(`Please enter a valid ${type} index`, 'error');
        return;
      }
      
      try {
        if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
        const contract = window.contractConfig.contract;
        
        // Extract numeric index
        let index = value;
        if (value.startsWith('IAM')) {
          index = value.substring(3);
        }
        index = index.replace(/[^0-9]/g, '');
        
        if (!index || index.length > 8) {
          showTempMessage(`Invalid ${type} index format`, 'error');
          return;
        }
        
        // Get address from index
        const address = await contract.indexToAddress(index);
        
        if (!address || address === '0x0000000000000000000000000000000000000000') {
          showTempMessage(`${type} index does not exist`, 'error');
          return;
        }
        
        // Set the address (store full address, display truncated)
        addressInput.value = address;
        addressInput.setAttribute('data-full-address', address);
        addressInput.style.backgroundColor = '#232946';
        addressInput.style.color = '#fff';
        
        // Update display with truncated address
        updateAddressDisplay(addressInput);
        
        // For referrer, also update the display field
        if (type === 'referrer') {
          referrerDisplay.value = address;
          referrerDisplay.setAttribute('data-full-address', address);
          updateAddressDisplay(referrerDisplay);
          
          // Clear the index input after successful conversion
          referrerIndexInput.value = '';
        }
        
        showTempMessage(`${type} address set successfully`, 'success');
        console.log(`‚úÖ ${type} address set: ${address}`);
        
        // If this is upper address, validate against referrer and show placement info
        if (type === 'upper') {
          await validateUpperAgainstReferrer();
        }
        
      } catch (error) {
        console.error(`Error applying ${type} index:`, error);
        showTempMessage(`Error applying ${type} index: ${error.message}`, 'error');
      }
    }
     

         // Address field event listeners are now set up in setupEventListeners function
     
    // Function to truncate address for display
    function truncateAddress(address) {
      if (!address || address.length < 10) return address;
      return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }
    
    // Function to update address display with truncation
    function updateAddressDisplay(addressInput) {
      const fullAddress = addressInput.getAttribute('data-full-address') || addressInput.value;
      if (fullAddress && fullAddress.length > 10) {
        addressInput.value = truncateAddress(fullAddress);
      }
    }
    
    // Function to check address validity
    async function checkAddressValidity(addressInput, type) {
      const address = addressInput.value.trim();
      if (!/^0x[a-fA-F0-9]{40}$/.test(address)) return;
      
      try {
        if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
        const contract = window.contractConfig.contract;
        
        const user = await contract.users(address);
        if (!user || !(user.index && BigInt(user.index) > 0n)) {
          showTempMessage(`${type} address is not active`, 'error');
          return;
        }
        
        showTempMessage(`${type} address is valid`, 'success');
      } catch (e) {
        showTempMessage(`Error checking ${type} address: ${e.message}`, 'error');
      }
    }
    
    // Function to validate upper address against referrer in real-time
    async function validateUpperAgainstReferrer() {
      const statusEl = document.getElementById('upper-validation-status');
      const placementEl = document.getElementById('placement-info');
      if (!statusEl || !placementEl) return;
      
      const referrer = refDisplay.getAttribute('data-full-address') || refDisplay.value.trim();
      const upper = upperInput.getAttribute('data-full-address') || upperInput.value.trim();
      
      if (!referrer || referrer === 'root') {
        statusEl.style.display = 'none';
        placementEl.style.display = 'none';
        return;
      }
      if (!/^0x[a-fA-F0-9]{40}$/.test(referrer)) {
        statusEl.style.display = 'none';
        placementEl.style.display = 'none';
        return;
      }
      
      try {
        if (!window.contractConfig || !window.contractConfig.contract) return;
        const contract = window.contractConfig.contract;
        
        if (currentRegistrationType === 'normal') {
          // Normal registration: validate upper against referrer
          if (!upper || upper === 'root' || !/^0x[a-fA-F0-9]{40}$/.test(upper)) {
            statusEl.style.display = 'none';
            placementEl.style.display = 'none';
            return;
          }
          
          await validateReferrerUpperRelationship(contract, referrer, upper);
          statusEl.className = 'register-form-status success';
          statusEl.textContent = '‚úÖ Upper address is valid for this referrer';
          statusEl.style.display = '';
          
          // Show placement information
          await showPlacementInfo(contract, upper);
          
          showTempMessage('Upper address is valid for this referrer', 'success');
        } else if (currentRegistrationType === 'free') {
          // Reserve registration: show placement info based on upper (connected wallet)
          statusEl.style.display = 'none';
          await showReservePlacementInfo(contract, upper);
          showTempMessage('Reserve placement calculated based on connected wallet', 'success');
        }
      } catch (error) {
        statusEl.className = 'register-form-status error';
        statusEl.textContent = '‚ùå ' + error.message;
        statusEl.style.display = '';
        placementEl.style.display = 'none';
        showTempMessage(error.message, 'error');
      }
    }
    
    // Function to show placement info for reserve registration (registerFree algorithm)
    async function showReservePlacementInfo(contract, upperAddress) {
      const placementEl = document.getElementById('placement-info');
      if (!placementEl) return;
      
      try {
        // Get upper user data (connected wallet)
        const upperUser = await contract.users(upperAddress);
        if (!upperUser || !(upperUser.index && BigInt(upperUser.index) > 0n)) {
          placementEl.style.display = 'none';
          return;
        }
        
        let parentIndex = Number(upperUser.index);
        let parentAddr = upperAddress;
        let found = false;
        let isLeft = false;
        let path = [parentIndex]; // Track the path taken
        
        // Simulate the exact registerFree algorithm
        while (!found) {
          const leftAddress = await contract.getLeftAddress(parentIndex);
          const rightAddress = await contract.getRightAddress(parentIndex);
          
          if (leftAddress === '0x0000000000000000000000000000000000000000') {
            // Left position is available
            isLeft = true;
            found = true;
            path.push(parentIndex * 2);
          } else if (rightAddress === '0x0000000000000000000000000000000000000000') {
            // Right position is available
            isLeft = false;
            found = true;
            path.push(parentIndex * 2 + 1);
          } else {
            // Both positions are occupied, need to find the path with fewer points
            try {
              const leftChildIndex = parentIndex * 2;
              const rightChildIndex = parentIndex * 2 + 1;
              
              const leftChildAddress = await contract.indexToAddress(leftChildIndex);
              const rightChildAddress = await contract.indexToAddress(rightChildIndex);
              
              if (leftChildAddress === '0x0000000000000000000000000000000000000000' || 
                  rightChildAddress === '0x0000000000000000000000000000000000000000') {
                // One of the children doesn't exist, this shouldn't happen
                throw new Error('Invalid tree structure');
              }
              
              const leftUser = await contract.users(leftChildAddress);
              const rightUser = await contract.users(rightChildAddress);
              
              const leftCount = Number(leftUser.leftPoints) + Number(leftUser.rightPoints);
              const rightCount = Number(rightUser.leftPoints) + Number(rightUser.rightPoints);
              
              if (leftCount <= rightCount) {
                parentIndex = leftChildIndex;
                parentAddr = leftChildAddress;
                path.push(leftChildIndex);
              } else {
                parentIndex = rightChildIndex;
                parentAddr = rightChildAddress;
                path.push(rightChildIndex);
              }
            } catch (error) {
              console.error('Error in tree traversal:', error);
              placementEl.className = 'register-form-status error';
              placementEl.textContent = '‚ùå Error calculating placement position';
              placementEl.style.display = '';
              return;
            }
          }
        }
        
        const userIndex = isLeft ? parentIndex * 2 : parentIndex * 2 + 1;
        const position = isLeft ? 'LEFT' : 'RIGHT';
        
        // Show placement information for reserve (exact registerFree algorithm)
        placementEl.className = 'register-form-status info';
        placementEl.innerHTML = `
          <div style="margin-bottom: 2px;">üìç Reserve user will be placed as <strong>${position}</strong> child</div>
          <div style="font-size: 0.65rem; opacity: 0.8; margin-bottom: 2px;">Final Index: <strong>${userIndex}</strong></div>
          <div style="font-size: 0.6rem; opacity: 0.7; margin-bottom: 2px;">Parent: ${parentAddr.substring(0, 6)}...${parentAddr.substring(38)} (Index: ${parentIndex})</div>
          <div style="font-size: 0.6rem; opacity: 0.7;">Path: ${path.slice(0, -1).join(' ‚Üí ')} ‚Üí <strong>${userIndex}</strong></div>
          <div style="font-size: 0.6rem; opacity: 0.6; margin-top: 2px; color: #ff6b6b;">‚ö†Ô∏è Reserve: User will be inactive (binaryPointCap = 0)</div>
        `;
        placementEl.style.display = '';
        
      } catch (error) {
        console.error('Error getting reserve placement info:', error);
        placementEl.className = 'register-form-status error';
        placementEl.textContent = '‚ùå Error calculating placement position';
        placementEl.style.display = '';
      }
    }
    
    // Function to show where new user will be placed (using smart contract algorithm)
    async function showPlacementInfo(contract, upperAddress) {
      const placementEl = document.getElementById('placement-info');
      if (!placementEl) return;
      
      try {
        // Get upper user data
        const upperUser = await contract.users(upperAddress);
        if (!upperUser || !(upperUser.index && BigInt(upperUser.index) > 0n)) {
          placementEl.style.display = 'none';
          return;
        }
        
        let parentIndex = Number(upperUser.index);
        let found = false;
        let isLeft = false;
        let path = [parentIndex]; // Track the path taken
        
        // Simulate the smart contract algorithm
        while (!found) {
          const leftAddress = await contract.getLeftAddress(parentIndex);
          const rightAddress = await contract.getRightAddress(parentIndex);
          
          if (leftAddress === '0x0000000000000000000000000000000000000000') {
            // Left position is available
            isLeft = true;
            found = true;
            path.push(parentIndex * 2);
          } else if (rightAddress === '0x0000000000000000000000000000000000000000') {
            // Right position is available
            isLeft = false;
            found = true;
            path.push(parentIndex * 2 + 1);
          } else {
            // Both positions are occupied, need to find the path with fewer points
            try {
              const leftChildIndex = parentIndex * 2;
              const rightChildIndex = parentIndex * 2 + 1;
              
              const leftChildAddress = await contract.indexToAddress(leftChildIndex);
              const rightChildAddress = await contract.indexToAddress(rightChildIndex);
              
              if (leftChildAddress === '0x0000000000000000000000000000000000000000' || 
                  rightChildAddress === '0x0000000000000000000000000000000000000000') {
                // One of the children doesn't exist, this shouldn't happen
                throw new Error('Invalid tree structure');
              }
              
              const leftUser = await contract.users(leftChildAddress);
              const rightUser = await contract.users(rightChildAddress);
              
              const leftCount = Number(leftUser.leftPoints) + Number(leftUser.rightPoints);
              const rightCount = Number(rightUser.leftPoints) + Number(rightUser.rightPoints);
              
              if (leftCount <= rightCount) {
                parentIndex = leftChildIndex;
                path.push(leftChildIndex);
              } else {
                parentIndex = rightChildIndex;
                path.push(rightChildIndex);
              }
            } catch (error) {
              console.error('Error in tree traversal:', error);
              placementEl.className = 'register-form-status error';
              placementEl.textContent = '‚ùå Error calculating placement position';
              placementEl.style.display = '';
              return;
            }
          }
        }
        
        const finalIndex = isLeft ? parentIndex * 2 : parentIndex * 2 + 1;
        const position = isLeft ? 'LEFT' : 'RIGHT';
        
        // Show placement information
        placementEl.className = 'register-form-status info';
        placementEl.innerHTML = `
          <div style="margin-bottom: 2px;">üìç New user will be placed as <strong>${position}</strong> child</div>
          <div style="font-size: 0.65rem; opacity: 0.8; margin-bottom: 2px;">Final Index: <strong>${finalIndex}</strong></div>
          <div style="font-size: 0.6rem; opacity: 0.7;">Path: ${path.slice(0, -1).join(' ‚Üí ')} ‚Üí <strong>${finalIndex}</strong></div>
        `;
        placementEl.style.display = '';
        
      } catch (error) {
        console.error('Error getting placement info:', error);
        placementEl.className = 'register-form-status error';
        placementEl.textContent = '‚ùå Error calculating placement position';
        placementEl.style.display = '';
      }
    }
     

     

     
            // ŸàŸÇÿ™€å ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿØ€åÿØ ÿ™ÿ∫€å€åÿ± ŸÖ€å‚Äå⁄©ŸÜÿØÿå ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ
       newUserInput.addEventListener('change', async function() {
         await checkNewUserAddress();
       });
       
       // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ event listener ÿ®ÿ±ÿß€å input
       newUserInput.addEventListener('input', async function() {
         await checkNewUserAddress();
         await calculatePlacementForNewUser();
       });
       
       newUserInput.addEventListener('paste', async function() {
         setTimeout(async () => {
           await checkNewUserAddress();
           await calculatePlacementForNewUser();
         }, 100);
       });
       
             // Function to check new user address
        async function checkNewUserAddress() {
        const address = newUserInput.value.trim();
        const status = document.getElementById('status-message');
        
                 // ÿß⁄Øÿ± ÿ¢ÿØÿ±ÿ≥ ÿÆÿßŸÑ€å ÿßÿ≥ÿ™ÿå Ÿæ€åÿßŸÖ ÿ±ÿß Ÿæÿß⁄© ⁄©ŸÜ
         if (!address) {
           status.textContent = '';
           return;
         }
         
         // ÿ®ÿ±ÿ±ÿ≥€å ŸÅÿ±ŸÖÿ™ ÿ¢ÿØÿ±ÿ≥
         if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
           status.style.color = '#d32f2f';
           status.textContent = 'The entered address is not valid. Please enter a correct address.';
           return;
         }
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          
          // ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å
          let myAddress = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                window.currentUserAddress = myAddress;
              }
            }
          } catch (e) {
            console.log(`ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ¢ÿØÿ±ÿ≥ ⁄©ÿßÿ±ÿ®ÿ± ÿ¨ÿßÿ±€å:`, e);
          }
          
                     // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ ŸÇÿ®ŸÑÿßŸã ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ÿ¥ÿØŸá ÿßÿ≥ÿ™
           const user = await contract.users(address);
           if (user && (user.index && BigInt(user.index) > 0n)) {
             status.style.color = '#d32f2f';
             status.textContent = 'This address is already registered.';
             return;
           }
           
           // ÿ®ÿ±ÿ±ÿ≥€å ÿß€åŸÜ⁄©Ÿá ÿ¢€åÿß ⁄©ÿßÿ±ÿ®ÿ± ÿ®ÿ±ÿß€å ÿÆŸàÿØÿ¥ ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ŸÖ€å‚Äå⁄©ŸÜÿØ
           if (address.toLowerCase() === myAddress.toLowerCase()) {
             status.style.color = '#388e3c';
             status.textContent = 'You can register for yourself.';
           } else {
             // ÿß⁄Øÿ± ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ ŸÜÿ¥ÿØŸáÿå Ÿæ€åÿßŸÖ ŸÖŸàŸÅŸÇ€åÿ™
             status.style.color = '#388e3c';
             status.textContent = 'New user address is valid and can be registered.';
           }
          
                     // ŸÜŸÖÿß€åÿ¥ ÿß€åŸÜÿØ⁄©ÿ≥ ŸÖÿ±ÿ®Ÿàÿ∑ ÿ®Ÿá ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ (ÿß⁄Øÿ± Ÿàÿ¨ŸàÿØ ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØ)
           try {
             // ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ÿß€åŸÜÿØ⁄©ÿ≥‚ÄåŸáÿß€å ŸÖŸàÿ¨ŸàÿØ ÿ®ÿ±ÿß€å €åÿßŸÅÿ™ŸÜ ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥
             let foundIndex = null;
             for (let i = 1; i <= 1000; i++) { // ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± 1000 ÿß€åŸÜÿØ⁄©ÿ≥ ÿßŸàŸÑ
               try {
                 const addrAtIndex = await contract.indexToAddress(i);
                 if (addrAtIndex.toLowerCase() === address.toLowerCase()) {
                   foundIndex = i;
                   break;
                 }
               } catch (e) {
                 // ÿß⁄Øÿ± ÿß€åŸÜÿØ⁄©ÿ≥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØÿå ÿßÿØÿßŸÖŸá ÿ®ÿØŸá
                 continue;
               }
             }
             
             if (foundIndex) {
               status.textContent += ` (Index: ${foundIndex})`;
             }
                      } catch (e) {
             // ÿß⁄Øÿ± ÿÆÿ∑ÿß ÿØÿ± ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ÿß€åŸÜÿØ⁄©ÿ≥ ÿØÿßÿ¥ÿ™€åŸÖÿå ŸÜÿßÿØ€åÿØŸá ÿ®⁄Ø€åÿ±
           }
         } catch (e) {
           showTempMessage('Error checking address: ' + (e.message || e), 'error');
         }
       }
       
       // Function to calculate placement for new user when both referrer and new user are provided
       async function calculatePlacementForNewUser() {
         const newUserAddress = newUserInput.value.trim();
         const referrerAddress = refDisplay.getAttribute('data-full-address') || refDisplay.value.trim();
         
         // Only calculate if both addresses are valid and different
         if (!newUserAddress || !referrerAddress || 
             !/^0x[a-fA-F0-9]{40}$/.test(newUserAddress) || 
             !/^0x[a-fA-F0-9]{40}$/.test(referrerAddress) ||
             newUserAddress.toLowerCase() === referrerAddress.toLowerCase()) {
           return;
         }
         
         try {
           if (!window.contractConfig || !window.contractConfig.contract) return;
           const contract = window.contractConfig.contract;
           
           // Get current user info
           let myAddress = null;
           let myUser = null;
           try {
             if (window.currentUserAddress) {
               myAddress = window.currentUserAddress;
               myUser = await contract.users(myAddress);
             } else {
               myAddress = contract.signer ? await contract.signer.getAddress() : null;
               if (myAddress) {
                 myUser = await contract.users(myAddress);
                 window.currentUserAddress = myAddress;
               }
             }
           } catch (e) {
             console.log('Error getting current user:', e);
             return;
           }
           
           // Only show placement if current user is active
           if (!myUser || !(myUser.index && BigInt(myUser.index) > 0n)) {
             return;
           }
           
           // Calculate placement based on registration type
           if (currentRegistrationType === 'normal') {
             const upperAddress = upperInput.getAttribute('data-full-address') || upperInput.value.trim();
             if (upperAddress && upperAddress !== 'root' && /^0x[a-fA-F0-9]{40}$/.test(upperAddress)) {
               await showPlacementInfo(contract, upperAddress);
             }
           } else if (currentRegistrationType === 'free') {
             // For reserve, use current user as upper
             await showReservePlacementInfo(contract, myAddress);
             
                // Show simple additional message for reserve registration
                const placementEl = document.getElementById('placement-info');
                if (placementEl && placementEl.style.display !== 'none') {
                  const additionalText = `Registering: ${newUserAddress.substring(0, 6)}...${newUserAddress.substring(38)} | Referrer: ${referrerAddress.substring(0, 6)}...${referrerAddress.substring(38)} | Change wallet if needed`;
                  
                  // Typewriter effect for additional info
                  let j = 0;
                  const additionalTypewriter = setInterval(() => {
                    if (j < additionalText.length) {
                      placementEl.textContent += additionalText.charAt(j);
                      j++;
                    } else {
                      clearInterval(additionalTypewriter);
                    }
                  }, 30);
                }
           }
           
         } catch (error) {
           console.error('Error calculating placement for new user:', error);
         }
       }
      


                             // Register new user (based on selected type)
    document.getElementById('register-btn').onclick = async function() {
      const status = document.getElementById('status-message');
      const registerBtn = this;
      
      // Disable button and show loading state
      registerBtn.disabled = true;
      registerBtn.style.opacity = '0.6';
      status.style.color = '#1976d2';
      status.textContent = 'Connecting wallet and validating information...';
      
      try {
        // Connect wallet if not already connected
        if (!window.contractConfig || !window.contractConfig.contract) {
          console.log('üîÑ Connecting wallet for registration...');
          await window.connectWallet();
          await loadRegisterInfo();
        }
        
        // Get full addresses for registration (not truncated display)
        const referrer = refDisplay.getAttribute('data-full-address') || refDisplay.value.trim();
        const upper = upperInput.getAttribute('data-full-address') || upperInput.value.trim();
        const newUser = newUserInput.value.trim();
        
        // Validate inputs
        if (!/^0x[a-fA-F0-9]{40}$/.test(referrer)) throw new Error('Invalid referrer address. Please enter a valid address.');
        if (currentRegistrationType === 'normal' && !/^0x[a-fA-F0-9]{40}$/.test(upper)) throw new Error('Invalid upper address. Please enter a valid address.');
        if (!/^0x[a-fA-F0-9]{40}$/.test(newUser)) throw new Error('Invalid new wallet address. Please enter a valid address.');
        
        // Use selected contract
        let contract;
        if (window.contractConfig && window.contractConfig.contract) {
            contract = new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, window.contractConfig.signer);
        } else {
            throw new Error('Contract connection failed. Please try again.');
        }
        
        // Validate referrer and upper relationship for normal registration
        if (currentRegistrationType === 'normal') {
          await validateReferrerUpperRelationship(contract, referrer, upper);
        }
        let myAddress = null, user = null;
                 try {
             // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ¢ÿØÿ±ÿ≥ ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá
           if (window.currentUserAddress) {
             myAddress = window.currentUserAddress;
             user = await contract.users(myAddress);
           } else {
             myAddress = contract.signer ? await contract.signer.getAddress() : null;
             if (myAddress) {
               user = await contract.users(myAddress);
               window.currentUserAddress = myAddress;
             }
           }
         } catch (e) {
             console.log(`Error getting user info in reserve registration:`, e);
           }
          
                     console.log(`üîç Checking user in reserve registration:`, user);
                   // Check if user is registering for themselves or others
           if (user && (user.index && BigInt(user.index) > 0n)) {
             // User is active, can register others
             console.log(`‚úÖ User is active, can register others`);
           } else {
             // If user is not active, check if they're registering for themselves
             if (newUser.toLowerCase() === myAddress.toLowerCase()) {
               console.log(`‚úÖ User registering for themselves`);
               // Allow self-registration
             } else {
               console.log(`‚ö†Ô∏è User not active:`, user);
               throw new Error(`You must register first to be able to register others.`);
             }
           }
         
                   // Check token balance based on registration type
         const userBalance = await contract.balanceOf(myAddress);
         let requiredAmount;
         
                    if (currentRegistrationType === 'free') {
             // Reserve mode: equivalent to $23 tokens
             let tokenPriceNum = 1; // Default price $1
             try {
               if (typeof contract.getTokenPrice === 'function') {
                 const tokenPrice = await contract.getTokenPrice();
                 tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
               }
             } catch (e) {
               console.log('Error getting token price, using default price:', e);
             }
             
             // Calculate required amount (23 USD / token price)
             const requiredAmountFloat = 23 / tokenPriceNum;
             requiredAmount = ethers.parseEther(requiredAmountFloat.toString());
           } else {
             // Normal mode: use regPrice function
           try {
             if (typeof window.getRegPrice === 'function') {
               const regPrice = await window.getRegPrice(contract);
               if (regPrice) {
                 requiredAmount = regPrice;
               } else {
                 throw new Error('RegPrice not available');
               }
             } else {
               throw new Error('RegPrice function not available');
             }
                        } catch (e) {
               console.log('Error getting regPrice:', e);
               throw new Error('Unable to get registration price');
             }
         }
         
         if (userBalance < requiredAmount) {
           const requiredFormatted = Number(ethers.formatEther(requiredAmount)).toFixed(2);
           const currentFormatted = Number(ethers.formatEther(userBalance)).toFixed(2);
           throw new Error(`Insufficient IAM balance. Required: ${requiredFormatted} IAM, Current: ${currentFormatted} IAM`);
         }
         
                  showTempMessage(currentRegistrationType === 'free' ? 'Sending reserve registration request to network... Please wait for transaction confirmation.' : 'Sending normal registration request to network... Please wait for transaction confirmation.', 'info');
          localStorage.setItem('avatar_' + newUser, selectedAvatar);
          
                   // Select function based on registration type
         let tx;
         if (currentRegistrationType === 'free') {
           tx = await contract.registerFree(referrer, newUser);
        } else {
           // For registerAndActivate, we need 3 parameters: referrer, upper, newUser
           tx = await contract.registerAndActivate(referrer, upper, newUser);
           }
          
         showTempMessage('Waiting for network transaction confirmation...', 'info');
          await tx.wait();
         showMessageBox(currentRegistrationType === 'free' ? 'Reserve registration completed successfully! Welcome to IAM family.' : 'Normal registration completed successfully! Welcome to IAM family.', 'success');
        setTimeout(loadRegisterInfo, 1500);
      } catch (e) {
        let errorMsg = e && (e.reason || (e.revert && e.revert.args && e.revert.args[0]) || e.message || e);
        if (typeof errorMsg !== 'string') errorMsg = JSON.stringify(errorMsg);
        if (/already registered|Already registered/i.test(errorMsg)) {
          showTempMessage('This address is already registered.', 'error');
                   } else if (/not active|inactive/i.test(errorMsg)) {
          showTempMessage('Selected referrer is not active. Please enter an active referrer.', 'error');
        } else if (/invalid referrer|referrer/i.test(errorMsg)) {
           showTempMessage('Invalid referrer address or does not exist.', 'error');
                   } else if (/insufficient|balance/i.test(errorMsg)) {
              // ÿß⁄Øÿ± ÿÆÿ∑ÿß€å ⁄©ŸÖÿ®ŸàÿØ ŸÖŸàÿ¨ŸàÿØ€å ÿßÿ≤ smart contract ÿ¢ŸÖÿØŸáÿå ŸáŸÖÿßŸÜ Ÿæ€åÿßŸÖ ÿ±Ÿà ŸÜÿ¥ŸàŸÜ ÿ®ÿØŸá
             if (errorMsg.includes('IAM balance insufficient')) {
             showMessageBox(errorMsg, 'error');
           } else {
             showTempMessage('Your IAM balance is insufficient for registration.', 'error');
           }
                   } else if (/user rejected|reject/i.test(errorMsg)) {
          showTempMessage('Registration process was cancelled by you.', 'error');
        } else if (/execution reverted/i.test(errorMsg)) {
          const match = errorMsg.match(/reverted: "([^"]+)"/);
          if (match && match[1]) {
            showTempMessage('Error: ' + match[1], 'error');
          } else {
             showTempMessage('Transaction was reverted by contract. Please check inputs.', 'error');
          }
        } else {
          showMessageBox('‚ùå Registration error: ' + (errorMsg.length > 120 ? errorMsg.slice(0,120)+'...' : errorMsg), 'error');
        }
      } finally {
        // Restore button state
        registerBtn.disabled = false;
        registerBtn.style.opacity = '1';
      }
    };

     

    // Clear faded guide on focus for index input
    indexInput.addEventListener('focus', function() {
      if (this.value === defaultGuide) {
        this.value = '';
        this.style.background = '';
        this.style.color = '';
        this.style.opacity = '';
      }
    });
    indexInput.addEventListener('blur', function() {
      if (this.value.trim() === '') {
        this.value = defaultGuide;
        this.style.background = '#f3f3f3';
        this.style.color = '#888';
        this.style.opacity = '0.7';
        refInput.value = 'root';
      }
    });
  </script>
  
  <!-- Floating Token Growth Card - ⁄©ÿßÿ±ÿ™ ÿ¥ŸÜÿßŸàÿ± ÿ±ÿ¥ÿØ ÿ™Ÿà⁄©ŸÜ -->
  <script src="js/floating-token-card.js"></script>
</body>
</html> 