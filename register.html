<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Register</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: #181c2a !important;
    }
    .register-form {
      background: linear-gradient(135deg, #232946 80%, #181c2a 100%) !important;
      color: #fff !important;
      border-radius: 16px;
      box-shadow: 0 8px 32px #00000033, 0 1.5px 6px #00ff8840;
      padding: 20px 16px 16px 16px;
    }
    .register-form label,
    .register-form-title {
      color: #a786ff !important;
    }
    .register-form input,
    .register-form-input {
      background: #232946 !important;
      color: #fff !important;
      border: 1.5px solid #444;
    }
    .register-form input:focus {
      border-color: #00ff88;
      background: #232946;
      color: #fff;
    }
    .info-box {
      background: rgba(28,28,40,0.97) !important;
      color: #fff !important;
      border: 1px solid #444;
      box-shadow: 0 2px 8px #00ff8840;
    }
    .register-btn, .buy-btn {
      background: linear-gradient(90deg,#00ff88,#a786ff) !important;
      color: #232946 !important;
      font-weight: bold;
      border-radius: 10px;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #a786ff22;
    }
    .register-btn:active, .buy-btn:active {
      background: linear-gradient(90deg,#a786ff,#00ff88) !important;
    }
    .register-form-status {
      color: #fff !important;
    }
    .form-group {
       margin-bottom: 8px !important;
    }
    .form-group label {
       margin-bottom: 2px !important;
       font-size: 0.85rem !important;
    }
    .register-form-input {
       padding: 6px 10px !important;
       font-size: 0.85rem !important;
    }
    .avatar-row {
       margin-bottom: 6px !important;
    }
    .avatar-choice {
       font-size: 1.3rem !important;
       padding: 3px !important;
     }
     .register-form {
       padding: 16px 14px 12px 14px !important;
     }
     .register-form-title {
       margin-bottom: 8px !important;
       font-size: 1.2rem !important;
    }
  </style>
</head>
<body>
  <script src="js/navbar.js"></script>
  <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--ios-background);">
         <form class="register-form" autocomplete="off" style="max-width:430px;width:100%;margin:0 auto;">
       <!-- Ø³Ø±Ø¨Ø±Ú¯â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ù†Ø§Ù… -->
       <div style="display: flex; margin-bottom: 16px; background: rgba(35, 41, 70, 0.5); border-radius: 8px; padding: 4px;">
         <button type="button" id="normal-tab" class="tab-btn active" style="flex: 1; padding: 8px 12px; background: linear-gradient(90deg,#00ff88,#a786ff); color: #232946; border: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer;">Normal Registration</button>
         <button type="button" id="free-tab" class="tab-btn" style="flex: 1; padding: 8px 12px; background: transparent; color: #a786ff; border: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer;">Reserve Registration</button>
       </div>
       
       <h2 class="register-form-title" style="text-align:center;margin-bottom:8px;font-size:1.2rem;">Register Form</h2>
      <div class="register-form-status info" id="connection-status"></div>
       <div class="register-form-status warning" id="metamask-status" style="display:none;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);color:#ffc107;">
         âš ï¸ MetaMask is required. Please install MetaMask extension and refresh the page.
       </div>
      <div class="register-form-status warning" id="register-suggestion" style="display:none;"></div>
      <div class="form-group">
                 <label for="index-search">Index</label>
                                                                       <div style="font-size:0.7rem;color:#a786ff;margin-bottom:4px;background:rgba(167,134,255,0.1);padding:4px;border-radius:3px;border:1px solid rgba(167,134,255,0.3);">
            âš ï¸ <strong>Limit:</strong> You can only register for indexes in your subtree. Referrer must have at least one empty child position.
         </div>
                 <input type="text" id="index-search" class="register-form-input" placeholder="e.g. 123" autocomplete="off" value="refferer ID : IAM00000" style="width: 100%; margin-bottom: 6px;">
         <button type="button" id="apply-index-btn" class="register-btn" style="width: 100%; padding: 6px 12px; font-size: 0.85rem;">Apply</button>
      </div>
      <div class="form-group">
                 <label for="referrer-address">Referrer Address (Parent)</label>
                 <div style="font-size:0.65rem;color:#718096;margin-bottom:3px;background:rgba(113,128,150,0.1);padding:3px;border-radius:3px;">
           ğŸ”— This field is automatically filled based on the selected index. Referrer must be active.
      </div>
        <input type="text" id="referrer-address" class="register-form-input" placeholder="0x..." autocomplete="off" value="root">
      </div>
      <div class="form-group">
        <label for="new-user-address">New User Address</label>
                 <div style="font-size:0.65rem;color:#718096;margin-bottom:3px;background:rgba(113,128,150,0.1);padding:3px;border-radius:3px;">
           ğŸ‘¤ Wallet address of the user you want to register. This address should not be previously registered.
         </div>
                 <input type="text" id="new-user-address" class="register-form-input" placeholder="0x..." autocomplete="off">
      </div>
       
                       <button class="register-btn buy-btn" id="register-btn" type="button" style="width:100%;margin-top:8px;">Register</button>
      
      <script>
         // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
     function showMessageBox(message, type = 'info') {
         // Ø­Ø°Ù message box Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
         const existingBox = document.getElementById('message-box');
         if (existingBox) {
             existingBox.remove();
         }
         
         // Ø§ÛŒØ¬Ø§Ø¯ message box Ø¬Ø¯ÛŒØ¯
         const messageBox = document.createElement('div');
         messageBox.id = 'message-box';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: ${type === 'error' ? 'rgba(255, 0, 0, 0.95)' : type === 'success' ? 'rgba(0, 255, 136, 0.95)' : 'rgba(167, 134, 255, 0.95)'};
             color: white;
             padding: 20px 30px;
             border-radius: 12px;
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
             z-index: 10000;
             max-width: 400px;
             text-align: center;
             font-size: 14px;
             line-height: 1.5;
             backdrop-filter: blur(10px);
             border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
         `;
         
         // Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
         const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
         
         messageBox.innerHTML = `
             <div style="margin-bottom: 10px; font-size: 24px;">${icon}</div>
             <div style="margin-bottom: 15px;">${message}</div>
             <button onclick="this.parentElement.remove()" style="
                 background: rgba(255, 255, 255, 0.2);
                 border: 1px solid rgba(255, 255, 255, 0.3);
                 color: white;
                 padding: 8px 20px;
                 border-radius: 6px;
                 cursor: pointer;
                 font-size: 13px;
                 transition: all 0.3s ease;
             " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                 Close
             </button>
         `;
         
         document.body.appendChild(messageBox);
         
         // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
         setTimeout(() => {
             if (messageBox.parentElement) {
                 messageBox.remove();
             }
         }, 5000);
     }

     // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ message box Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ (Ø¨Ø¯ÙˆÙ† Ø¯Ú©Ù…Ù‡ exit)
     function showIndexCheckMessage(message, type = 'info') {
         // Ø­Ø°Ù message box Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
         const existingBox = document.getElementById('index-check-message');
         if (existingBox) {
             existingBox.remove();
         }
         
         // ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú¯ Ùˆ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
         let bgColor, borderColor, icon;
         if (type === 'error') {
             bgColor = 'rgba(255, 0, 0, 0.95)';
             borderColor = 'rgba(255, 0, 0, 0.3)';
             icon = 'âŒ';
         } else if (type === 'success') {
             bgColor = 'rgba(0, 255, 136, 0.95)';
             borderColor = 'rgba(0, 255, 136, 0.3)';
             icon = 'âœ…';
         } else if (type === 'warning') {
             bgColor = 'rgba(255, 165, 0, 0.95)';
             borderColor = 'rgba(255, 165, 0, 0.3)';
             icon = 'âš ï¸';
         } else {
             bgColor = 'rgba(0, 123, 255, 0.95)';
             borderColor = 'rgba(0, 123, 255, 0.3)';
             icon = 'â„¹ï¸';
         }
         
         // Ø§ÛŒØ¬Ø§Ø¯ message box Ø¬Ø¯ÛŒØ¯
         const messageBox = document.createElement('div');
         messageBox.id = 'index-check-message';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: ${bgColor};
             color: white;
             padding: 25px 30px;
             border-radius: 16px;
             box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
             z-index: 10000;
             max-width: 90vw;
             width: 350px;
             text-align: center;
             font-size: 16px;
             line-height: 1.6;
             backdrop-filter: blur(15px);
             border: 2px solid ${borderColor};
             font-weight: 500;
         `;
         
         messageBox.innerHTML = `
             <div style="margin-bottom: 15px; font-size: 32px;">${icon}</div>
             <div style="margin-bottom: 20px; font-size: 18px; font-weight: bold;">Index Check Result</div>
             <div style="margin-bottom: 20px; font-size: 15px; line-height: 1.5;">${message}</div>
         `;
         
         document.body.appendChild(messageBox);
         
         // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 4 Ø«Ø§Ù†ÛŒÙ‡
         setTimeout(() => {
             if (messageBox.parentElement) {
                 messageBox.style.animation = 'fadeOut 0.5s ease';
                 setTimeout(() => messageBox.remove(), 500);
             }
         }, 4000);
     }

         // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø²Ø±Ùˆ
     function showReserveInfoMessage() {
         const messageBox = document.createElement('div');
         messageBox.id = 'reserve-info-message';
         messageBox.style.cssText = `
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: linear-gradient(135deg, rgba(255, 107, 107, 0.95), rgba(255, 165, 0, 0.95));
             color: white;
             padding: 20px 25px;
             border-radius: 16px;
             box-shadow: 0 12px 40px rgba(255, 107, 107, 0.4);
             z-index: 10000;
             max-width: 90vw;
             width: 320px;
             text-align: center;
             font-size: 15px;
             line-height: 1.5;
             backdrop-filter: blur(15px);
             border: 2px solid rgba(255, 165, 0, 0.5);
         `;
        
                                   messageBox.innerHTML = `
              <div style="margin-bottom: 12px; font-size: 24px;">ğŸ”„</div>
              <div style="margin-bottom: 15px; font-size: 16px; font-weight: bold; color: #fff;">Reserve Registration</div>
              
              <div style="text-align: left; margin-bottom: 12px; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                  <div style="margin-bottom: 6px; font-weight: bold; color: #fff; font-size: 14px;">ğŸ“‹ Features:</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Cost: $23 IAM tokens</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Type: Reserve (inactive)</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Status: Waiting mode</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Activation: Extra payment needed</div>
              </div>
              
              <div style="text-align: left; margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                  <div style="margin-bottom: 6px; font-weight: bold; color: #fff; font-size: 14px;">âš ï¸ Important:</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ User not active</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Extra payment for activation</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Position reservation only</div>
                  <div style="margin-bottom: 4px; font-size: 13px;">â€¢ Activation cost separate</div>
              </div>
              
              <div style="margin-top: 15px;">
                  <button onclick="this.parentElement.parentElement.remove()" style="
                      background: rgba(255, 255, 255, 0.2);
                      border: 2px solid rgba(255, 255, 255, 0.4);
                      color: white;
                      padding: 10px 20px;
                      border-radius: 8px;
                      cursor: pointer;
                      font-size: 13px;
                      font-weight: bold;
                      transition: all 0.3s ease;
                      width: 100%;
                  " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                      I Understand
                  </button>
              </div>
          `;
        
        document.body.appendChild(messageBox);
        
        // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 15 Ø«Ø§Ù†ÛŒÙ‡
        setTimeout(() => {
            if (messageBox.parentElement) {
                messageBox.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => messageBox.remove(), 500);
            }
        }, 15000);
    }

    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª (Ø¨Ø±Ø§ÛŒ validation)
    function showTempMessage(message, type = 'info', duration = 3000) {
        const tempBox = document.createElement('div');
        tempBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? 'rgba(255, 0, 0, 0.9)' : type === 'success' ? 'rgba(0, 255, 136, 0.9)' : 'rgba(167, 134, 255, 0.9)'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            font-size: 13px;
            max-width: 300px;
            backdrop-filter: blur(8px);
            border: 1px solid ${type === 'error' ? 'rgba(255, 0, 0, 0.3)' : type === 'success' ? 'rgba(0, 255, 136, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
            animation: slideIn 0.3s ease;
        `;
        
        const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
        tempBox.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(tempBox);
        
        setTimeout(() => {
            if (tempBox.parentElement) {
                tempBox.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => tempBox.remove(), 300);
            }
        }, duration);
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† CSS animations
    if (!document.getElementById('message-box-styles')) {
        const style = document.createElement('style');
        style.id = 'message-box-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            }
        `;
        document.head.appendChild(style);
    }

         document.addEventListener('DOMContentLoaded', function() {
           const addressInput = document.getElementById('new-user-address');
           
          // ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆÛŒ Ø§ÛŒÙ†Ù¾ÙˆØª Ú©Ù„ÛŒÚ© Ú©Ù†Ø¯
           addressInput.addEventListener('click', async function() {
               try {
              // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ù„ÛŒÙ¾Ø¨ÙˆØ±Ø¯
                 const clipboardText = await navigator.clipboard.readText();
                 
              // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯Ù‡ Ø´Ø¨ÛŒÙ‡ Ø¢Ø¯Ø±Ø³ Ø§ØªØ±ÛŒÙˆÙ… Ø§Ø³Øª
                 if (clipboardText.match(/^0x[a-fA-F0-9]{40}$/)) {
                   addressInput.value = clipboardText;
                
                                 // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                 alert('Address copied from clipboard successfully!');
                 }
               } catch (err) {
                           console.error('Error accessing clipboard:', err);
             // Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
             }
           });
         });
       </script>
             <div class="info-box" id="register-info" style="background:rgba(28,28,40,0.97);color:#fff;font-weight:bold;font-size:0.85rem;box-shadow:0 2px 8px #a786ff22;margin-bottom:8px;padding:8px;">
        <div style="margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid rgba(167,134,255,0.3);">
           <div style="color:#a786ff;font-size:0.75rem;margin-bottom:2px;">ğŸ“Š Registration Info:</div>
        </div>
        <div style="margin-bottom:3px;">ğŸ¯ Referrer Index: <b id="parent-index">...</b></div>
         <div style="margin-bottom:3px;">ğŸ“ New Position Index: <b id="empty-index">...</b></div>
         <div style="margin-bottom:3px;">ğŸ”„ New User Position: <b id="position-info">...</b></div>
         <div style="margin-bottom:3px;">ğŸ’° Registration Cost:<br><b id="register-cost" style="display:inline-block;margin-top:1px;font-size:0.9rem;color:#00ff88;">...</b></div>
         <div style="margin-bottom:3px;">ğŸ¯ Registration Type: <b id="registration-type" style="color:#a786ff;">Normal</b></div>
        
        <div style="margin-top:6px;padding-top:4px;border-top:1px solid rgba(167,134,255,0.3);">
           <div style="color:#a786ff;font-size:0.75rem;margin-bottom:4px;">ğŸ’³ Wallet Balance:</div>
          <div style="display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;">
                                          <span style="display:flex;align-items:center;gap:4px;">
              <span style="color:#8247E5;font-size:16px;">ğŸ”·</span>
              <span>MATIC Balance: <b id="matic-balance">...</b></span>
            </span>
            <span style="display:flex;align-items:center;gap:4px;">
              <span style="color:#00ff88;font-size:16px;">ğŸ’</span>
              <span>IAM Balance: <b id="IAM-balance">...</b></span>
            </span>
          </div>
                     <div style="font-size:0.65rem;color:#718096;margin-top:4px;text-align:center;background:rgba(113,128,150,0.1);padding:3px;border-radius:3px;">
             ğŸ’¡ <span id="registration-hint">For normal registration you need regPrice IAM tokens</span>
        </div>
      </div>
             </div>
              <div class="avatar-row" style="margin-bottom:0.3em;">
        <span class="avatar-choice selected" data-avatar="man">ğŸ‘¨â€ğŸ’¼</span>
        <span class="avatar-choice" data-avatar="woman">ğŸ‘©â€ğŸ’¼</span>
        <span class="avatar-choice" data-avatar="student-man">ğŸ‘¨â€ğŸ“</span>
        <span class="avatar-choice" data-avatar="student-woman">ğŸ‘©â€ğŸ“</span>
      </div>
      <div class="register-form-status" id="status-message"></div>
      
                                                             <div style="margin-top:8px;padding:6px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:5px;text-align:center;font-size:0.75rem;color:#ffc107;">
          âš ï¸ You need sufficient IAM and MATIC balance for registration
       </div>
    </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="js/config.js"></script>
  <script>
    let selectedAvatar = 'man';
    let isConnected = false;
    // ØªØ¹Ø±ÛŒÙ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡
    const indexInput = document.getElementById('index-search');
    const refInput = document.getElementById('referrer-address');
     const newUserInput = document.getElementById('new-user-address');
    const defaultGuide = 'refferer ID : IAM00000';
    
                                                // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
          function isIndexInUserSubtree(targetIndex, currentUserIndex) {
            console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ: Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù=${targetIndex}, Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ=${currentUserIndex}`);
            
            if (targetIndex === currentUserIndex) {
              console.log(`âŒ Ø®ÙˆØ¯Ø´ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø®ÙˆØ¯Ø´ Ø¨Ø§Ø´Ø¯`);
              return false;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
            let checkIndex = targetIndex;
            while (checkIndex > currentUserIndex) {
              checkIndex = Math.floor(checkIndex / 2);
              console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ±: ${checkIndex}`);
              if (checkIndex === currentUserIndex) {
                console.log(`âœ… Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯`);
                return true;
              }
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¶Ø§ÙÛŒ: Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ú©Ù…ØªØ± Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù†ÛŒØ³Øª
            if (targetIndex < currentUserIndex) {
              console.log(`âŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ú©Ù…ØªØ± Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø§Ø³Øª`);
              return false;
            }
            
            console.log(`âŒ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù‚Ø±Ø§Ø± Ù†Ø¯Ø§Ø±Ø¯`);
            return false;
                    }
      

      
          // Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÙˆØ§ØªØ§Ø±
    document.querySelectorAll('.avatar-choice').forEach(el => {
      el.onclick = function() {
        document.querySelectorAll('.avatar-choice').forEach(e2 => e2.classList.remove('selected'));
        this.classList.add('selected');
        selectedAvatar = this.getAttribute('data-avatar');
      };
    });

     // ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø±Ø¨Ø±Ú¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
     let currentRegistrationType = 'normal';
     
     // Event listener Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¨Ø±Ú¯ Ø«Ø¨Øª Ù†Ø§Ù… Ù…Ø¹Ù…ÙˆÙ„ÛŒ
     document.getElementById('normal-tab').addEventListener('click', function() {
       currentRegistrationType = 'normal';
       
       // ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± Ø³Ø±Ø¨Ø±Ú¯â€ŒÙ‡Ø§
       document.getElementById('normal-tab').style.background = 'linear-gradient(90deg,#00ff88,#a786ff)';
       document.getElementById('normal-tab').style.color = '#232946';
       document.getElementById('free-tab').style.background = 'transparent';
       document.getElementById('free-tab').style.color = '#a786ff';
       
       // ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¯Ú©Ù…Ù‡
       document.getElementById('register-btn').textContent = 'Register';
       document.getElementById('register-btn').style.background = 'linear-gradient(90deg,#00ff88,#a786ff) !important';
       
       // ØªØºÛŒÛŒØ± Ø§Ø·Ù„Ø§Ø¹Ø§Øª
       document.getElementById('registration-type').textContent = 'Normal';
       document.getElementById('registration-type').style.color = '#00ff88';
       document.getElementById('registration-hint').textContent = 'For normal registration you need regPrice IAM tokens';
       
       // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø²ÛŒÙ†Ù‡
       updateRegistrationCost();
     });
     
     // Event listener Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¨Ø±Ú¯ Ø«Ø¨Øª Ù†Ø§Ù… Ø±Ø§ÛŒÚ¯Ø§Ù†
     document.getElementById('free-tab').addEventListener('click', function() {
       currentRegistrationType = 'free';
       
       // ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± Ø³Ø±Ø¨Ø±Ú¯â€ŒÙ‡Ø§
       document.getElementById('free-tab').style.background = 'linear-gradient(90deg,#ff6b6b,#ffa500)';
       document.getElementById('free-tab').style.color = '#232946';
       document.getElementById('normal-tab').style.background = 'transparent';
       document.getElementById('normal-tab').style.color = '#a786ff';
       
       // ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¯Ú©Ù…Ù‡
       document.getElementById('register-btn').textContent = 'Register Reserve';
       document.getElementById('register-btn').style.background = 'linear-gradient(90deg,#ff6b6b,#ffa500) !important';
       
       // ØªØºÛŒÛŒØ± Ø§Ø·Ù„Ø§Ø¹Ø§Øª
       document.getElementById('registration-type').textContent = 'Reserve';
       document.getElementById('registration-type').style.color = '#ff6b6b';
       document.getElementById('registration-hint').textContent = 'For reserve registration you need equivalent $23 IAM tokens';
       
       // Ù†Ù…Ø§ÛŒØ´ message box Ø¨Ø§ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø²Ø±Ùˆ
       showReserveInfoMessage();
       
       // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø²ÛŒÙ†Ù‡
       updateRegistrationCost();
     });
     
     // ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ù†Ø§Ù…
     async function updateRegistrationCost() {
       if (currentRegistrationType === 'free') {
         // Ø­Ø§Ù„Øª Ø±Ø²Ø±Ùˆ: Ù…Ø¹Ø§Ø¯Ù„ 23 Ø¯Ù„Ø§Ø± ØªÙˆÚ©Ù†
         try {
           if (window.contractConfig && window.contractConfig.contract) {
             const contract = window.contractConfig.contract;
             if (typeof contract.getTokenPrice === 'function') {
               const tokenPrice = await contract.getTokenPrice();
               const tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
               const requiredAmount = (23 / tokenPriceNum);
               document.getElementById('register-cost').textContent = `${requiredAmount.toFixed(2)} IAM`;
             } else {
               document.getElementById('register-cost').textContent = '23 IAM';
             }
           } else {
             document.getElementById('register-cost').textContent = 'Equivalent to $23';
           }
         } catch (e) {
           document.getElementById('register-cost').textContent = '23 IAM';
         }
       } else {
         // Ø­Ø§Ù„Øª Ù†Ø±Ù…Ø§Ù„: Ø§Ø² ØªØ§Ø¨Ø¹ regPrice Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
         try {
           if (window.contractConfig && window.contractConfig.contract) {
             const contract = window.contractConfig.contract;
             if (typeof window.getRegPrice === 'function') {
               const regPrice = await window.getRegPrice(contract);
               if (regPrice) {
                 const regPriceNum = Number(ethers.formatUnits(regPrice, 18));
                 document.getElementById('register-cost').textContent = `${regPriceNum.toFixed(2)} IAM`;
               } else {
                 document.getElementById('register-cost').textContent = 'RegPrice not available';
               }
             } else {
               document.getElementById('register-cost').textContent = 'RegPrice function not available';
             }
           } else {
             document.getElementById('register-cost').textContent = 'Contract not available';
           }
         } catch (e) {
           document.getElementById('register-cost').textContent = 'Error loading regPrice';
         }
       }
     }

         // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
    async function loadRegisterInfo() {
      const status = document.getElementById('status-message');
      const connStatus = document.getElementById('connection-status');
       const metamaskStatus = document.getElementById('metamask-status');
      status.textContent = '';
      connStatus.textContent = 'Connecting to wallet...';
       metamaskStatus.style.display = 'none';
      isConnected = false;
      let myAddress = null;
      let contract = null;
      let connection = null;
      try {
                 connection = await window.connectWallet();
         contract = connection.contract;
         myAddress = connection.address;
         window.currentUserAddress = myAddress; // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±
         isConnected = true;
        connStatus.textContent = '';
        document.getElementById('register-info').style.display = '';
        document.getElementById('register-btn').disabled = false;
        document.querySelectorAll('input').forEach(i=>i.disabled=false);
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ referrer (ÙˆØ§Ù„Ø¯) Ùˆ parent-index ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ user
        const refInput = document.getElementById('referrer-address');
        let user;
        let parentIndex = '...';
        try {
          user = await contract.users(myAddress);
          console.log(`ğŸ” ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±:`, user);
          // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ù¾ÛŒØ§Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            const suggestionDiv = document.getElementById('register-suggestion');
                     if (user && !(user.index && BigInt(user.index) > 0n)) {
             console.log(`âš ï¸ User registered but not active`);
             suggestionDiv.style.display = '';
             suggestionDiv.textContent = 'You have not registered yet. Please do a reserve registration.';
           } else if (!user) {
             console.log(`âš ï¸ User not registered at all`);
             suggestionDiv.style.display = '';
             suggestionDiv.textContent = 'You have not registered yet. Please do a reserve registration.';
           } else {
             console.log(`âœ… User is active: index=${user.index}`);
             suggestionDiv.style.display = 'none';
           }
          // Ø§Ú¯Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„ ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø±ÙˆØª ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
          if ((!refInput.value || refInput.value === 'root') && (user.index && BigInt(user.index) > 0n)) {
            refInput.value = myAddress;
          } else if (!(user.index && BigInt(user.index) > 0n) && (!refInput.value || refInput.value === myAddress)) {
            refInput.value = 'root';
          }
          // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ parent-index
          parentIndex = user.index ? user.index.toString() : '...';
          // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙÛŒÙ„Ø¯ Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙÙ‚Ø· Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
          const indexInput = document.getElementById('index-search');
          if ((!indexInput.value || indexInput.value === defaultGuide) && (user.index && BigInt(user.index) > 0n) && user.index) {
            // ÙØ±Ù…Øª Ø§ÛŒÙ†Ø¯Ú©Ø³
            let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
            indexInput.value = IAMId;
            indexInput.style.background = '';
            indexInput.style.color = '';
            indexInput.style.opacity = '';
          }
                 } catch (e) {
          // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±ÙˆØª Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
          refInput.value = 'root';
           parentIndex = '...';
         }
        document.getElementById('parent-index').textContent = parentIndex;
        
        
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ empty-index (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ)
         let emptyIndex = '...';
         if (parentIndex !== '...') {
           let left = await contract.getLeftAddress(parentIndex);
           let right = await contract.getRightAddress(parentIndex);
           if (left === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n).toString();
           } else if (right === '0x0000000000000000000000000000000000000000') {
             emptyIndex = (BigInt(parentIndex) * 2n + 1n).toString();
                       } else {
             emptyIndex = 'Full';
            }
         }
         document.getElementById('empty-index').textContent = emptyIndex;
        
                 // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ù†Ø§Ù…
         await updateRegistrationCost();
        
        // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ØªÛŒÚ©
        let maticBalance = '...';
        if (isConnected && contract && myAddress) {
          try {
            let bal = await connection.provider.getBalance(myAddress);
            maticBalance = bal ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(bal)).toFixed(2) : (Number(bal)/1e18).toFixed(2)) : '0.00';
          } catch (e) {
            maticBalance = '0.00';
          }
        }
        document.getElementById('matic-balance').textContent = maticBalance;
        // Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM
        let IAMBalance = '...';
        if (isConnected && contract && myAddress && typeof contract.balanceOf === 'function') {
          try {
            let IAM = await contract.balanceOf(myAddress);
            IAMBalance = IAM ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(IAM)).toFixed(2) : (Number(IAM)/1e18).toFixed(2)) : '0.00';
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ÙØ¹Ù„ÛŒ
            const IAMBalanceElement = document.getElementById('IAM-balance');
            try {
              let requiredIAM = 0;
              
              if (currentRegistrationType === 'free') {
                // Ø­Ø§Ù„Øª Ø±Ø²Ø±Ùˆ: Ù…Ø¹Ø§Ø¯Ù„ 23 Ø¯Ù„Ø§Ø± ØªÙˆÚ©Ù†
                let tokenPriceNum = 1; // Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 1 Ø¯Ù„Ø§Ø±
                if (typeof contract.getTokenPrice === 'function') {
                  const tokenPrice = await contract.getTokenPrice();
                  tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
                }
                requiredIAM = parseFloat((23 / tokenPriceNum).toFixed(2));
              } else {
                // Ø­Ø§Ù„Øª Ù†Ø±Ù…Ø§Ù„: Ø§Ø² ØªØ§Ø¨Ø¹ regPrice Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                if (typeof window.getRegPrice === 'function') {
                  const regPrice = await window.getRegPrice(contract);
                  if (regPrice) {
                    requiredIAM = parseFloat(Number(ethers.formatUnits(regPrice, 18)).toFixed(2));
                  } else {
                    requiredIAM = 0; // Ø§Ú¯Ø± regPrice Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯
                  }
                } else {
                  requiredIAM = 0; // Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ getRegPrice Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯
                }
              }
              
              // Ø±Ù†Ú¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM
              if (parseFloat(IAMBalance) >= requiredIAM) {
                IAMBalanceElement.style.color = '#00ff88'; // Ø³Ø¨Ø²: Ú©Ø§ÙÛŒ Ø§Ø³Øª
              } else {
                IAMBalanceElement.style.color = '#ff453a'; // Ù‚Ø±Ù…Ø²: Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª
              }
              
              // Ø±Ù†Ú¯ Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
              const registerCostElement = document.getElementById('register-cost');
              if (registerCostElement) {
                if (parseFloat(IAMBalance) >= requiredIAM) {
                  registerCostElement.style.color = '#00ff88'; // Ø³Ø¨Ø²: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø§Ø³Øª
              } else {
                  registerCostElement.style.color = '#ff453a'; // Ù‚Ø±Ù…Ø²: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª
                }
              }
            } catch (e) {
              console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ:', e);
            }
          } catch (e) {
            IAMBalance = '0.00';
          }
        }
        document.getElementById('IAM-balance').textContent = IAMBalance;
      } catch (e) {
        isConnected = false;
        console.error('Connection error in loadRegisterInfo:', e);
         
         // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§ÛŒ MetaMask - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
         if (e.message && (
           e.message.includes('MetaMask is not installed') ||
           e.message.includes('Cannot read properties of undefined') ||
           e.message.includes('window.ethereum') ||
           !window.ethereum
         )) {
           metamaskStatus.style.display = '';
           metamaskStatus.textContent = 'âš ï¸ MetaMask is not installed. Please install MetaMask extension to use this application.';
           connStatus.textContent = '';
         } else {
           connStatus.textContent = 'âŒ Failed to connect wallet: ' + (e.message || e);
         }
         
        document.getElementById('register-info').style.display = 'none';
        document.getElementById('register-btn').disabled = true;
        document.querySelectorAll('input').forEach(i=>i.disabled=true);
      }
    }
         window.addEventListener('DOMContentLoaded', loadRegisterInfo);
     
     // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ú©ÛŒÙ Ù¾ÙˆÙ„
     if (window.ethereum) {
       window.ethereum.on('accountsChanged', async function (accounts) {
         console.log('ğŸ”„ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯:', accounts);
         if (accounts.length > 0) {
           window.currentUserAddress = accounts[0];
           await loadRegisterInfo(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
         }
       });
     }

         

    // --- Manual index application with button ---
    // Add button click handler for manual index application
    document.getElementById('apply-index-btn').addEventListener('click', async function() {
      const value = indexInput.value.trim();
      console.log(`ğŸ” Manual index application: ${value}`);
      
             if (!value || value === defaultGuide) {
         alert('Please enter a valid index');
         return;
       }
      
      // Format index to IAM format if it's a number
      let formattedValue = value;
      if (/^\d+$/.test(value)) {
        let IAMId = '';
        if (value.length <= 5) {
          IAMId = 'IAM' + value.padStart(5, '0');
        } else {
          IAMId = 'IAM' + value;
        }
        formattedValue = IAMId;
        indexInput.value = IAMId;
      }
      
      // Apply the index
      await checkIndexReferralLine();
    });
    
    // Keep only Enter key support for convenience
    indexInput.addEventListener('keypress', async function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('apply-index-btn').click();
      }
    });
     

     
           // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø· Ø±ÙØ±Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³
       async function checkIndexReferralLine() {
        let index = indexInput.value;
        
                 // Ø§Ú¯Ø± IAM prefix Ø¯Ø§Ø±Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†
         if (index.startsWith('IAM')) {
           index = index.substring(3);
         }
         
         // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
         index = index.replace(/[^0-9]/g, '');
         
                    // Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø®ÛŒÙ„ÛŒ Ø¨Ø²Ø±Ú¯ Ø§Ø³ØªØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª
           if (index.length > 8) {
             showIndexCheckMessage('The entered index is too large. Please check and enter a valid index.', 'error');
             return;
           }
        
        if (!index) return;
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          
                     // Step 1: Check if index exists in network
           console.log(`ğŸ” Checking if index ${index} exists in network...`);
          let addr = null;
          try {
            addr = await contract.indexToAddress(index);
                         console.log(`ğŸ“ Address of index ${index}:`, addr);
           } catch (e) {
             console.log(`âŒ Error getting address of index ${index}:`, e);
             showIndexCheckMessage('The entered index does not exist in the network. Please enter a valid index.', 'info');
             return;
           }
          
                     // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª (Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯)
           if (!addr || addr === '0x0000000000000000000000000000000000000000') {
             showIndexCheckMessage('The entered index does not exist in the network. Please enter a valid index.', 'info');
             return;
           }
          
                     // Step 2: Check if user at this index is active
           try {
             const userAtAddress = await contract.users(addr);
             console.log(`ğŸ‘¤ User info at index ${index}:`, userAtAddress);
             
           const isActive = userAtAddress && userAtAddress.index && BigInt(userAtAddress.index) > 0n;
           
           if (!isActive) {
             showIndexCheckMessage('User at this index is not active. Please select an active referrer.', 'error');
             return;
           }
          
                         // ØªÙ†Ø¸ÛŒÙ… Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù (Ù‡Ù…ÛŒØ´Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯)
           refInput.readOnly = false;
           refInput.disabled = false;
           refInput.value = addr;
           refInput.style.backgroundColor = '#232946';
           refInput.style.color = '#fff';
             status.style.color = '#388e3c';
             status.textContent = `âœ… Referrer address automatically set: ${addr}`;
             console.log(`âœ… Referrer address set: ${addr}`);
            
                     } catch (e) {
             console.log(`âŒ Error checking user status:`, e);
             status.style.color = '#d32f2f';
             showTempMessage('Error checking user status.', 'error');
             return;
           }
          
                     // Step 3: Check current user's eligibility
          let myAddress = null, currentUser = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
              currentUser = await contract.users(myAddress);
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                currentUser = await contract.users(myAddress);
                window.currentUserAddress = myAddress;
              }
            }
                     } catch (e) {
             console.log(`Error getting user info:`, e);
           }
          
                     console.log(`ğŸ” Checking current user:`, currentUser);
           if (currentUser && (currentUser.index && BigInt(currentUser.index) > 0n) && currentUser.index) {
             const currentUserIndex = parseInt(currentUser.index);
             const targetIndex = parseInt(index);
             console.log(`ğŸ” Checking eligibility: current user=${currentUserIndex}, target=${targetIndex}`);
             
             // Check if target index is in user's subtree
             if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
               showIndexCheckMessage('This index is cross-line. You can only register for indexes in your subtree.', 'error');
               return;
             } else {
               // Check if referrer has at least one empty child at level 1
               try {
                 const parentIndex = parseInt(index);
                 const leftAddress = await contract.getLeftAddress(parentIndex);
                 const rightAddress = await contract.getRightAddress(parentIndex);
                 
                 if (leftAddress === '0x0000000000000000000000000000000000000000' || rightAddress === '0x0000000000000000000000000000000000000000') {
                   // At least one child is empty
                   showIndexCheckMessage('Index is valid and in your subtree. Referrer has available positions for registration.', 'success');
                   
                   // Calculate and display new user position info
                   let emptyIndex, positionInfo;
                   if (leftAddress === '0x0000000000000000000000000000000000000000') {
                     emptyIndex = (parentIndex * 2).toString();
                     positionInfo = 'Left';
                   } else if (rightAddress === '0x0000000000000000000000000000000000000000') {
                     emptyIndex = (parentIndex * 2 + 1).toString();
                     positionInfo = 'Right';
                   } else {
                     emptyIndex = 'Full';
                     positionInfo = 'No empty position';
                   }
                   
                   document.getElementById('empty-index').textContent = emptyIndex;
                   document.getElementById('position-info').textContent = positionInfo;
                 } else {
                   // Both children are occupied
                   showIndexCheckMessage('This referrer is full. Please enter a different index with available positions.', 'warning');
                   document.getElementById('empty-index').textContent = 'Full';
                   document.getElementById('position-info').textContent = 'No empty position';
                   return;
                 }
               } catch (error) {
                 console.log('Error calculating position info:', error);
                 document.getElementById('position-info').textContent = 'Error calculating';
               }
             }
                        } else {
               // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
               const newUserAddress = document.getElementById('new-user-address').value.trim();
               if (newUserAddress && newUserAddress.toLowerCase() === myAddress.toLowerCase()) {
                 console.log(`âœ… User registering for themselves`);
                 status.style.color = '#388e3c';
                 status.textContent = 'You can register for yourself.';
                 
                 // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                 try {
                   const parentIndex = parseInt(index);
                   const leftAddress = await contract.getLeftAddress(parentIndex);
                   const rightAddress = await contract.getRightAddress(parentIndex);
                   
                   let emptyIndex, positionInfo;
                   if (leftAddress === '0x0000000000000000000000000000000000000000') {
                     emptyIndex = (parentIndex * 2).toString();
                     positionInfo = 'Left';
                   } else if (rightAddress === '0x0000000000000000000000000000000000000000') {
                     emptyIndex = (parentIndex * 2 + 1).toString();
                     positionInfo = 'Right';
                } else {
                     emptyIndex = 'Full';
                     positionInfo = 'No empty position';
                   }
                   
                   document.getElementById('empty-index').textContent = emptyIndex;
                   document.getElementById('position-info').textContent = positionInfo;
                 } catch (error) {
                   console.log('Error calculating position info:', error);
                   document.getElementById('position-info').textContent = 'Error calculating';
                 }
               } else {
                 console.log(`âš ï¸ User not active or no index:`, currentUser);
                 status.style.color = '#d32f2f';
                 status.textContent = `You must register first to be able to register others.`;
                 return;
               }
             }
          
        } catch (e) {
          const status = document.getElementById('status-message');
          status.style.color = '#d32f2f';
          showTempMessage('Error checking index: ' + (e.message || e), 'error');
        }
      }
         // When address changes, update index and check referral line
     refInput.addEventListener('change', async function() {
       await checkReferralLine();
     });
     
     // Adding event listener for input and paste
     refInput.addEventListener('input', async function() {
       await checkReferralLine();
     });
     
     refInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkReferralLine();
       }, 100);
     });
     
           // Function to check referral line
      async function checkReferralLine() {
        const address = refInput.value.trim();
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) return;
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          
          // Step 1: Check if address exists in network and get user info
          console.log(`ğŸ” Checking if address ${address} exists in network...`);
          let user = null;
          try {
            user = await contract.users(address);
            console.log(`ğŸ‘¤ User info at address ${address}:`, user);
                     } catch (e) {
             console.log(`âŒ Error getting user info:`, e);
             showIndexCheckMessage('The entered address does not exist in the network. Please enter a valid address.', 'info');
             return;
           }
          
                     // Step 2: Check if user is active
           if (!user || !(user.index && BigInt(user.index) > 0n)) {
             showIndexCheckMessage('User at this address is not active or does not exist. Please select an active referrer.', 'error');
             return;
           }
           
           // Step 3: Check if user has index
           if (!user.index) {
             showIndexCheckMessage('User at this address has no index. Please select a valid referrer.', 'error');
             return;
           }
           
           // Step 4: Set index in the relevant field
          let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
          indexInput.value = IAMId;
          indexInput.style.background = '';
          indexInput.style.color = '';
          indexInput.style.opacity = '';
          
                     // Step 5: Check current user's eligibility
          let myAddress = null, currentUser = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
              currentUser = await contract.users(myAddress);
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                currentUser = await contract.users(myAddress);
                window.currentUserAddress = myAddress;
              }
            }
                     } catch (e) {
             console.log(`Error getting current user info:`, e);
           }
           
           console.log(`ğŸ” Checking current user:`, currentUser);
           if (currentUser && (currentUser.index && BigInt(currentUser.index) > 0n) && currentUser.index) {
             const currentUserIndex = parseInt(currentUser.index);
             const targetIndex = parseInt(user.index);
             console.log(`ğŸ” Checking eligibility: current user=${currentUserIndex}, target=${targetIndex}`);
             
             if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
               showIndexCheckMessage('This address is cross-line. You can only register for addresses in your subtree.', 'error');
               return;
             } else {
               // Check if referrer has at least one empty child at level 1
               try {
                 const parentIndex = parseInt(user.index);
                 const leftAddress = await contract.getLeftAddress(parentIndex);
                 const rightAddress = await contract.getRightAddress(parentIndex);
                 
                 if (leftAddress === '0x0000000000000000000000000000000000000000' || rightAddress === '0x0000000000000000000000000000000000000000') {
                   // At least one child is empty
                   showIndexCheckMessage('Address is valid and in your subtree. Referrer has available positions for registration.', 'success');
                 } else {
                   // Both children are occupied
                   showIndexCheckMessage('This referrer is full. Please enter a different address with available positions.', 'warning');
                   return;
                 }
               } catch (error) {
                 console.log('Error checking referrer positions:', error);
                 status.style.color = '#d32f2f';
                 status.textContent = 'Error checking referrer positions.';
                 return;
               }
             }
                        } else {
               // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
               const newUserAddress = document.getElementById('new-user-address').value.trim();
               if (newUserAddress && newUserAddress.toLowerCase() === myAddress.toLowerCase()) {
                 console.log(`âœ… User registering for themselves`);
                 status.style.color = '#388e3c';
                 status.textContent = 'You can register for yourself.';
               } else {
                 console.log(`âš ï¸ User not active or no index:`, currentUser);
                 status.style.color = '#d32f2f';
                 status.textContent = `You must register first to be able to register others.`;
                 return;
               }
             }
          
        } catch (e) {
          showTempMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø¯Ø±Ø³: ' + (e.message || e), 'error');
        }
      }
     

     
            // ÙˆÙ‚ØªÛŒ Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†
       newUserInput.addEventListener('change', async function() {
         await checkNewUserAddress();
       });
       
       // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ input Ùˆ paste
       newUserInput.addEventListener('input', async function() {
         await checkNewUserAddress();
       });
       
       newUserInput.addEventListener('paste', async function() {
         setTimeout(async () => {
           await checkNewUserAddress();
         }, 100);
       });
       
             // Function to check new user address
        async function checkNewUserAddress() {
        const address = newUserInput.value.trim();
        const status = document.getElementById('status-message');
        
                 // Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
         if (!address) {
           status.textContent = '';
           return;
         }
         
         // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª Ø¢Ø¯Ø±Ø³
         if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
           status.style.color = '#d32f2f';
           status.textContent = 'The entered address is not valid. Please enter a correct address.';
           return;
         }
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          
          // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ
          let myAddress = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                window.currentUserAddress = myAddress;
              }
            }
          } catch (e) {
            console.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ:`, e);
          }
          
                     // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª
           const user = await contract.users(address);
           if (user && (user.index && BigInt(user.index) > 0n)) {
             status.style.color = '#d32f2f';
             status.textContent = 'This address is already registered.';
             return;
           }
           
           // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
           if (address.toLowerCase() === myAddress.toLowerCase()) {
             status.style.color = '#388e3c';
             status.textContent = 'You can register for yourself.';
           } else {
             // Ø§Ú¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡ØŒ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
             status.style.color = '#388e3c';
             status.textContent = 'New user address is valid and can be registered.';
           }
          
                     // Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
           try {
             // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³
             let foundIndex = null;
             for (let i = 1; i <= 1000; i++) { // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± 1000 Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§ÙˆÙ„
               try {
                 const addrAtIndex = await contract.indexToAddress(i);
                 if (addrAtIndex.toLowerCase() === address.toLowerCase()) {
                   foundIndex = i;
                   break;
                 }
               } catch (e) {
                 // Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
                 continue;
               }
             }
             
             if (foundIndex) {
               status.textContent += ` (Index: ${foundIndex})`;
             }
                      } catch (e) {
             // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
           }
         } catch (e) {
           showTempMessage('Error checking address: ' + (e.message || e), 'error');
         }
       }
      


                             // Register new user (based on selected type)
    document.getElementById('register-btn').onclick = async function() {
      const status = document.getElementById('status-message');
      const registerBtn = this;
      
      // Disable button and show loading state
      registerBtn.disabled = true;
      registerBtn.style.opacity = '0.6';
      status.style.color = '#1976d2';
      status.textContent = 'Connecting wallet and validating information...';
      
      try {
        // Connect wallet if not already connected
        if (!window.contractConfig || !window.contractConfig.contract) {
          console.log('ğŸ”„ Connecting wallet for registration...');
          await window.connectWallet();
          await loadRegisterInfo();
        }
        
        const referrer = refInput.value.trim();
        const newUser = document.getElementById('new-user-address').value.trim();
        const enteredIndexStr = indexInput.value.replace(/[^0-9]/g, '');
        const enteredIndex = enteredIndexStr ? parseInt(enteredIndexStr) : null;
        
        // Validate inputs
        if (!/^0x[a-fA-F0-9]{40}$/.test(referrer)) throw new Error('Invalid referrer address. Please enter a valid address.');
        if (!/^0x[a-fA-F0-9]{40}$/.test(newUser)) throw new Error('Invalid new wallet address. Please enter a valid address.');
        if (/^0x[a-fA-F0-9]{40}$/.test(referrer) && (!enteredIndexStr || indexInput.value === defaultGuide)) {
          throw new Error('Please enter the referrer index correctly.');
        }
        
        const contract = window.contractConfig.contract;
        if (!contract) throw new Error('Contract connection failed. Please try again.');
        let myAddress = null, user = null;
                 try {
             // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
           if (window.currentUserAddress) {
             myAddress = window.currentUserAddress;
             user = await contract.users(myAddress);
           } else {
             myAddress = contract.signer ? await contract.signer.getAddress() : null;
             if (myAddress) {
               user = await contract.users(myAddress);
               window.currentUserAddress = myAddress;
             }
           }
         } catch (e) {
             console.log(`Error getting user info in reserve registration:`, e);
           }
          
                     console.log(`ğŸ” Checking user in reserve registration:`, user);
                   // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø®Ø· Ø±ÙØ±Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
           if (user && (user.index && BigInt(user.index) > 0n) && user.index && enteredIndex !== null) {
             const currentUserIndex = parseInt(user.index);
             const targetIndex = parseInt(enteredIndex);
             console.log(`ğŸ” Checking in reserve registration: current user=${currentUserIndex}, target=${targetIndex}`);
             
             if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
               throw new Error(`You are only allowed to register for indexes in your subtree.`);
             }
             
             // Check if referrer has at least one empty child at level 1
             const leftAddress = await contract.getLeftAddress(targetIndex);
             const rightAddress = await contract.getRightAddress(targetIndex);
             
             if (leftAddress !== '0x0000000000000000000000000000000000000000' && rightAddress !== '0x0000000000000000000000000000000000000000') {
               throw new Error(`This referrer is full. Please select a different index with available positions.`);
             }
           } else {
             // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
             if (newUser.toLowerCase() === myAddress.toLowerCase()) {
               console.log(`âœ… User registering for themselves`);
               // Ø§Ø¬Ø§Ø²Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ø´
             } else {
               console.log(`âš ï¸ User not active or no index in reserve registration:`, user);
               throw new Error(`You must register first to be able to register others.`);
             }
          }
         const addrFromIndex = await contract.indexToAddress(enteredIndex);
         if (addrFromIndex.toLowerCase() !== referrer.toLowerCase()) {
           throw new Error('The entered index does not match the referrer address. Please check.');
         }
         
                   // Check token balance based on registration type
         const userBalance = await contract.balanceOf(myAddress);
         let requiredAmount;
         
                    if (currentRegistrationType === 'free') {
             // Reserve mode: equivalent to $23 tokens
             let tokenPriceNum = 1; // Default price $1
             try {
               if (typeof contract.getTokenPrice === 'function') {
                 const tokenPrice = await contract.getTokenPrice();
                 tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
               }
             } catch (e) {
               console.log('Error getting token price, using default price:', e);
             }
             
             // Calculate required amount (23 USD / token price)
             const requiredAmountFloat = 23 / tokenPriceNum;
             requiredAmount = ethers.parseEther(requiredAmountFloat.toString());
           } else {
             // Normal mode: use regPrice function
           try {
             if (typeof window.getRegPrice === 'function') {
               const regPrice = await window.getRegPrice(contract);
               if (regPrice) {
                 requiredAmount = regPrice;
               } else {
                 throw new Error('RegPrice not available');
               }
             } else {
               throw new Error('RegPrice function not available');
             }
                        } catch (e) {
               console.log('Error getting regPrice:', e);
               throw new Error('Unable to get registration price');
             }
         }
         
         if (userBalance < requiredAmount) {
           const requiredFormatted = Number(ethers.formatEther(requiredAmount)).toFixed(2);
           const currentFormatted = Number(ethers.formatEther(userBalance)).toFixed(2);
           throw new Error(`Insufficient IAM balance. Required: ${requiredFormatted} IAM, Current: ${currentFormatted} IAM`);
         }
         
                  showTempMessage(currentRegistrationType === 'free' ? 'Sending reserve registration request to network... Please wait for transaction confirmation.' : 'Sending normal registration request to network... Please wait for transaction confirmation.', 'info');
          localStorage.setItem('avatar_' + newUser, selectedAvatar);
          
                   // Select function based on registration type
         let tx;
         if (currentRegistrationType === 'free') {
           tx = await contract.registerFree(referrer, newUser);
        } else {
           tx = await contract.registerAndActivate(referrer, newUser);
           }
          
         showTempMessage('Waiting for network transaction confirmation...', 'info');
          await tx.wait();
         showMessageBox(currentRegistrationType === 'free' ? 'Reserve registration completed successfully! Welcome to IAM family.' : 'Normal registration completed successfully! Welcome to IAM family.', 'success');
        setTimeout(loadRegisterInfo, 1500);
      } catch (e) {
        let errorMsg = e && (e.reason || (e.revert && e.revert.args && e.revert.args[0]) || e.message || e);
        if (typeof errorMsg !== 'string') errorMsg = JSON.stringify(errorMsg);
        if (/already registered|Already registered/i.test(errorMsg)) {
          showTempMessage('This address is already registered.', 'error');
                   } else if (/not active|inactive/i.test(errorMsg)) {
          showTempMessage('Selected referrer is not active. Please enter an active referrer.', 'error');
        } else if (/invalid referrer|referrer/i.test(errorMsg)) {
           showTempMessage('Invalid referrer address or does not exist.', 'error');
                   } else if (/insufficient|balance/i.test(errorMsg)) {
              // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ Ú©Ù…Ø¨ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø² smart contract Ø¢Ù…Ø¯Ù‡ØŒ Ù‡Ù…Ø§Ù† Ù¾ÛŒØ§Ù… Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
             if (errorMsg.includes('IAM balance insufficient')) {
             showMessageBox(errorMsg, 'error');
           } else {
             showTempMessage('Your IAM balance is insufficient for registration.', 'error');
           }
                   } else if (/user rejected|reject/i.test(errorMsg)) {
          showTempMessage('Registration process was cancelled by you.', 'error');
        } else if (/execution reverted/i.test(errorMsg)) {
          const match = errorMsg.match(/reverted: "([^"]+)"/);
          if (match && match[1]) {
            showTempMessage('Error: ' + match[1], 'error');
          } else {
             showTempMessage('Transaction was reverted by contract. Please check inputs.', 'error');
          }
        } else {
          showMessageBox('âŒ Registration error: ' + (errorMsg.length > 120 ? errorMsg.slice(0,120)+'...' : errorMsg), 'error');
        }
      } finally {
        // Restore button state
        registerBtn.disabled = false;
        registerBtn.style.opacity = '1';
      }
    };

     

    // Clear faded guide on focus for index input
    indexInput.addEventListener('focus', function() {
      if (this.value === defaultGuide) {
        this.value = '';
        this.style.background = '';
        this.style.color = '';
        this.style.opacity = '';
      }
    });
    indexInput.addEventListener('blur', function() {
      if (this.value.trim() === '') {
        this.value = defaultGuide;
        this.style.background = '#f3f3f3';
        this.style.color = '#888';
        this.style.opacity = '0.7';
        refInput.value = 'root';
      }
    });
  </script>
  
  <!-- Floating Token Growth Card - Ú©Ø§Ø±Øª Ø´Ù†Ø§ÙˆØ± Ø±Ø´Ø¯ ØªÙˆÚ©Ù† -->
  <script src="js/floating-token-card.js"></script>
</body>
</html> 