<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: #181c2a !important;
    }
    .register-form {
      background: linear-gradient(135deg, #232946 80%, #181c2a 100%) !important;
      color: #fff !important;
      border-radius: 22px;
      box-shadow: 0 8px 32px #00000033, 0 1.5px 6px #00ff8840;
      padding: 36px 28px 28px 28px;
    }
    .register-form label,
    .register-form-title {
      color: #a786ff !important;
    }
    .register-form input,
    .register-form-input {
      background: #232946 !important;
      color: #fff !important;
      border: 1.5px solid #444;
    }
    .register-form input:focus {
      border-color: #00ff88;
      background: #232946;
      color: #fff;
    }
    .info-box {
      background: rgba(28,28,40,0.97) !important;
      color: #fff !important;
      border: 1px solid #444;
      box-shadow: 0 2px 8px #00ff8840;
    }
    .register-btn, .buy-btn {
      background: linear-gradient(90deg,#00ff88,#a786ff) !important;
      color: #232946 !important;
      font-weight: bold;
      border-radius: 10px;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #a786ff22;
    }
    .register-btn:active, .buy-btn:active {
      background: linear-gradient(90deg,#a786ff,#00ff88) !important;
    }
    .register-form-status {
      color: #fff !important;
    }
  </style>
</head>
<body>
  <script src="js/navbar.js"></script>
  <main style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--ios-background);">
    <form class="register-form" autocomplete="off" style="max-width:430px;width:100%;margin:0 auto;">
      <h2 class="register-form-title" style="text-align:center;margin-bottom:18px;">ÙØ±Ù… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ</h2>
      <div class="register-form-status info" id="connection-status"></div>
      <div class="register-form-status warning" id="register-suggestion" style="display:none;"></div>
      <div class="form-group">
        <label for="index-search">Ø§ÛŒÙ†Ø¯Ú©Ø³ (Index)</label>
                 <div style="font-size:0.85rem;color:#a786ff;margin-bottom:8px;background:rgba(167,134,255,0.1);padding:8px;border-radius:6px;border:1px solid rgba(167,134,255,0.3);">
           âš ï¸ <strong>Ù…Ø­Ø¯ÙˆØ¯ÛŒØª:</strong> ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø®Ø· Ø±ÙØ±Ø§Ù„ Ø®ÙˆØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯.
         </div>
        <input type="text" id="index-search" class="register-form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹ 123" autocomplete="off" value="refferer ID : IAM00000" style="width:100%;min-width:0;">
      </div>
      <div class="form-group">
        <label for="referrer-address">Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù (ÙˆØ§Ù„Ø¯)</label>
        <div style="font-size:0.8rem;color:#718096;margin-bottom:6px;background:rgba(113,128,150,0.1);padding:6px;border-radius:4px;">
          ğŸ”— Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…Ø¹Ø±Ù Ø¨Ø§ÛŒØ¯ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯.
        </div>
        <input type="text" id="referrer-address" class="register-form-input" placeholder="0x..." autocomplete="off" value="root">
      </div>
      <div class="form-group">
        <label for="new-user-address">Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</label>
        <div style="font-size:0.8rem;color:#718096;margin-bottom:6px;background:rgba(113,128,150,0.1);padding:6px;border-radius:4px;">
          ğŸ‘¤ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯. Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù†Ø¨Ø§ÛŒØ¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.
        </div>
        <input type="text" id="new-user-address" class="register-form-input" placeholder="0x..." autocomplete="off">
      </div>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const addressInput = document.getElementById('new-user-address');
          
          // ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆÛŒ Ø§ÛŒÙ†Ù¾ÙˆØª Ú©Ù„ÛŒÚ© Ú©Ù†Ø¯
          addressInput.addEventListener('click', async function() {
            try {
              // Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ú©Ù„ÛŒÙ¾Ø¨ÙˆØ±Ø¯
              const clipboardText = await navigator.clipboard.readText();
              
              // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯Ù‡ Ø´Ø¨ÛŒÙ‡ Ø¢Ø¯Ø±Ø³ Ø§ØªØ±ÛŒÙˆÙ… Ø§Ø³Øª
              if (clipboardText.match(/^0x[a-fA-F0-9]{40}$/)) {
                addressInput.value = clipboardText;
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                alert('Ø¢Ø¯Ø±Ø³ Ø§Ø² Ú©Ù„ÛŒÙ¾Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯!');
              }
            } catch (err) {
              console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾Ø¨ÙˆØ±Ø¯:', err);
              // Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
            }
          });
        });
      </script>
      <div class="info-box" id="register-info" style="background:rgba(28,28,40,0.97);color:#fff;font-weight:bold;font-size:1.08rem;box-shadow:0 2px 8px #a786ff22;margin-bottom:18px;">
        <div style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(167,134,255,0.3);">
          <div style="color:#a786ff;font-size:0.9rem;margin-bottom:4px;">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ:</div>
        </div>
        <div style="margin-bottom:8px;">ğŸ¯ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø±ÙØ±Ø±: <b id="parent-index">...</b></div>
        <div style="margin-bottom:8px;">ğŸ“ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø¬Ø¯ÛŒØ¯: <b id="empty-index">...</b></div>
        <div style="margin-bottom:8px;">ğŸ’° Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ:<br><b id="register-cost" style="display:inline-block;margin-top:4px;font-size:1.1rem;color:#00ff88;">...</b></div>
        
        <div style="margin-top:12px;padding-top:8px;border-top:1px solid rgba(167,134,255,0.3);">
          <div style="color:#a786ff;font-size:0.9rem;margin-bottom:8px;">ğŸ’³ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:</div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;">
          <span style="display:flex;align-items:center;gap:6px;">
            <img src="matic.svg" alt="MATIC" style="width:18px;height:18px;vertical-align:middle;"> 
            <span>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ØªÛŒÚ©: <b id="matic-balance">...</b></span>
          </span>
          <span style="display:flex;align-items:center;gap:6px;">
            <img src="IAM.jpg" alt="IAM" style="width:18px;height:18px;vertical-align:middle;border-radius:50%;"> 
            <span>Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM: <b id="IAM-balance">...</b></span>
          </span>
          </div>
          <div style="font-size:0.8rem;color:#718096;margin-top:8px;text-align:center;background:rgba(113,128,150,0.1);padding:6px;border-radius:4px;">
            ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø¹Ø§Ø¯Ù„ $23 ØªÙˆÚ©Ù† IAM Ø¯Ø§Ø±ÛŒØ¯
          </div>
        </div>
      </div>
      <div class="avatar-row" style="margin-bottom:0.5em;">
        <span class="avatar-choice selected" data-avatar="man">ğŸ‘¨â€ğŸ’¼</span>
        <span class="avatar-choice" data-avatar="woman">ğŸ‘©â€ğŸ’¼</span>
        <span class="avatar-choice" data-avatar="student-man">ğŸ‘¨â€ğŸ“</span>
        <span class="avatar-choice" data-avatar="student-woman">ğŸ‘©â€ğŸ“</span>
      </div>
                             <button class="register-btn buy-btn" id="register-btn" type="button" style="width:100%;margin-top:18px;">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ</button>
                       <div class="register-form-status" id="status-message"></div>
                       
                       <div style="margin-top:20px;padding:12px;background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;text-align:center;font-size:0.9rem;color:#ffc107;">
                           âš ï¸ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ IAM Ùˆ MATIC Ø¯Ø§Ø±ÛŒØ¯
                       </div>
                   </form>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="js/config.js"></script>
  <script>
    let selectedAvatar = 'man';
    let isConnected = false;
    // ØªØ¹Ø±ÛŒÙ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡
    const indexInput = document.getElementById('index-search');
    const refInput = document.getElementById('referrer-address');
     const newUserInput = document.getElementById('new-user-address');
    const defaultGuide = 'refferer ID : IAM00000';
    
                                                // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
          function isIndexInUserSubtree(targetIndex, currentUserIndex) {
            console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ: Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù=${targetIndex}, Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ=${currentUserIndex}`);
            
            if (targetIndex === currentUserIndex) {
              console.log(`âŒ Ø®ÙˆØ¯Ø´ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø®ÙˆØ¯Ø´ Ø¨Ø§Ø´Ø¯`);
              return false;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
            let checkIndex = targetIndex;
            while (checkIndex > currentUserIndex) {
              checkIndex = Math.floor(checkIndex / 2);
              console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø³ÛŒØ±: ${checkIndex}`);
              if (checkIndex === currentUserIndex) {
                console.log(`âœ… Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯`);
                return true;
              }
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¶Ø§ÙÛŒ: Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ú©Ù…ØªØ± Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù†ÛŒØ³Øª
            if (targetIndex < currentUserIndex) {
              console.log(`âŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ú©Ù…ØªØ± Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ø§Ø³Øª`);
              return false;
            }
            
            console.log(`âŒ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ù‚Ø±Ø§Ø± Ù†Ø¯Ø§Ø±Ø¯`);
            return false;
                    }
      

      
     // Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÙˆØ§ØªØ§Ø±
    document.querySelectorAll('.avatar-choice').forEach(el => {
      el.onclick = function() {
        document.querySelectorAll('.avatar-choice').forEach(e2 => e2.classList.remove('selected'));
        this.classList.add('selected');
        selectedAvatar = this.getAttribute('data-avatar');
      };
    });

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
    async function loadRegisterInfo() {
      const status = document.getElementById('status-message');
      const connStatus = document.getElementById('connection-status');
      status.textContent = '';
      connStatus.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„...';
      isConnected = false;
      let myAddress = null;
      let contract = null;
      let connection = null;
      try {
                 connection = await window.connectWallet();
         contract = connection.contract;
         myAddress = connection.address;
         window.currentUserAddress = myAddress; // Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø±
         isConnected = true;
        connStatus.textContent = '';
        document.getElementById('register-info').style.display = '';
        document.getElementById('register-btn').disabled = false;
        document.querySelectorAll('input').forEach(i=>i.disabled=false);
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ referrer (ÙˆØ§Ù„Ø¯) Ùˆ parent-index ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ user
        const refInput = document.getElementById('referrer-address');
        let user;
        let parentIndex = '...';
        try {
          user = await contract.users(myAddress);
          console.log(`ğŸ” ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±:`, user);
          // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªØŒ Ù¾ÛŒØ§Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
          const suggestionDiv = document.getElementById('register-suggestion');
          if (user && !user.activated) {
            console.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª`);
            suggestionDiv.style.display = '';
            suggestionDiv.textContent = 'Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯.';
          } else if (!user) {
            console.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± Ø§ØµÙ„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª`);
            suggestionDiv.style.display = '';
            suggestionDiv.textContent = 'Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯.';
          } else {
            console.log(`âœ… Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª: Ø§ÛŒÙ†Ø¯Ú©Ø³=${user.index}`);
            suggestionDiv.style.display = 'none';
          }
          // Ø§Ú¯Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„ ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø±ÙˆØª ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
          if ((!refInput.value || refInput.value === 'root') && user.activated) {
            refInput.value = myAddress;
          } else if (!user.activated && (!refInput.value || refInput.value === myAddress)) {
            refInput.value = 'root';
          }
          // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ parent-index
          parentIndex = user.index ? user.index.toString() : '...';
          // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙÛŒÙ„Ø¯ Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙÙ‚Ø· Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
          const indexInput = document.getElementById('index-search');
          if ((!indexInput.value || indexInput.value === defaultGuide) && user.activated && user.index) {
            // ÙØ±Ù…Øª Ø§ÛŒÙ†Ø¯Ú©Ø³
            let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
            indexInput.value = IAMId;
            indexInput.style.background = '';
            indexInput.style.color = '';
            indexInput.style.opacity = '';
          }
        } catch (e) {
          // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±ÙˆØª Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
          refInput.value = 'root';
          parentIndex = '...';
        }
        document.getElementById('parent-index').textContent = parentIndex;
        
        
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ empty-index (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ)
        let emptyIndex = '...';
        if (parentIndex !== '...') {
          let left = await contract.getLeftAddress(parentIndex);
          let right = await contract.getRightAddress(parentIndex);
          if (left === '0x0000000000000000000000000000000000000000') {
            emptyIndex = (BigInt(parentIndex) * 2n).toString();
          } else if (right === '0x0000000000000000000000000000000000000000') {
            emptyIndex = (BigInt(parentIndex) * 2n + 1n).toString();
          } else {
            emptyIndex = 'Ù¾Ø± Ø´Ø¯Ù‡';
          }
        }
        document.getElementById('empty-index').textContent = emptyIndex;
        
        // Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ (Ù…Ø¹Ø§Ø¯Ù„ $23)
        let regCost = 'Ù…Ø¹Ø§Ø¯Ù„ $23';
        try {
          // Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªÙˆÚ©Ù† Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚
          if (typeof contract.getTokenPrice === 'function') {
            const tokenPrice = await contract.getTokenPrice();
            // getTokenPrice Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§ 18 decimal Ø¯Ø§Ø±Ù‡ØŒ Ø¨Ø§ÛŒØ¯ formatUnits Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…
            const tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
            const requiredAmount = (23 / tokenPriceNum);
            regCost = `${requiredAmount.toFixed(2)} IAM`;
          }
        } catch (e) {
          console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªÙˆÚ©Ù†:', e);
          regCost = '23 IAM'; // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ú¯Ø± getTokenPrice Ú©Ø§Ø± Ù†Ú©Ø±Ø¯
        }
        document.getElementById('register-cost').textContent = regCost;
        
        // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ØªÛŒÚ©
        let maticBalance = '...';
        if (isConnected && contract && myAddress) {
          try {
            let bal = await connection.provider.getBalance(myAddress);
            maticBalance = bal ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(bal)).toFixed(2) : (Number(bal)/1e18).toFixed(2)) : '0.00';
          } catch (e) {
            maticBalance = '0.00';
          }
        }
        document.getElementById('matic-balance').textContent = maticBalance;
        // Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM
        let IAMBalance = '...';
        if (isConnected && contract && myAddress && typeof contract.balanceOf === 'function') {
          try {
            let IAM = await contract.balanceOf(myAddress);
            IAMBalance = IAM ? (typeof ethers !== 'undefined' ? Number(ethers.formatEther(IAM)).toFixed(2) : (Number(IAM)/1e18).toFixed(2)) : '0.00';
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ
            const IAMBalanceElement = document.getElementById('IAM-balance');
            try {
              let tokenPriceNum = 1; // Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 1 Ø¯Ù„Ø§Ø±
              if (typeof contract.getTokenPrice === 'function') {
                const tokenPrice = await contract.getTokenPrice();
                tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
              }
              const requiredIAM = (23 / tokenPriceNum).toFixed(2); // Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² IAM
              
              // Ø±Ù†Ú¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM
              if (parseFloat(IAMBalance) >= parseFloat(requiredIAM)) {
                IAMBalanceElement.style.color = '#00ff88'; // Ø³Ø¨Ø²: Ú©Ø§ÙÛŒ Ø§Ø³Øª
              } else {
                IAMBalanceElement.style.color = '#ff453a'; // Ù‚Ø±Ù…Ø²: Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª
              }
              
              // Ø±Ù†Ú¯ Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
              const registerCostElement = document.getElementById('register-cost');
              if (registerCostElement) {
                if (parseFloat(IAMBalance) >= parseFloat(requiredIAM)) {
                  registerCostElement.style.color = '#00ff88'; // Ø³Ø¨Ø²: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø§Ø³Øª
                } else {
                  registerCostElement.style.color = '#ff453a'; // Ù‚Ø±Ù…Ø²: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª
                }
              }
            } catch (e) {
              console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©ÙØ§ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ:', e);
            }
          } catch (e) {
            IAMBalance = '0.00';
          }
        }
        document.getElementById('IAM-balance').textContent = IAMBalance;
      } catch (e) {
        isConnected = false;
        connStatus.textContent = 'âŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯: ' + (e.message || e);
        document.getElementById('register-info').style.display = 'none';
        document.getElementById('register-btn').disabled = true;
        document.querySelectorAll('input').forEach(i=>i.disabled=true);
      }
    }
         window.addEventListener('DOMContentLoaded', loadRegisterInfo);
     
     // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ú©ÛŒÙ Ù¾ÙˆÙ„
     if (window.ethereum) {
       window.ethereum.on('accountsChanged', async function (accounts) {
         console.log('ğŸ”„ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯:', accounts);
         if (accounts.length > 0) {
           window.currentUserAddress = accounts[0];
           await loadRegisterInfo(); // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
         }
       });
     }

         

    // --- Two-way mapping: index <-> address ---
    // indexInput Ùˆ refInput ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
         // ÙˆÙ‚ØªÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¢Ø¯Ø±Ø³ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù† Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø· Ø±ÙØ±Ø§Ù„
    indexInput.addEventListener('change', async function() {
       await checkIndexReferralLine();
     });
     
     // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ input Ùˆ paste
     indexInput.addEventListener('input', async function() {
       await checkIndexReferralLine();
     });
     
     indexInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkIndexReferralLine();
       }, 100);
     });
     

     
           // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø· Ø±ÙØ±Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³
      async function checkIndexReferralLine() {
        const index = indexInput.value.replace(/[^0-9]/g, '');
        if (!index) return;
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          
          // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø± Ø´Ø¨Ú©Ù‡
          console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index} Ø¯Ø± Ø´Ø¨Ú©Ù‡...`);
          let addr = null;
          try {
            addr = await contract.indexToAddress(index);
            console.log(`ğŸ“ Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index}:`, addr);
          } catch (e) {
            console.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index}:`, e);
            status.style.color = '#d32f2f';
            status.textContent = 'Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø´Ø¨Ú©Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            return;
          }
          
          // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª (Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯)
          if (!addr || addr === '0x0000000000000000000000000000000000000000') {
            status.style.color = '#d32f2f';
            status.textContent = 'Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø´Ø¨Ú©Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            return;
          }
          
          // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§ÛŒÙ† Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙØ¹Ø§Ù„ Ø§Ø³Øª
          try {
            const userAtAddress = await contract.users(addr);
            console.log(`ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index}:`, userAtAddress);
            
            if (!userAtAddress || !userAtAddress.activated) {
              status.style.color = '#d32f2f';
              status.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§ÛŒÙ† Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.';
              return;
            }
          } catch (e) {
            console.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±:`, e);
            status.style.color = '#d32f2f';
            status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±.';
            return;
          }
          
          // Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ
          let myAddress = null, currentUser = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
              currentUser = await contract.users(myAddress);
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                currentUser = await contract.users(myAddress);
                window.currentUserAddress = myAddress;
              }
            }
          } catch (e) {
            console.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:`, e);
          }
          
          console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ:`, currentUser);
          if (currentUser && currentUser.activated && currentUser.index) {
            const currentUserIndex = parseInt(currentUser.index);
            const targetIndex = parseInt(index);
            console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª: Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ=${currentUserIndex}, Ù‡Ø¯Ù=${targetIndex}`);
            
            if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
              status.style.color = '#d32f2f';
              status.textContent = `Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†ÛŒØ³ØªÛŒØ¯. ÙÙ‚Ø· Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.`;
              return;
            } else {
              status.style.color = '#388e3c';
              status.textContent = 'Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø¹Ø±Ù Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª Ùˆ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø´Ù…Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.';
              refInput.value = addr; // ØªÙ†Ø¸ÛŒÙ… Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù
            }
          } else {
            console.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø¯Ø§Ø±Ø¯:`, currentUser);
            status.style.color = '#d32f2f';
            status.textContent = `Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.`;
            return;
          }
          
        } catch (e) {
          const status = document.getElementById('status-message');
          status.style.color = '#d32f2f';
          status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³: ' + (e.message || e);
        }
      }
         // ÙˆÙ‚ØªÛŒ Ø¢Ø¯Ø±Ø³ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù† Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø· Ø±ÙØ±Ø§Ù„
     refInput.addEventListener('change', async function() {
       await checkReferralLine();
     });
     
     // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ input Ùˆ paste
     refInput.addEventListener('input', async function() {
       await checkReferralLine();
     });
     
     refInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkReferralLine();
       }, 100);
     });
     
           // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø· Ø±ÙØ±Ø§Ù„
      async function checkReferralLine() {
        const address = refInput.value.trim();
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) return;
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          const status = document.getElementById('status-message');
          
          // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¢Ø¯Ø±Ø³ Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
          console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¢Ø¯Ø±Ø³ ${address} Ø¯Ø± Ø´Ø¨Ú©Ù‡...`);
          let user = null;
          try {
            user = await contract.users(address);
            console.log(`ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¢Ø¯Ø±Ø³ ${address}:`, user);
          } catch (e) {
            console.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:`, e);
            status.style.color = '#d32f2f';
            status.textContent = 'Ø¢Ø¯Ø±Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¯Ø± Ø´Ø¨Ú©Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            return;
          }
          
          // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ø§Ø³Øª
          if (!user || !user.activated) {
            status.style.color = '#d32f2f';
            status.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            return;
          }
          
          // Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø§Ø±Ø¯
          if (!user.index) {
            status.style.color = '#d32f2f';
            status.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø¯Ø§Ø±Ø¯.';
            return;
          }
          
          // Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙ†Ø¸ÛŒÙ… Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø± ÙÛŒÙ„Ø¯ Ù…Ø±Ø¨ÙˆØ·Ù‡
          let IAMId = 'IAM' + user.index.toString().padStart(5, '0');
          indexInput.value = IAMId;
          indexInput.style.background = '';
          indexInput.style.color = '';
          indexInput.style.opacity = '';
          
          // Ù…Ø±Ø­Ù„Ù‡ 5: Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ
          let myAddress = null, currentUser = null;
          try {
            if (window.currentUserAddress) {
              myAddress = window.currentUserAddress;
              currentUser = await contract.users(myAddress);
            } else {
              myAddress = contract.signer ? await contract.signer.getAddress() : null;
              if (myAddress) {
                currentUser = await contract.users(myAddress);
                window.currentUserAddress = myAddress;
              }
            }
          } catch (e) {
            console.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ:`, e);
          }
          
          console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ:`, currentUser);
          if (currentUser && currentUser.activated && currentUser.index) {
            const currentUserIndex = parseInt(currentUser.index);
            const targetIndex = parseInt(user.index);
            console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ØµÙ„Ø§Ø­ÛŒØª: Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ=${currentUserIndex}, Ù‡Ø¯Ù=${targetIndex}`);
            
            if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
              status.style.color = '#d32f2f';
              status.textContent = `Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù†ÛŒØ³ØªÛŒØ¯. ÙÙ‚Ø· Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.`;
              return;
            } else {
              status.style.color = '#388e3c';
              status.textContent = 'Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª Ùˆ Ø¯Ø± Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø´Ù…Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.';
            }
          } else {
            console.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø¯Ø§Ø±Ø¯:`, currentUser);
            status.style.color = '#d32f2f';
            status.textContent = `Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.`;
            return;
          }
          
        } catch (e) {
          const status = document.getElementById('status-message');
          status.style.color = '#d32f2f';
          status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø¯Ø±Ø³: ' + (e.message || e);
        }
      }
     

     
     // ÙˆÙ‚ØªÛŒ Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†
     newUserInput.addEventListener('change', async function() {
       await checkNewUserAddress();
     });
     
     // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ input Ùˆ paste
     newUserInput.addEventListener('input', async function() {
       await checkNewUserAddress();
     });
     
     newUserInput.addEventListener('paste', async function() {
       setTimeout(async () => {
         await checkNewUserAddress();
       }, 100);
     });
     
           // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
      async function checkNewUserAddress() {
        const address = newUserInput.value.trim();
        const status = document.getElementById('status-message');
        
        // Ø§Ú¯Ø± Ø¢Ø¯Ø±Ø³ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
        if (!address) {
          status.textContent = '';
          return;
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª Ø¢Ø¯Ø±Ø³
        if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
          status.style.color = '#d32f2f';
          status.textContent = 'Ø¢Ø¯Ø±Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
          return;
        }
        
        try {
          if (!window.contractConfig || !window.contractConfig.contract) await window.connectWallet();
          const contract = window.contractConfig.contract;
          
          // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª
          const user = await contract.users(address);
          if (user && user.activated) {
            status.style.color = '#d32f2f';
            status.textContent = 'Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.';
            return;
          }
          
          // Ø§Ú¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡ØŒ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
          status.style.color = '#388e3c';
          status.textContent = 'Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø´ÙˆØ¯.';
          
          // Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
          try {
            // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³
            let foundIndex = null;
            for (let i = 1; i <= 1000; i++) { // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± 1000 Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§ÙˆÙ„
              try {
                const addrAtIndex = await contract.indexToAddress(i);
                if (addrAtIndex.toLowerCase() === address.toLowerCase()) {
                  foundIndex = i;
                  break;
                }
              } catch (e) {
                // Ø§Ú¯Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
                continue;
              }
            }
            
            if (foundIndex) {
              status.textContent += ` (Ø§ÛŒÙ†Ø¯Ú©Ø³: ${foundIndex})`;
            }
          } catch (e) {
            // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
          }
        } catch (e) {
          status.style.color = '#d32f2f';
          status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø¯Ø±Ø³: ' + (e.message || e);
        }
      }
      


    // Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
    document.getElementById('register-btn').onclick = async function() {
      const status = document.getElementById('status-message');
      if (!isConnected) {
        status.style.color = '#d32f2f';
        status.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.';
        return;
      }
      const referrer = refInput.value.trim();
      const newUser = document.getElementById('new-user-address').value.trim();
      const enteredIndexStr = indexInput.value.replace(/[^0-9]/g, '');
      const enteredIndex = enteredIndexStr ? parseInt(enteredIndexStr) : null;
      status.style.color = '#1976d2';
      status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ...';
      this.disabled = true;
      try {
        if (!/^0x[a-fA-F0-9]{40}$/.test(referrer)) throw new Error('Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        if (!/^0x[a-fA-F0-9]{40}$/.test(newUser)) throw new Error('Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        if (/^0x[a-fA-F0-9]{40}$/.test(referrer) && (!enteredIndexStr || indexInput.value === defaultGuide)) {
          throw new Error('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø¹Ø±Ù Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
        }
        if (!window.contractConfig || !window.contractConfig.contract) {
          await loadRegisterInfo();
        }
        const contract = window.contractConfig.contract;
        if (!contract) throw new Error('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                 let myAddress = null, user = null;
         try {
           // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
           if (window.currentUserAddress) {
             myAddress = window.currentUserAddress;
             user = await contract.users(myAddress);
           } else {
             myAddress = contract.signer ? await contract.signer.getAddress() : null;
             if (myAddress) {
               user = await contract.users(myAddress);
               window.currentUserAddress = myAddress;
             }
           }
         } catch (e) {
           console.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ:`, e);
         }
         
         console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ:`, user);
                 // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‡Ø¯Ù Ø¯Ø± Ø®Ø· Ø±ÙØ±Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯
         if (user && user.activated && user.index && enteredIndex !== null) {
           const currentUserIndex = parseInt(user.index);
           const targetIndex = parseInt(enteredIndex);
           console.log(`ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ: Ú©Ø§Ø±Ø¨Ø± Ø¬Ø§Ø±ÛŒ=${currentUserIndex}, Ù‡Ø¯Ù=${targetIndex}`);
           
           if (!isIndexInUserSubtree(targetIndex, currentUserIndex)) {
             throw new Error(`Ø´Ù…Ø§ ÙÙ‚Ø· Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø®ÙˆØ¯ Ù‡Ø³ØªÛŒØ¯.`);
           }
         } else {
           console.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ:`, user);
           throw new Error(`Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø¨ØªØ¯Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.`);
        }
        const addrFromIndex = await contract.indexToAddress(enteredIndex);
        if (addrFromIndex.toLowerCase() !== referrer.toLowerCase()) {
          throw new Error('Ø§ÛŒÙ†Ø¯Ú©Ø³ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªÙˆÚ©Ù† Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ
        const userBalance = await contract.balanceOf(myAddress);
        let tokenPriceNum = 1; // Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 1 Ø¯Ù„Ø§Ø±
        try {
          if (typeof contract.getTokenPrice === 'function') {
            const tokenPrice = await contract.getTokenPrice();
            tokenPriceNum = Number(ethers.formatUnits(tokenPrice, 18));
          }
        } catch (e) {
          console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªÙˆÚ©Ù†ØŒ Ø§Ø² Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯:', e);
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² (23 Ø¯Ù„Ø§Ø± / Ù‚ÛŒÙ…Øª Ù‡Ø± ØªÙˆÚ©Ù†)
        const requiredAmountFloat = 23 / tokenPriceNum;
        const requiredAmount = ethers.parseEther(requiredAmountFloat.toString());
        
        if (userBalance < requiredAmount) {
          const requiredFormatted = requiredAmountFloat.toFixed(2);
          const currentFormatted = Number(ethers.formatEther(userBalance)).toFixed(2);
          throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª. Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${requiredFormatted} IAMØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ${currentFormatted} IAM`);
        }
        
        status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡... Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø´ÛŒØ¯.';
        status.style.color = '#1976d2';
        localStorage.setItem('avatar_' + newUser, selectedAvatar);
        const tx = await contract.registerFree(referrer, newUser);
        status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´ ØªÙˆØ³Ø· Ø´Ø¨Ú©Ù‡...';
        await tx.wait();
        status.style.color = '#388e3c';
        status.textContent = 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯! Ø¨Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ IAM Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.';
        setTimeout(loadRegisterInfo, 1500);
      } catch (e) {
        status.style.color = '#d32f2f';
        let errorMsg = e && (e.reason || (e.revert && e.revert.args && e.revert.args[0]) || e.message || e);
        if (typeof errorMsg !== 'string') errorMsg = JSON.stringify(errorMsg);
        if (/already registered|Already registered/i.test(errorMsg)) {
          status.textContent = 'Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.';
        } else if (/not active|inactive|ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª/i.test(errorMsg)) {
          status.textContent = 'Ù…Ø¹Ø±Ù Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø¹Ø±Ù ÙØ¹Ø§Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
        } else if (/invalid referrer|referrer/i.test(errorMsg)) {
          status.textContent = 'Ø¢Ø¯Ø±Ø³ Ù…Ø¹Ø±Ù Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
        } else if (/insufficient|balance|Ù…ÙˆØ¬ÙˆØ¯ÛŒ/i.test(errorMsg)) {
          // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ Ú©Ù…Ø¨ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø² smart contract Ø¢Ù…Ø¯Ù‡ØŒ Ù‡Ù…Ø§Ù† Ù¾ÛŒØ§Ù… Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡
          if (errorMsg.includes('IAM Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª')) {
            status.textContent = errorMsg;
          } else {
            status.textContent = 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.';
          }
        } else if (/user rejected|reject|Ù„ØºÙˆ Ø´Ø¯/i.test(errorMsg)) {
          status.textContent = 'ÙØ±Ø¢ÛŒÙ†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ ØªÙˆØ³Ø· Ø´Ù…Ø§ Ù„ØºÙˆ Ø´Ø¯.';
        } else if (/execution reverted/i.test(errorMsg)) {
          const match = errorMsg.match(/reverted: "([^"]+)"/);
          if (match && match[1]) {
            status.textContent = 'Ø®Ø·Ø§: ' + match[1];
          } else {
            status.textContent = 'ØªØ±Ø§Ú©Ù†Ø´ ØªÙˆØ³Ø· Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù„ØºÙˆ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
          }
        } else {
          status.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø±Ø²Ø±Ùˆ: ' + (errorMsg.length > 120 ? errorMsg.slice(0,120)+'...' : errorMsg);
        }
      }
      this.disabled = false;
    };

    // Clear faded guide on focus for index input
    indexInput.addEventListener('focus', function() {
      if (this.value === defaultGuide) {
        this.value = '';
        this.style.background = '';
        this.style.color = '';
        this.style.opacity = '';
      }
    });
    indexInput.addEventListener('blur', function() {
      if (this.value.trim() === '') {
        this.value = defaultGuide;
        this.style.background = '#f3f3f3';
        this.style.color = '#888';
        this.style.opacity = '0.7';
        refInput.value = 'root';
      }
    });
  </script>
  
  <!-- Floating Token Growth Card - Ú©Ø§Ø±Øª Ø´Ù†Ø§ÙˆØ± Ø±Ø´Ø¯ ØªÙˆÚ©Ù† -->
  <script src="js/floating-token-card.js"></script>
</body>
</html>