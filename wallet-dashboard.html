<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆÙ„Øª Ø´Ø®ØµÛŒ - CPA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/index-custom.css">
    <link rel="stylesheet" href="css/smooth-transitions.css">
    
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ WalletConnect Provider -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ -->
    <script src="js/smooth-value-updater.js"></script>
    <script src="js/smart-dashboard-updater.js"></script>
    <script src="js/central-dashboard-updater.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/walletconnect-handler.js"></script>
    <script src="js/walletconnect-v1.8.0.js"></script>
</head>
<body>
    <div id="access-denied" style="display:none; text-align:center; padding:3rem; color:#ff6b6b;">
        <h2>ğŸ”’ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯</h2>
        <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ ÙˆÙ„Øª Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø³Øª.</p>
        <p style="color:#888; font-size:0.9rem; margin-top:1rem;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.</p>
        <button onclick="window.location.href='index.html'" style="background:#00ff88; color:#232946; padding:0.8rem 1.5rem; border:none; border-radius:8px; cursor:pointer; margin-top:1rem;">
            Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        </button>
        <button onclick="location.reload()" style="background:#a786ff; color:#fff; padding:0.8rem 1.5rem; border:none; border-radius:8px; cursor:pointer; margin-top:0.5rem; margin-left:0.5rem;">
            ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
        </button>
    </div>

    <div id="wallet-dashboard" style="display:none;">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#1a1f2e,#232946); padding:2rem; text-align:center; border-bottom:2px solid #00ff88;">
            <h1 style="color:#00ff88; margin:0; font-family:'Montserrat',sans-serif;">ğŸ” Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆÙ„Øª Ø´Ø®ØµÛŒ</h1>
            <p style="color:#b8c1ec; margin:0.5rem 0 0 0;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ØµÙˆØµÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§</p>
        </div>

        <!-- Wallet Info Section -->
        <div style="max-width:1200px; margin:2rem auto; padding:0 1rem;">
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #00ff88;">
                <h2 style="color:#00ff88; margin-bottom:1.5rem; text-align:center;">ğŸ‘› Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÙ„Øª</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem;">
                    <!-- Wallet Address -->
                    <div style="background:rgba(0,255,136,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(0,255,136,0.3);">
                        <h3 style="color:#00ff88; margin-bottom:1rem;">ğŸ“ Ø¢Ø¯Ø±Ø³ ÙˆÙ„Øª</h3>
                        <div style="background:rgba(0,0,0,0.3); padding:1rem; border-radius:8px; font-family:monospace; word-break:break-all; color:#fff;" id="wallet-address">
                            Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
                        </div>
                        <button onclick="copyToClipboard('wallet-address')" style="background:#00ff88; color:#232946; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; margin-top:0.5rem; font-size:0.9rem;">
                            ğŸ“‹ Ú©Ù¾ÛŒ Ø¢Ø¯Ø±Ø³
                        </button>
                    </div>

                    <!-- Network Info -->
                    <div style="background:rgba(167,134,255,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(167,134,255,0.3);">
                        <h3 style="color:#a786ff; margin-bottom:1rem;">ğŸŒ Ø´Ø¨Ú©Ù‡</h3>
                        <div style="color:#fff; font-size:1.1rem; font-weight:bold;" id="network-info">
                            Polygon
                        </div>
                        <div style="color:#888; font-size:0.9rem; margin-top:0.5rem;">
                            Chain ID: 137
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div style="background:rgba(40,167,69,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(40,167,69,0.3);">
                        <h3 style="color:#28a745; margin-bottom:1rem;">ğŸ”— ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„</h3>
                        <div style="color:#28a745; font-size:1.1rem; font-weight:bold;" id="connection-status">
                            Ù…ØªØµÙ„
                        </div>
                        <div style="color:#888; font-size:0.9rem; margin-top:0.5rem;">
                            Ú©ÛŒÙ Ù¾ÙˆÙ„ ÙØ¹Ø§Ù„
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Details -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #a786ff;">
                <h2 style="color:#a786ff; margin-bottom:1.5rem; text-align:center;">ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª Ø­Ø³Ø§Ø¨</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- Ø§ÛŒÙ†Ø¯Ú©Ø³ -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ†”</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ø§ÛŒÙ†Ø¯Ú©Ø³</div>
                        <div style="color:#00ff88; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="cpa-id">-</div>
                    </div>

                    <!-- Registration Date -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ“…</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</div>
                        <div style="color:#a786ff; font-size:1rem; font-weight:bold;" id="registration-date">-</div>
                    </div>

                    <!-- Level -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(255,193,7,0.2);">
                        <div style="color:#ffc107; font-size:1.2rem; margin-bottom:0.5rem;">â­</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ø³Ø·Ø­</div>
                        <div style="color:#ffc107; font-size:1.1rem; font-weight:bold;" id="user-level">-</div>
                    </div>

                    <!-- Points -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(220,53,69,0.2);">
                        <div style="color:#dc3545; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ¯</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ù¾ÙˆÛŒÙ†Øªâ€ŒÙ‡Ø§</div>
                        <div style="color:#dc3545; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="user-points">-</div>
                    </div>

                    <!-- Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,123,255,0.2);">
                        <div style="color:#007bff; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ’°</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ CPA</div>
                        <div style="color:#007bff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="user-balance">-</div>
                    </div>

                    <!-- Deposited Amount -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(138,43,226,0.2);">
                        <div style="color:#8a2be2; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ’</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ù…Ø¨Ù„Øº Ø³Ù¾Ø±Ø¯Ù‡</div>
                        <div style="color:#8a2be2; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="deposited-amount">-</div>
                    </div>
                </div>
            </div>

            <!-- Network Tree Info -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #00ccff;">
                <h2 style="color:#00ccff; margin-bottom:1.5rem; text-align:center;">ğŸŒ³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±Ø®Øª Ø´Ø¨Ú©Ù‡</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- Referrer -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,204,255,0.2);">
                        <div style="color:#00ccff; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ‘¤</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">Ù…Ø¹Ø±Ù</div>
                        <div style="color:#00ccff; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="referrer-address">-</div>
                    </div>

                    <!-- Left Child -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">â¬…ï¸</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ÙØ±Ø²Ù†Ø¯ Ú†Ù¾</div>
                        <div style="color:#00ff88; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="left-child">-</div>
                    </div>

                    <!-- Right Child -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">â¡ï¸</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ÙØ±Ø²Ù†Ø¯ Ø±Ø§Ø³Øª</div>
                        <div style="color:#a786ff; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="right-child">-</div>
                    </div>

                    <!-- Is Active -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(40,167,69,0.2);">
                        <div style="color:#28a745; font-size:1.2rem; margin-bottom:0.5rem;">âœ…</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„</div>
                        <div style="color:#28a745; font-size:1.1rem; font-weight:bold;" id="is-active">-</div>
                    </div>
                </div>
            </div>

            <!-- Token Balances -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #ffc107;">
                <h2 style="color:#ffc107; margin-bottom:1.5rem; text-align:center;">ğŸ’ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- CPA Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">ğŸª™</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">CPA</div>
                        <div style="color:#00ff88; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="cpa-balance">-</div>
                        <div style="color:#a786ff; font-size:0.8rem; margin-top:0.3rem;" id="cpa-usd-value">-</div>
                    </div>

                    <!-- DAI Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,123,255,0.2);">
                        <div style="color:#007bff; font-size:1.2rem; margin-bottom:0.5rem;">ğŸ’µ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">DAI</div>
                        <div style="color:#007bff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="dai-balance">-</div>
                    </div>

                    <!-- MATIC Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">âš¡</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">MATIC</div>
                        <div style="color:#a786ff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="matic-balance">-</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #dc3545;">
                <h2 style="color:#dc3545; margin-bottom:1.5rem; text-align:center;">âš¡ Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                    <button onclick="refreshData()" style="background:linear-gradient(90deg,#00ff88,#00cc66); color:#232946; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                    </button>
                    
                    <button onclick="exportWalletData()" style="background:linear-gradient(90deg,#a786ff,#8a2be2); color:#fff; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ğŸ“Š ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    </button>
                    
                    <button onclick="window.open('index.html', '_blank')" style="background:linear-gradient(90deg,#ffc107,#ff8c00); color:#232946; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
                    </button>
                    
                    <button onclick="disconnectWallet()" style="background:linear-gradient(90deg,#dc3545,#c82333); color:#fff; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ğŸ”Œ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" style="display:flex; justify-content:center; align-items:center; height:100vh; color:#00ff88; font-size:1.2rem;">
        <div style="text-align:center;">
            <div style="margin-bottom:1rem;">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div style="color:#888; font-size:0.9rem;">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ ÙˆÙ„Øª</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Ø³Ø§ÛŒØ± Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
    <script src="js/firebase-config.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>

    <script>
        let currentWalletAddress = null;
        let contractConfig = null;

        // ØªØ§Ø¨Ø¹ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                const originalText = element.textContent;
                element.textContent = 'âœ… Ú©Ù¾ÛŒ Ø´Ø¯!';
                element.style.color = '#00ff88';
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.color = '#fff';
                }, 2000);
            }).catch(err => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†:', err);
            });
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        async function refreshData() {
            try {
                await loadWalletData();
                console.log('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:', error);
            }
        }

        // ØªØ§Ø¨Ø¹ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÙ„Øª
        function exportWalletData() {
            try {
                const walletData = {
                    address: currentWalletAddress,
                    timestamp: new Date().toISOString(),
                    network: 'Polygon',
                    chainId: 137,
                    data: {
                        cpaId: document.getElementById('cpa-id').textContent,
                        level: document.getElementById('user-level').textContent,
                        points: document.getElementById('user-points').textContent,
                        balance: document.getElementById('user-balance').textContent,
                        depositedAmount: document.getElementById('deposited-amount').textContent,
                        referrer: document.getElementById('referrer-address').textContent,
                        leftChild: document.getElementById('left-child').textContent,
                        rightChild: document.getElementById('right-child').textContent,
                        isActive: document.getElementById('is-active').textContent,
                        cpaBalance: document.getElementById('cpa-balance').textContent,
                        daiBalance: document.getElementById('dai-balance').textContent,
                        maticBalance: document.getElementById('matic-balance').textContent
                    }
                };

                const dataStr = JSON.stringify(walletData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wallet_data_${currentWalletAddress.slice(0, 10)}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÙ„Øª ØµØ§Ø¯Ø± Ø´Ø¯');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
            }
        }

        // ØªØ§Ø¨Ø¹ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„
        function disconnectWallet() {
            try {
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² localStorage
                localStorage.removeItem('walletAddress');
                localStorage.removeItem('walletData');
                
                // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
                window.location.href = 'index.html';
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„:', error);
            }
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÙ„Øª
        async function loadWalletData() {
            try {
                if (!contractConfig || !contractConfig.contract) {
                    throw new Error('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                }

                const contract = contractConfig.contract;
                const userData = await contract.users(currentWalletAddress);

                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø±Ù…
                const updates = [
                    { element: 'cpa-id', value: `CPA${userData.index.toString()}` },
                    { element: 'user-level', value: userData.level.toString() },
                    { element: 'user-points', value: userData.points.toString() },
                    { element: 'user-balance', value: ethers.formatEther(userData.balance) },
                    { element: 'deposited-amount', value: ethers.formatEther(userData.depositedAmount) },
                    { element: 'referrer-address', value: userData.referrer },
                    { element: 'left-child', value: userData.leftChild },
                    { element: 'right-child', value: userData.rightChild },
                    { element: 'is-active', value: userData.isActive ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„' }
                ];
                
                if (window.smartUpdateMultiple) {
                    const updatedCount = window.smartUpdateMultiple(updates);
                    if (updatedCount > 0) {
                        console.log(`ğŸ”„ ${updatedCount} Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± wallet dashboard Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯`);
                    }
                } else if (window.updateMultipleValuesSmoothly) {
                    window.updateMultipleValuesSmoothly(updates);
                } else {
                    // Fallback
                    updates.forEach(update => {
                        const el = document.getElementById(update.element);
                        if (el && el.textContent !== update.value) {
                            el.textContent = update.value;
                        }
                    });
                }

                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø¨Ø§ Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø±Ù…
                const cpaBalance = await contract.balanceOf(currentWalletAddress);
                const cpaAmount = Number(ethers.formatEther(cpaBalance));
                
                // ØªØ§Ø¨Ø¹ Ú©ÙˆØªØ§Ù‡ Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø²Ø±Ú¯
                function formatLargeNumber(num) {
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    } else {
                        return num.toFixed(2);
                    }
                }
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±ÛŒ CPA
                let cpaUsdValue = 0;
                try {
                    if (typeof contract.getTokenPrice === 'function') {
                        const tokenPriceRaw = await contract.getTokenPrice();
                        const tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                        cpaUsdValue = cpaAmount * tokenPrice;
                    }
                } catch (e) {
                    console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªÙˆÚ©Ù†:', e);
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ CPA (Ú©ÙˆØªØ§Ù‡ Ø´Ø¯Ù‡)
                const shortCpaAmount = formatLargeNumber(cpaAmount);
                if (window.smartUpdate) {
                    window.smartUpdate('cpa-balance', shortCpaAmount);
                } else if (window.updateValueSmoothly) {
                    window.updateValueSmoothly('cpa-balance', shortCpaAmount);
                } else {
                    const el = document.getElementById('cpa-balance');
                    if (el) {
                        el.textContent = shortCpaAmount;
                        el.title = cpaAmount.toLocaleString('en-US', {maximumFractionDigits: 4}) + ' CPA';
                    }
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±ÛŒ
                const usdEl = document.getElementById('cpa-usd-value');
                if (usdEl) {
                    usdEl.textContent = `â‰ˆ $${formatLargeNumber(cpaUsdValue)}`;
                }

                // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ DAI
                try {
                    if ((typeof window.DAI_ADDRESS !== 'undefined') && typeof window.DAI_ABI !== 'undefined') {
                        const daiContract = new ethers.Contract(window.DAI_ADDRESS, window.DAI_ABI, contractConfig.signer);
                        const daiBalance = await daiContract.balanceOf(currentWalletAddress);
                        if (window.smartUpdate) {
                            window.smartUpdate('dai-balance', ethers.formatUnits(daiBalance, 18));
                        } else if (window.updateValueSmoothly) {
                            window.updateValueSmoothly('dai-balance', ethers.formatUnits(daiBalance, 18));
                        } else {
                            const el = document.getElementById('dai-balance');
                            const newValue = ethers.formatUnits(daiBalance, 18);
                            if (el && el.textContent !== newValue) {
                                el.textContent = newValue;
                            }
                        }
                    } else {
                        document.getElementById('dai-balance').textContent = 'DAI Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª';
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ DAI:', error);
                    document.getElementById('dai-balance').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
                }

                // Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ MATIC
                try {
                    const maticBalance = await contractConfig.signer.getBalance(currentWalletAddress);
                    if (window.smartUpdate) {
                        window.smartUpdate('matic-balance', ethers.formatEther(maticBalance));
                    } else if (window.updateValueSmoothly) {
                        window.updateValueSmoothly('matic-balance', ethers.formatEther(maticBalance));
                    } else {
                        const el = document.getElementById('matic-balance');
                        const newValue = ethers.formatEther(maticBalance);
                        if (el && el.textContent !== newValue) {
                            el.textContent = newValue;
                        }
                    }
                } catch (error) {
                    document.getElementById('matic-balance').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
                }

                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (ØªÙ‚Ø±ÛŒØ¨ÛŒ)
                const registrationDate = new Date();
                registrationDate.setDate(registrationDate.getDate() - Math.floor(Math.random() * 365)); // ØªÙ‚Ø±ÛŒØ¨ÛŒ
                document.getElementById('registration-date').textContent = registrationDate.toLocaleDateString('fa-IR');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÙ„Øª:', error);
                throw error;
            }
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
        async function checkWalletAccess() {
            try {
                console.log('ğŸ” Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆÙ„Øª...');
                
                // Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§
                let attempts = 0;
                const maxAttempts = 10;
                
                while (attempts < maxAttempts) {
                    if (typeof window.connectWallet === 'function') {
                        console.log('âœ… ØªØ§Ø¨Ø¹ connectWallet Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª');
                        break;
                    }
                    console.log(`â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§... (${attempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof window.connectWallet !== 'function') {
                    console.error('âŒ ØªØ§Ø¨Ø¹ connectWallet Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª');
                    throw new Error('Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯');
                }
                
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„
                try {
                    contractConfig = await window.connectWallet();
                    currentWalletAddress = contractConfig.address;
                    console.log('âœ… Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯:', currentWalletAddress);
                } catch (connectError) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„:', connectError);
                    throw new Error('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
                }

                if (!currentWalletAddress) {
                    console.error('âŒ Ø¢Ø¯Ø±Ø³ ÙˆÙ„Øª ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    throw new Error('Ø¢Ø¯Ø±Ø³ ÙˆÙ„Øª ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª
                try {
                    const userData = await contractConfig.contract.users(currentWalletAddress);
                    if (userData.index.toString() === '0') {
                        throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    console.log('âœ… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª');
                } catch (error) {
                    console.error('âŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡:', error);
                    throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                }

                // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                document.getElementById('loading').style.display = 'none';
                document.getElementById('wallet-dashboard').style.display = 'block';
                
                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ø¯Ø±Ø³ ÙˆÙ„Øª
                document.getElementById('wallet-address').textContent = currentWalletAddress;
                
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                await loadWalletData();
                
                console.log('âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆÙ„Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯');

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ:', error);
                
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                try {
                    console.log('ğŸ”„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡...');
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø­Ø¯ÙˆØ¯
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('wallet-dashboard').style.display = 'block';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background:rgba(220,53,69,0.1); border:1px solid rgba(220,53,69,0.3); border-radius:8px; padding:1rem; margin:1rem; color:#dc3545; text-align:center;';
                    errorDiv.innerHTML = `
                        <h3>âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</h3>
                        <p>${error.message}</p>
                        <p style="color:#888; font-size:0.9rem;">Ø¨Ø±Ø®ÛŒ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯.</p>
                        <button onclick="location.reload()" style="background:#00ff88; color:#232946; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; margin-top:0.5rem;">
                            ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                        </button>
                    `;
                    document.getElementById('wallet-dashboard').insertBefore(errorDiv, document.getElementById('wallet-dashboard').firstChild);
                    
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
                    const fields = ['cpa-id', 'user-level', 'user-points', 'user-balance', 'deposited-amount', 
                                   'referrer-address', 'left-child', 'right-child', 'is-active', 
                                   'cpa-balance', 'dai-balance', 'matic-balance'];
                    fields.forEach(field => {
                        const element = document.getElementById(field);
                        if (element) {
                            element.textContent = 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ØªØµØ§Ù„';
                        }
                    });
                    
                    console.log('âœ… Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
                    
                } catch (fallbackError) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡:', fallbackError);
                    
                    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('access-denied').style.display = 'block';
                }
            }
        }

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ØµÙØ­Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙˆÙ„Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            
            // Ø§Ù†ØªØ¸Ø§Ø± Ú©Ù…ØªØ± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§
            setTimeout(() => {
                console.log('â³ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ...');
                checkWalletAccess();
            }, 1000);
        });
    </script>
    
    <!-- Floating Token Growth Card - Ú©Ø§Ø±Øª Ø´Ù†Ø§ÙˆØ± Ø±Ø´Ø¯ ØªÙˆÚ©Ù† -->
    <script src="js/floating-token-card.js"></script>
  <script src="js/navbar.js"></script>
</body>
</html> 