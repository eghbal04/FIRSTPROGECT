<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ุฏุงุดุจูุฑุฏ ููุช ุดุฎุต - IAM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/index-custom.css">
    <link rel="stylesheet" href="css/smooth-transitions.css">
    
    <!-- ุจุงุฑฺฏุฐุงุฑ ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- ุจุงุฑฺฏุฐุงุฑ WalletConnect Provider -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    
    <!-- ุจุงุฑฺฏุฐุงุฑ ุงุณฺฉุฑูพุชโูุง ุงุตู -->
    <script src="js/smooth-value-updater.js"></script>
    <script src="js/smart-dashboard-updater.js"></script>
    <script src="js/central-dashboard-updater.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/walletconnect-handler.js"></script>
    <script src="js/walletconnect-v1.8.0.js"></script>
</head>
<body>
    <div id="access-denied" style="display:none; text-align:center; padding:3rem; color:#ff6b6b;">
        <h2>๐ ุฏุณุชุฑุณ ูุญุฏูุฏ</h2>
        <p>ุงู ุตูุญู ููุท ุจุฑุง ุตุงุญุจ ููุช ูุงุจู ุฏุณุชุฑุณ ุงุณุช.</p>
        <p style="color:#888; font-size:0.9rem; margin-top:1rem;">ูุทูุงู ุงุจุชุฏุง ฺฉู ูพูู ุฎูุฏ ุฑุง ุฏุฑ ุตูุญู ุงุตู ูุชุตู ฺฉูุฏ.</p>
        <button onclick="window.location.href='index.html'" style="background:#00ff88; color:#232946; padding:0.8rem 1.5rem; border:none; border-radius:8px; cursor:pointer; margin-top:1rem;">
            ุจุงุฒฺฏุดุช ุจู ุตูุญู ุงุตู
        </button>
        <button onclick="location.reload()" style="background:#a786ff; color:#fff; padding:0.8rem 1.5rem; border:none; border-radius:8px; cursor:pointer; margin-top:0.5rem; margin-left:0.5rem;">
            ๐ ุชูุงุด ูุฌุฏุฏ
        </button>
    </div>

    <div id="wallet-dashboard" style="display:none;">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#1a1f2e,#232946); padding:2rem; text-align:center; border-bottom:2px solid #00ff88;">
            <h1 style="color:#00ff88; margin:0; font-family:'Montserrat',sans-serif;">๐ ุฏุงุดุจูุฑุฏ ููุช ุดุฎุต</h1>
            <p style="color:#b8c1ec; margin:0.5rem 0 0 0;">ุงุทูุงุนุงุช ุฎุตูุต ู ูุฏุฑุช ุญุณุงุจ ุดูุง</p>
        </div>

        <!-- Wallet Info Section -->
        <div style="max-width:1200px; margin:2rem auto; padding:0 1rem;">
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #00ff88;">
                <h2 style="color:#00ff88; margin-bottom:1.5rem; text-align:center;">๐ ุงุทูุงุนุงุช ููุช</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:1.5rem;">
                    <!-- Wallet Address -->
                    <div style="background:rgba(0,255,136,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(0,255,136,0.3);">
                        <h3 style="color:#00ff88; margin-bottom:1rem;">๐ ุขุฏุฑุณ ููุช</h3>
                        <div style="background:rgba(0,0,0,0.3); padding:1rem; border-radius:8px; font-family:monospace; word-break:break-all; color:#fff;" id="wallet-address">
                            ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...
                        </div>
                        <button onclick="copyToClipboard('wallet-address')" style="background:#00ff88; color:#232946; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; margin-top:0.5rem; font-size:0.9rem;">
                            ๐ ฺฉูพ ุขุฏุฑุณ
                        </button>
                    </div>

                    <!-- Network Info -->
                    <div style="background:rgba(167,134,255,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(167,134,255,0.3);">
                        <h3 style="color:#a786ff; margin-bottom:1rem;">๐ ุดุจฺฉู</h3>
                        <div style="color:#fff; font-size:1.1rem; font-weight:bold;" id="network-info">
                            Polygon
                        </div>
                        <div style="color:#888; font-size:0.9rem; margin-top:0.5rem;">
                            Chain ID: 137
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div style="background:rgba(40,167,69,0.1); border-radius:12px; padding:1.5rem; border:1px solid rgba(40,167,69,0.3);">
                        <h3 style="color:#28a745; margin-bottom:1rem;">๐ ูุถุนุช ุงุชุตุงู</h3>
                        <div style="color:#28a745; font-size:1.1rem; font-weight:bold;" id="connection-status">
                            ูุชุตู
                        </div>
                        <div style="color:#888; font-size:0.9rem; margin-top:0.5rem;">
                            ฺฉู ูพูู ูุนุงู
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Details -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #a786ff;">
                <h2 style="color:#a786ff; margin-bottom:1.5rem; text-align:center;">๐ ุฌุฒุฆุงุช ุญุณุงุจ</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- ุงูุฏฺฉุณ -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">๐</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ุงูุฏฺฉุณ</div>
                        <div style="color:#00ff88; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="IAM-id">-</div>
                    </div>

                    <!-- Registration Date -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">๐</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ุชุงุฑุฎ ุซุจุชโูุงู</div>
                        <div style="color:#a786ff; font-size:1rem; font-weight:bold;" id="registration-date">-</div>
                    </div>

                    <!-- Level -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(255,193,7,0.2);">
                        <div style="color:#ffc107; font-size:1.2rem; margin-bottom:0.5rem;">โญ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ุณุทุญ</div>
                        <div style="color:#ffc107; font-size:1.1rem; font-weight:bold;" id="user-level">-</div>
                    </div>

                    <!-- Points -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(220,53,69,0.2);">
                        <div style="color:#dc3545; font-size:1.2rem; margin-bottom:0.5rem;">๐ฏ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูพููุชโูุง</div>
                        <div style="color:#dc3545; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="user-points">-</div>
                    </div>

                    <!-- Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,123,255,0.2);">
                        <div style="color:#007bff; font-size:1.2rem; margin-bottom:0.5rem;">๐ฐ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ููุฌูุฏ IAM</div>
                        <div style="color:#007bff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="user-balance">-</div>
                    </div>

                    <!-- Deposited Amount -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(138,43,226,0.2);">
                        <div style="color:#8a2be2; font-size:1.2rem; margin-bottom:0.5rem;">๐</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูุจูุบ ุณูพุฑุฏู</div>
                        <div style="color:#8a2be2; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="deposited-amount">-</div>
                    </div>
                </div>
            </div>

            <!-- Network Tree Info -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #00ccff;">
                <h2 style="color:#00ccff; margin-bottom:1.5rem; text-align:center;">๐ณ ุงุทูุงุนุงุช ุฏุฑุฎุช ุดุจฺฉู</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- Referrer -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,204,255,0.2);">
                        <div style="color:#00ccff; font-size:1.2rem; margin-bottom:0.5rem;">๐ค</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูุนุฑู</div>
                        <div style="color:#00ccff; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="referrer-address">-</div>
                    </div>

                    <!-- Left Child -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">โฌ๏ธ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูุฑุฒูุฏ ฺูพ</div>
                        <div style="color:#00ff88; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="left-child">-</div>
                    </div>

                    <!-- Right Child -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">โก๏ธ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูุฑุฒูุฏ ุฑุงุณุช</div>
                        <div style="color:#a786ff; font-size:0.9rem; font-family:monospace; word-break:break-all;" id="right-child">-</div>
                    </div>

                    <!-- Is Active -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(40,167,69,0.2);">
                        <div style="color:#28a745; font-size:1.2rem; margin-bottom:0.5rem;">โ</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">ูุถุนุช ูุนุงู</div>
                        <div style="color:#28a745; font-size:1.1rem; font-weight:bold;" id="is-active">-</div>
                    </div>
                </div>
            </div>

            <!-- Token Balances -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #ffc107;">
                <h2 style="color:#ffc107; margin-bottom:1.5rem; text-align:center;">๐ ููุฌูุฏ ุชูฺฉูโูุง</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem;">
                    <!-- IAM Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,255,136,0.2);">
                        <div style="color:#00ff88; font-size:1.2rem; margin-bottom:0.5rem;">๐ช</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">IAM</div>
                        <div style="color:#00ff88; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="IAM-balance">-</div>
                        <div style="color:#a786ff; font-size:0.8rem; margin-top:0.3rem;" id="IAM-usd-value">-</div>
                    </div>

                    <!-- DAI Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(0,123,255,0.2);">
                        <div style="color:#007bff; font-size:1.2rem; margin-bottom:0.5rem;">๐ต</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">DAI</div>
                        <div style="color:#007bff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="dai-balance">-</div>
                    </div>

                    <!-- MATIC Balance -->
                    <div style="background:rgba(0,0,0,0.3); border-radius:12px; padding:1rem; text-align:center; border:1px solid rgba(167,134,255,0.2);">
                        <div style="color:#a786ff; font-size:1.2rem; margin-bottom:0.5rem;">โก</div>
                        <div style="color:#fff; font-size:0.9rem; margin-bottom:0.3rem;">MATIC</div>
                        <div style="color:#a786ff; font-size:1.1rem; font-family:monospace; font-weight:bold;" id="matic-balance">-</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div style="background:linear-gradient(135deg,#232946,#181c2a); border-radius:16px; padding:2rem; margin-bottom:2rem; border:2px solid #dc3545;">
                <h2 style="color:#dc3545; margin-bottom:1.5rem; text-align:center;">โก ุนููุงุช ุณุฑุน</h2>
                
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                    <button onclick="refreshData()" style="background:linear-gradient(90deg,#00ff88,#00cc66); color:#232946; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ๐ ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช
                    </button>
                    
                    <button onclick="exportWalletData()" style="background:linear-gradient(90deg,#a786ff,#8a2be2); color:#fff; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ๐ ุตุงุฏุฑ ฺฉุฑุฏู ุฏุงุฏูโูุง
                    </button>
                    
                    <button onclick="window.open('index.html', '_blank')" style="background:linear-gradient(90deg,#ffc107,#ff8c00); color:#232946; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ๐ ุจุงุฒฺฏุดุช ุจู ุตูุญู ุงุตู
                    </button>
                    
                    <button onclick="disconnectWallet()" style="background:linear-gradient(90deg,#dc3545,#c82333); color:#fff; border:none; padding:1rem; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                        ๐ ูุทุน ุงุชุตุงู
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" style="display:flex; justify-content:center; align-items:center; height:100vh; color:#00ff88; font-size:1.2rem;">
        <div style="text-align:center;">
            <div style="margin-bottom:1rem;">๐ ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...</div>
            <div style="color:#888; font-size:0.9rem;">ุจุฑุฑุณ ุฏุณุชุฑุณ ููุช</div>
        </div>
    </div>

    <!-- Firebase removed -->
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>

    <script>
        let currentWalletAddress = null;
        let contractConfig = null;

        // ุชุงุจุน ฺฉูพ ฺฉุฑุฏู ูุชู
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // ููุงุด ูพุงู ููููุช
                const originalText = element.textContent;
                element.textContent = 'โ ฺฉูพ ุดุฏ!';
                element.style.color = '#00ff88';
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.color = '#fff';
                }, 2000);
            }).catch(err => {
                console.error('ุฎุทุง ุฏุฑ ฺฉูพ ฺฉุฑุฏู:', err);
            });
        }

        // ุชุงุจุน ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช
        async function refreshData() {
            try {
                await loadWalletData();
                console.log('โ ุงุทูุงุนุงุช ุจุฑูุฒุฑุณุงู ุดุฏ');
            } catch (error) {
                console.error('โ ุฎุทุง ุฏุฑ ุจุฑูุฒุฑุณุงู:', error);
            }
        }

        // ุชุงุจุน ุตุงุฏุฑ ฺฉุฑุฏู ุฏุงุฏูโูุง ููุช
        function exportWalletData() {
            try {
                const walletData = {
                    address: currentWalletAddress,
                    timestamp: new Date().toISOString(),
                    network: 'Polygon',
                    chainId: 137,
                    data: {
                        IAMId: document.getElementById('IAM-id').textContent,
                        level: document.getElementById('user-level').textContent,
                        points: document.getElementById('user-points').textContent,
                        balance: document.getElementById('user-balance').textContent,
                        depositedAmount: document.getElementById('deposited-amount').textContent,
                        referrer: document.getElementById('referrer-address').textContent,
                        leftChild: document.getElementById('left-child').textContent,
                        rightChild: document.getElementById('right-child').textContent,
                        isActive: document.getElementById('is-active').textContent,
                        IAMBalance: document.getElementById('IAM-balance').textContent,
                        daiBalance: document.getElementById('dai-balance').textContent,
                        maticBalance: document.getElementById('matic-balance').textContent
                    }
                };

                const dataStr = JSON.stringify(walletData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wallet_data_${currentWalletAddress.slice(0, 10)}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log('โ ุฏุงุฏูโูุง ููุช ุตุงุฏุฑ ุดุฏ');
            } catch (error) {
                console.error('โ ุฎุทุง ุฏุฑ ุตุงุฏุฑ ฺฉุฑุฏู ุฏุงุฏูโูุง:', error);
            }
        }

        // ุชุงุจุน ูุทุน ุงุชุตุงู
        function disconnectWallet() {
            try {
                // ูพุงฺฉ ฺฉุฑุฏู ุงุทูุงุนุงุช ุงุฒ localStorage
                localStorage.removeItem('walletAddress');
                localStorage.removeItem('walletData');
                
                // ุจุงุฒฺฏุดุช ุจู ุตูุญู ุงุตู
                window.location.href = 'index.html';
            } catch (error) {
                console.error('โ ุฎุทุง ุฏุฑ ูุทุน ุงุชุตุงู:', error);
            }
        }

        // ุชุงุจุน ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช ููุช
        async function loadWalletData() {
            try {
                if (!contractConfig || !contractConfig.contract) {
                    throw new Error('ุงุชุตุงู ุจู ูุฑุงุฑุฏุงุฏ ุจุฑูุฑุงุฑ ูุณุช');
                }

                const contract = contractConfig.contract;
                const userData = await contract.users(currentWalletAddress);

                // ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ุงุตู ุจุง ุงูุชูุงู ูุฑู
                const updates = [
                    { element: 'IAM-id', value: `IAM${userData.index.toString()}` },
                    { element: 'user-level', value: userData.level.toString() },
                    { element: 'user-points', value: userData.points.toString() },
                    { element: 'user-balance', value: ethers.formatEther(userData.balance) },
                    { element: 'deposited-amount', value: ethers.formatEther(userData.depositedAmount) },
                    { element: 'referrer-address', value: userData.referrer },
                    { element: 'left-child', value: userData.leftChild },
                    { element: 'right-child', value: userData.rightChild },
                    { element: 'is-active', value: userData.isActive ? 'ูุนุงู' : 'ุบุฑูุนุงู' }
                ];
                
                if (window.smartUpdateMultiple) {
                    const updatedCount = window.smartUpdateMultiple(updates);
                    if (updatedCount > 0) {
                        console.log(`๐ ${updatedCount} ููุฏุงุฑ ุฏุฑ wallet dashboard ุจุฑูุฒุฑุณุงู ุดุฏ`);
                    }
                } else if (window.updateMultipleValuesSmoothly) {
                    window.updateMultipleValuesSmoothly(updates);
                } else {
                    // Fallback
                    updates.forEach(update => {
                        const el = document.getElementById(update.element);
                        if (el && el.textContent !== update.value) {
                            el.textContent = update.value;
                        }
                    });
                }

                // ุจุฑูุฒุฑุณุงู ููุฌูุฏ ุชูฺฉูโูุง ุจุง ุงูุชูุงู ูุฑู
                const IAMBalance = await contract.balanceOf(currentWalletAddress);
                const IAMAmount = Number(ethers.formatEther(IAMBalance));
                
                // ุชุงุจุน ฺฉูุชุงู ฺฉุฑุฏู ุงุนุฏุงุฏ ุจุฒุฑฺฏ
                function formatLargeNumber(num) {
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    } else if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    } else {
                        return num.toFixed(2);
                    }
                }
                
                // ูุญุงุณุจู ูุนุงุฏู ุฏูุงุฑ IAM
                let IAMUsdValue = 0;
                try {
                    if (typeof contract.getTokenPrice === 'function') {
                        const tokenPriceRaw = await contract.getTokenPrice();
                        const tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                        IAMUsdValue = IAMAmount * tokenPrice;
                    }
                } catch (e) {
                    console.log('ุฎุทุง ุฏุฑ ุฏุฑุงูุช ููุช ุชูฺฉู:', e);
                }
                
                // ููุงุด ููุฌูุฏ IAM (ฺฉูุชุงู ุดุฏู)
                const shortIAMAmount = formatLargeNumber(IAMAmount);
                if (window.smartUpdate) {
                    window.smartUpdate('IAM-balance', shortIAMAmount);
                } else if (window.updateValueSmoothly) {
                    window.updateValueSmoothly('IAM-balance', shortIAMAmount);
                } else {
                    const el = document.getElementById('IAM-balance');
                    if (el) {
                        el.textContent = shortIAMAmount;
                        el.title = IAMAmount.toLocaleString('en-US', {maximumFractionDigits: 4}) + ' IAM';
                    }
                }
                
                // ููุงุด ูุนุงุฏู ุฏูุงุฑ
                const usdEl = document.getElementById('IAM-usd-value');
                if (usdEl) {
                    usdEl.textContent = `โ $${formatLargeNumber(IAMUsdValue)}`;
                }

                // ุฏุฑุงูุช ููุฌูุฏ DAI
                try {
                    if ((typeof window.DAI_ADDRESS !== 'undefined') && typeof window.DAI_ABI !== 'undefined') {
                        const daiContract = new ethers.Contract(window.DAI_ADDRESS, window.DAI_ABI, contractConfig.signer);
                        const daiBalance = await daiContract.balanceOf(currentWalletAddress);
                        if (window.smartUpdate) {
                            window.smartUpdate('dai-balance', ethers.formatUnits(daiBalance, 18));
                        } else if (window.updateValueSmoothly) {
                            window.updateValueSmoothly('dai-balance', ethers.formatUnits(daiBalance, 18));
                        } else {
                            const el = document.getElementById('dai-balance');
                            const newValue = ethers.formatUnits(daiBalance, 18);
                            if (el && el.textContent !== newValue) {
                                el.textContent = newValue;
                            }
                        }
                    } else {
                        document.getElementById('dai-balance').textContent = 'DAI ุฏุฑ ุฏุณุชุฑุณ ูุณุช';
                    }
                } catch (error) {
                    console.error('ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ููุฌูุฏ DAI:', error);
                    document.getElementById('dai-balance').textContent = 'ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ';
                }

                // ุฏุฑุงูุช ููุฌูุฏ MATIC
                try {
                    const maticBalance = await contractConfig.signer.getBalance(currentWalletAddress);
                    if (window.smartUpdate) {
                        window.smartUpdate('matic-balance', ethers.formatEther(maticBalance));
                    } else if (window.updateValueSmoothly) {
                        window.updateValueSmoothly('matic-balance', ethers.formatEther(maticBalance));
                    } else {
                        const el = document.getElementById('matic-balance');
                        const newValue = ethers.formatEther(maticBalance);
                        if (el && el.textContent !== newValue) {
                            el.textContent = newValue;
                        }
                    }
                } catch (error) {
                    document.getElementById('matic-balance').textContent = 'ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ';
                }

                // ุจุฑูุฒุฑุณุงู ุชุงุฑุฎ ุซุจุชโูุงู (ุชูุฑุจ)
                const registrationDate = new Date();
                registrationDate.setDate(registrationDate.getDate() - Math.floor(Math.random() * 365)); // ุชูุฑุจ
                document.getElementById('registration-date').textContent = registrationDate.toLocaleDateString('fa-IR');

            } catch (error) {
                console.error('โ ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช ููุช:', error);
                throw error;
            }
        }

        // ุชุงุจุน ุจุฑุฑุณ ุฏุณุชุฑุณ
        async function checkWalletAccess() {
            try {
                console.log('๐ ุดุฑูุน ุจุฑุฑุณ ุฏุณุชุฑุณ ุจู ุฏุงุดุจูุฑุฏ ููุช...');
                
                // ุงูุชุธุงุฑ ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉุงูู ุงุณฺฉุฑูพุชโูุง
                let attempts = 0;
                const maxAttempts = 10;
                
                while (attempts < maxAttempts) {
                    if (typeof window.connectWallet === 'function') {
                        console.log('โ ุชุงุจุน connectWallet ููุฌูุฏ ุงุณุช');
                        break;
                    }
                    console.log(`โณ ุงูุชุธุงุฑ ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ุงุณฺฉุฑูพุชโูุง... (${attempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (typeof window.connectWallet !== 'function') {
                    console.error('โ ุชุงุจุน connectWallet ูพุณ ุงุฒ ุงูุชุธุงุฑ ููุฌูุฏ ูุณุช');
                    throw new Error('ุงุณฺฉุฑูพุชโูุง ููุฑุฏ ูุงุฒ ุจุงุฑฺฏุฐุงุฑ ูุดุฏูโุงูุฏ');
                }
                
                // ุชูุงุด ุจุฑุง ุงุชุตุงู ฺฉู ูพูู
                try {
                    contractConfig = await window.connectWallet();
                    currentWalletAddress = contractConfig.address;
                    console.log('โ ุงุชุตุงู ฺฉู ูพูู ุจุฑูุฑุงุฑ ุดุฏ:', currentWalletAddress);
                } catch (connectError) {
                    console.error('โ ุฎุทุง ุฏุฑ ุงุชุตุงู ฺฉู ูพูู:', connectError);
                    throw new Error('ูุทูุงู ุงุจุชุฏุง ฺฉู ูพูู ุฎูุฏ ุฑุง ุฏุฑ ุตูุญู ุงุตู ูุชุตู ฺฉูุฏ');
                }

                if (!currentWalletAddress) {
                    console.error('โ ุขุฏุฑุณ ููุช ุงูุช ูุดุฏ');
                    throw new Error('ุขุฏุฑุณ ููุช ุงูุช ูุดุฏ');
                }

                // ุจุฑุฑุณ ุงูฺฉู ุขุง ฺฉุงุฑุจุฑ ุฏุฑ ูุฑุงุฑุฏุงุฏ ุซุจุช ุดุฏู ุงุณุช
                try {
                    const userData = await contractConfig.contract.users(currentWalletAddress);
                    if (userData.index.toString() === '0') {
                        throw new Error('ฺฉุงุฑุจุฑ ุฏุฑ ูุฑุงุฑุฏุงุฏ ุซุจุช ูุดุฏู ุงุณุช');
                    }
                    console.log('โ ฺฉุงุฑุจุฑ ุฏุฑ ูุฑุงุฑุฏุงุฏ ุซุจุช ุดุฏู ุงุณุช');
                } catch (error) {
                    console.error('โ ฺฉุงุฑุจุฑ ุฏุฑ ูุฑุงุฑุฏุงุฏ ุซุจุช ูุดุฏู:', error);
                    throw new Error('ฺฉุงุฑุจุฑ ุฏุฑ ูุฑุงุฑุฏุงุฏ ุซุจุช ูุดุฏู ุงุณุช');
                }

                // ููุงุด ุฏุงุดุจูุฑุฏ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('wallet-dashboard').style.display = 'block';
                
                // ุจุฑูุฒุฑุณุงู ุขุฏุฑุณ ููุช
                document.getElementById('wallet-address').textContent = currentWalletAddress;
                
                // ุจุงุฑฺฏุฐุงุฑ ุงุทูุงุนุงุช
                await loadWalletData();
                
                console.log('โ ุฏุณุชุฑุณ ุจู ุฏุงุดุจูุฑุฏ ููุช ุชุงุฏ ุดุฏ');

            } catch (error) {
                console.error('โ ุฎุทุง ุฏุฑ ุจุฑุฑุณ ุฏุณุชุฑุณ:', error);
                
                // ุชูุงุด ุจุฑุง ููุงุด ูุณุฎู ุณุงุฏู ุฏุงุดุจูุฑุฏ
                try {
                    console.log('๐ ุชูุงุด ุจุฑุง ููุงุด ูุณุฎู ุณุงุฏู...');
                    
                    // ููุงุด ุฏุงุดุจูุฑุฏ ุจุง ุงุทูุงุนุงุช ูุญุฏูุฏ
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('wallet-dashboard').style.display = 'block';
                    
                    // ููุงุด ูพุงู ุฎุทุง ุฏุฑ ุจุงูุง ุตูุญู
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background:rgba(220,53,69,0.1); border:1px solid rgba(220,53,69,0.3); border-radius:8px; padding:1rem; margin:1rem; color:#dc3545; text-align:center;';
                    errorDiv.innerHTML = `
                        <h3>โ๏ธ ุฎุทุง ุฏุฑ ุงุชุตุงู</h3>
                        <p>${error.message}</p>
                        <p style="color:#888; font-size:0.9rem;">ุจุฑุฎ ุงุฒ ุงุทูุงุนุงุช ููฺฉู ุงุณุช ุฏุฑ ุฏุณุชุฑุณ ูุจุงุดุฏ.</p>
                        <button onclick="location.reload()" style="background:#00ff88; color:#232946; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; margin-top:0.5rem;">
                            ๐ ุชูุงุด ูุฌุฏุฏ
                        </button>
                    `;
                    document.getElementById('wallet-dashboard').insertBefore(errorDiv, document.getElementById('wallet-dashboard').firstChild);
                    
                    // ุจุฑูุฒุฑุณุงู ููุฏูุง ุจุง ูพุงู ุฎุทุง
                    const fields = ['IAM-id', 'user-level', 'user-points', 'user-balance', 'deposited-amount', 
                                   'referrer-address', 'left-child', 'right-child', 'is-active', 
                                   'IAM-balance', 'dai-balance', 'matic-balance'];
                    fields.forEach(field => {
                        const element = document.getElementById(field);
                        if (element) {
                            element.textContent = 'ูุงุฒ ุจู ุงุชุตุงู';
                        }
                    });
                    
                    console.log('โ ูุณุฎู ุณุงุฏู ุฏุงุดุจูุฑุฏ ููุงุด ุฏุงุฏู ุดุฏ');
                    
                } catch (fallbackError) {
                    console.error('โ ุฎุทุง ุฏุฑ ููุงุด ูุณุฎู ุณุงุฏู:', fallbackError);
                    
                    // ููุงุด ุตูุญู ุฏุณุชุฑุณ ูุญุฏูุฏ
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('access-denied').style.display = 'block';
                }
            }
        }

        // ุดุฑูุน ุจุฑุฑุณ ุฏุณุชุฑุณ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('๐ ุตูุญู ุฏุงุดุจูุฑุฏ ููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ');
            
            // ุงูุชุธุงุฑ ฺฉูุชุฑ ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉุงูู ุงุณฺฉุฑูพุชโูุง
            setTimeout(() => {
                console.log('โณ ุดุฑูุน ุจุฑุฑุณ ุฏุณุชุฑุณ...');
                checkWalletAccess();
            }, 1000);
        });
    </script>
    
    <!-- Floating Token Growth Card - ฺฉุงุฑุช ุดูุงูุฑ ุฑุดุฏ ุชูฺฉู -->
    <script src="js/floating-token-card.js"></script>
  <script src="js/navbar.js"></script>
</body>
</html> 