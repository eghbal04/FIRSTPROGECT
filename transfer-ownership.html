<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุงูุชูุงู ูุงูฺฉุช ูููุนุช</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/transfer-ownership.css?v=20250808-1">
</head>
<body class="transfer-ownership-page">
  <div class="transfer-ownership-container">
    <h2 class="page-title">ุงูุชูุงู ูุงูฺฉุช ูููุนุช</h2>
    <div class="subtext">ูุทูุงู ุขุฏุฑุณ ูุงูฺฉ ุฌุฏุฏ ุฑุง ุจุง ุฏูุช ูุงุฑุฏ ฺฉูุฏ</div>

    <div class="card balance-card">
      <b>๐ฐ ููุฌูุฏโูุง ุดูุง:</b><br>
      <div class="balance-grid">
        <span>๐ช CPA: <strong id="user-cpa-balance">-</strong></span>
        <span>๐ต DAI: <strong id="user-dai-balance">-</strong></span>
        <span>โก MATIC: <strong id="user-matic-balance">-</strong></span>
      </div>
    </div>

    <div class="card warning-card">
      <b>ูุดุฏุงุฑ ููู:</b><br>
      ุจุง ุงูุชูุงู ูุงูฺฉุชุ ุชูุงู ุฏุณุชุฑุณโูุง ู ฺฉูุชุฑู ุงู ูููุนุช ุจู ุขุฏุฑุณ ุฌุฏุฏ ููุชูู ูโุดูุฏ ู ุดูุง ุฏฺฏุฑ ูฺ ุฏุณุชุฑุณโุง ุจู ุงู ุงฺฉุงูุช ูุฎูุงูุฏ ุฏุงุดุช.<br>
      ุงู ุนููุงุช ุบุฑูุงุจู ุจุงุฒฺฏุดุช ุงุณุช. ูุทูุงู ูุจู ุงุฒ ุงูุฌุงูุ ุงุฒ ุตุญุช ุขุฏุฑุณ ููุตุฏ ุงุทููุงู ุญุงุตู ฺฉูุฏ.<br>
      <b>ุชูุตู:</b> ุขุฏุฑุณ ููุตุฏ ุฑุง ุจุง ุฏูุช ู ฺูุฏ ุจุงุฑ ุจุฑุฑุณ ฺฉูุฏ. ุฏุฑ ุตูุฑุช ุงุดุชุจุงูุ ุงูฺฉุงู ุจุงุฒฺฏุฑุฏุงู ูุฌูุฏ ูุฏุงุฑุฏ.
    </div>

    <div class="card tips-card">
      <b>๐ก ุฑุงูููุง ฺฉูพ ู ฺุณุจุงูุฏู:</b><br>
      โข ๐ ฺฉูพ ุขุฏุฑุณ ูุงุฑุฏ ุดุฏู ุง ุขุฏุฑุณ ูุนู ุดูุง<br>
      โข ๐ ฺุณุจุงูุฏู ุขุฏุฑุณ ุงุฒ ฺฉููพโุจุฑุฏ<br>
      โข ๐๏ธ ูพุงฺฉ ฺฉุฑุฏู ููุฏ ุขุฏุฑุณ<br>
      โข ๐ค ูพุฑ ฺฉุฑุฏู ุขุฏุฑุณ ูุนู ุดูุง<br>
      <small>ฺฉูุฏูุง ูุงูุจุฑ: Ctrl+C (ฺฉูพ)ุ Ctrl+V (ฺุณุจุงูุฏู)ุ Ctrl+X (ูพุงฺฉ ฺฉุฑุฏู)ุ Ctrl+F (ุขุฏุฑุณ ูุนู)</small>
    </div>

    <form id="transferOwnershipForm">
      <div class="form-group">
        <label for="newOwnerAddress">ุขุฏุฑุณ ูุงูฺฉ ุฌุฏุฏ</label>
        <div class="input-row">
          <input type="text" id="newOwnerAddress" class="text-input" placeholder="ูุซุงู: 0x..." autocomplete="off" required>
          <button type="button" id="copyAddressBtn" class="btn-icon" title="ฺฉูพ ุขุฏุฑุณ">๐</button>
          <button type="button" id="pasteAddressBtn" class="btn-icon" title="ฺุณุจุงูุฏู ุงุฒ ฺฉููพโุจุฑุฏ">๐</button>
          <button type="button" id="clearAddressBtn" class="btn-icon" title="ูพุงฺฉ ฺฉุฑุฏู">๐๏ธ</button>
          <button type="button" id="fillCurrentAddressBtn" class="btn-icon" title="ูพุฑ ฺฉุฑุฏู ุขุฏุฑุณ ูุนู">๐ค</button>
        </div>
        <div class="hint" id="addressHint"></div>
      </div>
      <button type="submit" id="transferOwnershipBtn" class="btn-primary" disabled>ุงูุชูุงู ูุงูฺฉุช</button>
      <div class="status" id="transferOwnershipStatus"></div>
    </form>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">ุชุงุฏ ุงูุชูุงู ูุงูฺฉุช</h3>
      <p>ูุงูฺฉุช ุงู ูููุนุช ุจู ุขุฏุฑุณ ุฒุฑ ููุชูู ูโุดูุฏ:</p>
      <p id="confirmAddressText" style="direction:ltr; text-align:right; font-family:monospace; font-weight:700;">-</p>
      <p class="modal-warning">ุงู ุนููุงุช ุบุฑูุงุจู ุจุงุฒฺฏุดุช ุงุณุช</p>
      <div class="form-group">
        <label for="confirmAddressInput">ุจุฑุง ุชุงุฏุ ุขุฏุฑุณ ููุตุฏ ุฑุง ูุฌุฏุฏุงู ูุงุฑุฏ ฺฉูุฏ</label>
        <input type="text" id="confirmAddressInput" class="text-input" placeholder="0x..." autocomplete="off">
        <div class="hint" id="confirmHint"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-outline" id="cancelConfirmBtn">ุงูุตุฑุงู</button>
        <button type="button" class="btn-danger" id="confirmTransferBtn">ุชุงุฏ ู ุงูุชูุงู</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="js/config.js"></script>
  <script>
    // ุชุงุจุน ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ุฎูุฏฺฉุงุฑ
    async function autoRefreshBalances() {
      try {
        if (!window.contractConfig || !window.contractConfig.contract || !window.contractConfig.signer) {
          return;
        }
        
        const userAddress = window.contractConfig.address;
        const contract = window.contractConfig.contract;
        const signer = window.contractConfig.signer;
        
        // ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ ุงุฒ ูุฑุงุฑุฏุงุฏ
        const user = await contract.users(userAddress);
        const userTree = await contract.getUserTree(userAddress);
        
        // ููุงุด ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ (ุงฺฏุฑ ุงููุงูโูุง ููุฌูุฏ ุจุงุดูุฏ)
        const updateElement = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        };
        
        // ุจุฑูุฒุฑุณุงู ููุฌูุฏโูุง
        try {
          // ููุฌูุฏ CPA
          const cpaBalance = await contract.balanceOf(userAddress);
          updateElement('user-cpa-balance', parseFloat(ethers.formatEther(cpaBalance)).toFixed(2) + ' CPA');
          
          // ููุฌูุฏ DAI
          const daiContract = new ethers.Contract(window.DAI_ADDRESS, window.DAI_ABI, signer);
          const daiBalance = await daiContract.balanceOf(userAddress);
          updateElement('user-dai-balance', parseFloat(ethers.formatUnits(daiBalance, 18)).toFixed(2) + ' DAI');
          
          // ููุฌูุฏ MATIC
          const maticBalance = await signer.provider.getBalance(userAddress);
          updateElement('user-matic-balance', parseFloat(ethers.formatEther(maticBalance)).toFixed(4) + ' MATIC');
          
        } catch (balanceError) {
          console.warn('ุฎุทุง ุฏุฑ ุจุฑูุฒุฑุณุงู ููุฌูุฏโูุง:', balanceError);
        }
        
        console.log('โ ุงุทูุงุนุงุช ุฎูุฏฺฉุงุฑ ุจุฑูุฒุฑุณุงู ุดุฏ');
      } catch (error) {
        console.warn('ุฎุทุง ุฏุฑ ุจุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ:', error);
      }
    }

    async function transferIndexOwnership(newOwner, statusEl, btn) {
      if (!window.contractConfig || !window.contractConfig.contract) {
        statusEl.textContent = 'โ ุงุชุตุงู ฺฉู ูพูู ุจุฑูุฑุงุฑ ูุณุช.';
        return;
      }
      if (!newOwner || !/^0x[a-fA-F0-9]{40}$/.test(newOwner)) {
        statusEl.textContent = 'โ ุขุฏุฑุณ ููุตุฏ ูุนุชุจุฑ ูุณุช.';
        return;
      }
      btn.disabled = true;
      statusEl.className = 'status loading';
      statusEl.textContent = 'โณ ุฏุฑ ุญุงู ุงูุชูุงู ูุงูฺฉุช...';
      try {
        const tx = await window.contractConfig.contract.transferIndexOwnership(newOwner);
        statusEl.className = 'status loading';
        statusEl.textContent = 'โณ ุฏุฑ ุงูุชุธุงุฑ ุชุงุฏ ุชุฑุงฺฉูุด ุฏุฑ ฺฉู ูพูู ุดูุง...';
        await tx.wait();
        statusEl.className = 'status success';
        statusEl.textContent = 'โ ุงูุชูุงู ูุงูฺฉุช ุจุง ููููุช ุงูุฌุงู ุดุฏ!';
        
        // ุจุฑูุฒุฑุณุงู ุงุทูุงุนุงุช ุจุนุฏ ุงุฒ ุงูุชูุงู ูููู
        setTimeout(autoRefreshBalances, 2000);
      } catch (error) {
        let msg = error && error.message ? error.message : error;
        statusEl.className = 'status error';
        if (error.code === 4001 || msg.includes('user denied')) {
          msg = 'โ ุชุฑุงฺฉูุด ุชูุณุท ฺฉุงุฑุจุฑ ูุบู ุดุฏ.';
        } else if (msg.includes('network')) {
          msg = 'โ ุฎุทุง ุดุจฺฉู! ุงุชุตุงู ุงูุชุฑูุช ุง ุดุจฺฉู ุจูุงฺฉฺู ุฑุง ุจุฑุฑุณ ฺฉูุฏ.';
        } else if (msg.includes('insufficient funds')) {
          msg = 'โ ููุฌูุฏ ฺฉุงู ุจุฑุง ูพุฑุฏุงุฎุช ฺฉุงุฑูุฒุฏ ูุฌูุฏ ูุฏุงุฑุฏ.';
        } else if (msg.includes('invalid address')) {
          msg = 'โ ุขุฏุฑุณ ููุตุฏ ูุงูุนุชุจุฑ ุงุณุช.';
        } else if (msg.includes('not allowed') || msg.includes('only owner')) {
          msg = 'โ ููุท ูุงูฺฉ ูุนู ูโุชูุงูุฏ ุงูุชูุงู ุงูุฌุงู ุฏูุฏ.';
        } else {
          msg = 'โ ุฎุทุง ุฏุฑ ุงูุชูุงู ูุงูฺฉุช: ' + msg;
        }
        statusEl.textContent = msg;
      } finally {
        btn.disabled = false;
      }
    }
    
    // ุชุงุจุน ฺฉูพ ฺฉุฑุฏู ุขุฏุฑุณ
    async function copyAddressToClipboard() {
      const addressInput = document.getElementById('newOwnerAddress');
      const address = addressInput.value.trim();
      
      if (!address) {
        // ุงฺฏุฑ ุขุฏุฑุณ ูุงุฑุฏ ูุดุฏูุ ุขุฏุฑุณ ูุนู ฺฉุงุฑุจุฑ ุฑุง ฺฉูพ ฺฉู
        if (window.contractConfig && window.contractConfig.address) {
          try {
            await navigator.clipboard.writeText(window.contractConfig.address);
            showCopyStatus('โ ุขุฏุฑุณ ูุนู ุดูุง ฺฉูพ ุดุฏ', 'success');
          } catch (error) {
            showCopyStatus('โ ุฎุทุง ุฏุฑ ฺฉูพ ฺฉุฑุฏู ุขุฏุฑุณ', 'error');
          }
        } else {
          showCopyStatus('โ ุขุฏุฑุณ ูุงุฑุฏ ูุดุฏู ู ุงุชุตุงู ฺฉู ูพูู ุจุฑูุฑุงุฑ ูุณุช', 'error');
        }
        return;
      }
      
      // ฺฉูพ ฺฉุฑุฏู ุขุฏุฑุณ ูุงุฑุฏ ุดุฏู
      try {
        await navigator.clipboard.writeText(address);
        showCopyStatus('โ ุขุฏุฑุณ ฺฉูพ ุดุฏ', 'success');
      } catch (error) {
        showCopyStatus('โ ุฎุทุง ุฏุฑ ฺฉูพ ฺฉุฑุฏู ุขุฏุฑุณ', 'error');
      }
    }
    
    // ุชุงุจุน ฺุณุจุงูุฏู ุขุฏุฑุณ ุงุฒ ฺฉููพโุจุฑุฏ
    async function pasteAddressFromClipboard() {
      try {
        const clipboardText = await navigator.clipboard.readText();
        const addressInput = document.getElementById('newOwnerAddress');
        
        // ุจุฑุฑุณ ุงูฺฉู ุขุง ูุชู ฺฉูพ ุดุฏู ุขุฏุฑุณ ุงุชุฑูู ูุนุชุจุฑ ุงุณุช
        if (clipboardText && /^0x[a-fA-F0-9]{40}$/.test(clipboardText.trim())) {
          addressInput.value = clipboardText.trim();
          showCopyStatus('โ ุขุฏุฑุณ ุงุฒ ฺฉููพโุจุฑุฏ ฺุณุจุงูุฏู ุดุฏ', 'success');
        } else {
          showCopyStatus('โ ูุญุชูุง ฺฉููพโุจุฑุฏ ุขุฏุฑุณ ุงุชุฑูู ูุนุชุจุฑ ูุณุช', 'error');
        }
      } catch (error) {
        showCopyStatus('โ ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุงุฒ ฺฉููพโุจุฑุฏ', 'error');
      }
    }
    
    // ููุงุด ูุถุนุช ฺฉูพ
    function showCopyStatus(message, type) {
      const statusEl = document.getElementById('transferOwnershipStatus');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      
      // ูพุงฺฉ ฺฉุฑุฏู ูพุงู ุจุนุฏ ุงุฒ 3 ุซุงูู
      setTimeout(() => {
        if (statusEl.textContent === message) {
          statusEl.className = 'status';
          statusEl.textContent = '';
        }
      }, 3000);
    }
    
    // ุฑูุฏุงุฏ ฺฉูฺฉ ุฑู ุฏฺฉูู ฺฉูพ
    document.getElementById('copyAddressBtn').addEventListener('click', copyAddressToClipboard);
    
    // ุชุงุจุน ูพุงฺฉ ฺฉุฑุฏู ุขุฏุฑุณ
    function clearAddress() {
      const addressInput = document.getElementById('newOwnerAddress');
      addressInput.value = '';
      showCopyStatus('โ ููุฏ ุขุฏุฑุณ ูพุงฺฉ ุดุฏ', 'success');
    }
    
    // ุชุงุจุน ูพุฑ ฺฉุฑุฏู ุฎูุฏฺฉุงุฑ ุขุฏุฑุณ ูุนู ฺฉุงุฑุจุฑ
    function fillCurrentUserAddress() {
      if (window.contractConfig && window.contractConfig.address) {
        const addressInput = document.getElementById('newOwnerAddress');
        addressInput.value = window.contractConfig.address;
        showCopyStatus('โ ุขุฏุฑุณ ูุนู ุดูุง ุฏุฑ ููุฏ ูุฑุงุฑ ฺฏุฑูุช', 'success');
      }
    }
    
    // ุฑูุฏุงุฏ ฺฉูฺฉ ุฑู ุฏฺฉูู ฺุณุจุงูุฏู
    document.getElementById('pasteAddressBtn').addEventListener('click', pasteAddressFromClipboard);
    
    // ุฑูุฏุงุฏ ฺฉูฺฉ ุฑู ุฏฺฉูู ูพุงฺฉ ฺฉุฑุฏู
    document.getElementById('clearAddressBtn').addEventListener('click', clearAddress);
    
    // ุฑูุฏุงุฏ ฺฉูฺฉ ุฑู ุฏฺฉูู ูพุฑ ฺฉุฑุฏู ุขุฏุฑุณ ูุนู
    document.getElementById('fillCurrentAddressBtn').addEventListener('click', fillCurrentUserAddress);
    
    // ฺฉูุฏูุง ูุงูุจุฑ
    document.addEventListener('keydown', function(e) {
      // Ctrl+V ุจุฑุง ฺุณุจุงูุฏู
      if (e.ctrlKey && e.key === 'v') {
        e.preventDefault();
        pasteAddressFromClipboard();
      }
      // Ctrl+C ุจุฑุง ฺฉูพ ฺฉุฑุฏู
      if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        copyAddressToClipboard();
      }
      // Ctrl+X ุจุฑุง ูพุงฺฉ ฺฉุฑุฏู
      if (e.ctrlKey && e.key === 'x') {
        e.preventDefault();
        clearAddress();
      }
      // Ctrl+F ุจุฑุง ูพุฑ ฺฉุฑุฏู ุขุฏุฑุณ ูุนู
      if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        fillCurrentUserAddress();
      }
    });
    
    // ุงุนุชุจุงุฑุณูุฌ ุฒูุฏู ุขุฏุฑุณ ู ูุฏุฑุช ูุถุนุช ุฏฺฉูู
    const newOwnerInput = document.getElementById('newOwnerAddress');
    const addressHint = document.getElementById('addressHint');
    const submitBtn = document.getElementById('transferOwnershipBtn');
    function validateAddressInput() {
      const v = newOwnerInput.value.trim();
      const ok = /^0x[a-fA-F0-9]{40}$/.test(v);
      if (!v) {
        addressHint.textContent = '';
        addressHint.className = 'hint';
        submitBtn.disabled = true;
        return false;
      }
      if (ok) {
        addressHint.textContent = 'โ ุขุฏุฑุณ ูุนุชุจุฑ ุงุณุช';
        addressHint.className = 'hint valid';
        submitBtn.disabled = false;
        return true;
      }
      addressHint.textContent = 'โ ุขุฏุฑุณ ูุงูุนุชุจุฑ ุงุณุช. ูุฑูุช ุตุญุญ: 0x... (ดฒ ฺฉุงุฑุงฺฉุชุฑ)';
      addressHint.className = 'hint error';
      submitBtn.disabled = true;
      return false;
    }
    newOwnerInput.addEventListener('input', validateAddressInput);

    // ููุฏุงู ุชุงุฏ
    let pendingTargetAddress = null;
    const modal = document.getElementById('confirmModal');
    const confirmAddressText = document.getElementById('confirmAddressText');
    const confirmInput = document.getElementById('confirmAddressInput');
    const confirmHint = document.getElementById('confirmHint');
    const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
    const confirmTransferBtn = document.getElementById('confirmTransferBtn');

    function openConfirmModal(targetAddress) {
      pendingTargetAddress = targetAddress;
      confirmAddressText.textContent = targetAddress;
      confirmInput.value = '';
      confirmHint.textContent = '';
      confirmHint.className = 'hint';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      setTimeout(() => confirmInput.focus(), 50);
    }
    function closeConfirmModal() {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }
    cancelConfirmBtn.addEventListener('click', closeConfirmModal);
    confirmTransferBtn.addEventListener('click', async function() {
      const entered = (confirmInput.value || '').trim();
      if (!pendingTargetAddress) return;
      if (entered.toLowerCase() !== pendingTargetAddress.toLowerCase()) {
        confirmHint.textContent = 'โ ุขุฏุฑุณ ูุงุฑุฏ ุดุฏู ูุทุงุจูุช ูุฏุงุฑุฏ';
        confirmHint.className = 'hint error';
        return;
      }
      closeConfirmModal();
      const statusEl = document.getElementById('transferOwnershipStatus');
      const btn = document.getElementById('transferOwnershipBtn');
      statusEl.className = 'status';
      await transferIndexOwnership(pendingTargetAddress, statusEl, btn);
      pendingTargetAddress = null;
    });

    // ุงุฑุณุงู ูุฑู โ ุจุงุฒ ฺฉุฑุฏู ููุฏุงู ุชุงุฏ
    document.getElementById('transferOwnershipForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const newOwner = newOwnerInput.value.trim();
      const statusEl = document.getElementById('transferOwnershipStatus');
      statusEl.className = 'status';
      if (!/^0x[a-fA-F0-9]{40}$/.test(newOwner)) {
        statusEl.className = 'status error';
        statusEl.textContent = 'โ ุขุฏุฑุณ ููุตุฏ ูุนุชุจุฑ ูุณุช.';
        return;
      }
      openConfirmModal(newOwner);
    });

    // ุจุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ ููฺฏุงู ุจุงุฑฺฏุฐุงุฑ ุตูุญู
    document.addEventListener('DOMContentLoaded', function() {
      // ุจุฑุฑุณ ูุถุนุช ุงุชุตุงู ฺฉู ูพูู
      if (window.contractConfig && window.contractConfig.contract) {
        autoRefreshBalances();
      } else {
        // ุงูุชุธุงุฑ ุจุฑุง ุงุชุตุงู ฺฉู ูพูู
        const checkConnection = setInterval(() => {
          if (window.contractConfig && window.contractConfig.contract) {
            autoRefreshBalances();
            clearInterval(checkConnection);
          }
        }, 1000);
        
        // ูุชููู ฺฉุฑุฏู ุจุฑุฑุณ ุจุนุฏ ุงุฒ 10 ุซุงูู
        setTimeout(() => clearInterval(checkConnection), 10000);
      }
      // ุงุนุชุจุงุฑุณูุฌ ุงููู
      validateAddressInput();
    });
  </script>
  <script src="js/navbar.js"></script>
  <script src="js/main.js"></script>
  
  <!-- Floating Token Growth Card - ฺฉุงุฑุช ุดูุงูุฑ ุฑุดุฏ ุชูฺฉู -->
  <script src="js/floating-token-card.js"></script>
</body>
</html> 