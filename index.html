<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IAMPHOENIX - Dashboard</title>
  <script>window.SKIP_META = true;</script>
  <script>
    // Suppress noisy extension/MetaMask RPC messages that don't affect functionality
    window.addEventListener('error', function(e){
      const m = (e && e.message) || '';
      if (m.includes('Could not establish connection') || m.includes('getEnabledChains') || m.includes('isDefaultWallet')) {
        e.preventDefault();
        return false;
      }
    });
    window.addEventListener('unhandledrejection', function(e){
      const r = e && e.reason;
      const msg = (r && (r.message || r)) || '';
      if (typeof msg === 'string' && (msg.includes('Could not establish connection') || msg.includes('getEnabledChains') || msg.includes('isDefaultWallet'))) {
        e.preventDefault();
        return false;
      }
    });
  </script>
    <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0a0b0f; color:#e6eaf0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; box-sizing: border-box; }
    h1 { margin: 0 0 16px; font-size: 20px; color:#9ecbff; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 16px; }
    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; gap: 14px; } }
    .card { background: #121521; border: 1px solid #1f2433; border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 12px; font-size: 18px; color:#aef3c6; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px dashed #263048; }
    .row:last-child { border-bottom: 0; }
    .label { color:#9aa8c1; }
    .value { color:#e6eaf0; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all; overflow-wrap: anywhere; }
    .actions { display:flex; gap:8px; margin-bottom:16px; }
    button { background:#2563eb; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#334155; }
    .muted { color:#7f8ca8; font-size: 12px; }
    .error { color:#ff6b6b; font-size: 13px; }
    .statusbar { background:#0e1220; border:1px solid #1f2433; padding:10px 12px; border-radius:12px; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); grid-auto-rows:auto; gap:8px; align-items:center; margin: 12px 0; }
    .pill { background:#162032; color:#cfe2ff; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #223150; white-space: nowrap; text-align:center; width:100%; box-sizing:border-box; }
    /* Force first row: likes, dislikes, rank, index */
    #status-likes, #status-dislikes, #status-rank, #status-index { grid-row: 1; }
    /* Second row for the rest */
    #status-address, #status-matic, #status-dai, #status-iam { grid-row: 2; }
    .footer-links { margin: 24px 0 0; display: flex; flex-wrap: wrap; gap: 8px; }
    .footer-links a { text-decoration: none; }
    .footer-btn { background:#1b2336; color:#e6eaf0; border:1px solid #273149; padding:10px 12px; border-radius:10px; font-size:13px; display:inline-block; }
    .footer-btn:hover { background:#223049; }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      h1 { font-size: 18px; margin-bottom: 14px; }
      .card { padding: 14px; border-radius: 10px; }
      .card h2 { font-size: 16px; }
      .row { gap: 10px; padding: 8px 0; }
      .label { font-size: 13px; }
      .value { font-size: 13px; }
      .statusbar { gap: 6px; padding: 8px 10px; }
      .pill { font-size: 11px; padding: 6px 8px; }
    }

    @media (max-width: 480px) {
      .container { padding: 14px; }
      h1 { font-size: 17px; }
      .row { flex-direction: column; align-items: flex-start; }
      .label { font-size: 13px; opacity: 0.95; }
      .value { width: 100%; text-align: left; direction: ltr; font-size: 13px; }
      .pill { font-size: 10.5px; }
    }

    @media (max-width: 360px) {
      .container { padding: 12px; }
      h1 { font-size: 16px; }
      .card { padding: 12px; }
      .row { padding: 6px 0; }
      .pill { font-size: 10px; padding: 5px 7px; }
        }
    </style>
</head>
<body>
  <div class="container">
    <h1>IAMPHOENIX Dashboard</h1>

    <div class="statusbar" id="status-bar">
      <span class="pill" id="status-address">-</span>
      <span class="pill" id="status-index">-</span>
      <span class="pill" id="status-rank">Rank: -</span>
      <span class="pill" id="status-matic">POL: -</span>
      <span class="pill" id="status-dai">DAI: -</span>
      <span class="pill" id="status-iam">IAM: -</span>
      <span class="pill" id="status-likes">Likes: -</span>
      <span class="pill" id="status-dislikes">Dislikes: -</span>
            </div>
            

    <div class="grid">
      <section class="card" id="contract-card" style="text-align:left; direction:ltr;">
        <h2>Contract Info</h2>
        <div class="row"><div class="label">Contract Address</div><div class="value" id="c-address">-</div></div>
        <div class="row"><div class="label">Name</div><div class="value" id="c-name">-</div></div>
        <div class="row"><div class="label">Symbol</div><div class="value" id="c-symbol">-</div></div>
        <div class="row"><div class="label">Decimals</div><div class="value" id="c-decimals">-</div></div>
        <div class="row"><div class="label">Total Supply</div><div class="value" id="c-total-supply">-</div></div>
        <div class="row"><div class="label">DAI In Contract</div><div class="value" id="c-dai-in-contract">-</div></div>
        <div class="row"><div class="label">IAM In Contract</div><div class="value" id="c-iam-in-contract">-</div></div>
        <div class="row"><div class="label">Registration Price</div><div class="value" id="c-registration-price">-</div></div>
        <div class="row"><div class="label">Token Price</div><div class="value" id="c-token-price">-</div></div>
        <div class="row"><div class="label">Point Price</div><div class="value" id="c-point-price">-</div></div>
        <div class="row"><div class="label">Cash Back</div><div class="value" id="c-cashback">-</div></div>
        
        
        <div class="row"><div class="label">Wallets Count</div><div class="value" id="c-wallets-count">-</div></div>
        <div class="row"><div class="label">Claimable Points (Total)</div><div class="value" id="c-claimable-points">-</div></div>
        
        <div class="muted">Some values may remain empty if their functions do not exist on the contract.</div>
        <div class="error" id="contract-error" style="display:none"></div>
      </section>
    </div>

        
        
    

    
                </div>
                
  <!-- Footer page links -->
  <div class="container">
    <div class="footer-links">
      <a class="footer-btn" href="index.html">Home</a>
      <a class="footer-btn" href="about.html">About</a>
      <a class="footer-btn" href="register.html">Register</a>
      <a class="footer-btn" href="profile.html">Profile</a>
      <a class="footer-btn" href="sales.html">Sales</a>
      <a class="footer-btn" href="swap.html">Swap</a>
      <a class="footer-btn" href="transfer.html">Transfer</a>
      <a class="footer-btn" href="transfer-ownership.html">Transfer Ownership</a>
      <a class="footer-btn" href="utility.html">Utility</a>
      <a class="footer-btn" href="professional-tree.html">Professional Tree</a>
            </div>
        </div>
        
  <!-- Ethers (v6) CDN if not already present on other pages -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
        
  <!-- Project scripts providing config and wallet connection/contract utils -->
    <script src="js/config.js"></script>
  <script src="js/network.js"></script>
  <script src="js/web3-interactions.js"></script>
  <script src="js/profile.js"></script>
  <script src="js/auto-wallet-connect.js"></script>
  <script src="js/swap.js"></script>
    
  <script>
    function safeFormatUnits(value, decimals) {
      try {
        return (window.ethers && ethers.formatUnits) ? ethers.formatUnits(value, decimals) : String(value);
      } catch { return String(value); }
    }

    function toNumberFromUnits(value, decimals) {
      try {
        const s = safeFormatUnits(value, decimals);
        const n = Number(s);
        return isNaN(n) ? 0 : n;
      } catch { return 0; }
    }

    function formatUsdFromWeiProduct(productWeiBigInt) {
      try {
        const s = safeFormatUnits(productWeiBigInt, 18);
        const n = Number(s);
        if (!isFinite(n)) return '$0.00';
        return '$' + n.toFixed(2);
      } catch { return '$0.00'; }
    }

    function ensureUsdLineBelow(valueEl) {
      if (!valueEl) return null;
      let usdEl = valueEl.nextElementSibling;
      if (!usdEl || usdEl.getAttribute('data-role') !== 'usd-subline') {
        usdEl = document.createElement('div');
        usdEl.setAttribute('data-role', 'usd-subline');
        usdEl.style.fontSize = '12px';
        usdEl.style.color = '#a786ff';
        usdEl.style.marginTop = '2px';
        valueEl.parentElement?.appendChild(usdEl);
      }
      return usdEl;
    }

    function formatMax2(num) {
      try { return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(Number(num)); } catch { return String(num); }
    }

    function format0(num) {
      try { return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(Number(num)); } catch { return String(num); }
    }

    function shortenAddress(addr) {
      try { if (!addr || addr.length < 10) return addr || '-'; return addr.slice(0, 6) + '...' + addr.slice(-4); } catch { return addr || '-'; }
    }

    function updateStatusPills(data) {
      const set = (id, label, value) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === 'status-address' || id === 'status-index' || id === 'status-rank') {
          el.textContent = `${value ?? '-'}`;
                        } else {
          el.textContent = `${label}: ${value ?? '-'}`;
        }
      };
      if (!data) return;
      if (data.address !== undefined) set('status-address', 'Address', data.address);
      if (data.index !== undefined) set('status-index', 'Index', data.index);
      if (data.rank !== undefined) set('status-rank', 'Rank', data.rank);
      if (data.matic !== undefined) set('status-matic', 'POL', data.matic);
      if (data.dai !== undefined) set('status-dai', 'DAI', data.dai);
      if (data.iam !== undefined) set('status-iam', 'IAM', data.iam);
      if (data.likes !== undefined) set('status-likes', 'Likes', data.likes);
      if (data.dislikes !== undefined) set('status-dislikes', 'Dislikes', data.dislikes);
    }

    // User Info removed

    async function fetchContractInfo() {
      const addrEl = document.getElementById('c-address');
      const nameEl = document.getElementById('c-name');
      const symbolEl = document.getElementById('c-symbol');
      const decimalsEl = document.getElementById('c-decimals');
      const supplyEl = document.getElementById('c-total-supply');
      const daiInEl = document.getElementById('c-dai-in-contract');
      const iamInEl = document.getElementById('c-iam-in-contract');
      const regPriceEl = document.getElementById('c-registration-price');
      const tokenPriceEl = document.getElementById('c-token-price');
      const cashbackEl = document.getElementById('c-cashback');
      const pointPriceEl = document.getElementById('c-point-price');
      const deployerEl = null;
      const usersCountEl = null;
      const walletsCountEl = document.getElementById('c-wallets-count');
      const claimablePointsEl = document.getElementById('c-claimable-points');
      const errEl = document.getElementById('contract-error');
      errEl.style.display = 'none';
      errEl.textContent = '';
      try {
        if (!window.connectWallet) throw new Error('Wallet connection is not available');
        const connection = await window.connectWallet();
        if (!connection || !connection.contract) throw new Error('Contract connection is not available');
        const { contract, provider, signer, address: connectedAddress } = connection;

        addrEl.textContent = (contract && contract.target) ? contract.target : (window.IAM_ADDRESS || '-');
        // Update status bar basic address immediately
        try { updateStatusPills({ address: shortenAddress(connectedAddress || (await signer.getAddress())) }); } catch {}

        // Always read directly from contract (no cached meta)
        nameEl.textContent = '';
        symbolEl.textContent = '';
        decimalsEl.textContent = '';
        supplyEl.textContent = '';
        
        if (walletsCountEl) walletsCountEl.textContent = '';
        

        // Direct reads
        try { if (typeof contract.name === 'function') nameEl.textContent = await contract.name(); } catch {}
        try { if (typeof contract.symbol === 'function') symbolEl.textContent = await contract.symbol(); } catch {}
        try { if (typeof contract.decimals === 'function') decimalsEl.textContent = (await contract.decimals()).toString(); } catch {}
        let tokenPriceWei = null;
        let totalSupplyWei = null;
        try {
          if (typeof contract.totalSupply === 'function') {
            totalSupplyWei = await contract.totalSupply();
            supplyEl.textContent = formatMax2(toNumberFromUnits(totalSupplyWei, 18));
          }
        } catch {}
        
        // Users count intentionally removed per request

        // Wallets count: prefer explicit contract variable/getter for wallets
        try {
          let walletsCount = null;
          if (typeof contract.wallets === 'function') walletsCount = await contract.wallets();
          if (typeof contract.walletsCount === 'function') walletsCount = await contract.walletsCount();
          else if (typeof contract.getWalletsCount === 'function') walletsCount = await contract.getWalletsCount();
          else if (typeof contract.totalWallets === 'function') walletsCount = await contract.totalWallets();
          else if (typeof contract.walletsLength === 'function') walletsCount = await contract.walletsLength();
          else if (typeof contract.getWalletsLength === 'function') walletsCount = await contract.getWalletsLength();
          if (walletsCountEl && walletsCount !== null && walletsCount !== undefined) walletsCountEl.textContent = (typeof walletsCount === 'bigint' ? walletsCount.toString() : String(walletsCount));
        } catch {}

        // IAM in contract (balanceOf self)
        let iamBalanceSelf = null;
        try {
          if (typeof contract.balanceOf === 'function') {
            iamBalanceSelf = await contract.balanceOf(contract.target);
            if (iamInEl) iamInEl.textContent = formatMax2(toNumberFromUnits(iamBalanceSelf, 18));
          }
        } catch {}

        // ===== Status bar: wallet balances =====
        try {
          const userAddr = connectedAddress || (signer ? await signer.getAddress() : null);
          if (userAddr) {
            // POL/MATIC
            try {
              const mBal = await provider.getBalance(userAddr);
              updateStatusPills({ matic: formatMax2(toNumberFromUnits(mBal, 18)) });
            } catch {}
            // DAI
            try {
              const daiAddr = window.DAI_ADDRESS || (window.contractConfig && window.contractConfig.DAI_ADDRESS);
              if (daiAddr) {
                const minimalDaiAbi = [{"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}];
                const Dai = new ethers.Contract(daiAddr, minimalDaiAbi, provider);
                const dBal = await Dai.balanceOf(userAddr);
                updateStatusPills({ dAI: undefined, dai: formatMax2(toNumberFromUnits(dBal, 18)) });
              }
            } catch {}
            // IAM balance
            try {
              if (typeof contract.balanceOf === 'function') {
                const ib = await contract.balanceOf(userAddr);
                updateStatusPills({ iam: formatMax2(toNumberFromUnits(ib, 18)) });
              }
            } catch {}
            // Likes/Dislikes for current user
            try {
              if (typeof contract.getVoteStatus === 'function') {
                const vs = await contract.getVoteStatus(userAddr);
                const likes = (vs && vs[0] !== undefined) ? Number(vs[0]) : 0;
                const dislikes = (vs && vs[1] !== undefined) ? Number(vs[1]) : 0;
                updateStatusPills({ likes, dislikes });
              }
            } catch {}
            // Index
            try {
              let idx = null;
              if (typeof contract.addressToIndex === 'function') idx = await contract.addressToIndex(userAddr);
              if ((idx === null || (typeof idx === 'bigint' && idx === 0n)) && typeof contract.users === 'function') {
                const u = await contract.users(userAddr);
                if (u && u.index !== undefined) idx = u.index;
                // Also derive a simple rank from binaryPointCap if available
                try {
                  if (u && u.binaryPointCap !== undefined) {
                    const rankVal = (typeof u.binaryPointCap === 'bigint') ? Number(u.binaryPointCap) : Number(u.binaryPointCap||0);
                    if (!isNaN(rankVal)) updateStatusPills({ rank: `Rank: ${rankVal}` });
                  }
                } catch {}
              }
              if (idx !== null && idx !== undefined) updateStatusPills({ index: (typeof idx === 'bigint' ? idx.toString() : String(idx)) });
            } catch {}
          }
        } catch {}

        // DAI in contract (best-effort via window.DAI_ADDRESS)
        try {
          const daiAddr = window.DAI_ADDRESS || (window.contractConfig && window.contractConfig.DAI_ADDRESS);
          if (provider && daiAddr) {
            const minimalDaiAbi = [{"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}];
            const Dai = new ethers.Contract(daiAddr, minimalDaiAbi, provider);
            const d = await Dai.balanceOf(contract.target);
            if (daiInEl) daiInEl.textContent = formatMax2(toNumberFromUnits(d, 18));
          }
        } catch {}

        // Registration price (only getRegPrice per request)
        let regPriceWei = null;
        try {
          if (typeof contract.getRegPrice === 'function') {
            const r = await contract.getRegPrice();
            regPriceWei = (typeof r === 'bigint') ? r : BigInt(r);
            if (regPriceEl) regPriceEl.textContent = formatMax2(toNumberFromUnits(regPriceWei, 18));
          }
        } catch {}

        // Token price (try common names)
        try {
          let p;
          if (typeof contract.getTokenPrice === 'function') p = await contract.getTokenPrice();
          else if (typeof contract.tokenPrice === 'function') p = await contract.tokenPrice();
          if (p !== undefined) {
            tokenPriceWei = (typeof p === 'bigint') ? p : BigInt(p);
            if (tokenPriceEl) tokenPriceEl.textContent = safeFormatUnits(tokenPriceWei, 18);
          }
        } catch {}

        // Point price will be derived below from IAM-in-contract / total unclaimed points

        // Claimable points total – read from its public variable/getter on contract
        let totalUnclaimedPoints = null;
        try {
          const preferIntegerString = (v) => {
            try { return (typeof v === 'bigint' ? v : BigInt(v)).toString(); } catch { return String(v); }
          };
          let cp;
          if (typeof contract.totalClaimablePoints === 'function') cp = await contract.totalClaimablePoints();
          else if (typeof contract.claimablePointsTotal === 'function') cp = await contract.claimablePointsTotal();
          else if (typeof contract.getClaimablePoints === 'function') cp = await contract.getClaimablePoints();
          else if (typeof contract.claimablePoints === 'function') cp = await contract.claimablePoints();
          else if (typeof contract.totalUnclaimedPoints === 'function') cp = await contract.totalUnclaimedPoints();
          else if (typeof contract.unclaimedPointsTotal === 'function') cp = await contract.unclaimedPointsTotal();
          if (cp !== undefined) {
            totalUnclaimedPoints = (typeof cp === 'bigint') ? cp : (()=>{ try{return BigInt(cp);}catch{return null;} })();
            if (claimablePointsEl && totalUnclaimedPoints !== null) claimablePointsEl.textContent = totalUnclaimedPoints.toString();
          }
        } catch {}

        // Derived Point Value = IAM in contract / total unclaimed points (IAM has 18 decimals; points are integer)
        try {
          if (pointPriceEl && iamBalanceSelf !== null && totalUnclaimedPoints !== null && totalUnclaimedPoints > 0n) {
            const ONE = 1000000000000000000n; // 1e18
            const priceWeiPerPoint = iamBalanceSelf / totalUnclaimedPoints;
            pointPriceEl.textContent = formatMax2(toNumberFromUnits(priceWeiPerPoint, 18));
            if (tokenPriceWei) {
              const usdPerPointWei = (priceWeiPerPoint * tokenPriceWei) / ONE;
              const usdEl = ensureUsdLineBelow(pointPriceEl);
              if (usdEl) usdEl.textContent = formatUsdFromWeiProduct(usdPerPointWei);
            }
          }
        } catch {}

        // Cashback (raw 18-decimals)
        try {
          if (cashbackEl && typeof contract.cashBack === 'function') {
            const cb = await contract.cashBack();
            const cbWei = (typeof cb === 'bigint') ? cb : BigInt(cb);
            cashbackEl.textContent = formatMax2(toNumberFromUnits(cbWei, 18));
            // USD subline below cashback
            if (tokenPriceWei) {
              const ONE = 1000000000000000000n;
              const cbUsdWei = (cbWei * tokenPriceWei) / ONE;
              const usdEl = ensureUsdLineBelow(cashbackEl);
              if (usdEl) usdEl.textContent = formatUsdFromWeiProduct(cbUsdWei);
            }
          }
        } catch {}

        // USD subline below Registration Price
        try {
          if (regPriceEl && regPriceWei && tokenPriceWei) {
            const ONE = 1000000000000000000n;
            const regUsdWei = (regPriceWei * tokenPriceWei) / ONE;
            const usdEl = ensureUsdLineBelow(regPriceEl);
            if (usdEl) usdEl.textContent = formatUsdFromWeiProduct(regUsdWei);
          }
        } catch {}

        // USD under Total Supply
        try {
          if (totalSupplyWei && tokenPriceWei) {
            const ONE = 1000000000000000000n;
            const supplyUsdWei = (totalSupplyWei * tokenPriceWei) / ONE;
            const usdEl = ensureUsdLineBelow(supplyEl);
            if (usdEl) usdEl.textContent = formatUsdFromWeiProduct(supplyUsdWei);
          }
        } catch {}

        // USD under IAM In Contract
        try {
          if (iamBalanceSelf !== null && tokenPriceWei) {
            const ONE = 1000000000000000000n;
            const iamUsdWei = (iamBalanceSelf * tokenPriceWei) / ONE;
            const usdEl = ensureUsdLineBelow(iamInEl);
            if (usdEl) usdEl.textContent = formatUsdFromWeiProduct(iamUsdWei);
          }
        } catch {}
            } catch (e) {
        errEl.textContent = e.message || 'Failed to load contract info';
        errEl.style.display = 'block';
      }
    }

    // Ensure connection before fetching; retry a few times
    async function waitForContract(maxWaitMs = 10000, intervalMs = 500) {
      const start = Date.now();
      while (Date.now() - start < maxWaitMs) {
        try {
          if (window.contractConfig && window.contractConfig.contract) return true;
          if (typeof window.connectWallet === 'function') {
            const conn = await window.connectWallet();
            if (conn && conn.contract) return true;
          }
        } catch {}
        await new Promise(r => setTimeout(r, intervalMs));
      }
      return false;
    }

    async function refreshContractInfoSafe() {
      const ok = await waitForContract(12000, 600);
      if (!ok) return;
      await fetchContractInfo();
    }

    // ==== Dynamic ABI UI builders ====
    function parseInputValue(raw, solidityType) {
      if (solidityType.startsWith('uint') || solidityType.startsWith('int')) {
        // Accept decimal string -> BigInt
        return (typeof raw === 'string' && raw.trim() !== '') ? BigInt(raw) : 0n;
      }
      if (solidityType === 'bool') {
        return String(raw).toLowerCase() === 'true';
      }
      // bytes, address, string, arrays (as JSON)
      if (solidityType.endsWith(']')) {
        try { return JSON.parse(raw); } catch { return []; }
      }
      return raw;
    }

     function buildFunctionRow(fn, container, isWrite = false) {
      const row = document.createElement('div');
      row.style.border = '1px solid #263048';
      row.style.borderRadius = '10px';
      row.style.padding = '10px';
      row.style.margin = '10px 0';

      const title = document.createElement('div');
      title.className = 'label';
      title.textContent = `${fn.name}(${(fn.inputs||[]).map(i=>i.type).join(', ')})`;
      row.appendChild(title);

      const inputsWrap = document.createElement('div');
      inputsWrap.style.display = 'grid';
      inputsWrap.style.gridTemplateColumns = 'repeat(auto-fit, minmax(180px, 1fr))';
      inputsWrap.style.gap = '8px';
      const inputs = [];
      (fn.inputs||[]).forEach((inp, idx) => {
        const field = document.createElement('input');
        field.placeholder = `${inp.name||'arg'+idx}: ${inp.type}`;
        field.style.background = '#0f1220';
        field.style.border = '1px solid #263048';
        field.style.borderRadius = '8px';
        field.style.color = '#e6eaf0';
        field.style.padding = '8px';
        inputsWrap.appendChild(field);
        inputs.push({ field, type: inp.type });
      });
      row.appendChild(inputsWrap);

      const actions = document.createElement('div');
      actions.style.marginTop = '8px';
      const btn = document.createElement('button');
      btn.textContent = isWrite ? 'ارسال تراکنش' : 'فراخوانی';
      actions.appendChild(btn);
      row.appendChild(actions);

      const result = document.createElement('div');
      result.className = 'value';
      result.style.marginTop = '8px';
      result.style.wordBreak = 'break-word';
      row.appendChild(result);

      btn.addEventListener('click', async () => {
        try {
          const args = inputs.map(i => parseInputValue(i.field.value, i.type));
          const callName = fn.name;
          const signature = `${fn.name}(${(fn.inputs||[]).map(i=>i.type).join(',')})`;
          if (isWrite) {
            result.textContent = '⏳ در حال ارسال تراکنش...';
            const sender = (typeof window.sendWriteSignature === 'function') ? window.sendWriteSignature : window.sendWrite;
            const receipt = await sender(signature, ...args);
            result.textContent = `✅ تایید شد: ${receipt.transactionHash}`;
                            } else {
            result.textContent = '⏳ در حال خواندن...';
            const reader = (typeof window.callReadSignature === 'function') ? window.callReadSignature : window.callRead;
            const out = await reader(signature, ...args);
            try { result.textContent = JSON.stringify(out, null, 2); }
            catch { result.textContent = String(out); }
          }
        } catch (e) {
          result.textContent = `❌ ${e.message||e}`;
        }
      });

      container.appendChild(row);
    }

     function buildAbiUI() { /* write functions removed per request */ }

    

    document.addEventListener('DOMContentLoaded', async () => {
      // Auto try to load if connection is already present
      try {
        await refreshContractInfoSafe();
        // buildAbiUI removed
      } catch {}

      // Refresh periodically
      setInterval(() => { refreshContractInfoSafe(); }, 30000);

      // MetaMask events: keep info fresh
      if (window.ethereum) {
        try {
          window.ethereum.on('accountsChanged', () => { refreshContractInfoSafe(); });
          window.ethereum.on('chainChanged', () => { refreshContractInfoSafe(); });
          window.ethereum.on('connect', () => { refreshContractInfoSafe(); });
          window.ethereum.on('disconnect', () => { /* no-op */ });
        } catch {}
      }
    });
  </script>
</body>
</html>

