<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>IAMPHOENIX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/index-custom.css">
    <link rel="stylesheet" href="css/floating-ai-assistant.css">
    <link rel="stylesheet" href="css/smooth-transitions.css">
    <link rel="stylesheet" href="css/mobile-user-popup.css">
    <link rel="stylesheet" href="css/modern-theme.css">

    <!-- Loading ethers.js version 6 from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- Loading WalletConnect Provider from official CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <!-- Loading WalletConnect Handler -->
    <script src="js/walletconnect-handler.js?v=5.7"></script>

      <!-- Loading WalletConnect UMD locally -->
  <script src="js/walletconnect-v1.8.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="js/auth-redirect.js"></script>
  <script src="js/modern-theme-variables.js"></script>
  
      <!-- Loading contract base knowledge -->
  <!-- <script src="js/contract-knowledge-base.js"></script> -->
  
      <!-- Loading Floating AI Assistants -->
  <!-- <script src="js/floating-ai-assistant.js"></script> -->
  
  <!-- Immediate AI Assistant Initialization -->
  <!--
  <script>
    // Force immediate initialization
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 DOM Content Loaded - Initializing AI Assistant...');

      setTimeout(() => {
        // فقط دستیار پیشرفته را مقداردهی کن
        if (typeof FloatingAIAssistant !== 'undefined') {
          console.log('✅ FloatingAIAssistant class found');

          if (!window.floatingAI) {
            console.log('🔄 Creating new FloatingAIAssistant instance...');
            window.floatingAI = new FloatingAIAssistant();
          }
          
          if (window.floatingAI) {
            console.log('✅ FloatingAI instance ready');
            window.floatingAI.switchToIdleState();
          }
        } else {
          console.error('❌ FloatingAIAssistant class not found');
        }
      }, 1000);
    });
  </script>
  -->
  
  <!-- Test script for floating AI -->

</head>
<body>
  <div id="online-session-bubble" style="display:none;">
          <span class="bubble-text">Online session is in progress! 🚀</span>
    <span class="bubble-timer" id="bubble-timer"></span>
    <a href="learning.html" class="bubble-link" target="_blank">Go to Class</a>
    <span class="bubble-close" id="bubble-close">×</span>
  </div>
  <div id="bubble-mini" style="display:none;">
    <span class="bubble-mini-icon">🚀</span>
  </div>


  <script>
    function formatCountdown(ms) {
      if (ms <= 0) return '00:00:00';
      let s = Math.floor(ms / 1000);
      let h = Math.floor(s / 3600);
      s = s % 3600;
      let m = Math.floor(s / 60);
      s = s % 60;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function showSessionBubble() {
      const info = window.sessionInfo;
      if (!info || !info.active) return;
      const bubble = document.getElementById('online-session-bubble');
      const mini = document.getElementById('bubble-mini');
      const timer = document.getElementById('bubble-timer');
      const link = bubble.querySelector('.bubble-link');
      link.href = info.link || 'learning.html';
      bubble.style.display = 'flex';
      mini.style.display = 'none';
      // شمارش معکوس
      function updateTimer() {
        const now = Date.now();
        if (now < info.startTime) {
          timer.textContent = 'شروع تا جلسه: ' + formatCountdown(info.startTime - now);
        } else if (now < info.endTime) {
          timer.textContent = 'زمان باقی‌مانده: ' + formatCountdown(info.endTime - now);
        } else {
          timer.textContent = 'جلسه به پایان رسید';
        }
      }
      updateTimer();
      window._bubbleTimerInterval = setInterval(updateTimer, 1000);
    }
    function hideSessionBubble() {
      document.getElementById('online-session-bubble').style.display = 'none';
      document.getElementById('bubble-mini').style.display = 'flex';
      if (window._bubbleTimerInterval) clearInterval(window._bubbleTimerInterval);
    }
    function showMiniBubble() {
      document.getElementById('bubble-mini').style.display = 'flex';
      document.getElementById('online-session-bubble').style.display = 'none';
    }
    function expandMiniBubble() {
      showSessionBubble();
    }
    // رویداد بستن
    document.addEventListener('DOMContentLoaded', function() {
      if (window.sessionInfo && window.sessionInfo.active) {
        showSessionBubble();
      }
      document.getElementById('bubble-close').onclick = hideSessionBubble;
      document.getElementById('bubble-mini').onclick = expandMiniBubble;
    });
  </script>

  
  
  <div id="main-dashboard" class="page-section" style="position:relative;overflow:visible;">
    <!-- User Status Bar (shown above dashboard cards for active users) -->
    <div id="index-user-status-bar" style="display:none;max-width:1200px;margin:0.75rem auto 0.5rem auto;padding:0.75rem 1rem;border-radius:16px;border:1px solid rgba(0,255,136,0.25);background:linear-gradient(135deg, rgba(0,255,136,0.08), rgba(167,134,255,0.08));box-shadow:0 6px 18px rgba(0,0,0,0.25), 0 1px 0 rgba(255,255,255,0.06) inset;backdrop-filter:blur(10px);">
      <div style="display:flex;align-items:center;justify-content:center;gap:0.75rem;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
          <span id="index-status-active" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.7rem;border-radius:12px;font-weight:700;color:#0f2d1f;background:linear-gradient(135deg,#00ff88,#00d178);border:1px solid rgba(0,255,136,0.4);box-shadow:0 2px 8px rgba(0,255,136,0.25);">✅ فعال</span>
          <span id="index-status-id" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.7rem;border-radius:12px;color:#ffffff;background:linear-gradient(135deg, rgba(0,255,136,0.12), rgba(167,134,255,0.12));border:1px solid rgba(255,255,255,0.18);font-weight:700;">🆔 IAM--</span>
          <span id="index-status-address" title="" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.7rem;border-radius:12px;color:#ffffff;background:linear-gradient(135deg, rgba(167,134,255,0.12), rgba(0,255,136,0.12));border:1px solid rgba(255,255,255,0.18);font-family:'Fira Mono', monospace;">📍 0x...</span>
          <button onclick="scrollToRanking()" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.7rem;border-radius:12px;color:#ffffff;background:linear-gradient(135deg, rgba(167,134,255,0.8), rgba(0,255,136,0.8));border:1px solid rgba(255,255,255,0.18);font-weight:700;cursor:pointer;border:none;font-size:0.9rem;">🏆 رنکینگ</button>
        </div>
      </div>
    </div>
    <script>
      (function(){
        function shortenAddress(addr){ if(!addr||typeof addr!=='string') return '-'; return addr.slice(0,6)+'...'+addr.slice(-4); }
        function formatIAMId(indexVal){
          try {
            let s = (typeof indexVal === 'bigint') ? indexVal.toString() : (indexVal && indexVal.toString ? indexVal.toString() : String(indexVal||''));
            // ensure only digits
            s = s.replace(/\D+/g,'');
            if (!s) return 'IAM-----';
            return 'IAM' + s.padStart(5,'0');
          } catch { return 'IAM-----'; }
        }
        function showBar(address, userData){
          const bar = document.getElementById('index-user-status-bar'); if(!bar) return;
          if (!address) { bar.style.display='none'; return; }
          // Derive active state robustly
          let active = false;
          let hasIndex = false;
          if (userData && userData.index != null) {
            try {
              const idxStr = (typeof userData.index === 'bigint') ? userData.index.toString() : (userData.index.toString ? userData.index.toString() : String(userData.index));
              hasIndex = idxStr !== '0';
            } catch(_) {}
          }
          if (userData) {
            if (userData.isActive === true || userData.activated === true) active = true;
            else if (userData.isActive === false || userData.activated === false) active = false;
          }
          // Consider registered index as active indicator if flags are missing
          if (!active && hasIndex) active = true;
          const idEl = document.getElementById('index-status-id');
          const addrEl = document.getElementById('index-status-address');
          const statusEl = document.getElementById('index-status-active');
          if (idEl) {
            if (hasIndex) { idEl.textContent = '🆔 ' + formatIAMId(userData.index); }
            else { idEl.textContent = '🆔 IAM--'; }
          }
          if (addrEl) { addrEl.textContent = '📍 ' + shortenAddress(address); addrEl.title = address; }
          if (statusEl) {
            if (active) {
              statusEl.textContent = '✅ فعال';
              statusEl.style.background = 'linear-gradient(135deg,#00ff88,#00d178)';
              statusEl.style.color = '#0f2d1f';
              statusEl.style.border = '1px solid rgba(0,255,136,0.4)';
              statusEl.style.boxShadow = '0 2px 8px rgba(0,255,136,0.25)';
            } else {
              statusEl.textContent = '⛔ غیرفعال';
              statusEl.style.background = 'linear-gradient(135deg,#ff6b6b,#c82333)';
              statusEl.style.color = '#ffffff';
              statusEl.style.border = '1px solid rgba(255,68,68,0.4)';
              statusEl.style.boxShadow = '0 2px 8px rgba(255,68,68,0.25)';
            }
          }
          const copyBtn = document.getElementById('index-status-copy');
          if(copyBtn){ copyBtn.onclick = function(){ if(!address) return; navigator.clipboard.writeText(address).then(()=>{ const t=copyBtn.textContent; copyBtn.textContent='✅ کپی شد'; setTimeout(()=>copyBtn.textContent=t,1500); }); } }
          bar.style.display='block';
        }
        function schedule(ms, fn){ setTimeout(fn, ms); }
        async function tryUpdate(){
          try{
            if(typeof window.ethers === 'undefined'){ return schedule(2000, tryUpdate); }
            // Prefer existing connected contract (with correct ABI)
            let address = null;
            let userData = null;
            if (window.contractConfig && window.contractConfig.contract) {
              try {
                address = window.contractConfig.address;
                const contract = window.contractConfig.contract;
                if (!address && window.contractConfig.signer && window.contractConfig.signer.getAddress) {
                  address = await window.contractConfig.signer.getAddress();
                }
                if (!address) { return schedule(3000, tryUpdate); }
                // Try primary users(address)
                try {
                  userData = await Promise.race([
                    contract.users(address),
                    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                  ]);
                } catch(e) {
                  userData = null;
                }
                // Fallbacks to derive index and activation
                let idxVal = null;
                try {
                  if (!userData || userData.index == null || (userData.index.toString && userData.index.toString() === '0')) {
                    if (typeof contract.getUserIndex === 'function') {
                      const idxRaw = await Promise.race([
                        contract.getUserIndex(address),
                        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                      ]);
                      idxVal = (typeof idxRaw === 'bigint') ? idxRaw : (idxRaw && idxRaw.toString ? BigInt(idxRaw.toString()) : null);
                    }
                  } else { idxVal = userData.index; }
                } catch(_) {}
                let act = null;
                try {
                  if (!userData || (userData.isActive == null && userData.activated == null)) {
                    if (typeof contract.getUserTree === 'function') {
                      const tree = await Promise.race([
                        contract.getUserTree(address),
                        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                      ]);
                      if (Array.isArray(tree) && tree.length >= 3) act = !!tree[2];
                    }
                  } else { act = !!(userData.isActive || userData.activated); }
                } catch(_) {}
                if (idxVal != null || act != null) {
                  userData = userData || {};
                  if (idxVal != null) userData.index = idxVal;
                  if (act != null) { userData.isActive = act; userData.activated = act; }
                }
              } catch(e) {
                // fallback to provider+IAM globals
              }
            }

            if (!userData) {
              const provider = (window.ethereum ? new ethers.BrowserProvider(window.ethereum) : null);
              if(!provider){ return schedule(2000, tryUpdate); }
              if(!address && window.ethereum && typeof window.ethereum.request==='function'){
                try{ const acc = await Promise.race([window.ethereum.request({method:'eth_accounts'}), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),1500))]); if(acc && acc[0]) address = acc[0]; }catch(_e){}
              }
              if(!address){ return schedule(4000, tryUpdate); }
              if(!(window.IAM_ADDRESS && window.IAM_ABI)){
                // Show bar with address even if contract globals not ready
                showBar(address, null);
                return schedule(2000, tryUpdate);
              }
              try {
                const fallbackContract = new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, provider);
                // Try users(address)
                try {
                  userData = await Promise.race([
                    fallbackContract.users(address),
                    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                  ]);
                } catch(_) { userData = null; }
                // Fill missing index
                let idxVal = null;
                try {
                  if (!userData || userData.index == null || (userData.index.toString && userData.index.toString() === '0')) {
                    if (typeof fallbackContract.getUserIndex === 'function') {
                      const idxRaw = await Promise.race([
                        fallbackContract.getUserIndex(address),
                        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                      ]);
                      idxVal = (typeof idxRaw === 'bigint') ? idxRaw : (idxRaw && idxRaw.toString ? BigInt(idxRaw.toString()) : null);
                    }
                  } else { idxVal = userData.index; }
                } catch(_) {}
                // Fill missing activation
                let act = null;
                try {
                  if (!userData || (userData.isActive == null && userData.activated == null)) {
                    if (typeof fallbackContract.getUserTree === 'function') {
                      const tree = await Promise.race([
                        fallbackContract.getUserTree(address),
                        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),3000))
                      ]);
                      if (Array.isArray(tree) && tree.length >= 3) act = !!tree[2];
                    }
                  } else { act = !!(userData.isActive || userData.activated); }
                } catch(_) {}
                if (idxVal != null || act != null) {
                  userData = userData || {};
                  if (idxVal != null) userData.index = idxVal;
                  if (act != null) { userData.isActive = act; userData.activated = act; }
                }
                if (!userData) return schedule(4000, tryUpdate);
              } catch(e) {
                return schedule(4000, tryUpdate);
              }
            }

            showBar(address, userData);
            schedule(10000, tryUpdate);
          }catch(e){ schedule(4000, tryUpdate); }
        }
        // expose for external triggers (e.g., after connect)
        window.indexStatusTryUpdate = tryUpdate;
        document.addEventListener('DOMContentLoaded', function(){
          schedule(1000, tryUpdate);
          if (window.ethereum && typeof window.ethereum.on === 'function') {
            try { window.ethereum.on('accountsChanged', () => setTimeout(tryUpdate, 500)); } catch(_){ }
            try { window.ethereum.on('chainChanged', () => setTimeout(tryUpdate, 800)); } catch(_){ }
          }
        });
      })();
    </script>
    <div class="dashboard-cards" style="display:flex;justify-content:center;flex-wrap:wrap;gap:1rem;max-width:1400px;margin:0 auto;">
      <!-- AI Assistant will be inserted here by JavaScript -->

      <!-- Blockchain Information Cards -->
      <div class="modern-card dashboard-card" style="min-width:100%;max-width:100%;margin:1rem 0;width:100%;padding:1.5rem;position:relative;overflow:hidden;">
        <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#00ff88,#a786ff,#00ff88);animation:shimmer 2s linear infinite;"></div>
        
        <div style="text-align:center;margin-bottom:1.5rem;">
          <h3 style="color:#00ff88;font-size:1.2rem;font-weight:bold;margin:0;font-family:monospace;">IAMPHOENIX</h3>
        </div>
        
        <!-- User Info Section -->
        <div id="dashboard-user-info" style="background:rgba(0,255,136,0.1);border-radius:12px;padding:1rem;margin-bottom:1rem;border:1px solid rgba(0,255,136,0.2);display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
            <div style="text-align:center;flex:1;min-width:120px;">
                                  <div style="color:#00ff88;font-size:0.8rem;font-weight:bold;margin-bottom:0.3rem;">ایندکس</div>
              <div style="color:#fff;font-size:1rem;font-family:monospace;font-weight:bold;" id="dashboard-user-index">-</div>
            </div>
            <div style="text-align:center;flex:1;min-width:120px;">
              <div style="color:#00ff88;font-size:0.8rem;font-weight:bold;margin-bottom:0.3rem;">آدرس کیف پول</div>
              <div style="color:#fff;font-size:0.9rem;font-family:monospace;" id="dashboard-user-address">-</div>
            </div>
            <div style="text-align:center;flex:1;min-width:120px;">
              <div style="color:#00ff88;font-size:0.8rem;font-weight:bold;margin-bottom:0.3rem;">وضعیت</div>
              <div style="color:#00ff88;font-size:0.9rem;font-weight:bold;" id="dashboard-user-status">-</div>
            </div>
          </div>
        </div>
        
        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;">
          <!-- 1. کل عرضه - اولویت اول -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(0,255,136,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#00ff88;font-size:1.2rem;margin-bottom:0.3rem;">💰</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">کل عرضه</div>
            <div style="color:#00ff88;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="circulating-supply" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">IAM Tokens</div>
            <div style="color:#f7931e;font-size:0.7rem;font-family:monospace;font-weight:bold;margin-top:0.2rem;" id="circulating-supply-dai">-</div>
            <div style="color:#888;font-size:0.6rem;margin-top:0.1rem;">≈ DAI</div>
          </div>
          
          <!-- 2. موجودی IAM قرارداد - اولویت دوم -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(255,193,7,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#ffc107;font-size:1.2rem;margin-bottom:0.3rem;">🏦</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">موجودی قرارداد</div>
            <div style="color:#ffc107;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="contract-token-balance" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">IAM in Contract</div>
            <div style="color:#f7931e;font-size:0.7rem;font-family:monospace;font-weight:bold;margin-top:0.2rem;" id="contract-token-balance-dai">-</div>
            <div style="color:#888;font-size:0.6rem;margin-top:0.1rem;">≈ DAI</div>
          </div>
          
          <!-- 3. موجودی قرارداد DAI - اولویت سوم -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(0,123,255,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#007bff;font-size:1.2rem;margin-bottom:0.3rem;">💵</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">موجودی قرارداد</div>
            <div style="color:#007bff;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-dai-balance" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">Contract Balance</div>
          </div>
          
          <!-- 4. قیمت توکن - اولویت چهارم -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(0,255,136,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#00ff88;font-size:1.2rem;margin-bottom:0.3rem;">💲</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">قیمت توکن IAM</div>
            <div style="color:#00ff88;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-token-price" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">DAI per IAM</div>
          </div>
          
          <!-- 5. قیمت ثبت‌نام - اولویت پنجم -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(138,43,226,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#8a2be2;font-size:1.2rem;margin-bottom:0.3rem;">🎫</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">قیمت ثبت‌نام</div>
            <div style="color:#8a2be2;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-registration-price" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">IAM per Registration</div>
            <div style="color:#f7931e;font-size:0.7rem;font-family:monospace;font-weight:bold;margin-top:0.2rem;" id="dashboard-registration-price-dai">-</div>
            <div style="color:#888;font-size:0.6rem;margin-top:0.1rem;">≈ DAI</div>
          </div>
          
          <!-- بقیه کارت‌ها -->
          
          <!-- Total Points Card -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(167,134,255,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#a786ff;font-size:1.2rem;margin-bottom:0.3rem;">🎯</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">کل پوینت‌ها</div>
            <div style="color:#a786ff;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="total-points" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">Binary Points</div>
          </div>
          
          <!-- Point Value Card -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(0,255,136,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#00ff88;font-size:1.2rem;margin-bottom:0.3rem;">💎</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">ارزش هر پوینت</div>
            <div style="color:#00ff88;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-point-value" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">IAM per Point</div>
            <div style="color:#f7931e;font-size:0.7rem;font-family:monospace;font-weight:bold;margin-top:0.2rem;" id="dashboard-point-value-dai">-</div>
            <div style="color:#888;font-size:0.6rem;margin-top:0.1rem;">≈ DAI</div>
          </div>
          
          <!-- Help Fund Card -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(220,53,69,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#dc3545;font-size:1.2rem;margin-bottom:0.3rem;">💝</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">صندوق کمک</div>
            <div style="color:#dc3545;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-cashback-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">Cashback Pool</div>
            <div style="color:#f7931e;font-size:0.7rem;font-family:monospace;font-weight:bold;margin-top:0.2rem;" id="dashboard-cashback-value-dai">-</div>
            <div style="color:#888;font-size:0.6rem;margin-top:0.1rem;">≈ DAI</div>
          </div>
          
          <!-- Wallet Count Card -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(255,165,0,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#ffa500;font-size:1.2rem;margin-bottom:0.3rem;">👛</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">تعداد ولت‌ها</div>
            <div style="color:#ffa500;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="dashboard-wallets-count" class="dashboard-value smooth-value-transition numeric-value">-</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">Connected Wallets</div>
          </div>
          
          <!-- Network Status Card -->
          <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid rgba(40,167,69,0.2);text-align:center;min-width:140px;flex:1;max-width:180px;">
            <div style="color:#28a745;font-size:1.2rem;margin-bottom:0.3rem;">🌐</div>
            <div style="color:#fff;font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;">وضعیت شبکه</div>
            <div style="color:#28a745;font-size:0.9rem;font-family:monospace;font-weight:bold;" id="network-status">Polygon</div>
            <div style="color:#888;font-size:0.7rem;margin-top:0.2rem;">Active</div>
          </div>
        </div>
        
        <!-- Last Update Info -->
        <div style="text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.1);">
          <div style="color:#888;font-size:0.8rem;font-family:monospace;margin-bottom:0.5rem;">
            آخرین بروزرسانی: <span id="blockchain-last-update">-</span>
          </div>
          <!-- دکمه بروزرسانی حذف شد -->
        </div>
        

      </div>

      <!-- رنکینگ کاربران برتر -->
      <div id="top-users-ranking" class="modern-card" style="margin-top: 2rem; padding: 1rem;">
        <!-- Ranking content is loaded by JavaScript -->
        <div style="text-align: center; padding: 1rem;">
          <div class="modern-heading-2" style="margin-bottom: 1rem;">🏆 رنکینگ کاربران برتر</div>
          <div style="color: var(--modern-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">برای مشاهده 10 کاربر برتر بر اساس لایک‌ها، دکمه زیر را کلیک کنید</div>
          <div class="modern-alert modern-alert-info" style="margin-bottom: 1rem;">
            💡 <strong>نکته:</strong> می‌توانید برای هر کاربر لایک یا دیسلایک کنید و همچنین با وارد کردن ایندکس، برای هر کاربری رای دهید
          </div>
          <button onclick="loadRanking()" class="modern-btn modern-btn-primary" style="font-size: 1rem;">
            🔄 Loading ranking
          </button>
        </div>
      </div>



      <script>
      document.addEventListener('DOMContentLoaded', function() {
        
        // پاپ‌اپ قوانین سواپ حذف شد
        
        // (swap pre-modal removed)
        // نمایش پاپ آپ خوشامدگویی
        function showWelcomeModal() {
          console.log('🔄 showWelcomeModal called');
          const modal = document.getElementById('welcome-modal');
          const closeBtn = document.getElementById('welcome-modal-close');
          const understandBtn = document.getElementById('welcome-understand-btn');
          console.log('Modal element found:', !!modal);
          
          // Always show the welcome modal on each visit
          
          // نمایش مودال بعد از 1.5 ثانیه
          console.log('⏱️ Setting timeout for modal display');
          setTimeout(() => {
            console.log('⚡ Timeout reached, showing modal');
            if (modal) {
              modal.style.display = 'flex';
              document.body.style.overflow = 'hidden';
              console.log('✅ Modal display set to flex');
              startWelcomeTypewriter();
            } else {
              console.error('❌ Modal element not found!');
            }
          }, 1500);
          
          function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = '';
            // Do not persist seen flag; always show on next visit
          }
          
          // تابع بستن پاپ اپ
          window.closeWelcomeModal = function() {
            // متوقف کردن تایمر
            if (readingTimerInterval) {
              clearInterval(readingTimerInterval);
            }
            const modal = document.getElementById('welcome-modal');
            if (modal) {
              modal.style.display = 'none';
              document.body.style.overflow = '';
            }
          };
          
          if (closeBtn) closeBtn.onclick = function() {
            // بررسی اینکه آیا چک‌باکس‌ها وجود دارند و آیا همه تیک خورده‌اند
            const acceptButton = document.getElementById('acceptButton');
            if (acceptButton && acceptButton.disabled) {
              // اگر دکمه پذیرش غیرفعال است، اجازه بستن نده
              return;
            }
            closeModal();
          };
          if (understandBtn) understandBtn.onclick = closeModal;
          
          // بستن با کلیک روی بک‌گراند (فقط اگر شرایط پذیرفته نشده باشد)
          modal.onclick = function(e) {
            if (e.target === modal) {
              // بررسی اینکه آیا چک‌باکس‌ها وجود دارند و آیا همه تیک خورده‌اند
              const acceptButton = document.getElementById('acceptButton');
              if (acceptButton && acceptButton.disabled) {
                // اگر دکمه پذیرش غیرفعال است، اجازه بستن نده
                return;
              }
              closeModal();
            }
          };
        }

        // بررسی تعداد نمایش پاپ آپ در حافظه کش
        function shouldShowWelcomeModal() {
          const showCount = localStorage.getItem('welcomeModalShowCount') || 0;
          return showCount < 3;
        }

        // افزایش شمارنده نمایش پاپ آپ
        function incrementShowCount() {
          const currentCount = parseInt(localStorage.getItem('welcomeModalShowCount') || 0);
          localStorage.setItem('welcomeModalShowCount', currentCount + 1);
        }

        // تایمر مطالعه
        let readingTimerInterval;
        let readingSeconds = 0;
        
        function startReadingTimer() {
          readingSeconds = 0;
          readingTimerInterval = setInterval(() => {
            readingSeconds++;
            const minutes = Math.floor(readingSeconds / 60);
            const seconds = readingSeconds % 60;
            const timerDisplay = document.getElementById('readingTimer');
            if (timerDisplay) {
              timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // بعد از 30 ثانیه مطالعه، چک‌باکس‌ها را فعال کن
            if (readingSeconds >= 30) {
              enableCheckboxes();
              clearInterval(readingTimerInterval);
            }
          }, 1000);
        }
        
        // فعال‌سازی چک‌باکس‌ها بعد از مطالعه
        function enableCheckboxes() {
          const condition1 = document.getElementById('condition1');
          const condition2 = document.getElementById('condition2');
          const condition3 = document.getElementById('condition3');
          const acceptButton = document.getElementById('acceptButton');
          
          if (condition1 && condition2 && condition3 && acceptButton) {
            // فعال‌سازی چک‌باکس‌ها
            condition1.disabled = false;
            condition2.disabled = false;
            condition3.disabled = false;
            
            // تغییر متن چک‌باکس‌ها
            const spans = document.querySelectorAll('#welcome-typewriter-content label span');
            if (spans.length >= 3) {
              spans[0].textContent = '✅ من شرایط پذیرش را مطالعه کرده و می‌پذیرم';
              spans[0].style.opacity = '1';
              spans[1].textContent = '🎓 من خواهان یادگیری این بازار هستم';
              spans[1].style.opacity = '1';
              spans[2].textContent = '📚 من از قواعد و قوانین ارزهای دیجیتال آشنایی دارم';
              spans[2].style.opacity = '1';
            }
            
            // تغییر متن دکمه
            acceptButton.textContent = '🔓 Enter Platform';
            acceptButton.style.background = 'linear-gradient(135deg,#00ff88,#00cc6a)';
            acceptButton.style.color = '#000';
            acceptButton.style.cursor = 'pointer';
            
            // تغییر متن تایمر
            const timerText = document.querySelector('#welcome-typewriter-content p strong');
            if (timerText) {
              timerText.textContent = '✅ مطالعه کامل شد!';
            }
          }
        }
        
        // تایپ‌رایتر پاپ آپ شرایط و قوانین
        function startWelcomeTypewriter() {
          const container = document.getElementById('welcome-typewriter-content');
          if (!container) {
            console.error('Container not found');
            return;
          }
          
          console.log('Starting typewriter...');
          
          // شروع تایمر مطالعه از ابتدای تایپ‌رایتر
          if (typeof startReadingTimer === 'function') {
            startReadingTimer();
          }
          
          const welcomeText = `<div style="background:rgba(255,193,7,0.08);padding:1.2em 1.4em;border-radius:12px;border-right:4px solid #ffc107;margin-bottom:1.2em;">
  <p style="margin:0;color:#e0e6f7;font-weight:500;">
    ⚠️ <strong>Important Notice:</strong> Before entering the platform, please read and accept the following terms and conditions.
  </p>
</div>

<h3 style="color:#a786ff;font-size:1.25em;margin:0 0 0.8em 0;">شرایط پذیرش</h3>
<div style="background:rgba(0,255,136,0.05);padding:1em;border-radius:8px;border-right:3px solid #00ff88;margin-bottom:1em;">
  <p style="margin:0;color:#e0e6f7;line-height:1.6;">
    <strong>✅ من شرایط زیر را می‌پذیرم:</strong><br>
    • سرمایه‌گذاری در ارزهای دیجیتال با ریسک همراه است<br>
    • تمامی تراکنش‌ها غیرقابل بازگشت و شفاف هستند<br>
    • مسئولیت تصمیمات مالی بر عهده خودم است<br>
    • قوانین و مقررات محلی را رعایت می‌کنم
  </p>
</div>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">تمایل به یادگیری</h3>
<div style="background:rgba(138,43,226,0.05);padding:1em;border-radius:8px;border-right:3px solid #8a2be2;margin-bottom:1em;">
  <p style="margin:0;color:#e0e6f7;line-height:1.6;">
    <strong>🎓 من خواهان یادگیری این بازار هستم:</strong><br>
    • مطالعه مستمر در زمینه ارزهای دیجیتال<br>
    • آشنایی با مفاهیم بلاکچین و قراردادهای هوشمند<br>
    • یادگیری مدیریت ریسک و سرمایه<br>
    
  </p>
</div>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">آشنایی با قواعد ارزهای دیجیتال</h3>
<div style="background:rgba(255,69,0,0.05);padding:1em;border-radius:8px;border-right:3px solid #ff4500;margin-bottom:1em;">
  <p style="margin:0;color:#e0e6f7;line-height:1.6;">
    <strong>📚 من از قواعد و قوانین ارزهای دیجیتال آشنایی دارم:</strong><br>
    • نحوه کارکرد کیف پول‌های دیجیتال<br>
    • اصول امنیت و حفاظت از کلیدهای خصوصی<br>
    • آشنایی با شبکه‌های مختلف (اتریوم، پالیگان)<br>
    • درک مفاهیم گس (Gas) و تایید تراکنش‌ها
  </p>
</div>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">مشخصات قرارداد هوشمند</h3>
<p style="margin-top:0;">
  <strong>آدرس قرارداد:</strong> 0xA3d5445e3e57dDA57C69184e88A93C9f6f7f9aA6<br>
  <strong>شبکه:</strong> Polygon (MATIC)<br>
  <strong>استاندارد:</strong> ERC-20<br>
  <strong>نام توکن:</strong> IAM Token<br>
  <strong>نماد:</strong> IAM<br>
  <strong>تعداد اعشار:</strong> 18
</p>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">توابع اصلی قرارداد</h3>
<ul style="list-style:none;padding:0;margin:0;">
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>register()</strong> - ثبت‌نام کاربر جدید
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>transfer()</strong> - انتقال توکن بین کیف پول‌ها
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>getTokenPrice()</strong> - Get current token price
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>getPointValue()</strong> - Get value of each point
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>buyTokens()</strong> - خرید توکن با DAI
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">🔹</span>
    <strong>sellTokens()</strong> - Sell tokens and receive DAI
  </li>
</ul>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">ساختار داده‌ها</h3>
<p style="margin-top:0;">
  <strong>User Struct:</strong><br>
  - address: آدرس کیف پول کاربر<br>
  - uint256 index: شماره ایندکس کاربر<br>
  - bool activated: وضعیت فعال بودن<br>
  - uint256 registrationTime: زمان ثبت‌نام<br>
  - address referrer: معرف کاربر<br>
  - uint256 totalPoints: کل پوینت‌های کسب شده
</p>

<h3 style="color:#a786ff;font-size:1.25em;margin:1.1em 0 0.6em 0;">متغیرهای مهم</h3>
<ul style="list-style:none;padding:0;margin:0;">
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">✅</span>
    <strong>totalSupply:</strong> کل عرضه توکن IAM
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">✅</span>
    <strong>registrationPrice:</strong> قیمت ثبت‌نام (به IAM)
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">✅</span>
    <strong>tokenPrice:</strong> قیمت فعلی توکن (به DAI)
  </li>
  <li style="margin-bottom:0.65em;padding-right:1.5em;position:relative;">
    <span style="position:absolute;right:0;color:#00ff88;">✅</span>
    <strong>pointValue:</strong> ارزش هر پوینت (به IAM)
  </li>
</ul>

<div style="margin-top:1.2em;background:rgba(167,134,255,0.08);padding:1em;border-radius:10px;border-right:4px solid #a786ff;">
  <p style="margin:0;">تمام تراکنش‌ها در <strong>PolygonScan</strong> قابل ردیابی هستند و کد قرارداد <strong>باز و قابل بررسی</strong> است.</p>
</div>`;
          
          let i = 0;
          const speed = 15; // سرعت تایپ‌رایتر (میلی‌ثانیه)
          
          function typeWriter() {
            if (i < welcomeText.length) {
              let char = welcomeText.charAt(i);
              
              // اگر کاراکتر < باشد، کل تگ HTML را یکجا اضافه کن
              if (char === '<') {
                let tagEnd = welcomeText.indexOf('>', i);
                if (tagEnd !== -1) {
                  container.innerHTML += welcomeText.substring(i, tagEnd + 1);
                  i = tagEnd + 1;
                  // auto-scroll as content grows
                  container.scrollTop = container.scrollHeight;
                  setTimeout(typeWriter, 5); // تگ‌ها سریع اضافه شوند
                  return;
                }
              }
              
              container.innerHTML += char;
              i++;
              // auto-scroll as content grows
              container.scrollTop = container.scrollHeight;
              const delay = (char === '.' || char === '!' || char === '؟' || char === '،') ? speed * 3 : speed;
              setTimeout(typeWriter, delay);
            } else {
              // تایپ‌رایتر تمام شد، حالا چک‌باکس‌ها را نمایش بده
              if (typeof showCheckboxes === 'function') {
                showCheckboxes();
              }
            }
          }
          
          typeWriter();
        }
        
        // تابع تست برای تایپ‌رایتر
        function testTypewriter() {
          console.log('Testing typewriter...');
          const container = document.getElementById('welcome-typewriter-content');
          if (container) {
            container.innerHTML = 'تست تایپ‌رایتر...';
            setTimeout(() => {
              startWelcomeTypewriter();
            }, 1000);
          }
        }

        // نمایش چک‌باکس‌های شرایط
        function showCheckboxes() {
          const container = document.getElementById('welcome-typewriter-content');
          if (!container) return;

          const checkboxesHTML = `
            <div style="margin-top:2em;background:rgba(255,193,7,0.1);padding:1.5em;border-radius:12px;border:2px solid #ffc107;">
              <h3 style="color:#ffc107;margin-bottom:1em;text-align:center;">✅ تایید شرایط و قوانین</h3>
              
              <div style="margin-bottom:1em;">
                <label style="display:flex;align-items:center;cursor:pointer;color:#e0e6f7;">
                  <input type="checkbox" id="condition1" style="margin-left:0.5em;transform:scale(1.2);" onchange="checkAllConditions()" disabled>
                  <span style="opacity:0.6;">⏳ من شرایط پذیرش را مطالعه کرده و می‌پذیرم</span>
                </label>
              </div>
              
              <div style="margin-bottom:1em;">
                <label style="display:flex;align-items:center;cursor:pointer;color:#e0e6f7;">
                  <input type="checkbox" id="condition2" style="margin-left:0.5em;transform:scale(1.2);" onchange="checkAllConditions()" disabled>
                  <span style="opacity:0.6;">⏳ من خواهان یادگیری این بازار هستم</span>
                </label>
              </div>
              
              <div style="margin-bottom:1em;">
                <label style="display:flex;align-items:center;cursor:pointer;color:#e0e6f7;">
                  <input type="checkbox" id="condition3" style="margin-left:0.5em;transform:scale(1.2);" onchange="checkAllConditions()" disabled>
                  <span style="opacity:0.6;">⏳ من از قواعد و قوانین ارزهای دیجیتال آشنایی دارم</span>
                </label>
              </div>
              
              <div style="text-align:center;margin-top:1.5em;">
                <button id="acceptButton" onclick="acceptConditions()" style="background:linear-gradient(135deg,#666,#444);color:#999;border:none;padding:0.8em 2em;border-radius:8px;font-weight:bold;cursor:not-allowed;opacity:0.5;pointer-events:none;" disabled>
                  ⏳ لطفاً ابتدا مفاد را مطالعه کنید
                </button>
              </div>
            </div>
          `;
          
          container.innerHTML += checkboxesHTML;
          container.scrollTop = container.scrollHeight;
        }

        // تایمر مطالعه
        // تکراری حذف شد
        
        function startReadingTimer() {
          readingSeconds = 0;
          readingTimerInterval = setInterval(() => {
            readingSeconds++;
            const minutes = Math.floor(readingSeconds / 60);
            const seconds = readingSeconds % 60;
            const timerDisplay = document.getElementById('readingTimer');
            if (timerDisplay) {
              timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // بعد از 30 ثانیه مطالعه، چک‌باکس‌ها را فعال کن
            if (readingSeconds >= 30) {
              enableCheckboxes();
              clearInterval(readingTimerInterval);
            }
          }, 1000);
        }
        
        // فعال‌سازی چک‌باکس‌ها بعد از مطالعه
        function enableCheckboxes() {
          const condition1 = document.getElementById('condition1');
          const condition2 = document.getElementById('condition2');
          const condition3 = document.getElementById('condition3');
          const acceptButton = document.getElementById('acceptButton');
          
          if (condition1 && condition2 && condition3 && acceptButton) {
            // فعال‌سازی چک‌باکس‌ها
            condition1.disabled = false;
            condition2.disabled = false;
            condition3.disabled = false;
            
            // تغییر متن چک‌باکس‌ها
            const spans = document.querySelectorAll('#welcome-typewriter-content label span');
            if (spans.length >= 3) {
              spans[0].textContent = '✅ من شرایط پذیرش را مطالعه کرده و می‌پذیرم';
              spans[0].style.opacity = '1';
              spans[1].textContent = '🎓 من خواهان یادگیری این بازار هستم';
              spans[1].style.opacity = '1';
              spans[2].textContent = '📚 من از قواعد و قوانین ارزهای دیجیتال آشنایی دارم';
              spans[2].style.opacity = '1';
            }
            
            // تغییر متن دکمه
            acceptButton.textContent = '🔓 Enter Platform';
            acceptButton.style.background = 'linear-gradient(135deg,#00ff88,#00cc6a)';
            acceptButton.style.color = '#000';
            acceptButton.style.cursor = 'pointer';
            
            // تغییر متن تایمر
            const timerText = document.querySelector('#welcome-typewriter-content p strong');
            if (timerText) {
              timerText.textContent = '✅ مطالعه کامل شد!';
            }
          }
        }
        
        // بررسی وضعیت تمام چک‌باکس‌ها
        function checkAllConditions() {
          const condition1 = document.getElementById('condition1');
          const condition2 = document.getElementById('condition2');
          const condition3 = document.getElementById('condition3');
          const acceptButton = document.getElementById('acceptButton');
          
          if (condition1 && condition2 && condition3 && acceptButton) {
            if (condition1.checked && condition2.checked && condition3.checked) {
              acceptButton.style.opacity = '1';
              acceptButton.style.pointerEvents = 'auto';
              acceptButton.disabled = false;
            } else {
              acceptButton.style.opacity = '0.5';
              acceptButton.style.pointerEvents = 'none';
              acceptButton.disabled = true;
            }
          }
        }

        // Accept terms and enter platform
        function acceptConditions() {
          // Stop timer
          if (readingTimerInterval) {
            clearInterval(readingTimerInterval);
          }
          incrementShowCount();
          closeWelcomeModal();
        }
        
        
        const text = `The IAM Continuous Profit Academy is an innovative, people-centric ecosystem established to provide fully decentralized and transparent financial, educational, and trading services. In this collection, your capital always remains under your control, whether in your personal exchange account, with a broker, or in a smart wallet connected to a decentralized contract.

Our Services:
• Providing specialized signals and auto-trading robots for financial markets
• Opportunity to act as an agent for individuals and IBs in brokerages
• Network marketing opportunities for friends who want to promote this collection
• You can benefit from Referral Shares.
• You can also achieve guaranteed profit by investing in the IAM fund and its incremental token.
• Comprehensive Forex and Cryptocurrency training
• Support for the decentralized IAM fund and IAM token
• Copy-trading services: If the IAM robot profits, you profit, and if it incurs a loss, you also incur a loss; no profit is withdrawn from your account during a loss, and IAM receives no share until the loss is recovered.
• Our motto: Your capital in your own account, your profit with us.`;
        const container = document.getElementById('IAM-typewriter');
        if (container) {
          let i = 0;
          const speed = 40; // ms per character (slower)
          function typeWriter() {
            if (i < text.length) {
              const char = text.charAt(i);
              if (char === '\\n' || char === '\n') {
                container.innerHTML += '<br>';
                i++;
                setTimeout(typeWriter, 350);
              } else {
                container.innerHTML += char;
                i++;
                setTimeout(typeWriter, speed);
              }
            }
          }
          typeWriter();
        }

        // Expand/collapse logic
        const wrapper = document.getElementById('IAM-typewriter-wrapper');
        const fade = document.getElementById('IAM-fade');
        const btn = document.getElementById('IAM-expand-btn');
        if (wrapper && fade && btn) {
          let expanded = false;
          btn.addEventListener('click', function() {
            expanded = !expanded;
            if (expanded) {
              wrapper.style.maxHeight = '2000px';
              fade.style.opacity = '0';
              btn.textContent = 'نمایش کمتر';
            } else {
              wrapper.style.maxHeight = '2.1em';
              fade.style.opacity = '1';
              btn.textContent = 'نمایش بیشتر';
            }
          });
        }
      });
      </script>

  <!-- Swap Section -->
  <div id="main-swap" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;">
    
    <div id="swap-main-content" style="display:block;">
    <div class="expand-header" style="padding:0 1.5rem;">
      <h2 style="margin:0 0 0.5rem 0;">🔄 تبدیل ارز</h2>
      <p style="margin:0 0 0.5rem 0;">تبدیل بین توکن‌های DAI و IAM</p>
    </div>
    <div class="expand-content" style="padding:0;">
      <div class="swap-container" style="max-width:600px;margin:0 auto;padding:1.5rem;">
        
        <!-- Swap Rules and Information -->
        <div class="swap-rules" style="background:linear-gradient(135deg,#232946,#181c2a);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;border:2px solid #00ff88;">
          <h3 style="color:#00ff88;margin-bottom:1rem;font-size:1.2rem;">📋 قوانین و راهنمای تبدیل</h3>
          
          <div style="margin-bottom:1rem;">
            <h4 style="color:#00ff88;margin-bottom:0.5rem;">🔄 نحوه تبدیل:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li>✅ <strong style="color:#00ff88;">DAI → IAM:</strong> خرید توکن IAM با DAI (نرخ متغیر)</li>
              <li>✅ <strong style="color:#00ff88;">IAM → DAI:</strong> Sell IAM tokens and receive DAI</li>
              <li>✅ کارمزد تبدیل: پویا (۲٪، ۲.۵٪ یا ۳٪ بر اساس موجودی DAI قرارداد)</li>
              <li>✅ حداقل مقدار تبدیل: بیش از 1 DAI یا بیش از 1 IAM</li>
            </ul>
          </div>
          
          <div style="margin-bottom:1rem;">
            <h4 style="color:#00ff88;margin-bottom:0.5rem;">💰 مزایای تبدیل:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li><strong style="color:#00ff88;">IAM:</strong> توکن اصلی پلتفرم - برای سرمایه‌گذاری و کسب درآمد</li>
              <li><strong style="color:#00ccff;">DAI:</strong> توکن استیبل - برای حفظ ارزش و معاملات روزانه</li>
              <li>🔄 تبدیل فوری و بدون نیاز به تایید اضافی</li>
              <li>📊 نرخ تبدیل بر اساس عرضه و تقاضا محاسبه می‌شود</li>
            </ul>
          </div>
          
          <div>
            <h4 style="color:#00ff88;margin-bottom:0.5rem;">⚠️ نکات مهم:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li>🔍 قبل از تبدیل، نرخ فعلی را بررسی کنید</li>
              <li>💰 موجودی کافی برای تبدیل + کارمزد داشته باشید</li>
              <li>⏱️ تبدیل‌ها فوری انجام می‌شوند</li>
              <li>📞 در صورت مشکل با پشتیبانی تماس بگیرید</li>
            </ul>
          </div>
        </div>
        <!-- Blockchain Information Dashboard (added to prevent not found errors) -->

        <form id="swapForm" class="swap-form">
          <div class="swap-row">
            <label for="swapDirection">نوع تبدیل:</label>
            <select id="swapDirection" required>
              <option value="dai-to-IAM">DAI → IAM</option>
              <option value="IAM-to-dai">IAM → DAI</option>
            </select>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">نوع تبدیل مورد نظر را انتخاب کنید</small>
          </div>
          
          <div class="swap-row">
            <label for="swapAmount">مقدار:</label>
            <div class="amount-input-group">
              <input type="number" id="swapAmount" placeholder="مقدار را وارد کنید" min="0" step="any" required>
              <button type="button" id="maxBtn" class="max-btn">حداکثر</button>
            </div>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">مقدار مورد نظر برای تبدیل را وارد کنید</small>
          </div>
          
          <div class="swap-row" id="swap-usd-converter-row" style="display:none;">
            <label for="swapUsdAmount">💰 معادل دلاری:</label>
            <div class="usd-converter-container" style="display:flex;gap:0.5rem;align-items:center;">
              <span style="color:#00ff88;font-weight:bold;">$</span>
              <input type="number" id="swapUsdAmount" placeholder="5.00" min="0" step="0.01" style="flex:1;">
              <button type="button" id="swapUsdToTokenBtn" style="
                background: linear-gradient(90deg,#00ff88,#a786ff);
                color: #181c2a;
                border: none;
                border-radius: 6px;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
              ">🔄 تبدیل</button>
            </div>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">مقدار دلاری وارد کنید تا به توکن تبدیل شود (مثل: 5 برای $5)</small>
          </div>
          
          <div id="swapRate" class="swap-rate">Exchange rate: Loading...</div>
          <div id="swapPreview" class="swap-preview"></div>
          <div id="swapLimitInfo" class="swap-limit-info" style="margin-top:0.5rem;color:#555;font-size:0.98em;"></div>
          
          <button type="submit" class="swap-btn">تبدیل</button>
          <div id="swapStatus" class="swap-status"></div>
        </form>
        
        <!-- Balance Check -->
        <div class="swap-balance-check" style="background:rgba(0,255,136,0.1);border-radius:8px;padding:1rem;margin-top:1.5rem;">
          <h4 style="color:#00ff88;margin-bottom:0.8rem;">💰 موجودی فعلی شما:</h4>
          <div class="swap-balance-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <div style="text-align:center;">
              <div style="color:#00ff88;font-weight:bold;">DAI</div>
              <div id="daiBalance" style="color:#b8c1ec;font-family:monospace;">-</div>
            </div>
            <div style="text-align:center;">
              <div style="color:#00ccff;font-weight:bold;">IAM</div>
              <div id="IAMBalance" style="color:#b8c1ec;font-family:monospace;">-</div>
              <div id="IAMUsdValue" style="color:#a786ff;font-size:0.8rem;margin-top:2px;">-</div>
            </div>
          </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transfer Section -->
  <div id="main-transfer" class="page-section expandable-container" style="width:100vw;max-width:none;margin:0;left:0;right:0;padding:0.5rem 0;display:none;">
    <div class="expand-header">
      <h2 style="margin:0 0 0.5rem 0;">💸 ترانسفر</h2>
      <p style="margin:0 0 0.5rem 0;">انتقال توکن به کیف پول دیگر</p>
    </div>
    <div class="expand-content" style="padding:0;">
      <div class="transfer-container" style="max-width:600px;margin:0;padding:1.5rem;">
        
        <!-- Transfer Rules and Information -->
        <div class="transfer-rules" style="background:linear-gradient(135deg,#232946,#181c2a);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;border:2px solid #a786ff;">
          <h3 style="color:#00ff88;margin-bottom:1rem;font-size:1.2rem;">📋 قوانین و راهنمای انتقال</h3>
          
          <div style="margin-bottom:1rem;">
            <h4 style="color:#a786ff;margin-bottom:0.5rem;">🔒 امنیت انتقال:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li>✅ انتقال‌ها غیرقابل بازگشت هستند - قبل از ارسال دوباره بررسی کنید</li>
              <li>✅ آدرس مقصد را با دقت وارد کنید - یک کاراکتر اشتباه باعث از دست رفتن دارایی می‌شود</li>
              <li>✅ ابتدا مقدار کمی ارسال کنید تا از صحت آدرس مطمئن شوید</li>
              <li>✅ از کیف پول‌های معتبر و امن استفاده کنید</li>
            </ul>
          </div>
          
          <div style="margin-bottom:1rem;">
            <h4 style="color:#a786ff;margin-bottom:0.5rem;">💰 انواع توکن قابل انتقال:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li><strong style="color:#00ff88;">DAI:</strong> توکن استیبل با ارزش 1 دلار - برای معاملات روزانه</li>
              <li><strong style="color:#a786ff;">POL (MATIC):</strong> توکن شبکه Polygon - برای پرداخت کارمزد تراکنش‌ها</li>
              <li><strong style="color:#00ccff;">IAM:</strong> توکن اصلی پلتفرم - برای سرمایه‌گذاری و کسب درآمد</li>
            </ul>
          </div>
          
          <div style="margin-bottom:1rem;">
            <h4 style="color:#a786ff;margin-bottom:0.5rem;">⚡ کارمزد تراکنش:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li>💸 کارمزد شبکه Polygon: ~0.001-0.01 MATIC (بسته به ترافیک شبکه)</li>
              <li>⏱️ زمان تایید: 2-5 ثانیه (معمولاً)</li>
              <li>🔍 تراکنش‌ها در PolygonScan قابل ردیابی هستند</li>
            </ul>
          </div>
          
          <div>
            <h4 style="color:#a786ff;margin-bottom:0.5rem;">🎯 نکات مهم:</h4>
            <ul style="color:#b8c1ec;line-height:1.6;margin:0;padding-right:1rem;">
              <li>📱 می‌توانید با ایندکس کاربر جستجو کنید تا آدرس را پیدا کنید</li>
              <li>🔍 قبل از انتقال، موجودی خود را بررسی کنید</li>
              <li>⚠️ مقدار انتقال + کارمزد شبکه باید کمتر از موجودی باشد</li>
              <li>📞 در صورت مشکل با پشتیبانی تماس بگیرید</li>
            </ul>
          </div>
        </div>
        
        <form id="transferForm" class="transfer-form">
          <div class="transfer-row">
            <label for="transferTo">آدرس مقصد:</label>
            <input type="text" id="transferTo" placeholder="0x..." required style="direction:ltr;">
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">آدرس کیف پول مقصد را وارد کنید (42 کاراکتر)</small>
          </div>
          <div class="transfer-row" style="margin-bottom:0.5rem;">
            <label for="searchIndex">جستجو با ایندکس:</label>
            <div class="search-index-container" style="display:flex;gap:0.5rem;align-items:center;">
              <input type="number" id="searchIndex" placeholder="ایندکس کاربر" min="0" style="width:120px;direction:ltr;">
              <button type="button" id="searchIndexBtn" class="transfer-btn" style="padding:0.5rem 1.2rem;font-size:1rem;min-width:80px;">جستجو</button>
            </div>
            <div id="searchIndexStatus" class="transfer-status" style="margin-top:0.3rem;"></div>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">ایندکس کاربر را وارد کنید تا آدرس به طور خودکار پر شود</small>
          </div>
          <div class="transfer-row">
            <label for="transferAmount">مقدار:</label>
            <input type="number" id="transferAmount" placeholder="مقدار را وارد کنید" min="0" step="any" required>
            <button type="button" id="maxAmountBtn" style="
              background: linear-gradient(90deg,#ff6b6b,#ee5a52);
              color: #fff;
              border: none;
              border-radius: 6px;
              padding: 0.4rem 0.8rem;
              font-size: 0.8rem;
              cursor: pointer;
              margin-top: 0.5rem;
              transition: all 0.3s ease;
              width: auto;
              display: inline-block;
            ">🔥 حداکثر موجودی</button>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">مقدار انتقال را وارد کنید یا روی "حداکثر" کلیک کنید</small>
          </div>
          <div class="transfer-row" id="usd-converter-row" style="display:none;">
            <label for="transferUsdAmount">💰 معادل دلاری (فقط برای IAM):</label>
            <div class="usd-converter-container" style="display:flex;gap:0.5rem;align-items:center;">
              <span style="color:#00ff88;font-weight:bold;">$</span>
              <input type="number" id="transferUsdAmount" placeholder="5.00" min="0" step="0.01" style="flex:1;">
              <button type="button" id="usdToIAMBtn" style="
                background: linear-gradient(90deg,#00ff88,#a786ff);
                color: #181c2a;
                border: none;
                border-radius: 6px;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
              ">🔄 تبدیل</button>
            </div>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">مقدار دلاری وارد کنید تا به IAM تبدیل شود (مثل: 5 برای $5)</small>
          </div>
          <div class="transfer-row">
            <label for="transferToken">نوع توکن:</label>
            <select id="transferToken" required>
              <option value="dai" selected>DAI</option>
              <option value="pol">POL</option>
              <option value="IAM">IAM</option>
            </select>
            <small style="color:#b8c1ec;font-size:0.85rem;margin-top:0.3rem;display:block;">نوع توکن مورد نظر برای انتقال را انتخاب کنید</small>
          </div>
          
          <!-- Balance Check -->
          <div style="background:rgba(167,134,255,0.1);border-radius:8px;padding:1rem;margin-bottom:1rem;" class="balance-check">
            <h4 style="color:#a786ff;margin-bottom:0.8rem;">💰 موجودی فعلی شما:</h4>
            <div class="balance-check-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
              <div style="text-align:center;">
                <div style="color:#00ff88;font-weight:bold;">DAI</div>
                <div id="transfer-dai-balance" style="color:#b8c1ec;font-family:monospace;">-</div>
              </div>
              <div style="text-align:center;">
                <div style="color:#a786ff;font-weight:bold;">POL</div>
                <div id="transfer-poly-balance" style="color:#b8c1ec;font-family:monospace;">-</div>
              </div>
              <div style="text-align:center;">
                <div style="color:#00ccff;font-weight:bold;">IAM</div>
                <div id="transfer-IAM-balance" style="color:#b8c1ec;font-family:monospace;">-</div>
                <div id="transfer-IAM-usd" style="color:#a786ff;font-size:0.8rem;margin-top:2px;">-</div>
              </div>
            </div>
          </div>
          
          <button type="submit" class="transfer-btn">انتقال</button>
          <div id="transferStatus" class="transfer-status"></div>
        </form>
      </div>
    </div>
  </div>

  




    
    <script src="js/smooth-value-updater.js"></script>
    <script src="js/smart-dashboard-updater.js"></script>
    <script src="js/central-dashboard-updater.js"></script>
    <script src="js/test-address-config.js"></script>
    <script src="js/config.js"></script>
    <script>
      // بررسی لود شدن config.js
      console.log('🔍 بررسی لود شدن config.js...');
      setTimeout(() => {
        console.log('displayTopUsersRanking موجود:', typeof window.displayTopUsersRanking);
        console.log('voteForIndex موجود:', typeof window.voteForIndex);
        if (typeof window.displayTopUsersRanking !== 'function') {
          console.error('❌ config.js درست لود نشده است!');
        } else {
          console.log('✅ config.js با موفقیت لود شد');
        }
      }, 1000);
    </script>
  <script src="js/reports.js"></script>
  <script src="js/web3-interactions.js"></script>
  <script src="js/main.js"></script>
  <script src="js/network.js?v=5.7"></script>
  <script src="js/network-database.js?v=5.8"></script>
  <script src="js/mobile-user-popup.js"></script>
  <script src="js/profile.js?v=5.7"></script>
  
  <script src="js/homepage.js?v=5.8"></script>

  <style>
    /* Fix for chart width issues */
    #price-chart-section {
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden !important;
    }
    
    #price-chart-canvas,
    #point-chart-canvas {
      width: 100% !important;
      max-width: 100% !important;
      height: 150px !important;
      box-sizing: border-box !important;
    }
    
    @media (max-width: 768px) {
      #price-chart-canvas,
      #point-chart-canvas {
        height: 120px !important;
      }
    }
    
    /* Transfer Status Styles */
    .transfer-status {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .transfer-status.success {
      background: rgba(0, 255, 136, 0.1);
      color: #00ff88;
      border: 1px solid rgba(0, 255, 136, 0.3);
    }
    
    .transfer-status.error {
      background: rgba(255, 68, 68, 0.1);
      color: #ff4444;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }
    
    .transfer-status.loading {
      background: rgba(167, 134, 255, 0.1);
      color: #a786ff;
      border: 1px solid rgba(167, 134, 255, 0.3);
    }
    
    /* Transfer Form Improvements */
    .transfer-form {
      background: linear-gradient(135deg, #232946, #181c2a);
      border-radius: 12px;
      padding: 1.5rem;
      border: 2px solid #a786ff;
    }
    
    .transfer-row {
      margin-bottom: 1.5rem;
    }
    
    .transfer-row label {
      display: block;
      color: #a786ff;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .transfer-row input,
    .transfer-row select {
      width: 100%;
      padding: 0.8rem;
      border-radius: 8px;
      border: 2px solid #a786ff;
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
      font-size: 0.95rem;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    
    .transfer-row input:focus,
    .transfer-row select:focus {
      outline: none;
      border-color: #00ff88;
    }
    
    .transfer-btn {
      background: linear-gradient(90deg, #00ff88, #a786ff);
      color: #181c2a;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 1rem 2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    
    .transfer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
    }
    
    .transfer-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Responsive Design for Transfer Section */
    @media (max-width: 768px) {
      #main-transfer {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        left: 0 !important;
        right: 0 !important;
        padding: 0.5rem !important;
      }
      

      
      .transfer-container {
        max-width: 100% !important;
        padding: 0.8rem !important;
        margin: 0 !important;
        width: 100% !important;
      }
      
      .transfer-form {
        padding: 0.8rem !important;
        border-radius: 8px !important;
      }
      
      .transfer-row {
        margin-bottom: 0.8rem !important;
      }
      
      .transfer-row label {
        font-size: 0.9rem !important;
        margin-bottom: 0.3rem !important;
      }
      
      .transfer-row input,
      .transfer-row select {
        padding: 0.6rem !important;
        font-size: 0.9rem !important;
        border-radius: 6px !important;
      }
      
      .transfer-btn {
        padding: 0.7rem 1.2rem !important;
        font-size: 0.9rem !important;
        border-radius: 6px !important;
      }
      
      /* Balance grid responsive */
      .balance-check {
        padding: 0.8rem !important;
        border-radius: 6px !important;
      }
      
      .balance-check .balance-check-grid {
        grid-template-columns: 1fr !important;
        gap: 0.6rem !important;
      }
      
      .balance-check h4 {
        font-size: 1rem !important;
        margin-bottom: 0.6rem !important;
      }
      
      /* Search index row responsive */
      .search-index-container {
        flex-direction: column !important;
        gap: 0.4rem !important;
      }
      
      .search-index-container input {
        width: 100% !important;
        min-width: auto !important;
      }
      
      .search-index-container button {
        width: 100% !important;
        min-width: auto !important;
        padding: 0.5rem !important;
      }
      
      /* USD converter row responsive */
      .usd-converter-container {
        flex-direction: column !important;
        gap: 0.4rem !important;
      }
      
      .usd-converter-container input {
        width: 100% !important;
      }
      
      .usd-converter-container button {
        width: 100% !important;
        padding: 0.5rem !important;
      }
      
      /* Rules section responsive */
      .transfer-rules {
        padding: 0.8rem !important;
        border-radius: 8px !important;
        margin-bottom: 1rem !important;
      }
      
      .transfer-rules h3 {
        font-size: 1.1rem !important;
        margin-bottom: 0.8rem !important;
      }
      
      .transfer-rules h4 {
        font-size: 0.95rem !important;
        margin-bottom: 0.4rem !important;
      }
      
      .transfer-rules ul {
        font-size: 0.8rem !important;
        line-height: 1.4 !important;
        padding-right: 0.8rem !important;
      }
      
      .transfer-rules li {
        margin-bottom: 0.3rem !important;
      }
      
      /* Small text responsive */
      .transfer-row small {
        font-size: 0.75rem !important;
        margin-top: 0.2rem !important;
      }
      
      /* Max amount button responsive */
      #maxAmountBtn {
        padding: 0.4rem 0.8rem !important;
        font-size: 0.8rem !important;
        margin-top: 0.4rem !important;
        width: 100% !important;
      }
    }
    
    @media (max-width: 480px) {
      #main-transfer {
        padding: 0.3rem !important;
      }
      

      
      .transfer-container {
        padding: 0.6rem !important;
        margin: 0 !important;
        width: 100% !important;
      }
      
      .transfer-form {
        padding: 0.6rem !important;
      }
      
      .transfer-row {
        margin-bottom: 0.6rem !important;
      }
      
      .transfer-row label {
        font-size: 0.85rem !important;
      }
      
      .transfer-row input,
      .transfer-row select {
        padding: 0.5rem !important;
        font-size: 0.85rem !important;
      }
      
      .transfer-btn {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
      }
      
      .balance-check {
        padding: 0.6rem !important;
      }
      
      .transfer-rules {
        padding: 0.6rem !important;
      }
      
      .transfer-rules h3 {
        font-size: 1rem !important;
      }
      
      .transfer-rules h4 {
        font-size: 0.9rem !important;
      }
      
      .transfer-rules ul {
        font-size: 0.75rem !important;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {

      
      .transfer-container {
        max-width: 90% !important;
        padding: 1.2rem !important;
        margin: 0 auto !important;
      }
      
      .transfer-form {
        padding: 1.2rem !important;
      }
      
      .balance-check .balance-check-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem !important;
      }
    }
    
    @media (min-width: 1025px) {

      
      .transfer-container {
        max-width: 700px !important;
        padding: 1.5rem !important;
        margin: 0 auto !important;
      }
      
      .transfer-form {
        padding: 1.5rem !important;
      }
      
      .transfer-row {
        margin-bottom: 1.5rem !important;
      }
      
      .balance-check .balance-check-grid {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 1rem !important;
      }
    }
    
    /* Responsive Design for Swap Section */
    @media (max-width: 768px) {
      #main-swap {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        left: 0 !important;
        right: 0 !important;
        padding: 0.5rem !important;
      }
      
      .swap-container {
        max-width: 100% !important;
        padding: 0.8rem !important;
        margin: 0 !important;
        width: 100% !important;
      }
      
      .swap-form {
        padding: 0.8rem !important;
        border-radius: 8px !important;
      }
      
      .swap-row {
        margin-bottom: 0.8rem !important;
      }
      
      .swap-row label {
        font-size: 0.9rem !important;
        margin-bottom: 0.3rem !important;
      }
      
      .swap-row input,
      .swap-row select {
        padding: 0.6rem !important;
        font-size: 0.9rem !important;
        border-radius: 6px !important;
      }
      
      .swap-btn {
        padding: 0.7rem 1.2rem !important;
        font-size: 0.9rem !important;
        border-radius: 6px !important;
      }
      
      /* Swap rules responsive */
      .swap-rules {
        padding: 0.8rem !important;
        border-radius: 8px !important;
        margin-bottom: 1rem !important;
      }
      
      .swap-rules h3 {
        font-size: 1.1rem !important;
        margin-bottom: 0.8rem !important;
      }
      
      .swap-rules h4 {
        font-size: 0.95rem !important;
        margin-bottom: 0.4rem !important;
      }
      
      .swap-rules ul {
        font-size: 0.8rem !important;
        line-height: 1.4 !important;
        padding-right: 0.8rem !important;
      }
      
      .swap-rules li {
        margin-bottom: 0.3rem !important;
      }
      
      /* Amount input group responsive */
      .amount-input-group {
        flex-direction: column !important;
        gap: 0.4rem !important;
      }
      
      .amount-input-group input {
        width: 100% !important;
      }
      
      .amount-input-group .max-btn {
        width: 100% !important;
        padding: 0.5rem !important;
      }
      
      /* USD converter responsive */
      .swap-row .usd-converter-container {
        flex-direction: column !important;
        gap: 0.4rem !important;
      }
      
      .swap-row .usd-converter-container input {
        width: 100% !important;
      }
      
      .swap-row .usd-converter-container button {
        width: 100% !important;
        padding: 0.5rem !important;
      }
      
      /* Balance check responsive */
      .swap-balance-check {
        padding: 0.8rem !important;
        border-radius: 6px !important;
      }
      
      .swap-balance-check .swap-balance-grid {
        grid-template-columns: 1fr !important;
        gap: 0.6rem !important;
      }
      
      .swap-balance-check h4 {
        font-size: 1rem !important;
        margin-bottom: 0.6rem !important;
      }
      
      /* Small text responsive */
      .swap-row small {
        font-size: 0.75rem !important;
        margin-top: 0.2rem !important;
      }
    }
    
    @media (max-width: 480px) {
      #main-swap {
        padding: 0.3rem !important;
      }
      
      .swap-container {
        padding: 0.6rem !important;
      }
      
      .swap-form {
        padding: 0.6rem !important;
      }
      
      .swap-row {
        margin-bottom: 0.6rem !important;
      }
      
      .swap-row label {
        font-size: 0.85rem !important;
      }
      
      .swap-row input,
      .swap-row select {
        padding: 0.5rem !important;
        font-size: 0.85rem !important;
      }
      
      .swap-btn {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
      }
      
      .swap-balance-check {
        padding: 0.6rem !important;
      }
      
      .swap-rules {
        padding: 0.6rem !important;
      }
      
      .swap-rules h3 {
        font-size: 1rem !important;
      }
      
      .swap-rules h4 {
        font-size: 0.9rem !important;
      }
      
      .swap-rules ul {
        font-size: 0.75rem !important;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      .swap-container {
        max-width: 90% !important;
        padding: 1.2rem !important;
        margin: 0 auto !important;
      }
      
      .swap-form {
        padding: 1.2rem !important;
      }
      
      .swap-balance-check .swap-balance-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem !important;
      }
    }
    
    @media (min-width: 1025px) {
      .swap-container {
        max-width: 700px !important;
        padding: 1.5rem !important;
        margin: 0 auto !important;
      }
      
      .swap-form {
        padding: 1.5rem !important;
      }
      
      .swap-row {
        margin-bottom: 1.5rem !important;
      }
      
      .swap-balance-check .swap-balance-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem !important;
      }
    }
  </style>
  
  <!-- تعریف متغیرهای مورد نیاز برای سواپ -->
  <script>
    // آدرس قرارداد DAI (DAI) در شبکه Polygon
    window.DAI_ADDRESS = '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';
    
    // ABI ساده برای DAI (DAI)
    window.DAI_ABI = [
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "value",
            "type": "uint256"
          }
        ],
        "name": "approve",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "owner",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "spender",
            "type": "address"
          }
        ],
        "name": "allowance",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "account",
            "type": "address"
          }
        ],
        "name": "balanceOf",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];
  </script>
  
  <script src="js/swap.js?v=5.7"></script>
  

 
  <!-- Charts removed -->
  
  <script>
    // Safe, no-op placeholder to avoid unhandled users(address) calls
    (async () => {
      try {
        await window.connectWallet();
        // Intentionally skip direct contract.users(address) call to avoid provider decode issues
      } catch (e) {
        // ignore
      }
    })();
  </script>

  <script>
    async function updateAboutWalletsCount() {
      try {
        if (!window.contractConfig || !window.contractConfig.contract) {
          await window.connectWallet();
        }
        const contract = window.contractConfig.contract;
        if (contract && contract.wallets) {
          const walletsCount = await contract.wallets();
          document.getElementById('about-wallets-count').innerText = walletsCount.toString();
        } else {
          document.getElementById('about-wallets-count').innerText = '-';
        }
      } catch (e) {
        document.getElementById('about-wallets-count').innerText = '-';
      }
    }
    // Hook into tab switching
    const aboutBtn = document.getElementById('tab-about-btn');
    if (aboutBtn) {
      aboutBtn.addEventListener('click', updateAboutWalletsCount);
    }
  </script>

  <script>
    function toggleDashboardChart(chartId, btn) {
      const chartDiv = document.getElementById(chartId);
      if (!chartDiv) return;
      const isOpen = chartDiv.style.display === 'block';
      chartDiv.style.display = isOpen ? 'none' : 'block';
      btn.textContent = isOpen ? '▼' : '▲';
      // Placeholder: Here you can load/render the chart if needed
    }
  </script>
  <!-- مودال افزودن/ویرایش ساب ادمین -->
  <div class="sub-admin-modal" id="sub-admin-modal">
    <div class="sub-admin-modal-content">
      <h3 id="modal-title">افزودن ساب ادمین جدید</h3>
      <form class="sub-admin-form" id="sub-admin-form">
        <div class="form-group">
          <label for="sub-admin-name">نام ساب ادمین:</label>
          <input type="text" id="sub-admin-name" placeholder="نام کامل ساب ادمین" required>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-address">آدرس کیف پول:</label>
          <input type="text" id="sub-admin-address" placeholder="0x..." required>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-role">نقش:</label>
          <select id="sub-admin-role" required>
            <option value="">انتخاب نقش</option>
            <option value="moderator">مدیر محتوا</option>
            <option value="support">پشتیبانی</option>
            <option value="analyst">تحلیلگر</option>
            <option value="teacher">مدرس</option>
            <option value="custom">سفارشی</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="sub-admin-description">توضیحات:</label>
          <textarea id="sub-admin-description" placeholder="توضیحات اضافی..." rows="3"></textarea>
        </div>
        
        <div class="permissions-group">
          <h5>🔐 دسترسی‌های ساب ادمین</h5>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-stream-control" name="permissions">
            <label for="perm-stream-control">کنترل لایو استریم</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-chat-moderate" name="permissions">
            <label for="perm-chat-moderate">مدیریت چت</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-ban-users" name="permissions">
            <label for="perm-ban-users">مسدود کردن کاربران</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-reports" name="permissions">
            <label for="perm-view-reports">مشاهده گزارش‌ها</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-manage-content" name="permissions">
            <label for="perm-manage-content">مدیریت محتوا</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-analytics" name="permissions">
            <label for="perm-view-analytics">مشاهده آمار</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-edit-products" name="permissions">
            <label for="perm-edit-products">ویرایش محصولات</label>
          </div>
          
          <div class="permission-item">
            <input type="checkbox" id="perm-view-orders" name="permissions">
            <label for="perm-view-orders">مشاهده سفارشات</label>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="submit" class="modal-btn primary" id="save-sub-admin-btn">💾 ذخیره</button>
          <button type="button" class="modal-btn secondary" id="cancel-sub-admin-btn">❌ انصراف</button>
        </div>
      </form>
    </div>
  </div>

  <!-- مودال تأیید حذف -->
  <div class="sub-admin-modal" id="delete-confirm-modal">
    <div class="sub-admin-modal-content">
      <h3>⚠️ تأیید حذف</h3>
      <p style="color: #ccc; text-align: center; margin-bottom: 1.5rem;">
        آیا مطمئن هستید که می‌خواهید این ساب ادمین را حذف کنید؟
      </p>
      <div style="background: #181c2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="color: #fff; margin: 0;"><strong>نام:</strong> <span id="delete-admin-name"></span></p>
        <p style="color: #888; margin: 0.5rem 0 0 0;"><strong>آدرس:</strong> <span id="delete-admin-address"></span></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn danger" id="confirm-delete-btn">🗑️ حذف</button>
        <button class="modal-btn secondary" id="cancel-delete-btn">❌ انصراف</button>
      </div>
    </div>
  </div>



  <div id="custom-footer-div" style="text-align:center; padding:2rem; color:#00ff88; font-size:1.2rem;">
  <br>  <br>  <br>  <br>  <br>  <br>  <br>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var archiveBtn = Array.from(document.querySelectorAll('button, a')).find(el => el.textContent.includes('آرشیو بازارهای مالی'));
      if (archiveBtn) archiveBtn.remove();
      
      // بازیابی تب فعال از localStorage
      const savedTab = localStorage.getItem('currentActiveTab');
      if (savedTab && savedTab !== 'network' && typeof window.showTab === 'function') {
        // Wait a bit for the page to fully load
        setTimeout(() => {
          window.showTab(savedTab);
        }, 1000);
      }
    });
  </script>

  <script>
  (async function() {
    if (window.getUserProfile) {
      const profile = await window.getUserProfile();
      if (!(profile.index && BigInt(profile.index) > 0n)) {
        // قفل کردن فقط بخش ریپورت
        const reportsSection = document.getElementById('main-reports');
        if (reportsSection) {
          reportsSection.innerHTML = '<div style="color:#ff6b6b;text-align:center;padding:3rem;font-size:1.5rem;">دسترسی به این بخش فقط برای کاربران فعال مجاز است.<br>🔒</div>';
          reportsSection.style.background = '#181c2a';
        }
      }
    }
  })();
  </script>

  <!-- Control display of destination address input -->
  <script>
    // تابع بروزرسانی خودکار موجودی‌های ترنسفر
    async function autoRefreshTransferBalances() {
      try {
        if (window.updateTransferBalancesOnConnect) {
          await window.updateTransferBalancesOnConnect();
          console.log('✅ موجودی‌های ترنسفر خودکار بروزرسانی شد');
        }
      } catch (error) {
        console.warn('خطا در بروزرسانی خودکار موجودی‌های ترنسفر:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const transferForm = document.getElementById('transferForm');
      if (!transferForm) return;

              // Auto-update balances when page loads
      const initTransferBalances = () => {
        if (window.contractConfig && window.contractConfig.contract) {
          autoRefreshTransferBalances();
        } else {
          // انتظار برای اتصال کیف پول
          const checkConnection = setInterval(() => {
            if (window.contractConfig && window.contractConfig.contract) {
              autoRefreshTransferBalances();
              clearInterval(checkConnection);
            }
          }, 1000);
          
          // متوقف کردن بررسی بعد از 15 ثانیه
          setTimeout(() => clearInterval(checkConnection), 15000);
        }
      };

      // شروع بروزرسانی
      initTransferBalances();

      // USD Converter functionality
      const usdConverterRow = document.getElementById('usd-converter-row');
      const transferUsdAmount = document.getElementById('transferUsdAmount');
      const usdToIAMBtn = document.getElementById('usdToIAMBtn');
      
      // نمایش/مخفی کردن فیلد USD بر اساس نوع توکن
      function toggleUsdConverter() {
        const selectedToken = transferTokenSelect.value;
        if (selectedToken === 'IAM') {
          usdConverterRow.style.display = 'block';
        } else {
          usdConverterRow.style.display = 'none';
          transferUsdAmount.value = '';
        }
      }
      
      // تبدیل USD به IAM
      async function convertUsdToIAM() {
        const usdAmount = parseFloat(transferUsdAmount.value);
        if (isNaN(usdAmount) || usdAmount <= 0) {
          alert('لطفاً مقدار معتبری برای دلار وارد کنید');
          return;
        }
        
        try {
          // Get token price from smart contract
          const connection = await window.connectWallet();
          if (!connection || !connection.contract) {
            alert('ابتدا کیف پول خود را متصل کنید');
            return;
          }
          
          usdToIAMBtn.textContent = '⏳ در حال محاسبه...';
          usdToIAMBtn.disabled = true;
          
          const tokenPriceRaw = await connection.contract.getTokenPrice();
          const tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
          
          // محاسبه مقدار IAM مورد نیاز
          const IAMAmount = (usdAmount / tokenPrice).toFixed(6);
          
          // قرار دادن مقدار در فیلد اصلی
          transferAmountInput.value = IAMAmount;
          
          // نمایش پیام موفقیت
          const statusDiv = document.getElementById('transferStatus');
          if (statusDiv) {
            statusDiv.innerHTML = `✅ $${usdAmount} معادل ${parseFloat(IAMAmount).toLocaleString('en-US', {maximumFractionDigits: 6})} IAM است`;
            statusDiv.style.color = '#00ff88';
            setTimeout(() => {
              statusDiv.innerHTML = '';
            }, 3000);
          }
          
        } catch (error) {
          console.error('خطا در تبدیل USD به IAM:', error);
          alert('خطا در تبدیل. لطفاً دوباره تلاش کنید.');
        } finally {
          usdToIAMBtn.textContent = '🔄 تبدیل';
          usdToIAMBtn.disabled = false;
        }
      }
      
      // دکمه حداکثر
      const maxAmountBtn = document.getElementById('maxAmountBtn');
      const transferAmountInput = document.getElementById('transferAmount');
      const transferTokenSelect = document.getElementById('transferToken');

      if (maxAmountBtn && transferAmountInput && transferTokenSelect) {
        maxAmountBtn.addEventListener('click', function() {
          const selectedToken = transferTokenSelect.value;
          let maxAmount = '0';
          
          // Get balance based on selected token
          if (selectedToken === 'dai') {
            const daiBalanceEl = document.getElementById('transfer-dai-balance');
            if (daiBalanceEl) {
              const raw = parseFloat(daiBalanceEl.dataset.value || daiBalanceEl.textContent);
              if (!isNaN(raw) && raw > 0) maxAmount = raw.toString();
            }
          } else if (selectedToken === 'pol') {
            const polBalanceEl = document.getElementById('transfer-poly-balance');
            if (polBalanceEl) {
              const raw = parseFloat(polBalanceEl.dataset.value || polBalanceEl.textContent);
              if (!isNaN(raw)) {
                maxAmount = Math.max(0, raw - 0.01).toString();
              }
            }
          } else if (selectedToken === 'IAM') {
            const IAMBalanceEl = document.getElementById('transfer-IAM-balance');
            if (IAMBalanceEl) {
              const raw = parseFloat(IAMBalanceEl.dataset.value || IAMBalanceEl.textContent);
              if (!isNaN(raw) && raw > 0) maxAmount = raw.toString();
            }
          }
          
          // Set value in input field
          if (parseFloat(maxAmount) > 0) {
            const decimals = (transferTokenSelect.value === 'IAM') ? 6 : 18;
            // برای DAI و POL بهتر است 2 یا 4 رقم استفاده کنیم؛ برای IAM تا 6 رقم
            const floorToDecimals = (val, d) => { const m = Math.pow(10, d); return Math.floor(Number(val) * m) / m; };
            const d = (transferTokenSelect.value === 'IAM') ? 6 : 4;
            const floored = floorToDecimals(maxAmount, d);
            transferAmountInput.value = floored.toFixed(d);
            // تغییر متن دکمه به صورت موقت
            const originalText = maxAmountBtn.textContent;
            maxAmountBtn.textContent = '✓ تنظیم شد';
            maxAmountBtn.style.background = 'linear-gradient(90deg,#00ff88,#00cc66)';
            setTimeout(() => {
              maxAmountBtn.textContent = originalText;
              maxAmountBtn.style.background = 'linear-gradient(90deg,#ff6b6b,#ee5a52)';
            }, 1500);
          } else {
            // نمایش پیام خطا
            maxAmountBtn.textContent = '❌ موجودی کافی نیست';
            maxAmountBtn.style.background = 'linear-gradient(90deg,#666,#555)';
            setTimeout(() => {
              maxAmountBtn.textContent = 'حداکثر';
              maxAmountBtn.style.background = 'linear-gradient(90deg,#ff6b6b,#ee5a52)';
            }, 2000);
          }
        });
      }
      
      // Event listeners برای USD converter
      if (transferTokenSelect) {
        // تغییر نوع توکن
        transferTokenSelect.addEventListener('change', toggleUsdConverter);
        
        // اجرای اولیه برای تنظیم وضعیت اولیه
        toggleUsdConverter();
      }
      
      if (usdToIAMBtn) {
        // کلیک دکمه تبدیل
        usdToIAMBtn.addEventListener('click', convertUsdToIAM);
      }
      
      if (transferUsdAmount) {
        // Enter key در فیلد USD
        transferUsdAmount.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            convertUsdToIAM();
          }
        });
        
        // Real-time محاسبه وقتی کاربر تایپ می‌کنه
        let usdTimeout;
        transferUsdAmount.addEventListener('input', function() {
          clearTimeout(usdTimeout);
          usdTimeout = setTimeout(async () => {
            const usdAmount = parseFloat(transferUsdAmount.value);
            if (!isNaN(usdAmount) && usdAmount > 0) {
              try {
                const connection = await window.connectWallet();
                if (connection && connection.contract) {
                  const tokenPriceRaw = await connection.contract.getTokenPrice();
                  const tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                  const IAMAmount = (usdAmount / tokenPrice).toFixed(6);
                  
                  // نمایش preview در placeholder
                  transferAmountInput.placeholder = `≈ ${parseFloat(IAMAmount).toLocaleString('en-US', {maximumFractionDigits: 6})} IAM`;
                }
              } catch (e) {
                // خطا در real-time - نادیده بگیر
              }
            } else {
              transferAmountInput.placeholder = 'مقدار را وارد کنید';
            }
          }, 500); // 500ms delay برای جلوگیری از کال‌های زیاد
        });
      }
      
      // Real-time محاسبه معادل دلاری وقتی مقدار IAM تغییر میکنه
      if (transferAmountInput) {
        let IAMTimeout;
        transferAmountInput.addEventListener('input', function() {
          if (transferTokenSelect.value === 'IAM') {
            clearTimeout(IAMTimeout);
            IAMTimeout = setTimeout(async () => {
              const IAMAmount = parseFloat(transferAmountInput.value);
              if (!isNaN(IAMAmount) && IAMAmount > 0) {
                try {
                  const connection = await window.connectWallet();
                  if (connection && connection.contract) {
                    const tokenPriceRaw = await connection.contract.getTokenPrice();
                    const tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    const usdValue = (IAMAmount * tokenPrice).toFixed(2);
                    
                    // نمایش معادل دلاری در فیلد USD
                    if (transferUsdAmount) {
                      transferUsdAmount.placeholder = `≈ $${parseFloat(usdValue).toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                    }
                  }
                } catch (e) {
                  // خطا در real-time - نادیده بگیر
                }
              } else {
                if (transferUsdAmount) {
                  transferUsdAmount.placeholder = '5.00';
                }
              }
            }, 500);
          }
        });
      }

      transferForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const transferBtn = transferForm.querySelector('button[type="submit"]');
        if (transferBtn) {
          transferBtn.disabled = true;
          var oldText = transferBtn.textContent;
          transferBtn.textContent = 'در حال پردازش...';
        }
        const to = document.getElementById('transferTo').value.trim();
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const token = document.getElementById('transferToken').value;
        const status = document.getElementById('transferStatus');
        status.textContent = '';
        status.className = 'transfer-status';
        if (!to || !amount || amount <= 0) {
          status.textContent = 'آدرس مقصد و مقدار معتبر وارد کنید';
          status.className = 'transfer-status error';
          if (transferBtn) { transferBtn.disabled = false; transferBtn.textContent = oldText; }
          return;
        }
        if (!window.contractConfig || !window.contractConfig.contract || !window.contractConfig.signer) {
          status.textContent = 'اتصال کیف پول برقرار نیست';
          status.className = 'transfer-status error';
          if (transferBtn) { transferBtn.disabled = false; transferBtn.textContent = oldText; }
          return;
        }
        try {
          status.textContent = 'در حال ارسال...';
          status.className = 'transfer-status loading';
          if (token === 'pol') {
            // انتقال MATIC/POL
            const tx = await window.contractConfig.signer.sendTransaction({
              to,
              value: ethers.parseEther(amount.toString())
            });
            await tx.wait();
            status.textContent = 'انتقال با موفقیت انجام شد!\nکد تراکنش: ' + tx.hash;
            status.className = 'transfer-status success';
          } else if (token === 'dai') {
            // انتقال DAI - تصحیح decimal به 18
            const daiContract = new ethers.Contract(DAI_ADDRESS, DAI_ABI, window.contractConfig.signer);
            const decimals = 18; // DAI has 18 decimals, not 6
            const parsedAmount = ethers.parseUnits(amount.toString(), decimals);
            const tx = await daiContract.transfer(to, parsedAmount);
            await tx.wait();
            status.textContent = 'انتقال DAI با موفقیت انجام شد!\nکد تراکنش: ' + tx.hash;
            status.className = 'transfer-status success';
          } else {
            // انتقال IAM
            const contract = window.contractConfig.contract;
            const tx = await contract.transfer(to, ethers.parseEther(amount.toString()));
            await tx.wait();
            status.textContent = 'انتقال با موفقیت انجام شد!\nکد تراکنش: ' + tx.hash;
            status.className = 'transfer-status success';
          }
          transferForm.reset();
          
          // بروزرسانی موجودی‌ها بعد از انتقال موفق
          setTimeout(autoRefreshTransferBalances, 2000);
        } catch (error) {
          let msg = error && error.message ? error.message : error;
          if (msg.includes('user rejected')) msg = 'تراکنش توسط کاربر لغو شد';
          else if (msg.includes('insufficient funds')) msg = 'موجودی کافی نیست';
          else if (msg.includes('invalid address')) msg = 'آدرس مقصد نامعتبر است';
          else if (msg.includes('nonce')) msg = 'خطا در شماره تراکنش. لطفاً دوباره تلاش کنید';
          else if (msg.includes('execution reverted')) msg = 'تراکنش ناموفق بود. لطفاً شرایط را بررسی کنید';
          else msg = 'خطا در انتقال: ' + msg;
          status.textContent = msg;
          status.className = 'transfer-status error';
        }
        if (transferBtn) { transferBtn.disabled = false; transferBtn.textContent = oldText; }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchBtn = document.getElementById('searchIndexBtn');
      const searchInput = document.getElementById('searchIndex');
      const searchStatus = document.getElementById('searchIndexStatus');
      if (searchBtn && searchInput) {
        searchBtn.onclick = async function() {
          searchStatus.textContent = '';
          const idx = searchInput.value.trim();
          if (!idx || isNaN(idx) || Number(idx) < 0) {
            searchStatus.textContent = 'ایندکس معتبر وارد کنید';
            searchStatus.className = 'transfer-status error';
            return;
          }
          if (!window.contractConfig || !window.contractConfig.contract) {
            searchStatus.textContent = 'اتصال کیف پول برقرار نیست';
            searchStatus.className = 'transfer-status error';
            return;
          }
          try {
            searchStatus.textContent = 'در حال جستجو...';
            searchStatus.className = 'transfer-status loading';
            const contract = window.contractConfig.contract;
            const address = await contract.indexToAddress(BigInt(idx));
            if (!address || address === '0x0000000000000000000000000000000000000000') {
              searchStatus.textContent = 'Wallet address not found for this index';
              searchStatus.className = 'transfer-status error';
              document.getElementById('transferTo').value = '';
            } else {
              searchStatus.textContent = 'آدرس ولت پیدا شد';
              searchStatus.className = 'transfer-status success';
              document.getElementById('transferTo').value = address;
            }
          } catch (err) {
            searchStatus.textContent = 'خطا در جستجو: ' + (err && err.message ? err.message : err);
            searchStatus.className = 'transfer-status error';
            document.getElementById('transferTo').value = '';
          }
        };
      }
    });
  </script>

  <script>
    // تابع باز/بسته کردن بخش‌های قابل گسترش
    function toggleExpandable(containerId) {
      const container = document.getElementById(containerId);
      if (container) {
        container.classList.toggle('collapsed');
        
        // ذخیره وضعیت در localStorage
        const isCollapsed = container.classList.contains('collapsed');
        localStorage.setItem(`expandable_${containerId}`, isCollapsed ? 'collapsed' : 'expanded');
      }
    }

    // بازیابی وضعیت بخش‌های قابل گسترش از localStorage
    function restoreExpandableStates() {
      const expandableContainers = document.querySelectorAll('.expandable-container');
      expandableContainers.forEach(container => {
        const containerId = container.id;
        const savedState = localStorage.getItem(`expandable_${containerId}`);
        if (savedState === 'collapsed') {
          container.classList.add('collapsed');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      // بازیابی وضعیت بخش‌های قابل گسترش
      restoreExpandableStates();
      
      
    });
  </script>

  <script>
    // تابع نمایش قیمت با نماد علمی
    window.formatTokenPrice = function(priceWei) {
      if (!priceWei || priceWei === '0') return '0';
      let priceString = priceWei.toString();
      while (priceString.length < 18) priceString = '0' + priceString;
      if (priceString.length > 18) priceString = priceString.slice(-18);
      const result = '0.' + priceString;
      const numResult = parseFloat(result);
      if (numResult < 0.000001) {
        return numResult.toExponential(6);
      }
      return result;
    }

    // تابع بروزرسانی نمایش قیمت
    async function updateTokenPriceDisplay() {
      try {
        if (!window.contractConfig || !window.contractConfig.contract) {
          await window.connectWallet();
          if (!window.contractConfig || !window.contractConfig.contract) {
            const el = document.getElementById('chart-lvl-usd');
            if (el) el.textContent = 'اتصال ناموفق';
            return;
          }
        }
        const contract = window.contractConfig.contract;
        const tokenPrice = await contract.getTokenPrice();
        const priceFormatted = window.formatTokenPrice(tokenPrice);
        const el = document.getElementById('chart-lvl-usd');
        if (el) el.textContent = priceFormatted;
        // بروزرسانی point-value از قرارداد
        try {
          const pointValue = await contract.getPointValue();
          const pointValueNum = parseFloat(ethers.formatUnits(pointValue, 18));
          const pointValueFormatted = pointValueNum < 0.000001 ? pointValueNum.toExponential(6) : pointValueNum.toFixed(2);
          const el2 = document.getElementById('point-value');
          if (el2) el2.textContent = pointValueFormatted; // حذف پسوند IAM
        } catch (error) {
          // ...
        }
      } catch (error) {
        const el = document.getElementById('chart-lvl-usd');
                    if (el) el.textContent = 'Loading error';
      }
    }
    // ... existing code ...
  </script>

  <script>
    if (window.loadUserProfile) {
      const origLoadUserProfile = window.loadUserProfile;
      window.loadUserProfile = async function() {
        await origLoadUserProfile.apply(this, arguments);
        await updateProfileReferrer(); // اینجا با await و بدون تاخیر
      };
    }
  </script>
  <script src="js/token-price.js"></script>
  <script src="js/remove-archive-btn.js"></script>



  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('connectProfileWalletBtn');
    if (btn) {
      btn.addEventListener('click', async function() {
        try {
          if (window.connectWallet) {
            await window.connectWallet();
            // After connecting, reload profile
            if (typeof loadUserProfile === 'function') loadUserProfile();
          }
        } catch (e) {
          alert('خطا در اتصال کیف پول: ' + (e.message || e));
        }
      });
    }
  });
  </script>

  <script src="js/navbar.js"></script>
  
  <!-- مقداردهی SwapManager -->
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('🚀 شروع مقداردهی SwapManager...');
      
              // Ensure swap.js is loaded
      if (typeof SwapManager !== 'undefined') {
        try {
          console.log('✅ SwapManager class found');
          
          // Wait a bit for DOM to fully load
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // بررسی وجود عناصر مورد نیاز
          const requiredElements = ['swapForm', 'swapDirection', 'swapAmount', 'maxBtn', 'swapRate', 'swapPreview', 'swapLimitInfo', 'swapStatus'];
          const missingElements = requiredElements.filter(id => !document.getElementById(id));
          
          if (missingElements.length > 0) {
            console.warn('⚠️ The following elements were not found:', missingElements);
            return;
          }
          
          console.log('✅ تمام عناصر مورد نیاز موجود هستند');
          
          // بررسی وجود متغیرهای مورد نیاز
          if (!window.DAI_ADDRESS || !window.DAI_ABI) {
            console.error('❌ متغیرهای DAI_ADDRESS یا DAI_ABI تعریف نشده‌اند');
            return;
          }
          
          console.log('✅ متغیرهای DAI موجود هستند');
          
          // ایجاد نمونه SwapManager
          window.swapManager = new SwapManager();
          console.log('✅ نمونه SwapManager ایجاد شد');
          
          // مقداردهی اولیه
          await window.swapManager.initializeSwap();
          console.log('✅ SwapManager با موفقیت مقداردهی شد');
          
        } catch (error) {
          console.error('❌ خطا در مقداردهی SwapManager:', error);
        }
      } else {
        console.warn('⚠️ SwapManager تعریف نشده است - فایل swap.js بارگذاری نشده');
      }
      
      // بارگذاری رنکینگ کاربران برتر
      try {
        if (typeof window.displayTopUsersRanking === 'function') {
          // کمی صبر کن تا اتصال به قرارداد برقرار شود
          setTimeout(async () => {
            try {
              // استفاده از تابع بهینه‌سازی شده برای عملکرد بهتر
              if (typeof window.getTopLikedUsersOptimized === 'function') {
                const topUsers = await window.getTopLikedUsersOptimized(10);
                if (topUsers.length > 0) {
                  await window.displayTopUsersRanking('top-users-ranking');
                } else {
                  // اگر تابع بهینه کار نکرد، از تابع اصلی استفاده کن
                  await window.displayTopUsersRanking('top-users-ranking');
                }
              } else {
                await window.displayTopUsersRanking('top-users-ranking');
              }
            } catch (error) {
              console.error('❌ خطا در بارگذاری رنکینگ:', error);
            }
          }, 2000);
        } else {
          console.warn('⚠️ تابع displayTopUsersRanking تعریف نشده است');
        }
      } catch (error) {
        console.error('❌ خطا در بارگذاری رنکینگ:', error);
      }
    });
    
    // مقداردهی مجدد بعد از اتصال کیف پول
    if (window.connectWallet) {
      const originalConnectWallet = window.connectWallet;
      window.connectWallet = async function() {
        const result = await originalConnectWallet();
        
        // مقداردهی مجدد SwapManager بعد از اتصال
        setTimeout(async () => {
          if (window.swapManager && typeof window.swapManager.refreshSwapData === 'function') {
            try {
              console.log('🔄 رفرش SwapManager بعد از اتصال کیف پول...');
              await window.swapManager.refreshSwapData();
              console.log('✅ SwapManager رفرش شد');
            } catch (error) {
              console.warn('⚠️ خطا در رفرش SwapManager:', error);
            }
          }
          // Update index dashboard status bar
          try { if (typeof window.indexStatusTryUpdate === 'function') window.indexStatusTryUpdate(); } catch(_) {}
        }, 1000);
        
        return result;
      };
    }
  </script>
  </div>

<style>
/* فایل تمیز شد - CSS جدید در انتها قرار دارد */

/* === همه کارت‌ها فیکس عرض در موبایل === */
@media (max-width: 768px) {
  /* کانتینر اصلی کارت‌ها */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.8rem !important;
    width: 100% !important;
    padding: 0 0.5rem !important;
  }
  
  /* همه کارت‌ها فیکس عرض کامل */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    width: 100% !important;
    min-width: 100% !important;
    max-width: 100% !important;
    flex: none !important;
    padding: 1.2rem !important;
    margin: 0 !important;
    margin-bottom: 0.8rem !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3) !important;
    backdrop-filter: blur(6px) !important;
    border: 1.5px solid rgba(255,255,255,0.15) !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
  }
  
  /* آیکون‌های کارت */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:1.2rem;margin-bottom:0.3rem;"] {
    font-size: 1.8rem !important;
    margin-bottom: 0.6rem !important;
    text-align: center !important;
  }
  
  /* عنوان کارت‌ها */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;"] {
    font-size: 1rem !important;
    margin-bottom: 0.4rem !important;
    letter-spacing: 0.3px !important;
    text-align: center !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  /* مقادیر کارت‌ها - فیکس overflow */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.9rem;font-family:monospace;font-weight:bold;"] {
    font-size: 1.1rem !important;
    margin: 0.6rem 0 !important;
    letter-spacing: 0.2px !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4) !important;
    text-align: center !important;
    word-break: break-all !important;
    overflow-wrap: break-word !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }
  
  /* توضیحات کارت‌ها */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.7rem;margin-top:0.2rem;"] {
    font-size: 0.8rem !important;
    margin-top: 0.4rem !important;
    opacity: 0.7 !important;
    text-align: center !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }
  
  /* کارت‌های خاص - اندازه‌های ویژه */
  
  /* کارت کل عرضه */
  div[style*="border:1px solid rgba(0,255,136,0.2)"] {
    border: 3px solid rgba(0,255,136,0.4) !important;
    background: rgba(0,255,136,0.1) !important;
  }
  
  /* کارت موجودی قرارداد IAM */
  div[style*="border:1px solid rgba(255,193,7,0.2)"] {
    border: 3px solid rgba(255,193,7,0.4) !important;
    background: rgba(255,193,7,0.1) !important;
  }
  
  /* کارت موجودی DAI */
  div[style*="border:1px solid rgba(0,123,255,0.2)"] {
    border: 3px solid rgba(0,123,255,0.4) !important;
    background: rgba(0,123,255,0.1) !important;
  }
  
  /* کارت قیمت ثبت‌نام */
  div[style*="border:1px solid rgba(138,43,226,0.2)"] {
    border: 3px solid rgba(138,43,226,0.4) !important;
    background: rgba(138,43,226,0.1) !important;
  }
  
  /* Card Entry Animation */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    animation: slideUpMobile 0.6s ease-out !important;
    animation-delay: calc(var(--card-index, 0) * 0.1s) !important;
  }
}

/* Card Entry Animation on Mobile */
@keyframes slideUpMobile {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* مخصوص صفحات خیلی کوچک */
@media (max-width: 480px) {
  /* کانتینر کارت‌ها */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    padding: 0 0.3rem !important;
    gap: 0.6rem !important;
  }
  
  /* کارت‌ها */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    padding: 1rem !important;
    margin-bottom: 0.6rem !important;
    border-radius: 10px !important;
  }
  
  /* آیکون‌ها */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:1.2rem;margin-bottom:0.3rem;"] {
    font-size: 1.5rem !important;
    margin-bottom: 0.5rem !important;
  }
  
  /* عناوین */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.8rem;font-weight:bold;margin-bottom:0.2rem;"] {
    font-size: 0.9rem !important;
    margin-bottom: 0.3rem !important;
  }
  
  /* مقادیر */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.9rem;font-family:monospace;font-weight:bold;"] {
    font-size: 1rem !important;
    margin: 0.5rem 0 !important;
    line-height: 1.2 !important;
  }
  
  /* توضیحات */
  div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.7rem;margin-top:0.2rem;"] {
    font-size: 0.75rem !important;
    margin-top: 0.3rem !important;
  }
}

/* جلوگیری از بیرون زدن اعداد طولانی از داخل کارت‌ها (در همه اندازه‌ها) */
div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.9rem;font-family:monospace;font-weight:bold;"] {
  word-break: break-all !important;
  overflow-wrap: anywhere !important;
  white-space: normal !important;
  max-width: 100% !important;
}

/* Responsive Layout for Dashboard Metric Cards on Tablet and Desktop */
@media (min-width: 769px) and (max-width: 1023px) {
  /* ظرف کارت‌ها → 2 ستون در هر سطر */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 0.8rem !important;
    justify-content: center !important;
  }
  /* خود کارت‌ها داخل ظرف بالا */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    min-width: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    flex: none !important;
    box-sizing: border-box !important;
  }
}

@media (min-width: 1024px) {
  /* ظرف کارت‌ها → 3 ستون در هر سطر */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    display: grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
    gap: 1rem !important;
    justify-content: center !important;
  }
  /* خود کارت‌ها داخل ظرف بالا */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    min-width: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    flex: none !important;
    box-sizing: border-box !important;
  }
}

/* Dynamic Width Mode for Dashboard Metric Cards on Tablet/Desktop
   این بلوک قوانین گرید را در بالا override می‌کند تا کارت‌ها به اندازهٔ محتوا عریض شوند */
@media (min-width: 769px) {
  /* ظرف کارت‌ها: فلکس و قابل پیچش */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 0.8rem !important;
    justify-content: center !important;
    align-items: stretch !important;
  }
  /* خود کارت‌ها: عرض بر اساس محتوا */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    flex: 0 0 auto !important;
    width: auto !important;
    min-width: auto !important;
    max-width: none !important;
    box-sizing: border-box !important;
  }
  /* مقدارها: یک‌خطی بمانند تا کارت عریض شود */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.9rem;font-family:monospace;font-weight:bold;"] {
    white-space: nowrap !important;
    word-break: normal !important;
    overflow-wrap: normal !important;
  }
}

/* Dynamic Width Mode for Dashboard Metric Cards on Mobile */
@media (max-width: 768px) {
  /* ظرف کارت‌ها: فلکس، پیچش فعال، چینش ردیفی، اسکرول افقی در صورت نیاز */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
    align-items: stretch !important;
    gap: 0.6rem !important;
    width: 100% !important;
    padding: 0 0.5rem !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  /* کارت‌ها: عرض بر اساس محتوا، جلوگیری از کشیده شدن به 100% */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] {
    flex: 0 0 auto !important;
    width: auto !important;
    min-width: max-content !important;
    max-width: none !important;
    box-sizing: border-box !important;
    margin: 0 !important;
  }
  /* مقدارها: یک‌خطی برای افزایش عرض کارت */
  div[style*="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;justify-content:center;"] > div[style*="background:rgba(0,0,0,0.3);border-radius:12px;padding:0.8rem;border:1px solid"] > div[style*="font-size:0.9rem;font-family:monospace;font-weight:bold;"] {
    white-space: nowrap !important;
    word-break: normal !important;
    overflow-wrap: normal !important;
  }
}
</style>

<script>
// مدیریت کارت‌ها و مقادیر در موبایل
function optimizeCardsForMobile() {
  if (window.innerWidth <= 768) {
    // پیدا کردن همه کارت‌ها
    const cards = document.querySelectorAll('div[style*="background:rgba(0,0,0,0.3)"]');
    
    cards.forEach((card, index) => {
      // فیکس کردن عرض
      card.style.width = '100%';
      card.style.maxWidth = '100%';
      card.style.minWidth = '100%';
      card.style.boxSizing = 'border-box';
      card.style.overflow = 'hidden';
      
      // Entry Animation
      card.style.setProperty('--card-index', index.toString());
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      
      // تاخیر برای انیمیشن
      setTimeout(() => {
        card.style.transition = 'all 0.4s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 80);
      
      // بهینه‌سازی مقادیر داخل کارت
      const valueElements = card.querySelectorAll('div[style*="font-family:monospace"]');
      valueElements.forEach(valueEl => {
        valueEl.style.wordBreak = 'break-all';
        valueEl.style.overflowWrap = 'break-word';
        valueEl.style.maxWidth = '100%';
        valueEl.style.textAlign = 'center';
        
        // اگر مقدار خیلی بلند است، فونت را کوچک‌تر کن
        const text = valueEl.textContent || '';
        if (text.length > 15) {
          valueEl.style.fontSize = '0.9rem';
          valueEl.style.lineHeight = '1.2';
        }
        if (text.length > 25) {
          valueEl.style.fontSize = '0.8rem';
          valueEl.style.lineHeight = '1.1';
        }
      });
    });
    
    // بهینه‌سازی کانتینر اصلی
    const container = document.querySelector('div[style*="display:flex;flex-wrap:wrap"]');
    if (container) {
      container.style.width = '100%';
      container.style.padding = '0 0.5rem';
      container.style.boxSizing = 'border-box';
    }
  }
}

// مدیریت دکمه رفرش موبایل
document.addEventListener('DOMContentLoaded', function() {
  // بهینه‌سازی کارت‌ها برای موبایل
  setTimeout(() => {
    optimizeCardsForMobile();
  }, 800);
  
  // بهینه‌سازی مجدد هنگام تغییر اندازه صفحه
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      optimizeCardsForMobile();
    }, 300);
  });
  
  // بهینه‌سازی مجدد هنگام بروزرسانی مقادیر
  const observer = new MutationObserver(() => {
    if (window.innerWidth <= 768) {
      setTimeout(optimizeCardsForMobile, 200);
    }
  });
  
  // نظارت بر تغییرات در کارت‌ها
  const targetNode = document.querySelector('div[style*="display:flex;flex-wrap:wrap"]');
  if (targetNode) {
    observer.observe(targetNode, {
      childList: true,
      subtree: true,
      characterData: true
    });
  }
  
  // کدهای اصلی صفحه
});



// پایان اسکریپت‌های اصلی

// تابع بارگذاری دستی رنکینگ
function loadRanking() {
  console.log('🔄 شروع بارگذاری رنکینگ...');
  
  // بررسی اتصال کیف پول
  if (!window.contractConfig || !window.contractConfig.contract) {
    console.log('⚠️ کیف پول متصل نیست، در حال اتصال...');
    window.connectWallet().then(() => {
      setTimeout(() => {
        loadRankingInternal();
      }, 1000);
    }).catch(error => {
      console.error('❌ خطا در اتصال کیف پول:', error);
      document.getElementById('top-users-ranking').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #ff4444;">
          <div>❌ ابتدا کیف پول خود را متصل کنید</div>
        </div>
      `;
    });
  } else {
    loadRankingInternal();
  }
}

function loadRankingInternal() {
  console.log('🔍 بررسی توابع رنکینگ...');
  console.log('displayTopUsersRanking موجود:', typeof window.displayTopUsersRanking);
  console.log('getTopLikedUsersOptimized موجود:', typeof window.getTopLikedUsersOptimized);
  
  if (typeof window.displayTopUsersRanking === 'function') {
    console.log('✅ شروع نمایش رنکینگ...');
    window.displayTopUsersRanking('top-users-ranking').then(() => {
      console.log('✅ رنکینگ با موفقیت بارگذاری شد');
    }).catch(error => {
      console.error('❌ خطا در نمایش رنکینگ:', error);
      document.getElementById('top-users-ranking').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #ff4444;">
          <div>❌ خطا در بارگذاری رنکینگ</div>
          <div style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</div>
        </div>
      `;
    });
  } else {
    console.error('❌ تابع displayTopUsersRanking موجود نیست');
    document.getElementById('top-users-ranking').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #ff4444;">
        <div>❌ تابع رنکینگ موجود نیست</div>
        <div style="font-size: 0.8rem; margin-top: 0.5rem;">لطفاً صفحه را رفرش کنید</div>
      </div>
    `;
  }
}

// تابع اسکرول به بخش رنکینگ
function scrollToRanking() {
  const rankingElement = document.getElementById('top-users-ranking');
  if (rankingElement) {
    rankingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    // هایلایت کردن بخش رنکینگ
    rankingElement.style.boxShadow = '0 0 20px rgba(167,134,255,0.5)';
    setTimeout(() => {
      rankingElement.style.boxShadow = '';
    }, 2000);
  }
}



</script>

<!-- Floating Token Growth Card - کارت شناور رشد توکن -->
<script src="js/floating-token-card.js"></script>

<!-- اعمال تم مدرن -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🎨 اعمال تم مدرن نارنجی و بنفش...');
  
  // Apply modern-card class to all existing cards
  const cards = document.querySelectorAll('.dashboard-card');
  cards.forEach(card => {
    if (!card.classList.contains('modern-card')) {
      card.classList.add('modern-card');
    }
  });
  
  // Apply modern-btn class to all buttons
  const buttons = document.querySelectorAll('button');
  buttons.forEach(button => {
    if (!button.classList.contains('modern-btn')) {
      button.classList.add('modern-btn', 'modern-btn-primary');
    }
  });
  
  // Apply modern-input class to all input fields
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    if (!input.classList.contains('modern-input')) {
      input.classList.add('modern-input');
    }
  });
  
  console.log('✅ تم مدرن نارنجی و بنفش اعمال شد');
});
</script>

</body>
</html>