<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Charts | PHOENIX (IAM)</title>
  
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  
  <!-- Load ethers.js version 6 from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  
  <!-- Main scripts -->
  <script src="js/index.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auto-wallet-connect.js"></script>
  <script src="js/neon-api-service.js"></script>
  <script src="browser-price-service.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #2d3748 100%);
      color: #e2e8f0;
      font-family: 'Noto Sans Arabic', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, #a786ff, #00ff88);
      color: #181c2a;
      text-decoration: none;
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(167, 134, 255, 0.3);
    }
    
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(167, 134, 255, 0.4);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      padding-top: 4rem;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #a786ff, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      font-size: 1.1rem;
      color: #94a3b8;
      margin-bottom: 2rem;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
    }
    
    .chart-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .chart-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.3rem;
      font-weight: 600;
      color: #e2e8f0;
      margin: 0;
    }
    
    .chart-icon {
      font-size: 1.5rem;
    }
    
    .chart-stats {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: #00ff88;
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 1.1rem;
      color: #94a3b8;
    }
    
    .error {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #ff6b6b;
      text-align: center;
      flex-direction: column;
      gap: 1rem;
    }
    
    .error-icon {
      font-size: 3rem;
    }
    
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-online {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }
    
    .status-offline {
      background: #ff6b6b;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }
    
    .status-warning {
      background: #ffa726;
      box-shadow: 0 0 10px rgba(255, 167, 38, 0.5);
    }
  </style>
</head>

<body>
  <a href="index.html" class="back-btn">‚Üê Back to Home</a>
  
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Price Charts</h1>
      <p class="page-subtitle">Real-time IAM Token and Point Price Analysis</p>
    </div>
    
    
    <div class="charts-grid">
      <!-- Point Price Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <span class="chart-icon">‚≠ê</span>
            Point Price Chart
          </h3>
          <div class="chart-stats" id="pointStats">
            <div class="stat-item">
              <div class="stat-value current-price" id="currentPointPrice">$0.00</div>
              <div class="stat-label">Current Price</div>
            </div>
            <div class="stat-item">
              <div class="stat-value current-price" id="pointValue">0.00 IAM</div>
              <div class="stat-label">Value in IAM</div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="pointChart"></canvas>
        </div>
      </div>
      
      <!-- Token Price Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <span class="chart-icon">üí∞</span>
            Token Price Chart
          </h3>
          <div class="chart-stats" id="tokenStats">
            <div class="stat-item">
              <div class="stat-value current-price" id="currentTokenPrice">$0.000000000000000000</div>
              <div class="stat-label">Current Price</div>
            </div>
            <div class="stat-item">
              <div class="stat-value current-price" id="tokenSupply">0</div>
              <div class="stat-label">Total Supply</div>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="tokenChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let priceService = null;
    let tokenChart = null;
    let pointChart = null;
    let refreshInterval = null;
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Initializing Price Charts...');
      
      try {
        // Initialize price service
        priceService = new BrowserPriceService();
        await priceService.connectToDatabase();
        await priceService.connectToContract();
        
        // Load charts automatically
        await loadCharts();
        
        // Start real-time updates automatically
        startRealTimeAutoRefresh();
        
        console.log('‚úÖ Price Charts initialized successfully - Auto mode enabled');
        
      } catch (error) {
        console.error('‚ùå Error initializing Price Charts:', error);
        showError('Failed to initialize charts. Please refresh the page.');
      }
    });
    
    // Load charts with real data
    async function loadCharts() {
      try {
        console.log('üîÑ Loading charts...');
        
        // Ensure canvas elements exist
        const tokenCanvas = document.getElementById('tokenChart');
        const pointCanvas = document.getElementById('pointChart');
        
        if (!tokenCanvas || !pointCanvas) {
          console.error('‚ùå Canvas elements not found');
          return;
        }
        
        console.log('‚úÖ Canvas elements ready');
        
        // Load real charts data
        console.log('üîÑ Loading real charts data...', priceService);
        
        // Load token chart
        await loadTokenChart();
        
        // Load point chart
        await loadPointChart();
        
        console.log('‚úÖ Charts loaded successfully');
        
      } catch (error) {
        console.error('‚ùå Error loading charts:', error);
        // Auto-retry after 5 seconds
        setTimeout(() => {
          console.log('üîÑ Auto-retrying chart load...');
          loadCharts();
        }, 5000);
      }
    }
    
    // Load token chart
    async function loadTokenChart() {
      try {
        console.log('üîÑ Loading token chart...');
        
        const canvas = document.getElementById('tokenChart');
        if (!canvas) return;
        
        // Get latest token price
        const latestPrice = await priceService.getLatestTokenPrice('IAM');
        console.log('üìä Latest token price:', latestPrice);
        
        if (!latestPrice || !latestPrice.price_usd) {
          console.warn('‚ö†Ô∏è No valid token price data, using fallback');
          // Use fallback data
          const fallbackPrice = {
            price_usd: '1.28e-15',
            total_supply: '4579431465023559287516108250615514281',
            symbol: 'IAM',
            name: 'IAM Token'
          };
          updateTokenStats(fallbackPrice);
          return;
        }
        
        // Update stats
        updateTokenStats(latestPrice);
        
        // Generate real-time history
        const history = await priceService.generateRealTimeHistory('token', 'IAM', 24);
        console.log('üìä Token history loaded:', history.length, 'points');
        
        // Create chart
        createTokenChart(canvas, history);
        
      } catch (error) {
        console.error('‚ùå Error loading token chart:', error);
        showChartError(document.getElementById('tokenChart'), 'Failed to load token chart');
      }
    }
    
    // Load point chart
    async function loadPointChart() {
      try {
        console.log('üîÑ Loading point chart...');
        
        const canvas = document.getElementById('pointChart');
        if (!canvas) return;
        
        // Get latest point price
        const latestPrice = await priceService.getLatestPointPrice('binary_points');
        console.log('üìä Latest point price:', latestPrice);
        
        if (!latestPrice || !latestPrice.point_value_usd) {
          console.warn('‚ö†Ô∏è No valid point price data, using fallback');
          // Use fallback data
          const fallbackPrice = {
            point_value_usd: '15.63',
            point_value_iam: '12182186011218572.00',
            point_type: 'binary_points'
          };
          updatePointStats(fallbackPrice);
          return;
        }
        
        // Update stats
        updatePointStats(latestPrice);
        
        // Generate real-time history
        const history = await priceService.generateRealTimeHistory('point', 'binary_points', 24);
        console.log('üìä Point history loaded:', history.length, 'points');
        
        // Create chart
        createPointChart(canvas, history);
        
      } catch (error) {
        console.error('‚ùå Error loading point chart:', error);
        showChartError(document.getElementById('pointChart'), 'Failed to load point chart');
      }
    }
    
    // Update token stats
    function updateTokenStats(priceData) {
      const priceElement = document.getElementById('currentTokenPrice');
      const supplyElement = document.getElementById('tokenSupply');
      
      if (priceElement) {
        const price = parseFloat(priceData.price_usd || priceData.priceUsd || 0);
        if (isNaN(price)) {
          priceElement.textContent = '$0.00';
        } else {
          priceElement.textContent = `$${price.toExponential(2)}`;
        }
      }
      
      if (supplyElement) {
        const supply = priceData.total_supply || priceData.totalSupply || 0;
        if (isNaN(supply)) {
          supplyElement.textContent = '0';
        } else {
          supplyElement.textContent = formatNumber(supply);
        }
      }
    }
    
    // Update point stats
    function updatePointStats(priceData) {
      const priceElement = document.getElementById('currentPointPrice');
      const valueElement = document.getElementById('pointValue');
      
      if (priceElement) {
        const price = parseFloat(priceData.point_value_usd || priceData.pointValueUsd || 0);
        if (isNaN(price)) {
          priceElement.textContent = '$0.00';
        } else {
          priceElement.textContent = `$${price.toFixed(2)}`;
        }
      }
      
      if (valueElement) {
        const value = parseFloat(priceData.point_value_iam || priceData.pointValueIam || 0);
        if (isNaN(value)) {
          valueElement.textContent = '0.000000 IAM';
        } else {
          valueElement.textContent = `${value.toFixed(6)} IAM`;
        }
      }
    }
    
    // Create token chart
    function createTokenChart(canvas, history) {
      if (tokenChart) {
        tokenChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      
      const labels = history.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });
      
      const prices = history.map(item => parseFloat(item.price_usd));
      
      tokenChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Token Price (USD)',
            data: prices,
            borderColor: '#00ff88',
            backgroundColor: 'rgba(0, 255, 136, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#94a3b8',
                callback: function(value) {
                  return value.toExponential(2);
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          }
        }
      });
    }
    
    // Create point chart
    function createPointChart(canvas, history) {
      if (pointChart) {
        pointChart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      
      const labels = history.map(item => {
        const date = new Date(item.timestamp);
        return date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      });
      
      const prices = history.map(item => parseFloat(item.point_value_usd));
      
      pointChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Point Price (USD)',
            data: prices,
            borderColor: '#a786ff',
            backgroundColor: 'rgba(167, 134, 255, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#94a3b8',
                callback: function(value) {
                  return `$${value.toFixed(2)}`;
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          }
        }
      });
    }
    
    // Show chart error
    function showChartError(canvas, message) {
      if (!canvas) return;
      
      const container = canvas.parentElement;
      container.innerHTML = `
        <div class="error">
          <div class="error-icon">‚ö†Ô∏è</div>
          <div>${message}</div>
        </div>
      `;
    }
    
    // Show general error
    function showError(message) {
      const container = document.querySelector('.container');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'chart-card';
      errorDiv.innerHTML = `
        <div class="error">
          <div class="error-icon">‚ùå</div>
          <div>${message}</div>
        </div>
      `;
      container.appendChild(errorDiv);
    }
    
    // Start real-time auto refresh
    function startRealTimeAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
      
      // Auto-refresh every 30 seconds
      refreshInterval = setInterval(() => {
        console.log('üîÑ Auto-refresh triggered...');
        loadCharts();
      }, 30000); // 30 seconds
      
      console.log('‚úÖ Auto-refresh enabled: 30 seconds');
      
      // Also start price service auto-update
      if (priceService) {
        priceService.startAutoUpdate(1); // Every 1 minute
      }
    }
    
    
    // Format number with commas
    function formatNumber(num) {
      if (isNaN(num) || num === null || num === undefined) {
        return '0';
      }
      return new Intl.NumberFormat('en-US').format(num);
    }
  </script>
</body>
</html>