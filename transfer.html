<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer - IAM Platform</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/modern-theme.css">

    
    <style>
      body {
        background: linear-gradient(135deg, #0a0f1c, #1a1f2e);
        min-height: 100vh;
        margin: 0;
        padding: 1rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: #1a1f2e;
        border-radius: 12px;
        padding: 0.8rem;
        border: 2px solid #00ff88;
      }
      
      .header {
        text-align: center;
        margin-bottom: 0.8rem;
      }
      
      .header h1 {
        color: #00ff88;
        font-size: 1.8rem;
        margin: 0 0 0.2rem 0;
      }
      
      .back-btn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        background: linear-gradient(135deg, #a786ff, #00ff88);
        color: #0a0f1c;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9rem;
      }
      
      .form-group {
        margin-bottom: 0.5rem;
      }
      
      .form-group label {
        display: block;
        color: #00ff88;
        margin-bottom: 0.15rem;
        font-weight: 600;
        font-size: 0.9rem;
      }
      
      .form-group input, .form-group select {
        width: 100%;
        background: #0a0f1c;
        border: 2px solid #2a3441;
        color: #ffffff;
        padding: 0.6rem;
        border-radius: 6px;
        outline: none;
        font-size: 0.9rem;
      }
      
      .form-group input:focus, .form-group select:focus {
        border-color: #00ff88;
      }
      
      .search-row {
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }
      
      .search-row input {
        flex: 1;
      }
      
      .search-row button {
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        color: #0a0f1c;
        border: none;
        padding: 0.6rem 0.8rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
        font-size: 0.85rem;
      }
      
      .balance-container {
        margin: 0.4rem 0;
        display: flex;
        justify-content: center;
      }
      
      .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.3rem;
        margin: 0.4rem 0;
      }
      
      .balance-card {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 6px;
        padding: 0.4rem;
        text-align: center;
      }
      
      .balance-card h4 {
        color: #00ff88;
        margin: 0 0 0.1rem 0;
        font-size: 0.75rem;
      }
      
      .balance-card .amount {
        color: #ffffff;
        font-size: 0.75rem;
        font-weight: 600;
        font-family: monospace;
        word-break: break-all;
        line-height: 1.2;
      }
      
      .balance-card .usd-amount {
        color: #00ff88;
        font-size: 0.7rem;
        font-weight: 500;
        font-family: monospace;
        margin-top: 0.15rem;
      }
      
      .balance-card .usd-toggle-btn {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.4);
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-size: 0.65rem;
        cursor: pointer;
        margin-top: 0.15rem;
        transition: all 0.3s ease;
      }
      
      .balance-card .usd-toggle-btn:hover {
        background: rgba(0, 255, 136, 0.3);
        border-color: rgba(0, 255, 136, 0.6);
      }
      
      #transfer-usd-converter {
        background: rgba(0, 255, 136, 0.05);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 6px;
        padding: 0.5rem;
        margin-top: 0.3rem;
      }
      
      #transfer-usd-converter label {
        color: #00ff88;
        font-weight: 600;
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
      }
      
      #usdConversionStatus {
        font-size: 0.8rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
        padding: 0.4rem;
      }
      
      .transfer-btn {
        width: 100%;
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        color: #0a0f1c;
        border: none;
        border-radius: 6px;
        padding: 0.6rem;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 0.4rem;
      }
      
      .status {
        margin-top: 0.4rem;
        padding: 0.5rem;
        border-radius: 6px;
        text-align: center;
        font-weight: 500;
        font-size: 0.9rem;
      }
      
      .status.success {
        background: rgba(0, 255, 136, 0.1);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.3);
      }
      
      .status.error {
        background: rgba(255, 68, 68, 0.1);
        color: #ff4444;
        border: 1px solid rgba(255, 68, 68, 0.3);
      }
      
      .status.loading {
        background: rgba(167, 134, 255, 0.1);
        color: #a786ff;
        border: 1px solid rgba(167, 134, 255, 0.3);
      }
      
      #searchIndexStatus {
        font-size: 0.75rem;
        word-break: break-all;
        line-height: 1.3;
        font-family: monospace;
      }
      
      .wallet-status {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 6px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        text-align: center;
        font-size: 0.9rem;
      }
      

      
      @media (max-width: 768px) {
        .container {
          margin: 0.25rem;
          padding: 0.75rem;
        }
        
        .header h1 {
          font-size: 1.5rem;
        }
        
        .balance-container {
          margin: 0.3rem 0;
        }
        
        .balance-grid {
          grid-template-columns: 1fr;
          gap: 0.25rem;
        }
        
        .balance-card {
          padding: 0.3rem;
        }
        
        .balance-card h4 {
          font-size: 0.7rem;
        }
        
        .balance-card .amount {
          font-size: 0.7rem;
          word-break: break-all;
          line-height: 1.1;
        }
        
        .balance-card .usd-amount {
          font-size: 0.65rem;
        }
        
        .balance-card .usd-toggle-btn {
          font-size: 0.55rem;
          padding: 0.15rem 0.3rem;
        }
        
        #transfer-usd-converter {
          padding: 0.4rem;
          margin-top: 0.2rem;
        }
        
        #usdConversionStatus {
          font-size: 0.7rem;
          padding: 0.3rem;
        }
        
        #searchIndexStatus {
          font-size: 0.65rem;
          word-break: break-all;
          line-height: 1.2;
        }
      }
    </style>
</head>
<body>
    <!-- Back Button -->
    <a href="index.html" class="back-btn">‚Üê Back</a>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∏ Transfer</h1>
        </div>

        <!-- Wallet Status -->
        <div id="walletStatus" class="wallet-status" style="display: none;">
            <div>Wallet: <span id="addressDisplay">üîÑ Connecting...</span></div>
            <div id="connectionStatus" style="display:none;margin-top:0.5rem;">
                <div id="connectionMessage">‚ö†Ô∏è Connecting to wallet...</div>
            </div>
        </div>

        <!-- Transfer Form -->
        <form id="transferForm">
            <!-- Destination Address -->
            <div class="form-group">
                <label for="transferTo">Destination Address</label>
                <input type="text" id="transferTo" placeholder="0x..." required>
            </div>

            <!-- Index Search -->
            <div class="form-group">
                <label>üîç Search by Index</label>
                <div class="search-row">
                    <input type="number" id="searchIndex" placeholder="Enter user index">
                    <button type="button" id="searchIndexBtn">üîç Search</button>
                </div>
                <div id="searchIndexStatus" style="text-align:center;padding:0.5rem;margin-top:0.5rem;border-radius:6px;"></div>
            </div>

            <!-- Amount -->
            <div class="form-group">
                <label for="transferAmount">Amount</label>
                <div class="search-row">
                    <input type="number" id="transferAmount" placeholder="Enter amount" min="0" step="any" required>
                    <button type="button" id="maxAmountBtn">Max</button>
                </div>
            </div>

            <!-- USD Converter (for IAM token) -->
            <div id="transfer-usd-converter" class="form-group" style="display: none;">
                <label for="transferUsdAmount">üí≤ USD Amount</label>
                <div class="search-row">
                    <input type="number" id="transferUsdAmount" placeholder="Enter USD amount" min="0" step="0.01">
                    <button type="button" id="convertUsdToTokenBtn">üîÑ Convert</button>
                </div>
                <div id="usdConversionStatus" style="text-align:center;padding:0.5rem;margin-top:0.5rem;border-radius:6px;"></div>
            </div>

            <!-- Token Type -->
            <div class="form-group">
                <label for="transferToken">Token Type</label>
                <select id="transferToken" required>
                    <option value="DAI">üü¢ DAI</option>
                    <option value="POL">üîµ POL (MATIC)</option>
                    <option value="IAM">üü£ IAM</option>
                </select>
            </div>

            <!-- Selected Token Balance -->
            <div id="selected-token-balance" class="balance-container" style="display: none;">
                <div class="balance-card" id="selected-balance-card">
                    <h4 id="selected-token-name">üü¢ DAI</h4>
                    <div id="selected-token-amount" class="amount">-</div>
                    <div id="selected-token-usd" class="usd-amount" style="display: none;">-</div>
                    <button id="selected-token-usd-toggle" class="usd-toggle-btn" style="display: none;">üí≤ USD</button>
                </div>
            </div>

            <!-- Transfer Button -->
            <button type="submit" class="transfer-btn">üì§ Execute Transfer</button>
        </form>

        <!-- Status Message -->
        <div id="transferStatus" class="status"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/transfer-form.js"></script>

    
    <!-- Contract Configuration -->
    <script>
        // Contract Configuration - Updated to new contract
        window.IAM_ADDRESS = '0x2D3923A5ba62B2bec13b9181B1E9AE0ea2C8118D';
        
        // Use the full ABI from config.js instead of limited ABI
        // The full ABI will be loaded from config.js
        console.log('üîÑ Transfer page: Setting contract address to:', window.IAM_ADDRESS);
        
        // Ensure ABI is loaded from config.js
        if (window.IAM_ABI) {
            console.log('‚úÖ ABI loaded from config.js');
        } else {
            console.log('‚ö†Ô∏è ABI not loaded, waiting for config.js...');
            // Wait for config.js to load
            setTimeout(() => {
                if (window.IAM_ABI) {
                    console.log('‚úÖ ABI loaded after delay');
                } else {
                    console.error('‚ùå ABI still not available');
                }
            }, 1000);
        }
        
        // Force contract connection with new address
        window.ensureContractConnection = async function() {
            console.log('üîó Ensuring contract connection...');
            console.log('Contract Address:', window.IAM_ADDRESS);
            console.log('ABI Available:', !!window.IAM_ABI);
            console.log('Config Available:', !!window.contractConfig);
            
            if (window.contractConfig && window.contractConfig.contract) {
                console.log('‚úÖ Contract already connected');
                return window.contractConfig.contract;
            }
            
            if (window.ethereum && window.IAM_ADDRESS && window.IAM_ABI) {
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, signer);
                    
                    console.log('‚úÖ Contract connected successfully');
                    return contract;
                } catch (error) {
                    console.error('‚ùå Contract connection failed:', error);
                    return null;
                }
            } else {
                console.error('‚ùå Missing requirements for contract connection');
                return null;
            }
        };
        
        // Auto-connect to new contract on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Transfer page loaded, ensuring new contract connection');
            
            // Force contract update
            if (typeof window.forceContractUpdate === 'function') {
                window.forceContractUpdate();
            }
            
            // Ensure contract connection
            setTimeout(() => {
                window.ensureContractConnection();
            }, 1000);
        });
    </script>
    
    <script>

        
        // Update wallet display
        function updateWalletButton() {
            const addressDisplay = document.getElementById('addressDisplay');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionMessage = document.getElementById('connectionMessage');
            
            if (window.transferManager && window.transferManager.signer) {
                if (addressDisplay) {
                    window.transferManager.signer.getAddress().then(address => {
                        const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                        addressDisplay.textContent = 'üü¢ ' + shortAddress;
                    }).catch(() => {
                        addressDisplay.textContent = 'üü¢ Connected';
                    });
                }
                
                if (connectionStatus && connectionMessage) {
                    connectionStatus.style.display = 'block';
                    connectionStatus.style.background = 'rgba(0, 255, 136, 0.1)';
                    connectionStatus.style.border = '1px solid rgba(0, 255, 136, 0.3)';
                    connectionStatus.style.color = '#00ff88';
                    connectionMessage.textContent = '‚úÖ Connected!';
                }
            } else {
                if (addressDisplay) {
                    addressDisplay.textContent = 'üîÑ Connecting...';
                }
                
                if (connectionStatus && connectionMessage) {
                    connectionStatus.style.display = 'block';
                    connectionStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    connectionStatus.style.border = '1px solid rgba(255, 193, 7, 0.3)';
                    connectionStatus.style.color = '#ffc107';
                    connectionMessage.textContent = '‚ö†Ô∏è Connecting...';
                }
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof ethers === 'undefined') {
                console.error('Ethers.js not loaded');
                return;
            }
            
            let attempts = 0;
            while (attempts < 50) {
                if (typeof window.TransferManager !== 'undefined') {
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof window.TransferManager === 'undefined') {
                console.error('TransferManager not found');
                return;
            }
            
            try {
                window.transferManager = new window.TransferManager();
                await window.transferManager.initializeTransfer();
                updateWalletButton();
                setupSearchFunctionality();
            } catch (error) {
                console.error('Error initializing TransferManager:', error);
            }
        });
        
        // Setup search functionality
        function setupSearchFunctionality() {
            const searchIndexBtn = document.getElementById('searchIndexBtn');
            const searchIndexInput = document.getElementById('searchIndex');
            const searchIndexStatus = document.getElementById('searchIndexStatus');
            const transferToInput = document.getElementById('transferTo');
            
            if (!searchIndexBtn || !searchIndexInput || !searchIndexStatus || !transferToInput) {
                return;
            }
            
            searchIndexBtn.addEventListener('click', performIndexSearch);
            searchIndexInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performIndexSearch();
                }
            });
            
            async function performIndexSearch() {
                const index = searchIndexInput.value.trim();
                
                if (!index || isNaN(index) || parseInt(index) < 1) {
                    showSearchStatus('Please enter a valid index (number > 0)', 'error');
                    return;
                }
                
                try {
                    showSearchStatus('üîç Searching for user...', 'loading');
                    searchIndexBtn.disabled = true;
                    searchIndexBtn.textContent = 'üîÑ Searching...';
                    
                    console.log('üîç Starting search for index:', index);
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Search timeout after 15 seconds')), 15000)
                    );
                    
                    const searchPromise = convertIndexToAddress(parseInt(index));
                    const address = await Promise.race([searchPromise, timeoutPromise]);
                    
                    console.log('üéØ Search result:', address);
                    
                    if (address && address !== '0x0000000000000000000000000000000000000000') {
                        transferToInput.value = address;
                        showSearchStatus(`‚úÖ Found: ${address}`, 'success');
                    } else {
                        showSearchStatus('‚ùå User not found for this index', 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Search error:', error);
                    let errorMessage = '‚ùå Search failed';
                    
                    if (error.message.includes('timeout')) {
                        errorMessage = '‚è∞ Search timeout - try again';
                    } else if (error.message.includes('MetaMask')) {
                        errorMessage = 'ü¶ä MetaMask connection issue';
                    } else if (error.message.includes('Contract')) {
                        errorMessage = 'üìã Contract call failed';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'üë§ User not found for this index';
                    }
                    
                    showSearchStatus(errorMessage, 'error');
                } finally {
                    searchIndexBtn.disabled = false;
                    searchIndexBtn.textContent = 'üîç Search';
                }
            }
            
            function showSearchStatus(message, type) {
                searchIndexStatus.textContent = message;
                searchIndexStatus.className = `search-status ${type}`;
                
                switch (type) {
                    case 'success':
                        searchIndexStatus.style.background = 'rgba(0, 255, 136, 0.1)';
                        searchIndexStatus.style.color = '#00ff88';
                        searchIndexStatus.style.border = '1px solid rgba(0, 255, 136, 0.3)';
                        break;
                    case 'error':
                        searchIndexStatus.style.background = 'rgba(255, 68, 68, 0.1)';
                        searchIndexStatus.style.color = '#ff4444';
                        searchIndexStatus.style.border = '1px solid rgba(255, 68, 68, 0.3)';
                        break;
                    case 'loading':
                        searchIndexStatus.style.background = 'rgba(255, 165, 0, 0.1)';
                        searchIndexStatus.style.color = '#ffa500';
                        searchIndexStatus.style.border = '1px solid rgba(255, 165, 0, 0.3)';
                        break;
                }
            }
        }
        
        // Convert index to address
        async function convertIndexToAddress(index) {
            try {
                console.log('üîç Starting index to address conversion for index:', index);
                
                if (!window.ethereum) {
                    throw new Error('MetaMask not installed');
                }
                
                // Check if wallet is connected
                let accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (!accounts || accounts.length === 0) {
                    console.log('‚ö†Ô∏è No accounts found, requesting connection...');
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (!accounts || accounts.length === 0) {
                        throw new Error('Please connect your wallet first');
                    }
                }
                
                console.log('‚úÖ Wallet connected:', accounts[0]);
                
                let provider;
                if (typeof ethers.providers !== 'undefined' && ethers.providers.Web3Provider) {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } else if (typeof ethers.BrowserProvider !== 'undefined') {
                    provider = new ethers.BrowserProvider(window.ethereum);
                } else {
                    throw new Error('Ethers.js provider not available');
                }
                
                const signer = await provider.getSigner();
                console.log('‚úÖ Provider and signer created');
                
                if (!window.IAM_ADDRESS) {
                    throw new Error('Contract address not available');
                }
                
                console.log('‚úÖ Contract config available:', window.IAM_ADDRESS);
                
                // Use ABI from config.js
                const abi = window.IAM_ABI || window.CONTRACT_ABI;
                if (!abi) {
                    throw new Error('Contract ABI not available');
                }
                
                console.log('‚úÖ Using ABI from config.js');
                const contract = new ethers.Contract(window.IAM_ADDRESS, abi, signer);
                console.log('‚úÖ Contract instance created');
                
                // First check total users to validate index
                try {
                    const totalUsers = await contract.getTotalUsers();
                    console.log('üìä Total users in contract:', totalUsers.toString());
                    
                    if (index > parseInt(totalUsers.toString())) {
                        throw new Error(`Index ${index} is greater than total users (${totalUsers.toString()})`);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Could not get total users, proceeding anyway...');
                }
                
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Contract call timeout')), 10000)
                );
                
                console.log('üîÑ Calling getUserAddress for index:', index);
                
                // Try multiple methods to get user address
                let address = null;
                
                try {
                    // Method 1: getUserAddress
                    const contractPromise1 = contract.getUserAddress(index);
                    address = await Promise.race([contractPromise1, timeoutPromise]);
                    console.log('üìã getUserAddress response:', address);
                } catch (error1) {
                    console.log('‚ö†Ô∏è getUserAddress failed, trying indexToAddress...');
                    
                    try {
                        // Method 2: indexToAddress
                        const contractPromise2 = contract.indexToAddress(index);
                        address = await Promise.race([contractPromise2, timeoutPromise]);
                        console.log('üìã indexToAddress response:', address);
                    } catch (error2) {
                        console.log('‚ö†Ô∏è indexToAddress failed, trying wallets...');
                        
                        try {
                            // Method 3: wallets (array access)
                            const contractPromise3 = contract.wallets(index - 1); // wallets is 0-indexed
                            address = await Promise.race([contractPromise3, timeoutPromise]);
                            console.log('üìã wallets response:', address);
                        } catch (error3) {
                            console.error('‚ùå All methods failed:', { error1, error2, error3 });
                            throw new Error('User not found - index may be invalid or user not registered');
                        }
                    }
                }
                
                if (address && address !== '0x0000000000000000000000000000000000000000') {
                    console.log('‚úÖ Address found:', address);
                    return address;
                } else {
                    throw new Error('User not found or invalid index');
                }
                
            } catch (error) {
                console.error('‚ùå Error in convertIndexToAddress:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
