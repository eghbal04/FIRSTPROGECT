<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="css/mobile-responsive.css">
    <script src="js/mobile-navigation.js"></script>
    <script src="js/mobile-optimizer.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Inter', 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #232946 0%, #181c2a 100%);
            margin: 0;
            padding: 0;
            direction: ltr;
            color: #e0e6f7;
        }
        .container {
            max-width: 600px;
            margin: 20px auto;
            background: rgba(35,41,70,0.98);
            border-radius: 12px;
            box-shadow: 0 2px 12px #0005;
            padding: 20px 16px 16px 16px;
            border: 1px solid #a786ff33;
        }
        
        /* Responsive Design for different screen sizes */
        @media (max-width: 768px) {
            .back-btn {
                top: 0.5rem;
                left: 0.5rem;
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .container {
                max-width: 98%;
                margin: 10px auto;
                padding: 16px 12px 12px 12px;
            }
            h1 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }
            .balance-box {
                flex-direction: column;
                gap: 8px;
                margin: 8px 0 12px 0;
                padding: 10px 8px 6px 8px;
            }
            .balance-item {
                flex: none;
                min-width: auto;
                margin: 0;
            }
            .balance-label {
                font-size: 0.85em;
            }
            .balance-value {
                font-size: 0.9em;
            }
            .profile-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 6px 0;
                font-size: 0.9em;
            }
            .profile-value {
                word-break: break-all;
                font-size: 0.85em;
            }
        }
        
        @media (max-width: 480px) {
            .back-btn {
                top: 0.25rem;
                left: 0.25rem;
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .container {
                max-width: 99%;
                margin: 5px auto;
                padding: 12px 8px 8px 8px;
            }
            h1 {
                font-size: 1.3em;
                margin-bottom: 8px;
            }
            .balance-box {
                padding: 8px 6px 4px 6px;
                margin: 6px 0 8px 0;
                gap: 6px;
            }
            .balance-label {
                font-size: 0.8em;
            }
            .balance-value {
                font-size: 0.85em;
            }
            .profile-row {
                font-size: 0.85em;
                padding: 4px 0;
                gap: 2px;
            }
            .profile-value {
                font-size: 0.8em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 80%;
                padding: 32px 28px 24px 28px;
            }
            .balance-box {
                gap: 20px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 700px;
                padding: 40px 32px 32px 32px;
            }
            .balance-box {
                gap: 24px;
            }
            .balance-item {
                flex: 1 1 140px;
                min-width: 140px;
            }
        }
        h1 {
            text-align: center;
            color: #00ff88;
            margin-bottom: 16px;
            font-weight: 700;
            letter-spacing: 0.3px;
            font-size: 1.8em;
            text-shadow: 0 1px 4px #00ff8822;
        }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2d3250;
            font-size: 0.95em;
        }
        .profile-row:last-child { border-bottom: none; }
        .profile-label { color: #a786ff; font-weight: bold; }
        .profile-value { color: #e0e6f7; font-family: monospace; }
        .balance-box {
            background: #181c2a;
            border-radius: 8px;
            margin: 12px 0 16px 0;
            box-shadow: 0 1px 4px #a786ff11;
            padding: 12px 10px 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
        }
        .balance-item {
            flex: 1 1 100px;
            min-width: 100px;
            margin: 0 4px;
            text-align: center;
        }
        .balance-label { color: #00ff88; font-weight: bold; font-size: 0.9em; }
        .balance-value { color: #fff; font-size: 1em; font-family: monospace; margin-top: 2px; display: block; }
        
        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(135deg, #a786ff, #00ff88);
            color: #181c2a;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(167, 134, 255, 0.3);
        }

        .loading, .error-message {
            text-align: center;
            margin: 24px 0;
            color: #a786ff;
        }
        .error-message { color: #ff4444; }
        #copyProfileReferral:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        #copyProfileReferral:active {
            transform: translateY(0);
        }
        
        /* Responsive withdrawal buttons */
        @media (max-width: 768px) {
            .withdrawal-buttons {
                flex-direction: column !important;
                gap: 0.6rem !important;
                margin-bottom: 1rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.6em 1.2em !important;
                font-size: 0.9em !important;
            }
        }
        
        @media (max-width: 480px) {
            .withdrawal-buttons {
                gap: 0.4rem !important;
                margin-bottom: 0.8rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.5em 1em !important;
                font-size: 0.8em !important;
            }
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <a href="index.html" class="back-btn">← Back</a>
    
    <div class="container">
        <h1>User Profile</h1>
        <div id="profile-content">
            <div class="loading">Loading information...</div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/profile.js"></script>
    <script>
    function formatDateTime(ts) {
        if (!ts || ts == 0) return '-';
        // Convert to string and then number to avoid BigInt error
        let n = Number(ts.toString());
        if (isNaN(n)) return '-';
        // If the value is in seconds (small), multiply by 1000
        if (n < 10000000000) n = n * 1000;
        const d = new Date(n);
        if (isNaN(d.getTime())) return '-';
        // YYYY-MM-DD HH:mm
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    
    // Function to initialize withdrawal timers
    function startWithdrawalTimers(user) {
        const claimTimer = document.getElementById('claim-timer');
        const cashbackTimer = document.getElementById('cashback-timer');
        const upgradeTimer = document.getElementById('upgrade-timer');
        
        if (!claimTimer) return;
        
        // Commission withdrawal timer (every 12 hours)
        function updateClaimTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastClaim = user.lastClaimTime ? Number(user.lastClaimTime) : 0;
            const nextClaimTime = lastClaim + (12 * 3600); // 12 hours
            const timeLeft = nextClaimTime - now;
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                claimTimer.textContent = `⏰ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                claimTimer.style.color = '#ff4444';
                claimTimer.style.fontWeight = 'bold';
            } else {
                claimTimer.textContent = '✅ Ready';
                claimTimer.style.color = '#00ff88';
                claimTimer.style.fontWeight = 'bold';
            }
        }
        
        // Cashback withdrawal timer (every 30 days) - only if button exists
        function updateCashbackTimer() {
            if (!cashbackTimer) return;
            
            const now = Math.floor(Date.now() / 1000);
            const lastCashback = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
            const nextCashbackTime = lastCashback + (30 * 24 * 3600); // 30 days
            const timeLeft = nextCashbackTime - now;
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (24 * 3600));
                const hours = Math.floor((timeLeft % (24 * 3600)) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                
                if (days > 0) {
                    cashbackTimer.textContent = `⏰ ${days}d ${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    cashbackTimer.textContent = `⏰ ${hours}h ${minutes}m`;
                } else {
                    cashbackTimer.textContent = `⏰ ${minutes}m`;
                }
                cashbackTimer.style.color = '#ff4444';
                cashbackTimer.style.fontWeight = 'bold';
            } else {
                cashbackTimer.textContent = '✅ Ready';
                cashbackTimer.style.color = '#00ff88';
                cashbackTimer.style.fontWeight = 'bold';
            }
        }
        
        // Upgrade cap timer (every 4 weeks = 28 days)
        function updateUpgradeTimer() {
            if (!upgradeTimer) return;
            
            const now = Math.floor(Date.now() / 1000);
            const lastUpgrade = user.upgradeTime ? Number(user.upgradeTime) : 0;
            const nextUpgradeTime = lastUpgrade + (28 * 24 * 3600); // 28 days (4 weeks)
            const timeLeft = nextUpgradeTime - now;
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (24 * 3600));
                const hours = Math.floor((timeLeft % (24 * 3600)) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                
                if (days > 0) {
                    upgradeTimer.textContent = `⏰ ${days}d ${hours}h`;
                } else if (hours > 0) {
                    upgradeTimer.textContent = `⏰ ${hours}h ${minutes}m`;
                } else {
                    upgradeTimer.textContent = `⏰ ${minutes}m`;
                }
                upgradeTimer.style.color = '#ff4444';
                upgradeTimer.style.fontWeight = 'bold';
            } else {
                upgradeTimer.textContent = '✅ Ready';
                upgradeTimer.style.color = '#00ff88';
                upgradeTimer.style.fontWeight = 'bold';
            }
        }
        
        // Initialize timers
        updateClaimTimer();
        updateCashbackTimer();
        updateUpgradeTimer();
        
        // Update every second
        setInterval(updateClaimTimer, 1000);
        setInterval(updateCashbackTimer, 1000);
        setInterval(updateUpgradeTimer, 1000);
    }
    async function loadProfile() {
        const content = document.getElementById('profile-content');
        content.innerHTML = '<div class="loading">Loading information...</div>';
        try {
            if (!window.connectWallet) throw new Error('Wallet connection is not active');
            const { contract, address, provider } = await window.connectWallet();
            if (!contract || !address) throw new Error('Wallet connection failed');
            // User struct information with error handling
            async function fetchUserSafe(addr) {
                try {
                    return await contract.users(addr);
                } catch (e) {
                    console.warn('users(address) decode failed, using defaults:', e);
                    return {
                        index: 0n,
                        binaryPoints: 0n,
                        binaryPointCap: 0n,
                        binaryPointsClaimed: 0n,
                        activated: false,
                        totalPurchasedKind: 0n,
                        upgradeTime: 0n,
                        lastClaimTime: 0n,
                        leftPoints: 0n,
                        rightPoints: 0n,
                        lastMonthlyClaim: 0n,
                        totalMonthlyRewarded: 0n,
                        refclimed: 0n,
                        depositedAmount: 0n
                    };
                }
            }
            const user = await fetchUserSafe(address);
            // Balances
            const maticBalance = await provider.getBalance(address);
            const IAMBalance = await contract.balanceOf(address);
            
            // Function to format large numbers
            function formatLargeNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return num.toFixed(2);
                }
            }
            
            // Calculate IAM USD equivalent
            let IAMUsdValue = 0;
            let tokenPrice = 0;
            try {
                if (typeof contract.getTokenPrice === 'function') {
                    const tokenPriceRaw = await contract.getTokenPrice();
                    tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    const IAMAmount = Number(ethers.formatUnits(IAMBalance, 18));
                    IAMUsdValue = IAMAmount * tokenPrice;
                }
            } catch (e) {
                console.log('Error getting token price:', e);
            }
            
            // DAI
            let daiBalance = '0';
            try {
                const daiAddress = window.DAI_ADDRESS || '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';
                const daiAbi = window.DAI_ABI || [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
                const dai = new ethers.Contract(daiAddress, daiAbi, provider);
                const daiRaw = await dai.balanceOf(address);
                daiBalance = ethers.formatUnits(daiRaw, 18);
            } catch {}
            // Index
            const IAMId = user.index ? `IAM${user.index.toString().padStart(5, '0')}` : '-';
            // Condition for monthly cashback button activation
            let canMonthlyCashback = false;
            let monthlyMsg = '';
            
            // Check if user is active (has an index)
            if (!user.index || BigInt(user.index) <= 0n) {
                monthlyMsg = 'You must be an active user to access cashback withdrawal.';
            } else {
                const now = Math.floor(Date.now() / 1000);
                const lastMonthly = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
                const oneMonth = 30 * 24 * 60 * 60;
                
                // Check for empty child (left or right)
                let hasEmptyChild = false;
                if (typeof contract.indexToAddress === 'function') {
                    const leftAddr = await contract.indexToAddress(BigInt(user.index) * 2n);
                    const rightAddr = await contract.indexToAddress(BigInt(user.index) * 2n + 1n);
                    if (!leftAddr || leftAddr === '0x0000000000000000000000000000000000000000' || !rightAddr || rightAddr === '0x0000000000000000000000000000000000000000') {
                        hasEmptyChild = true;
                    }
                }
                
                if (hasEmptyChild && (now - lastMonthly >= oneMonth)) {
                    canMonthlyCashback = true;
                } else {
                    if (!hasEmptyChild) monthlyMsg = 'To withdraw monthly cashback, you must have at least one empty child position.';
                    else if (now - lastMonthly < oneMonth) monthlyMsg = 'At least one month must have passed since the last monthly withdrawal.';
                }
            }
            // Display
            content.innerHTML = `
                <div class="balance-box">
                    <div class="balance-item">
                        <div class="balance-label">IAM</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)))}</span>
                        <div style="font-size:0.8rem;color:#a786ff;margin-top:2px;">≈ $${formatLargeNumber(IAMUsdValue)}</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">MATIC</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatEther(maticBalance.toString())).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatEther(maticBalance.toString())))}</span>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">DAI</div>
                        <span class="balance-value" title="${Number.parseFloat(daiBalance.toString()).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(daiBalance.toString()))}</span>
                    </div>
                </div>
                <div class="withdrawal-buttons" style="display:flex;gap:0.8rem;justify-content:center;margin-bottom:1rem;flex-wrap:wrap;">
                  <button id="claim-btn" title="Commission withdrawal is only possible once every 12 hours and if you have points to withdraw. If you don't have points or 12 hours haven't passed yet, withdrawal is not possible." style="background:linear-gradient(90deg,#00ff88,#a786ff);color:#181c2a;font-weight:bold;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:0.95em;cursor:pointer;box-shadow:0 1px 4px #00ff8840;display:inline-flex;align-items:center;gap:0.4em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1em;'>💸</span> Withdraw Commission <span id="claim-timer" style="font-size:0.8em;margin-right:0.3em;"></span></button>
                  ${canMonthlyCashback ? `<button id="monthly-cashback-btn" title="Cashback withdrawal is only possible once every 30 days, with at least one empty child position and up to the deposit limit. If both positions are full or 30 days haven't passed or the cashback limit is reached, withdrawal is not possible." style="background:linear-gradient(90deg,#a786ff,#00ff88);color:#181c2a;font-weight:bold;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:0.95em;cursor:pointer;box-shadow:0 1px 4px #a786ff40;display:inline-flex;align-items:center;gap:0.4em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1em;'>📆</span> Cashback <span id="cashback-timer" style="font-size:0.8em;margin-right:0.3em;"></span></button>` : ''}
                  <button id="upgrade-cap-btn" title="Upgrade binary points cap using IAM tokens. The more you upgrade, the higher your points cap becomes." style="background:linear-gradient(90deg,#ff6b35,#ff8e53);color:#181c2a;font-weight:bold;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:0.95em;cursor:pointer;box-shadow:0 1px 4px #ff6b3540;display:inline-flex;align-items:center;gap:0.4em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1em;'>📈</span> Upgrade Cap <span id="upgrade-timer" style="font-size:0.8em;margin-right:0.3em;"></span></button>
                </div>
                ${!canMonthlyCashback && monthlyMsg ? `<div style="background:rgba(167,134,255,0.08);border:1.5px solid #a786ff;border-radius:10px;padding:1em 1.2em;margin-bottom:1.5rem;text-align:center;font-size:1.07em;color:#a786ff;box-shadow:0 2px 8px #a786ff22;"><span style='font-size:1.2em;'>📆</span> <b>Cashback Not Available:</b><br>${monthlyMsg}</div>` : ''}
                <div id="monthly-cashback-msg" style="display:none;color:#ff4444;text-align:center;margin-bottom:1.2rem;font-size:1.05em;transition:opacity 0.3s;"></div>
                
                                                   <!-- Upgrade Cap Modal -->
                  <div id="upgrade-cap-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px);">
                      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(35,41,70,0.98);border-radius:18px;padding:2rem;max-width:600px;width:90%;border:2px solid #ff6b3533;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
                          <div style="text-align:center;margin-bottom:1.5rem;">
                              <h3 style="color:#ff6b35;margin:0;font-size:1.5em;">📈 Upgrade Binary Points Cap</h3>
                              <p style="color:#ccc;margin:0.5rem 0;font-size:0.9em;">You can purchase up to 2 points every 4 weeks</p>
                          </div>
                          
                          <div style="margin-bottom:1.5rem;">
                              <label style="display:block;color:#a786ff;margin-bottom:0.5rem;font-weight:bold;">IAM Amount for Upgrade:</label>
                              <input type="number" id="upgrade-cap-amount" placeholder="Enter IAM amount" style="width:100%;padding:0.8rem;border:2px solid #ff6b3333;border-radius:8px;background:rgba(255,107,51,0.1);color:#fff;font-size:1rem;box-sizing:border-box;">
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Balance: </span>
                                  <span id="upgrade-cap-balance" style="color:#00ff88;font-weight:bold;">Loading...</span>
                              </div>
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Cap: </span>
                                  <span id="upgrade-cap-current" style="color:#a786ff;font-weight:bold;">Loading...</span>
                              </div>
                          </div>
                          
                          <div style="display:flex;gap:1rem;justify-content:center;">
                              <button id="upgrade-cap-confirm" style="background:linear-gradient(90deg,#ff6b35,#ff8e53);color:#181c2a;border:none;border-radius:8px;padding:0.8rem 1.5rem;font-weight:bold;cursor:pointer;transition:all 0.2s;">Confirm Upgrade</button>
                              <button id="upgrade-cap-cancel" style="background:rgba(255,255,255,0.1);color:#ccc;border:1px solid #666;border-radius:8px;padding:0.8rem 1.5rem;cursor:pointer;transition:all 0.2s;">Cancel</button>
                          </div>
                          
                          <div id="upgrade-cap-status" style="margin-top:1rem;text-align:center;font-size:0.9em;min-height:1.5em;"></div>
                      </div>
                  </div>
                <div class="profile-row"><span class="profile-label">Wallet Address:</span><span class="profile-value">${address}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID:</span><span class="profile-value">${IAMId}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID Number:</span><span class="profile-value">${user.index}</span></div>
                <div class="profile-row"><span class="profile-label">Active:</span><span class="profile-value">${(user.index && BigInt(user.index) > 0n) ? 'Yes' : 'No'}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points:</span><span class="profile-value">${user.binaryPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points Cap:</span><span class="profile-value">${user.binaryPointCap}</span></div>
                <div class="profile-row"><span class="profile-label">Claimed Points:</span><span class="profile-value">${user.binaryPointsClaimed}</span></div>
                <div class="profile-row"><span class="profile-label">Total Purchases:</span><span class="profile-value">${user.totalPurchasedKind}</span></div>
                <div class="profile-row"><span class="profile-label">Upgrade Time:</span><span class="profile-value">${formatDateTime(user.upgradeTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Last Points Withdrawal:</span><span class="profile-value">${formatDateTime(user.lastClaimTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Left Points:</span><span class="profile-value">${user.leftPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Right Points:</span><span class="profile-value">${user.rightPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Left Wallets Count:</span><span class="profile-value" id="profile-left-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Right Wallets Count:</span><span class="profile-value" id="profile-right-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Last Monthly Withdrawal:</span><span class="profile-value">${formatDateTime(user.lastMonthlyClaim)}</span></div>
                <div class="profile-row"><span class="profile-label">Total Monthly Rewards:</span><span class="profile-value">${user.totalMonthlyRewarded}</span></div>
                <div class="profile-row"><span class="profile-label">Deposit:</span><span class="profile-value">${Number(user.depositedAmount.toString())/1e18|0}</span></div>
                                 <div class="profile-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                     <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                         <span class="profile-label">Referral Reward:</span>
                         <span class="profile-value">${Number(user.refclimed.toString())/1e18|0} IAM</span>
                     </div>
                     <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                         <span class="profile-label">USD Value:</span>
                         <span class="profile-value">$${formatLargeNumber(Number(user.refclimed.toString())/1e18 * tokenPrice)}</span>
                     </div>
                     <div style="display: flex; flex-direction: column; gap: 8px; width: 100%; background: rgba(167,134,255,0.08); border-radius: 6px; padding: 8px; border: 1px solid #a786ff22;">
                         <div style="display: flex; align-items: center; gap: 8px; width: 100%; flex-wrap: wrap;">
                             <span class="profile-value" id="profile-referral-link" style="flex: 1; min-width: 200px; word-break: break-all; font-size: 0.85em; color: #a786ff; font-family: monospace; background: rgba(0,0,0,0.1); padding: 4px 6px; border-radius: 4px;">${window.location.origin}/?ref=${user.index && BigInt(user.index) > 0n ? user.index : address}</span>
                             <button id="copyProfileReferral" style="background: linear-gradient(90deg,#00ff88,#a786ff); color: #181c2a; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.8em; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.2s; min-width: 60px; flex-shrink: 0;">Copy</button>
                         </div>
                         <div style="font-size: 0.75em; color: #a786ff; opacity: 0.8; text-align: center; margin-top: 4px;">
                             Share this link to earn referral rewards (10% of registration fee)
                         </div>
                     </div>
                 </div>
            `;
            setTimeout(function() {
              const cashbackBtn = document.getElementById('monthly-cashback-btn');
              const cashbackMsg = document.getElementById('monthly-cashback-msg');
              
              // Claim button (commission withdrawal)
              const claimBtn = document.getElementById('claim-btn');
              if (claimBtn) {
                claimBtn.addEventListener('click', async function(e) {
                  console.log('Claim button clicked!'); // for debugging
                  claimBtn.disabled = true;
                  claimBtn.style.opacity = '0.5';
                  claimBtn.style.cursor = 'not-allowed';
                  cashbackMsg.style.display = 'block';
                  cashbackMsg.style.opacity = '1';
                  cashbackMsg.style.background = 'rgba(167,134,255,0.08)';
                  cashbackMsg.style.border = '1.5px solid #a786ff';
                  cashbackMsg.style.borderRadius = '10px';
                  cashbackMsg.style.padding = '1em 1.2em';
                  cashbackMsg.style.marginBottom = '1.2rem';
                  cashbackMsg.style.textAlign = 'center';
                  cashbackMsg.style.fontSize = '1.07em';
                  cashbackMsg.style.boxShadow = '0 2px 8px #a786ff22';
                  cashbackMsg.style.whiteSpace = 'pre-line';
                  
                  // Display specific message for claim operation
                  cashbackMsg.innerHTML = '<b>💸 Commission Withdrawal Operation:</b><br>• This operation withdraws your binary rewards<br>• Withdrawal is only possible once every 12 hours<br>• You must have active points<br>• If you don\'t have points or 12 hours haven\'t passed, withdrawal is not possible<br><br><b>🔍 Checking conditions...</b>';
                  cashbackMsg.style.color = '#a786ff';
                  
                  try {
                    const { contract, address } = await window.connectWallet();
                    const user = await fetchUserSafe(address);
                    const now = Math.floor(Date.now() / 1000);
                    
                    // Check withdrawal conditions
                    if (!(user.index && BigInt(user.index) > 0n)) {
                      throw new Error('Your account is not active. You must register first.');
                    }
                    
                    if (user.binaryPoints == 0) {
                      throw new Error('You have no points to withdraw.');
                    }
                    
                    if (now < Number(user.lastClaimTime) + 12 * 3600) {
                      const remain = Math.ceil((Number(user.lastClaimTime) + 12 * 3600 - now) / 3600);
                      throw new Error(`Still ${remain} hours remaining until next withdrawal.`);
                    }
                    
                    cashbackMsg.innerHTML = '⏳ Sending commission withdrawal request...';
                    cashbackMsg.style.color = '#00ff88';
                    
                    // Call claim function
                    const tx = await contract.claim();
                    
                    cashbackMsg.innerHTML = '⏳ Waiting for transaction confirmation in wallet...';
                    cashbackMsg.style.color = '#a786ff';
                    
                    await tx.wait();
                    
                    cashbackMsg.innerHTML = '✅ Commission withdrawal completed successfully!';
                    cashbackMsg.style.color = '#00ff88';
                    cashbackMsg.style.background = 'rgba(0,255,136,0.08)';
                    cashbackMsg.style.border = '1.5px solid #00ff88';
                    
                    setTimeout(() => {
                      cashbackMsg.style.display = 'none';
                      loadProfile(); // Reload profile
                    }, 2000);
                    
                  } catch(err) {
                    console.error('Claim error:', err); // for debugging
                    let errorMsg = 'Error in commission withdrawal';
                    
                    if (err.code === 4001 || err.message.includes('user denied')) {
                      errorMsg = '❌ Transaction was cancelled by user.';
                    } else if (err.code === -32002 || err.message.includes('Already processing')) {
                      errorMsg = '⏳ Wallet is processing another request. Please wait.';
                    } else if (err.message.includes('network')) {
                      errorMsg = '❌ Network error! Check your internet connection.';
                    } else if (err.message.includes('insufficient funds')) {
                      errorMsg = '❌ Insufficient balance to pay transaction fee.';
                    } else {
                      errorMsg = '❌ ' + (err.message || 'Unknown withdrawal error');
                    }
                    
                    cashbackMsg.innerHTML = errorMsg;
                    cashbackMsg.style.color = '#ff4444';
                    cashbackMsg.style.background = 'rgba(255,68,68,0.08)';
                    cashbackMsg.style.border = '1.5px solid #ff4444';
                    
                    setTimeout(() => {
                      cashbackMsg.style.display = 'none';
                    }, 5000);
                  }
                  
                  claimBtn.disabled = false;
                  claimBtn.style.opacity = '';
                  claimBtn.style.cursor = '';
                });
              }
              
              // Cashback button (monthly withdrawal)
              if (cashbackBtn && cashbackMsg) {
                cashbackBtn.addEventListener('click', async function(e) {
                  console.log('Cashback button clicked!'); // for debugging
                  cashbackBtn.disabled = true;
                  cashbackBtn.style.opacity = '0.5';
                  cashbackBtn.style.cursor = 'not-allowed';
                  cashbackMsg.style.display = 'block';
                  cashbackMsg.style.opacity = '1';
                  cashbackMsg.style.background = 'rgba(0,255,136,0.08)';
                  cashbackMsg.style.border = '1.5px solid #00ff88';
                  cashbackMsg.style.borderRadius = '10px';
                  cashbackMsg.style.padding = '1em 1.2em';
                  cashbackMsg.style.marginBottom = '1.2rem';
                  cashbackMsg.style.textAlign = 'center';
                  cashbackMsg.style.fontSize = '1.07em';
                  cashbackMsg.style.boxShadow = '0 2px 8px #00ff8822';
                  cashbackMsg.style.whiteSpace = 'pre-line';
                  
                  // Display specific message for cashback operation
                  cashbackMsg.innerHTML = '<b>📆 Monthly Cashback Withdrawal Operation:</b><br>• This operation withdraws your monthly reward<br>• Withdrawal is only possible once every 30 days<br>• You must have at least one empty child position<br>• Cashback limit equals your deposit amount<br>• <span style=\'color:#a786ff\'>If there is sufficient balance in the help fund, <b>three percent</b> of your payment amount is paid as monthly cashback.</span><br><br><b>🔍 Checking conditions...</b>';
                  cashbackMsg.style.color = '#00ff88';
                  
                  try {
                    const { contract, address } = await window.connectWallet();
                    const user = await fetchUserSafe(address);
                    const now = Math.floor(Date.now() / 1000);
                    const leftAddr = await contract.getLeftAddress(user.index);
                    const rightAddr = await contract.getRightAddress(user.index);
                    
                    // Check cashback withdrawal conditions
                    if (!(user.index && BigInt(user.index) > 0n)) {
                      throw new Error('Your account is not active. You must register first.');
                    }
                    
                    if (leftAddr != '0x0000000000000000000000000000000000000000' && rightAddr != '0x0000000000000000000000000000000000000000') {
                      throw new Error('To withdraw cashback, you must have at least one empty child position.');
                    }
                    
                    if (now < Number(user.lastMonthlyClaim) + 30 * 24 * 3600) {
                      const remain = Math.ceil((Number(user.lastMonthlyClaim) + 30 * 24 * 3600 - now) / (24*3600));
                      throw new Error(`Still ${remain} days remaining until next cashback withdrawal.`);
                    }
                    
                    if (user.totalMonthlyRewarded >= user.depositedAmount) {
                      throw new Error('Your monthly cashback limit is full.');
                    }
                    
                    cashbackMsg.innerHTML = '⏳ Sending cashback withdrawal request...';
                    cashbackMsg.style.color = '#a786ff';
                    
                    // Call cashback function
                    const tx = await contract.claimMonthlyReward(1);
                    
                    cashbackMsg.innerHTML = '⏳ Waiting for transaction confirmation in wallet...';
                    cashbackMsg.style.color = '#a786ff';
                    
                    await tx.wait();
                    
                    cashbackMsg.innerHTML = '✅ Monthly cashback withdrawal completed successfully!';
                    cashbackMsg.style.color = '#00ff88';
                    cashbackMsg.style.background = 'rgba(0,255,136,0.08)';
                    cashbackMsg.style.border = '1.5px solid #00ff88';
                    
                    setTimeout(() => {
                      cashbackMsg.style.display = 'none';
                      loadProfile(); // Reload profile
                    }, 2000);
                    
                  } catch(err) {
                    console.error('Cashback error:', err); // for debugging
                    let errorMsg = 'Error in cashback withdrawal';
                    
                    if (err.code === 4001 || err.message.includes('user denied')) {
                      errorMsg = '❌ Transaction was cancelled by user.';
                    } else if (err.code === -32002 || err.message.includes('Already processing')) {
                      errorMsg = '⏳ Wallet is processing another request. Please wait.';
                    } else if (err.message.includes('network')) {
                      errorMsg = '❌ Network error! Check your internet connection.';
                    } else if (err.message.includes('insufficient funds')) {
                      errorMsg = '❌ Insufficient balance to pay transaction fee.';
                    } else {
                      errorMsg = '❌ ' + (err.message || 'Unknown withdrawal error');
                    }
                    
                    cashbackMsg.innerHTML = errorMsg;
                    cashbackMsg.style.color = '#ff4444';
                    cashbackMsg.style.background = 'rgba(255,68,68,0.08)';
                    cashbackMsg.style.border = '1.5px solid #ff4444';
                    
                    setTimeout(() => {
                      cashbackMsg.style.display = 'none';
                    }, 5000);
                  }
                  
                  cashbackBtn.disabled = false;
                  cashbackBtn.style.opacity = '';
                  cashbackBtn.style.cursor = '';
                });
              }
            }, 100);
            
                         // Setup referral link copy button
             if (typeof setupReferralCopy === 'function') {
                 setupReferralCopy();
             }
             
             // Direct setup for copy button
             const copyBtn = document.getElementById('copyProfileReferral');
             if (copyBtn) {
                 copyBtn.addEventListener('click', async () => {
                     try {
                         const linkElement = document.getElementById('profile-referral-link');
                         if (linkElement) {
                             const referralLink = linkElement.textContent;
                             
                             // Try modern clipboard API first
                             if (navigator.clipboard && navigator.clipboard.writeText) {
                                 await navigator.clipboard.writeText(referralLink);
                                 copyBtn.textContent = 'کپی شد!';
                                 setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                             } else {
                                 // Fallback for older browsers
                                 const textArea = document.createElement('textarea');
                                 textArea.value = referralLink;
                                 document.body.appendChild(textArea);
                                 textArea.select();
                                 document.execCommand('copy');
                                 document.body.removeChild(textArea);
                                 copyBtn.textContent = 'کپی شد!';
                                 setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                             }
                         } else {
                             copyBtn.textContent = 'خطا: لینک یافت نشد';
                             setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                         }
                     } catch (error) {
                         console.error('Copy error:', error);
                         copyBtn.textContent = 'خطا در کپی';
                         setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                     }
                 });
             }
             
             // Calculate and display left and right wallet counts
             if (typeof updateWalletCountsDisplay === 'function') {
                 setTimeout(async () => {
                     await updateWalletCountsDisplay();
                 }, 1000); // 1 second delay to ensure complete loading
             }
             
             // Initialize withdrawal timers
             startWithdrawalTimers(user);
             
                          // Setup upgrade cap button
              setupUpgradeCapButton(user, contract, address);
                 } catch (e) {
             content.innerHTML = `<div class="error-message">Error: ${e.message || e}</div>`;
         }
    }
    window.addEventListener('DOMContentLoaded', async function() {
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                await loadProfile();
            }
        }
    });
    </script>
    
    <!-- Floating Token Growth Card -->
    <script src="js/floating-token-card.js"></script>
</body>
</html> 
