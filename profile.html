<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Inter', 'SF Pro Display', sans-serif;
            background: linear-gradient(135deg, #232946 0%, #181c2a 100%);
            margin: 0;
            padding: 0;
            direction: ltr;
            color: #e0e6f7;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: rgba(35,41,70,0.98);
            border-radius: 18px;
            box-shadow: 0 4px 24px #0005;
            padding: 36px 22px 28px 22px;
            border: 2px solid #a786ff33;
        }
        
        /* Responsive Design for different screen sizes */
        @media (max-width: 768px) {
            .container {
                max-width: 95%;
                margin: 20px auto;
                padding: 24px 16px 20px 16px;
            }
            h1 {
                font-size: 1.8em;
            }
            .balance-box {
                flex-direction: column;
                gap: 12px;
            }
            .balance-item {
                flex: none;
                min-width: auto;
                margin: 0;
            }
            .profile-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .profile-value {
                word-break: break-all;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                max-width: 98%;
                margin: 10px auto;
                padding: 20px 12px 16px 12px;
            }
            h1 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }
            .balance-box {
                padding: 14px 10px 8px 10px;
            }
            .balance-label {
                font-size: 1em;
            }
            .balance-value {
                font-size: 1.1em;
            }
            .profile-row {
                font-size: 1em;
                padding: 10px 0;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 80%;
                padding: 32px 28px 24px 28px;
            }
            .balance-box {
                gap: 20px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 700px;
                padding: 40px 32px 32px 32px;
            }
            .balance-box {
                gap: 24px;
            }
            .balance-item {
                flex: 1 1 140px;
                min-width: 140px;
            }
        }
        h1 {
            text-align: center;
            color: #00ff88;
            margin-bottom: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: 2.1em;
            text-shadow: 0 2px 8px #00ff8822;
        }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2d3250;
            font-size: 1.08em;
        }
        .profile-row:last-child { border-bottom: none; }
        .profile-label { color: #a786ff; font-weight: bold; }
        .profile-value { color: #e0e6f7; font-family: monospace; }
        .balance-box {
            background: #181c2a;
            border-radius: 10px;
            margin: 18px 0 28px 0;
            box-shadow: 0 2px 8px #a786ff11;
            padding: 18px 14px 10px 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            justify-content: space-between;
        }
        .balance-item {
            flex: 1 1 120px;
            min-width: 120px;
            margin: 0 8px;
            text-align: center;
        }
        .balance-label { color: #00ff88; font-weight: bold; font-size: 1.08em; }
        .balance-value { color: #fff; font-size: 1.18em; font-family: monospace; margin-top: 4px; display: block; }
        #connect-wallet-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 32px;
            font-size: 1.13em;
            background: linear-gradient(90deg,#00ff88,#a786ff);
            color: #181c2a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 2px 8px #00ff8822;
        }
        #connect-wallet-btn:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88);
            box-shadow: 0 4px 16px #00ff8844;
        }
        
        /* Responsive button styles */
        @media (max-width: 768px) {
            #connect-wallet-btn {
                padding: 10px 24px;
                font-size: 1.05em;
            }
        }
        
        @media (max-width: 480px) {
            #connect-wallet-btn {
                padding: 8px 20px;
                font-size: 1em;
            }
        }
        .loading, .error-message {
            text-align: center;
            margin: 24px 0;
            color: #a786ff;
        }
        .error-message { color: #ff4444; }
        #copyProfileReferral:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        #copyProfileReferral:active {
            transform: translateY(0);
        }
        
        /* Responsive withdrawal buttons */
        @media (max-width: 768px) {
            .withdrawal-buttons {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.8em 1.8em !important;
                font-size: 1em !important;
            }
        }
        
        @media (max-width: 480px) {
            .withdrawal-buttons {
                gap: 0.8rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.7em 1.5em !important;
                font-size: 0.95em !important;
            }
        }
    </style>
</head>
<body>
    <script src="js/navbar.js"></script>
    <div class="container">
        <h1>User Profile</h1>
        <button id="connect-wallet-btn">Connect Wallet</button>
        <div id="profile-content">
            <div class="loading">Loading information...</div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/profile.js"></script>
    <script>
    function formatDateTime(ts) {
        if (!ts || ts == 0) return '-';
        // Convert to string and then number to avoid BigInt error
        let n = Number(ts.toString());
        if (isNaN(n)) return '-';
        // If the value is in seconds (small), multiply by 1000
        if (n < 10000000000) n = n * 1000;
        const d = new Date(n);
        if (isNaN(d.getTime())) return '-';
        // YYYY-MM-DD HH:mm
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    
    // Function to initialize withdrawal timers
    function startWithdrawalTimers(user) {
        const claimTimer = document.getElementById('claim-timer');
        const cashbackTimer = document.getElementById('cashback-timer');
        
        if (!claimTimer || !cashbackTimer) return;
        
        // Commission withdrawal timer (every 12 hours)
        function updateClaimTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastClaim = user.lastClaimTime ? Number(user.lastClaimTime) : 0;
            const nextClaimTime = lastClaim + (12 * 3600); // 12 hours
            const timeLeft = nextClaimTime - now;
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                claimTimer.textContent = `(${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
                claimTimer.style.color = '#ff4444';
            } else {
                claimTimer.textContent = '(Ready)';
                claimTimer.style.color = '#00ff88';
            }
        }
        
        // Cashback withdrawal timer (every 30 days)
        function updateCashbackTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastCashback = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
            const nextCashbackTime = lastCashback + (30 * 24 * 3600); // 30 days
            const timeLeft = nextCashbackTime - now;
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (24 * 3600));
                const hours = Math.floor((timeLeft % (24 * 3600)) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                cashbackTimer.textContent = `(${days}days ${hours}hours)`;
                cashbackTimer.style.color = '#ff4444';
            } else {
                cashbackTimer.textContent = '(Ready)';
                cashbackTimer.style.color = '#00ff88';
            }
        }
        
        // Initialize timers
        updateClaimTimer();
        updateCashbackTimer();
        
        // Update every second
        setInterval(updateClaimTimer, 1000);
        setInterval(updateCashbackTimer, 1000);
    }
    async function loadProfile() {
        const content = document.getElementById('profile-content');
        content.innerHTML = '<div class="loading">Loading information...</div>';
        try {
            if (!window.connectWallet) throw new Error('Wallet connection is not active');
            const { contract, address, provider } = await window.connectWallet();
            if (!contract || !address) throw new Error('Wallet connection failed');
            // User struct information with error handling
            async function fetchUserSafe(addr) {
                try {
                    return await contract.users(addr);
                } catch (e) {
                    console.warn('users(address) decode failed, using defaults:', e);
                    return {
                        index: 0n,
                        binaryPoints: 0n,
                        binaryPointCap: 0n,
                        binaryPointsClaimed: 0n,
                        activated: false,
                        totalPurchasedKind: 0n,
                        upgradeTime: 0n,
                        lastClaimTime: 0n,
                        leftPoints: 0n,
                        rightPoints: 0n,
                        lastMonthlyClaim: 0n,
                        totalMonthlyRewarded: 0n,
                        refclimed: 0n,
                        depositedAmount: 0n
                    };
                }
            }
            const user = await fetchUserSafe(address);
            // Balances
            const maticBalance = await provider.getBalance(address);
            const IAMBalance = await contract.balanceOf(address);
            
            // Function to format large numbers
            function formatLargeNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return num.toFixed(2);
                }
            }
            
            // Calculate IAM USD equivalent
            let IAMUsdValue = 0;
            let tokenPrice = 0;
            try {
                if (typeof contract.getTokenPrice === 'function') {
                    const tokenPriceRaw = await contract.getTokenPrice();
                    tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    const IAMAmount = Number(ethers.formatUnits(IAMBalance, 18));
                    IAMUsdValue = IAMAmount * tokenPrice;
                }
            } catch (e) {
                console.log('Error getting token price:', e);
            }
            
            // DAI
            let daiBalance = '0';
            try {
                const daiAddress = window.DAI_ADDRESS || '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';
                const daiAbi = window.DAI_ABI || [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
                const dai = new ethers.Contract(daiAddress, daiAbi, provider);
                const daiRaw = await dai.balanceOf(address);
                daiBalance = ethers.formatUnits(daiRaw, 18);
            } catch {}
            // Index
            const IAMId = user.index ? `IAM${user.index.toString().padStart(5, '0')}` : '-';
            // Condition for monthly cashback button activation
            let canMonthlyCashback = false;
            let monthlyMsg = '';
            const now = Math.floor(Date.now() / 1000);
            const lastMonthly = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
            const oneMonth = 30 * 24 * 60 * 60;
            // Check for empty child (left or right)
            let hasEmptyChild = false;
            if (typeof contract.indexToAddress === 'function') {
                const leftAddr = await contract.indexToAddress(BigInt(user.index) * 2n);
                const rightAddr = await contract.indexToAddress(BigInt(user.index) * 2n + 1n);
                if (!leftAddr || leftAddr === '0x0000000000000000000000000000000000000000' || !rightAddr || rightAddr === '0x0000000000000000000000000000000000000000') {
                    hasEmptyChild = true;
                }
            }
            if (hasEmptyChild && (now - lastMonthly >= oneMonth)) {
                canMonthlyCashback = true;
            } else {
                if (!hasEmptyChild) monthlyMsg = 'To withdraw monthly cashback, you must have at least one empty child position.';
                else if (now - lastMonthly < oneMonth) monthlyMsg = 'At least one month must have passed since the last monthly withdrawal.';
            }
            // نمایش
            content.innerHTML = `
                <div class="balance-box">
                    <div class="balance-item">
                        <div class="balance-label">IAM</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)))}</span>
                        <div style="font-size:0.8rem;color:#a786ff;margin-top:2px;">≈ $${formatLargeNumber(IAMUsdValue)}</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">MATIC</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatEther(maticBalance.toString())).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatEther(maticBalance.toString())))}</span>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">DAI</div>
                        <span class="balance-value" title="${Number.parseFloat(daiBalance.toString()).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(daiBalance.toString()))}</span>
                    </div>
                </div>
                <div class="withdrawal-buttons" style="display:flex;gap:1.2rem;justify-content:center;margin-bottom:1.5rem;flex-wrap:wrap;">
                  <button id="claim-btn" title="Commission withdrawal is only possible once every 12 hours and if you have points to withdraw. If you don't have points or 12 hours haven't passed yet, withdrawal is not possible." style="background:linear-gradient(90deg,#00ff88,#a786ff);color:#181c2a;font-weight:bold;border:none;border-radius:10px;padding:0.9em 2.2em;font-size:1.08em;cursor:pointer;box-shadow:0 2px 8px #00ff8840;display:inline-flex;align-items:center;gap:0.6em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1.2em;'>💸</span> Withdraw Commission <span id="claim-timer" style="font-size:0.9em;margin-right:0.5em;"></span></button>
                  <button id="monthly-cashback-btn" title="Cashback withdrawal is only possible once every 30 days, with at least one empty child position and up to the deposit limit. If both positions are full or 30 days haven't passed or the cashback limit is reached, withdrawal is not possible." style="background:linear-gradient(90deg,#a786ff,#00ff88);color:#181c2a;font-weight:bold;border:none;border-radius:10px;padding:0.9em 2.2em;font-size:1.08em;cursor:pointer;box-shadow:0 2px 8px #a786ff40;display:inline-flex;align-items:center;gap:0.6em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1.2em;'>📆</span> Cashback <span id="cashback-timer" style="font-size:0.9em;margin-right:0.5em;"></span></button>
                  <button id="upgrade-cap-btn" title="Upgrade binary points cap using IAM tokens. The more you upgrade, the higher your points cap becomes." style="background:linear-gradient(90deg,#ff6b35,#ff8e53);color:#181c2a;font-weight:bold;border:none;border-radius:10px;padding:0.9em 2.2em;font-size:1.08em;cursor:pointer;box-shadow:0 2px 8px #ff6b3540;display:inline-flex;align-items:center;gap:0.6em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1.2em;'>📈</span> Upgrade Cap</button>
                </div>
                <div id="monthly-cashback-msg" style="display:none;color:#ff4444;text-align:center;margin-bottom:1.2rem;font-size:1.05em;transition:opacity 0.3s;"></div>
                
                                                   <!-- Upgrade Cap Modal -->
                  <div id="upgrade-cap-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px);">
                      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(35,41,70,0.98);border-radius:18px;padding:2rem;max-width:600px;width:90%;border:2px solid #ff6b3533;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
                          <div style="text-align:center;margin-bottom:1.5rem;">
                              <h3 style="color:#ff6b35;margin:0;font-size:1.5em;">📈 Upgrade Binary Points Cap</h3>
                              <p style="color:#ccc;margin:0.5rem 0;font-size:0.9em;">You can purchase up to 2 points every 4 weeks</p>
                          </div>
                          
                          <div style="margin-bottom:1.5rem;">
                              <label style="display:block;color:#a786ff;margin-bottom:0.5rem;font-weight:bold;">IAM Amount for Upgrade:</label>
                              <input type="number" id="upgrade-cap-amount" placeholder="Enter IAM amount" style="width:100%;padding:0.8rem;border:2px solid #ff6b3333;border-radius:8px;background:rgba(255,107,51,0.1);color:#fff;font-size:1rem;box-sizing:border-box;">
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Balance: </span>
                                  <span id="upgrade-cap-balance" style="color:#00ff88;font-weight:bold;">Loading...</span>
                              </div>
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Cap: </span>
                                  <span id="upgrade-cap-current" style="color:#a786ff;font-weight:bold;">Loading...</span>
                              </div>
                          </div>
                          
                          <div style="display:flex;gap:1rem;justify-content:center;">
                              <button id="upgrade-cap-confirm" style="background:linear-gradient(90deg,#ff6b35,#ff8e53);color:#181c2a;border:none;border-radius:8px;padding:0.8rem 1.5rem;font-weight:bold;cursor:pointer;transition:all 0.2s;">Confirm Upgrade</button>
                              <button id="upgrade-cap-cancel" style="background:rgba(255,255,255,0.1);color:#ccc;border:1px solid #666;border-radius:8px;padding:0.8rem 1.5rem;cursor:pointer;transition:all 0.2s;">Cancel</button>
                          </div>
                          
                          <div id="upgrade-cap-status" style="margin-top:1rem;text-align:center;font-size:0.9em;min-height:1.5em;"></div>
                      </div>
                  </div>
                <div class="profile-row"><span class="profile-label">Wallet Address:</span><span class="profile-value">${address}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID:</span><span class="profile-value">${IAMId}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID Number:</span><span class="profile-value">${user.index}</span></div>
                <div class="profile-row"><span class="profile-label">Active:</span><span class="profile-value">${(user.index && BigInt(user.index) > 0n) ? 'Yes' : 'No'}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points:</span><span class="profile-value">${user.binaryPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points Cap:</span><span class="profile-value">${user.binaryPointCap}</span></div>
                <div class="profile-row"><span class="profile-label">Claimed Points:</span><span class="profile-value">${user.binaryPointsClaimed}</span></div>
                <div class="profile-row"><span class="profile-label">Total Purchases:</span><span class="profile-value">${user.totalPurchasedKind}</span></div>
                <div class="profile-row"><span class="profile-label">Upgrade Time:</span><span class="profile-value">${formatDateTime(user.upgradeTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Last Points Withdrawal:</span><span class="profile-value">${formatDateTime(user.lastClaimTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Left Points:</span><span class="profile-value">${user.leftPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Right Points:</span><span class="profile-value">${user.rightPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Left Wallets Count:</span><span class="profile-value" id="profile-left-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Right Wallets Count:</span><span class="profile-value" id="profile-right-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Last Monthly Withdrawal:</span><span class="profile-value">${formatDateTime(user.lastMonthlyClaim)}</span></div>
                <div class="profile-row"><span class="profile-label">Total Monthly Rewards:</span><span class="profile-value">${user.totalMonthlyRewarded}</span></div>
                <div class="profile-row"><span class="profile-label">Deposit:</span><span class="profile-value">${Number(user.depositedAmount.toString())/1e18|0}</span></div>
                                 <div class="profile-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                     <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                         <span class="profile-label">Referral Reward:</span>
                         <span class="profile-value">${Number(user.refclimed.toString())/1e18|0} IAM</span>
                     </div>
                     <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                         <span class="profile-label">USD Value:</span>
                         <span class="profile-value">$${formatLargeNumber(Number(user.refclimed.toString())/1e18 * tokenPrice)}</span>
                     </div>
                     <div style="display: flex; align-items: center; gap: 8px; width: 100%; background: rgba(167,134,255,0.08); border-radius: 6px; padding: 8px; border: 1px solid #a786ff22;">
                         <span class="profile-value" id="profile-referral-link" style="flex: 1; word-break: break-all; font-size: 0.85em; color: #a786ff;">${window.location.origin}/?ref=${address}</span>
                         <button id="copyProfileReferral" style="background: linear-gradient(90deg,#00ff88,#a786ff); color: #181c2a; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.8em; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.2s;">Copy</button>
                     </div>
                 </div>
            `;
            setTimeout(function() {
              const cashbackBtn = document.getElementById('monthly-cashback-btn');
              const cashbackMsg = document.getElementById('monthly-cashback-msg');
              if (cashbackBtn && cashbackMsg) {
                const claimBtn = document.getElementById('claim-btn');
                if (claimBtn) {
                  claimBtn.addEventListener('click', async function(e) {
                    claimBtn.disabled = true;
                    claimBtn.style.opacity = '0.5';
                    claimBtn.style.cursor = 'not-allowed';
                    cashbackMsg.style.display = 'block';
                    cashbackMsg.style.opacity = '1';
                    cashbackMsg.style.background = 'rgba(167,134,255,0.08)';
                    cashbackMsg.style.border = '1.5px solid #a786ff';
                    cashbackMsg.style.borderRadius = '10px';
                    cashbackMsg.style.padding = '1em 1.2em';
                    cashbackMsg.style.marginBottom = '1.2rem';
                    cashbackMsg.style.textAlign = 'center';
                    cashbackMsg.style.fontSize = '1.07em';
                    cashbackMsg.style.boxShadow = '0 2px 8px #a786ff22';
                    cashbackMsg.style.whiteSpace = 'pre-line';
                    
                                         // Display commission withdrawal conditions
                     cashbackMsg.innerHTML = '<b>Commission Withdrawal Conditions:</b><br>• You can only withdraw once every 12 hours.<br>• You must have active points.<br>• If you don\'t have points or 12 hours haven\'t passed yet, withdrawal is not possible.<br><br><b>Checking conditions...</b>';
                     cashbackMsg.style.color = '#a786ff';
                     
                     try {
                       const { contract, address } = await window.connectWallet();
                       const user = await fetchUserSafe(address);
                       const now = Math.floor(Date.now() / 1000);
                       if (!(user.index && BigInt(user.index) > 0n)) throw new Error('Your account is not active.');
                       if (user.binaryPoints == 0) throw new Error('You have no points to withdraw.');
                       if (now < Number(user.lastClaimTime) + 12 * 3600) {
                         const remain = Math.ceil((Number(user.lastClaimTime) + 12 * 3600 - now) / 3600);
                         throw new Error(`Still ${remain} hours until next withdrawal.`);
                       }
                       cashbackMsg.innerHTML = 'Sending commission withdrawal request...';
                       cashbackMsg.style.color = '#a786ff';
                       const tx = await contract.claim();
                       await tx.wait();
                       cashbackMsg.style.display = 'none';
                       await loadProfile();
                     } catch(err) {
                       cashbackMsg.style.display = 'none';
                     }
                    claimBtn.disabled = false;
                    claimBtn.style.opacity = '';
                    claimBtn.style.cursor = '';
                  });
                }
                if (cashbackBtn && cashbackMsg) {
                  cashbackBtn.addEventListener('click', async function(e) {
                    cashbackBtn.disabled = true;
                    cashbackBtn.style.opacity = '0.5';
                    cashbackBtn.style.cursor = 'not-allowed';
                    cashbackMsg.style.display = 'block';
                    cashbackMsg.style.opacity = '1';
                    cashbackMsg.style.background = 'rgba(0,255,136,0.08)';
                    cashbackMsg.style.border = '1.5px solid #00ff88';
                    cashbackMsg.style.borderRadius = '10px';
                    cashbackMsg.style.padding = '1em 1.2em';
                    cashbackMsg.style.marginBottom = '1.2rem';
                    cashbackMsg.style.textAlign = 'center';
                    cashbackMsg.style.fontSize = '1.07em';
                    cashbackMsg.style.boxShadow = '0 2px 8px #00ff8822';
                    cashbackMsg.style.whiteSpace = 'pre-line';
                    
                                         // Display cashback withdrawal conditions
                     cashbackMsg.innerHTML = '<b>Monthly Cashback Withdrawal Conditions:</b><br>• You can only withdraw once every 30 days.<br>• You must have at least one empty child position.<br>• The cashback limit equals your deposit amount.<br>• If both positions are full or 30 days haven\'t passed or the cashback limit is reached, withdrawal is not possible.<br>• <span style=\'color:#a786ff\'>If there is sufficient balance in the help fund, you will receive <b>three percent</b> of the amount you paid as monthly cashback each month.</span><br><br><b>Checking conditions...</b>';
                     cashbackMsg.style.color = '#00ff88';
                     
                     try {
                       const { contract, address } = await window.connectWallet();
                       const user = await fetchUserSafe(address);
                       const now = Math.floor(Date.now() / 1000);
                       const leftAddr = await contract.getLeftAddress(user.index);
                       const rightAddr = await contract.getRightAddress(user.index);
                       if (!(user.index && BigInt(user.index) > 0n)) throw new Error('Your account is not active.');
                       if (leftAddr != '0x0000000000000000000000000000000000000000' && rightAddr != '0x0000000000000000000000000000000000000000')
                         throw new Error('To withdraw cashback, you must have at least one empty child position.');
                       if (now < Number(user.lastMonthlyClaim) + 30 * 24 * 3600) {
                         const remain = Math.ceil((Number(user.lastMonthlyClaim) + 30 * 24 * 3600 - now) / (24*3600));
                         throw new Error(`Still ${remain} days until next cashback withdrawal.`);
                       }
                       if (user.totalMonthlyRewarded >= user.depositedAmount)
                         throw new Error('Your monthly cashback limit is full.');
                       cashbackMsg.innerHTML = 'Sending cashback withdrawal request...';
                       cashbackMsg.style.color = '#a786ff';
                       const tx = await contract.claimMonthlyReward(1);
                       await tx.wait();
                       cashbackMsg.style.display = 'none';
                       await loadProfile();
                     } catch(err) {
                       cashbackMsg.style.display = 'none';
                     }
                    cashbackBtn.disabled = false;
                    cashbackBtn.style.opacity = '';
                    cashbackBtn.style.cursor = '';
                  });
                }
              }
            }, 100);
            
                         // Setup referral link copy button
             if (typeof setupReferralCopy === 'function') {
                 setupReferralCopy();
             }
             
             // Calculate and display left and right wallet counts
             if (typeof updateWalletCountsDisplay === 'function') {
                 setTimeout(async () => {
                     await updateWalletCountsDisplay();
                 }, 1000); // 1 second delay to ensure complete loading
             }
             
             // Initialize withdrawal timers
             startWithdrawalTimers(user);
             
                          // Setup upgrade cap button
              setupUpgradeCapButton(user, contract, address);
                 } catch (e) {
             content.innerHTML = `<div class="error-message">Error: ${e.message || e}</div>`;
         }
    }
    document.getElementById('connect-wallet-btn').onclick = async function() {
        await loadProfile();
        this.style.display = 'none';
    };
    window.addEventListener('DOMContentLoaded', async function() {
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                document.getElementById('connect-wallet-btn').style.display = 'none';
                await loadProfile();
            }
        }
    });
    </script>
    
    <!-- Floating Token Growth Card -->
    <script src="js/floating-token-card.js"></script>
</body>
</html> 
