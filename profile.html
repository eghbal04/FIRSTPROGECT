<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background: linear-gradient(135deg, #232946 0%, #181c2a 100%);
            margin: 0;
            padding: 0;
            direction: rtl;
            color: #e0e6f7;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: rgba(35,41,70,0.98);
            border-radius: 18px;
            box-shadow: 0 4px 24px #0005;
            padding: 36px 22px 28px 22px;
            border: 2px solid #a786ff33;
        }
        
        /* Responsive Design for different screen sizes */
        @media (max-width: 768px) {
            .container {
                max-width: 95%;
                margin: 20px auto;
                padding: 24px 16px 20px 16px;
            }
            h1 {
                font-size: 1.8em;
            }
            .balance-box {
                flex-direction: column;
                gap: 12px;
            }
            .balance-item {
                flex: none;
                min-width: auto;
                margin: 0;
            }
            .profile-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .profile-value {
                word-break: break-all;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                max-width: 98%;
                margin: 10px auto;
                padding: 20px 12px 16px 12px;
            }
            h1 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }
            .balance-box {
                padding: 14px 10px 8px 10px;
            }
            .balance-label {
                font-size: 1em;
            }
            .balance-value {
                font-size: 1.1em;
            }
            .profile-row {
                font-size: 1em;
                padding: 10px 0;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 80%;
                padding: 32px 28px 24px 28px;
            }
            .balance-box {
                gap: 20px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 700px;
                padding: 40px 32px 32px 32px;
            }
            .balance-box {
                gap: 24px;
            }
            .balance-item {
                flex: 1 1 140px;
                min-width: 140px;
            }
        }
        h1 {
            text-align: center;
            color: #00ff88;
            margin-bottom: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
            font-size: 2.1em;
            text-shadow: 0 2px 8px #00ff8822;
        }
        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2d3250;
            font-size: 1.08em;
        }
        .profile-row:last-child { border-bottom: none; }
        .profile-label { color: #a786ff; font-weight: bold; }
        .profile-value { color: #e0e6f7; font-family: monospace; }
        .balance-box {
            background: #181c2a;
            border-radius: 10px;
            margin: 18px 0 28px 0;
            box-shadow: 0 2px 8px #a786ff11;
            padding: 18px 14px 10px 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            justify-content: space-between;
        }
        .balance-item {
            flex: 1 1 120px;
            min-width: 120px;
            margin: 0 8px;
            text-align: center;
        }
        .balance-label { color: #00ff88; font-weight: bold; font-size: 1.08em; }
        .balance-value { color: #fff; font-size: 1.18em; font-family: monospace; margin-top: 4px; display: block; }
        #connect-wallet-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 32px;
            font-size: 1.13em;
            background: linear-gradient(90deg,#00ff88,#a786ff);
            color: #181c2a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 2px 8px #00ff8822;
        }
        #connect-wallet-btn:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88);
            box-shadow: 0 4px 16px #00ff8844;
        }
        
        /* Responsive button styles */
        @media (max-width: 768px) {
            #connect-wallet-btn {
                padding: 10px 24px;
                font-size: 1.05em;
            }
        }
        
        @media (max-width: 480px) {
            #connect-wallet-btn {
                padding: 8px 20px;
                font-size: 1em;
            }
        }
        .loading, .error-message {
            text-align: center;
            margin: 24px 0;
            color: #a786ff;
        }
        .error-message { color: #ff4444; }
        #copyProfileReferral:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        #copyProfileReferral:active {
            transform: translateY(0);
        }
        
        /* Responsive withdrawal buttons */
        @media (max-width: 768px) {
            .withdrawal-buttons {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.8em 1.8em !important;
                font-size: 1em !important;
            }
        }
        
        @media (max-width: 480px) {
            .withdrawal-buttons {
                gap: 0.8rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.7em 1.5em !important;
                font-size: 0.95em !important;
            }
        }
    </style>
</head>
<body>
    <script src="js/navbar.js"></script>
    <div class="container">
        <h1>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±</h1>
        <button id="connect-wallet-btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        <div id="profile-content">
            <div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/profile.js"></script>
    <script>
    function formatDateTime(ts) {
        if (!ts || ts == 0) return '-';
        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ø´ØªÙ‡ Ùˆ Ø³Ù¾Ø³ Ø¹Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ BigInt
        let n = Number(ts.toString());
        if (isNaN(n)) return '-';
        // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø± Ø­Ø³Ø¨ Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø³Øª (Ú©ÙˆÚ†Ú©)ØŒ Ø¶Ø±Ø¨Ø¯Ø± 1000 Ú©Ù†
        if (n < 10000000000) n = n * 1000;
        const d = new Date(n);
        if (isNaN(d.getTime())) return '-';
        // YYYY-MM-DD HH:mm
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    
    // ØªØ§Ø¨Ø¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª
    function startWithdrawalTimers(user) {
        const claimTimer = document.getElementById('claim-timer');
        const cashbackTimer = document.getElementById('cashback-timer');
        
        if (!claimTimer || !cashbackTimer) return;
        
        // ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾ÙˆØ±Ø³Ø§Ù†Øª (Ù‡Ø± 12 Ø³Ø§Ø¹Øª)
        function updateClaimTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastClaim = user.lastClaimTime ? Number(user.lastClaimTime) : 0;
            const nextClaimTime = lastClaim + (12 * 3600); // 12 Ø³Ø§Ø¹Øª
            const timeLeft = nextClaimTime - now;
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                claimTimer.textContent = `(${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')})`;
                claimTimer.style.color = '#ff4444';
            } else {
                claimTimer.textContent = '(Ø¢Ù…Ø§Ø¯Ù‡)';
                claimTimer.style.color = '#00ff88';
            }
        }
        
        // ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú© (Ù‡Ø± 30 Ø±ÙˆØ²)
        function updateCashbackTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastCashback = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
            const nextCashbackTime = lastCashback + (30 * 24 * 3600); // 30 Ø±ÙˆØ²
            const timeLeft = nextCashbackTime - now;
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (24 * 3600));
                const hours = Math.floor((timeLeft % (24 * 3600)) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                cashbackTimer.textContent = `(${days}Ø±ÙˆØ² ${hours}Ø³Ø§Ø¹Øª)`;
                cashbackTimer.style.color = '#ff4444';
            } else {
                cashbackTimer.textContent = '(Ø¢Ù…Ø§Ø¯Ù‡)';
                cashbackTimer.style.color = '#00ff88';
            }
        }
        
        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ§ÛŒÙ…Ø±Ù‡Ø§
        updateClaimTimer();
        updateCashbackTimer();
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡
        setInterval(updateClaimTimer, 1000);
        setInterval(updateCashbackTimer, 1000);
    }
    async function loadProfile() {
        const content = document.getElementById('profile-content');
        content.innerHTML = '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>';
        try {
            if (!window.connectWallet) throw new Error('Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª');
            const { contract, address, provider } = await window.connectWallet();
            if (!contract || !address) throw new Error('Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯');
            // Ø§Ø·Ù„Ø§Ø¹Ø§Øª struct User Ø¨Ø§ Ù‡Ù†Ø¯Ù„ Ø®Ø·Ø§
            async function fetchUserSafe(addr) {
                try {
                    return await contract.users(addr);
                } catch (e) {
                    console.warn('users(address) decode failed, using defaults:', e);
                    return {
                        index: 0n,
                        binaryPoints: 0n,
                        binaryPointCap: 0n,
                        binaryPointsClaimed: 0n,
                        activated: false,
                        totalPurchasedKind: 0n,
                        upgradeTime: 0n,
                        lastClaimTime: 0n,
                        leftPoints: 0n,
                        rightPoints: 0n,
                        lastMonthlyClaim: 0n,
                        totalMonthlyRewarded: 0n,
                        refclimed: 0n,
                        depositedAmount: 0n
                    };
                }
            }
            const user = await fetchUserSafe(address);
            // Ù…ÙˆØ¬ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
            const maticBalance = await provider.getBalance(address);
            const IAMBalance = await contract.balanceOf(address);
            
            // ØªØ§Ø¨Ø¹ Ú©ÙˆØªØ§Ù‡ Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø²Ø±Ú¯
            function formatLargeNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return num.toFixed(2);
                }
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±ÛŒ IAM
            let IAMUsdValue = 0;
            let tokenPrice = 0;
            try {
                if (typeof contract.getTokenPrice === 'function') {
                    const tokenPriceRaw = await contract.getTokenPrice();
                    tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    const IAMAmount = Number(ethers.formatUnits(IAMBalance, 18));
                    IAMUsdValue = IAMAmount * tokenPrice;
                }
            } catch (e) {
                console.log('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ØªÙˆÚ©Ù†:', e);
            }
            
            // DAI
            let daiBalance = '0';
            try {
                const daiAddress = window.DAI_ADDRESS || '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';
                const daiAbi = window.DAI_ABI || [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
                const dai = new ethers.Contract(daiAddress, daiAbi, provider);
                const daiRaw = await dai.balanceOf(address);
                daiBalance = ethers.formatUnits(daiRaw, 18);
            } catch {}
            // Ø§ÛŒÙ†Ø¯Ú©Ø³
            const IAMId = user.index ? `IAM${user.index.toString().padStart(5, '0')}` : '-';
            // Ø´Ø±Ø· ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡ Ú©Ø´Ø¨Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡
            let canMonthlyCashback = false;
            let monthlyMsg = '';
            const now = Math.floor(Date.now() / 1000);
            const lastMonthly = user.lastMonthlyClaim ? Number(user.lastMonthlyClaim) : 0;
            const oneMonth = 30 * 24 * 60 * 60;
            // Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø²Ù†Ø¯ Ø®Ø§Ù„ÛŒ (left ÛŒØ§ right)
            let hasEmptyChild = false;
            if (typeof contract.indexToAddress === 'function') {
                const leftAddr = await contract.indexToAddress(BigInt(user.index) * 2n);
                const rightAddr = await contract.indexToAddress(BigInt(user.index) * 2n + 1n);
                if (!leftAddr || leftAddr === '0x0000000000000000000000000000000000000000' || !rightAddr || rightAddr === '0x0000000000000000000000000000000000000000') {
                    hasEmptyChild = true;
                }
            }
            if (hasEmptyChild && (now - lastMonthly >= oneMonth)) {
                canMonthlyCashback = true;
            } else {
                if (!hasEmptyChild) monthlyMsg = 'Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´Ø¨Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¬Ø§ÛŒÚ¯Ø§Ù‡ ÙØ±Ø²Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.';
                else if (now - lastMonthly < oneMonth) monthlyMsg = 'Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.';
            }
            // Ù†Ù…Ø§ÛŒØ´
            content.innerHTML = `
                <div class="balance-box">
                    <div class="balance-item">
                        <div class="balance-label">IAM</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)))}</span>
                        <div style="font-size:0.8rem;color:#a786ff;margin-top:2px;">â‰ˆ $${formatLargeNumber(IAMUsdValue)}</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">MATIC</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatEther(maticBalance.toString())).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatEther(maticBalance.toString())))}</span>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">DAI</div>
                        <span class="balance-value" title="${Number.parseFloat(daiBalance.toString()).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(daiBalance.toString()))}</span>
                    </div>
                </div>
                <div class="withdrawal-buttons" style="display:flex;gap:1.2rem;justify-content:center;margin-bottom:1.5rem;">
                  <button id="claim-btn" title="Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø² ÙÙ‚Ø· Ù‡Ø± Û±Û² Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø± Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† Ø§Ù…ØªÛŒØ§Ø² Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø³Øª. Ø§Ú¯Ø± Ø§Ù…ØªÛŒØ§Ø² Ù†Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ù‡Ù†ÙˆØ² Û±Û² Ø³Ø§Ø¹Øª Ù†Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª." style="background:linear-gradient(90deg,#00ff88,#a786ff);color:#181c2a;font-weight:bold;border:none;border-radius:10px;padding:0.9em 2.2em;font-size:1.08em;cursor:pointer;box-shadow:0 2px 8px #00ff8840;display:inline-flex;align-items:center;gap:0.6em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1.2em;'>ğŸ’¸</span> Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾ÙˆØ±Ø³Ø§Ù†Øª <span id="claim-timer" style="font-size:0.9em;margin-right:0.5em;"></span></button>
                  <button id="monthly-cashback-btn" title="Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú© ÙÙ‚Ø· Ù‡Ø± Û³Û° Ø±ÙˆØ² ÛŒÚ©Ø¨Ø§Ø±ØŒ Ø¨Ø§ Ø¯Ø§Ø´ØªÙ† Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¬Ø§ÛŒÚ¯Ø§Ù‡ ÙØ±Ø²Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ùˆ ØªØ§ Ø³Ù‚Ù Ø³Ù¾Ø±Ø¯Ù‡ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª. Ø§Ú¯Ø± Ù‡Ø± Ø¯Ùˆ Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ù¾Ø± Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ù‡Ù†ÙˆØ² Û³Û° Ø±ÙˆØ² Ù†Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ø³Ù‚Ù Ú©Ø´â€ŒØ¨Ú© Ù¾Ø± Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª." style="background:linear-gradient(90deg,#a786ff,#00ff88);color:#181c2a;font-weight:bold;border:none;border-radius:10px;padding:0.9em 2.2em;font-size:1.08em;cursor:pointer;box-shadow:0 2px 8px #a786ff40;display:inline-flex;align-items:center;gap:0.6em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1.2em;'>ğŸ“†</span> Ú©Ø´â€ŒØ¨Ú© <span id="cashback-timer" style="font-size:0.9em;margin-right:0.5em;"></span></button>
                </div>
                <div id="monthly-cashback-msg" style="display:none;color:#ff4444;text-align:center;margin-bottom:1.2rem;font-size:1.05em;transition:opacity 0.3s;"></div>
                <div class="profile-row"><span class="profile-label">Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„:</span><span class="profile-value">${address}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§ÛŒÙ†Ø¯Ú©Ø³:</span><span class="profile-value">${IAMId}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§ÛŒÙ†Ø¯Ú©Ø³:</span><span class="profile-value">${user.index}</span></div>
                <div class="profile-row"><span class="profile-label">ÙØ¹Ø§Ù„:</span><span class="profile-value">${(user.index && BigInt(user.index) > 0n) ? 'Ø¨Ù„Ù‡' : 'Ø®ÛŒØ±'}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒÙ†Ø±ÛŒ:</span><span class="profile-value">${user.binaryPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Ø³Ù‚Ù Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ÛŒÙ†Ø±ÛŒ:</span><span class="profile-value">${user.binaryPointCap}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªâ€ŒØ´Ø¯Ù‡:</span><span class="profile-value">${user.binaryPointsClaimed}</span></div>
                <div class="profile-row"><span class="profile-label">Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÛŒØ¯:</span><span class="profile-value">${user.totalPurchasedKind}</span></div>
                <div class="profile-row"><span class="profile-label">Ø²Ù…Ø§Ù† Ø§Ø±ØªÙ‚Ø§:</span><span class="profile-value">${formatDateTime(user.upgradeTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø²:</span><span class="profile-value">${formatDateTime(user.lastClaimTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§Ù…ØªÛŒØ§Ø² Ú†Ù¾:</span><span class="profile-value">${user.leftPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Ø§Ù…ØªÛŒØ§Ø² Ø±Ø§Ø³Øª:</span><span class="profile-value">${user.rightPoints}</span></div>
                <div class="profile-row"><span class="profile-label">ØªØ¹Ø¯Ø§Ø¯ ÙˆÙ„Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ú†Ù¾:</span><span class="profile-value" id="profile-left-wallets">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</span></div>
                <div class="profile-row"><span class="profile-label">ØªØ¹Ø¯Ø§Ø¯ ÙˆÙ„Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª:</span><span class="profile-value" id="profile-right-wallets">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</span></div>
                <div class="profile-row"><span class="profile-label">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø§Ù‡Ø§Ù†Ù‡:</span><span class="profile-value">${formatDateTime(user.lastMonthlyClaim)}</span></div>
                <div class="profile-row"><span class="profile-label">Ú©Ù„ Ù¾Ø§Ø¯Ø§Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡:</span><span class="profile-value">${user.totalMonthlyRewarded}</span></div>
                <div class="profile-row"><span class="profile-label">Ù¾Ø§Ø¯Ø§Ø´ Ø±ÙØ±Ø§Ù„:</span><span class="profile-value">${Number(user.refclimed.toString())/1e18|0}</span></div>
                <div class="profile-row"><span class="profile-label">Ø³Ù¾Ø±Ø¯Ù‡:</span><span class="profile-value">${Number(user.depositedAmount.toString())/1e18|0}</span></div>
                <div class="profile-row" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                    <span class="profile-label">Ù„ÛŒÙ†Ú© Ø±ÙØ±Ø§Ù„:</span>
                    <div style="display: flex; align-items: center; gap: 10px; width: 100%; background: rgba(167,134,255,0.1); border-radius: 8px; padding: 12px; border: 1px solid #a786ff33;">
                        <span class="profile-value" id="profile-referral-link" style="flex: 1; word-break: break-all; font-size: 0.9em;">${window.location.origin}/?ref=${address}</span>
                        <button id="copyProfileReferral" style="background: linear-gradient(90deg,#00ff88,#a786ff); color: #181c2a; border: none; border-radius: 6px; padding: 8px 16px; font-size: 0.9em; cursor: pointer; font-weight: bold; white-space: nowrap; transition: all 0.2s;">Ú©Ù¾ÛŒ</button>
                    </div>
                </div>
            `;
            setTimeout(function() {
              const cashbackBtn = document.getElementById('monthly-cashback-btn');
              const cashbackMsg = document.getElementById('monthly-cashback-msg');
              if (cashbackBtn && cashbackMsg) {
                const claimBtn = document.getElementById('claim-btn');
                if (claimBtn) {
                  claimBtn.addEventListener('click', async function(e) {
                    claimBtn.disabled = true;
                    claimBtn.style.opacity = '0.5';
                    claimBtn.style.cursor = 'not-allowed';
                    cashbackMsg.style.display = 'block';
                    cashbackMsg.style.opacity = '1';
                    cashbackMsg.style.background = 'rgba(167,134,255,0.08)';
                    cashbackMsg.style.border = '1.5px solid #a786ff';
                    cashbackMsg.style.borderRadius = '10px';
                    cashbackMsg.style.padding = '1em 1.2em';
                    cashbackMsg.style.marginBottom = '1.2rem';
                    cashbackMsg.style.textAlign = 'center';
                    cashbackMsg.style.fontSize = '1.07em';
                    cashbackMsg.style.boxShadow = '0 2px 8px #a786ff22';
                    cashbackMsg.style.whiteSpace = 'pre-line';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø²
                    cashbackMsg.innerHTML = '<b>Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø²:</b><br>â€¢ ÙÙ‚Ø· Ù‡Ø± Û±Û² Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.<br>â€¢ Ø¨Ø§ÛŒØ¯ Ø§Ù…ØªÛŒØ§Ø² ÙØ¹Ø§Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.<br>â€¢ Ø§Ú¯Ø± Ø§Ù…ØªÛŒØ§Ø² Ù†Ø¯Ø§Ø±ÛŒØ¯ ÛŒØ§ Ù‡Ù†ÙˆØ² Û±Û² Ø³Ø§Ø¹Øª Ù†Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª.<br><br><b>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ·...</b>';
                    cashbackMsg.style.color = '#a786ff';
                    
                    try {
                      const { contract, address } = await window.connectWallet();
                      const user = await fetchUserSafe(address);
                      const now = Math.floor(Date.now() / 1000);
                      if (!(user.index && BigInt(user.index) > 0n)) throw new Error('Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.');
                      if (user.binaryPoints == 0) throw new Error('Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ø¯Ø§Ø±ÛŒØ¯.');
                      if (now < Number(user.lastClaimTime) + 12 * 3600) {
                        const remain = Math.ceil((Number(user.lastClaimTime) + 12 * 3600 - now) / 3600);
                        throw new Error(`Ù‡Ù†ÙˆØ² ${remain} Ø³Ø§Ø¹Øª ØªØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø¹Ø¯ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.`);
                      }
                      cashbackMsg.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø²...';
                      cashbackMsg.style.color = '#a786ff';
                      const tx = await contract.claim();
                      await tx.wait();
                      cashbackMsg.style.display = 'none';
                      await loadProfile();
                    } catch(err) {
                      cashbackMsg.style.display = 'none';
                    }
                    claimBtn.disabled = false;
                    claimBtn.style.opacity = '';
                    claimBtn.style.cursor = '';
                  });
                }
                if (cashbackBtn && cashbackMsg) {
                  cashbackBtn.addEventListener('click', async function(e) {
                    cashbackBtn.disabled = true;
                    cashbackBtn.style.opacity = '0.5';
                    cashbackBtn.style.cursor = 'not-allowed';
                    cashbackMsg.style.display = 'block';
                    cashbackMsg.style.opacity = '1';
                    cashbackMsg.style.background = 'rgba(0,255,136,0.08)';
                    cashbackMsg.style.border = '1.5px solid #00ff88';
                    cashbackMsg.style.borderRadius = '10px';
                    cashbackMsg.style.padding = '1em 1.2em';
                    cashbackMsg.style.marginBottom = '1.2rem';
                    cashbackMsg.style.textAlign = 'center';
                    cashbackMsg.style.fontSize = '1.07em';
                    cashbackMsg.style.boxShadow = '0 2px 8px #00ff8822';
                    cashbackMsg.style.whiteSpace = 'pre-line';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú©
                    cashbackMsg.innerHTML = '<b>Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡:</b><br>â€¢ ÙÙ‚Ø· Ù‡Ø± Û³Û° Ø±ÙˆØ² ÛŒÚ©Ø¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.<br>â€¢ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¬Ø§ÛŒÚ¯Ø§Ù‡ ÙØ±Ø²Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.<br>â€¢ Ø³Ù‚Ù Ú©Ø´â€ŒØ¨Ú© Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§ Ù…Ø¨Ù„Øº Ø³Ù¾Ø±Ø¯Ù‡ Ø´Ù…Ø§Ø³Øª.<br>â€¢ Ø§Ú¯Ø± Ù‡Ø± Ø¯Ùˆ Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ù¾Ø± Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ù‡Ù†ÙˆØ² Û³Û° Ø±ÙˆØ² Ù†Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ø³Ù‚Ù Ú©Ø´â€ŒØ¨Ú© Ù¾Ø± Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª.<br>â€¢ <span style=\'color:#a786ff\'>Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø¯Ø± ØµÙ†Ø¯ÙˆÙ‚ Ú©Ù…Ú© ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ù‡Ø± Ù…Ø§Ù‡ Ù…Ø¹Ø§Ø¯Ù„ <b>Ø³Ù‡ Ø¯Ø±ØµØ¯</b> Ø§Ø² Ù…Ø¨Ù„ØºÛŒ Ú©Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ø´â€ŒØ¨Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ù‡ Ø´Ù…Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</span><br><br><b>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ·...</b>';
                    cashbackMsg.style.color = '#00ff88';
                    
                    try {
                      const { contract, address } = await window.connectWallet();
                      const user = await fetchUserSafe(address);
                      const now = Math.floor(Date.now() / 1000);
                      const leftAddr = await contract.getLeftAddress(user.index);
                      const rightAddr = await contract.getRightAddress(user.index);
                      if (!(user.index && BigInt(user.index) > 0n)) throw new Error('Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.');
                      if (leftAddr != '0x0000000000000000000000000000000000000000' && rightAddr != '0x0000000000000000000000000000000000000000')
                        throw new Error('Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú© Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¬Ø§ÛŒÚ¯Ø§Ù‡ ÙØ±Ø²Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.');
                      if (now < Number(user.lastMonthlyClaim) + 30 * 24 * 3600) {
                        const remain = Math.ceil((Number(user.lastMonthlyClaim) + 30 * 24 * 3600 - now) / (24*3600));
                        throw new Error(`Ù‡Ù†ÙˆØ² ${remain} Ø±ÙˆØ² ØªØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø¹Ø¯ÛŒ Ú©Ø´â€ŒØ¨Ú© Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.`);
                      }
                      if (user.totalMonthlyRewarded >= user.depositedAmount)
                        throw new Error('Ø³Ù‚Ù Ú©Ø´â€ŒØ¨Ú© Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø´Ù…Ø§ Ù¾Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.');
                      cashbackMsg.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ø´â€ŒØ¨Ú©...';
                      cashbackMsg.style.color = '#a786ff';
                      const tx = await contract.claimMonthlyReward(1);
                      await tx.wait();
                      cashbackMsg.style.display = 'none';
                      await loadProfile();
                    } catch(err) {
                      cashbackMsg.style.display = 'none';
                    }
                    cashbackBtn.disabled = false;
                    cashbackBtn.style.opacity = '';
                    cashbackBtn.style.cursor = '';
                  });
                }
              }
            }, 100);
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© Ø±ÙØ±Ø§Ù„
            if (typeof setupReferralCopy === 'function') {
                setupReferralCopy();
            }
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ ÙˆÙ„Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ù…Øª Ø±Ø§Ø³Øª Ùˆ Ú†Ù¾
            if (typeof updateWalletCountsDisplay === 'function') {
                setTimeout(async () => {
                    await updateWalletCountsDisplay();
                }, 1000); // ØªØ§Ø®ÛŒØ± 1 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„
            }
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª
            startWithdrawalTimers(user);
        } catch (e) {
            content.innerHTML = `<div class="error-message">Ø®Ø·Ø§: ${e.message || e}</div>`;
        }
    }
    document.getElementById('connect-wallet-btn').onclick = async function() {
        await loadProfile();
        this.style.display = 'none';
    };
    window.addEventListener('DOMContentLoaded', async function() {
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                document.getElementById('connect-wallet-btn').style.display = 'none';
                await loadProfile();
            }
        }
    });
    </script>
    
    <!-- Floating Token Growth Card - Ú©Ø§Ø±Øª Ø´Ù†Ø§ÙˆØ± Ø±Ø´Ø¯ ØªÙˆÚ©Ù† -->
    <script src="js/floating-token-card.js"></script>
</body>
</html> 
