// swap.js - Professional and principled for DAI ↔ IAM swap

// Contract addresses
const IAM_ADDRESS_OLD = '0x2D3923A5ba62B2bec13b9181B1E9AE0ea2C8118D'; // Old contract
const IAM_ADDRESS_MIDDLE = '0xF473E4018cDf3dEbFb151cB50D6aB3a0292Ad658'; // Middle contract
const IAM_ADDRESS_NEW = 'config.js:1843 ✅ Clean config loaded - Real Contracts Available
config.js:1844 📍 Contract Addresses:
config.js:1845    Contract 3 (Old): 0x2D3923A5ba62B2bec13b9181B1E9AE0ea2C8118D - Old contract
config.js:1846    Contract 5 (New): 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26 - New contract
config.js:1847    Universal ABI: Same ABI for all contracts
config.js:1848 🔧 ABI Functions: 80
swap.js:1  Uncaught SyntaxError: Identifier 'DAI_ABI' has already been declared (at swap.js:1:1)
network.js:1430 🔄 DOMContentLoaded event fired for network.js
floating-token-card.js:644 🎯 Initializing floating token card...
floating-token-card.js:37 🔨 Creating new floating token card...
floating-token-card.js:88 ✅ Floating card HTML added to DOM
floating-token-card.js:95 ✅ Card elements found: {card: true, percentage: true, status: true}
floating-token-card.js:447 🔄 Starting floating card updates...
floating-token-card.js:479 📊 Found contractConfig, setting up updates
floating-token-card.js:646 ✅ Floating token card initialized successfully
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
index.html:3392 New contract selected - showing all pages
index.html:1817 🔄 Force refreshing contract info...
floating-token-card.js:165 🔍 Getting token growth data...
floating-token-card.js:178 🔍 Contract type: New Base price: 0.00001
floating-token-card.js:245 📊 Trying to get contract from connectWallet
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:416 ⚠️ Update already in progress, skipping
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:416 ⚠️ Update already in progress, skipping
floating-token-card.js:248 📊 Wallet result: {provider: BrowserProvider, signer: JsonRpcSigner, address: '0xB6F844eFE62948647968196257B7DcD2323beF0C', contract: Proxy(Contract), config: {…}}
floating-token-card.js:250 📊 Using contract from connectWallet
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:416 ⚠️ Update already in progress, skipping
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
floating-token-card.js:252 📊 Token price raw: 15351175897030n
floating-token-card.js:275 ✅ Price from connectWallet contract: 0.00001535117589703 Growth: 53.51175897029998
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521247471 )
index.html:1870 🔍 Fetching contract info for address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
index.html:1881 📋 Contract header updated: New
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521247471 )
index.html:1870 🔍 Fetching contract info for address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
index.html:1881 📋 Contract header updated: New
floating-token-card.js:165 🔍 Getting token growth data...
floating-token-card.js:178 🔍 Contract type: New Base price: 0.00001
floating-token-card.js:201 📊 Using contract data
floating-token-card.js:228 ✅ Price from contract: 0.00001535117589703 Growth: 53.51175897029998
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521252274 )
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
index.html:1834 ✅ Contract info force refreshed
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521252274 )
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521252274 )
index.html:1870 🔍 Fetching contract info for address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
index.html:1881 📋 Contract header updated: New
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:165 🔍 Getting token growth data...
floating-token-card.js:178 🔍 Contract type: New Base price: 0.00001
floating-token-card.js:201 📊 Using contract data
floating-token-card.js:228 ✅ Price from contract: 0.00001535117589703 Growth: 53.51175897029998
index.html:2316 🔍 Raw user data: Proxy(Result) {0: 1n, 1: '0x0000000000000000000000000000000000000000', 2: '0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA', 3: '0x7695Fc2E069d86a8C4397f99E3C5aD0E98603072', 4: 10n, 5: 10n, 6: 0n, 7: 0n, 8: 1761512067n, 9: 1761512067n, 10: 83n, 11: 206n, 12: 1959089019116887505n, 13: 1761512067n, #names: Array(0)}
index.html:2317 🔍 Raw binaryPoints: 10n
index.html:2318 🔍 Raw lastClaimTime: 1761512067n
index.html:2326 🔍 Checking claimable points for contract: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
index.html:2327 🔍 User points: 10 Time since last claim: 9187
index.html:2328 🔍 Current time: 1761521254 Last claim time: 1761512067
index.html:2337 ⏰ User has points but not enough time passed: 10 Time since last claim: 9187
config.js:1771 🔍 Debugging wallet connection...
config.js:1772 🔍 window.ethereum: object
config.js:1757 ✅ Ethers v6 detected
config.js:1779 ✅ Ethers v6 fully loaded after 0 ms
config.js:1783 🔍 Using stored contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1785 🔍 Connecting wallet with contract address: 0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26
config.js:1790 🔧 Using ethers v6
config.js:1801 ✅ Wallet connected successfully: 0xB6F844eFE62948647968196257B7DcD2323beF0C
floating-token-card.js:423 ⚠️ Update too recent, skipping (last update: 1761521254411 )
index.html:2893 📊 Using contract from connectWallet: Proxy(Contract) {target: '0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26', interface: Interface, runner: JsonRpcSigner, filters: Proxy(Object), fallback: null, …}
index.html:2930 🌳 Starting binary tree exploration...
index.html:2972 🌳 Starting tree traversal with contract: Proxy(Contract) {target: '0x2DdDD3Bfc8B591296695fFA1EF74F7114140cC26', interface: Interface, runner: JsonRpcSigner, filters: Proxy(Object), fallback: null, …}
index.html:3005 📊 Method 2 (numToAddress): Index 1 -> 0xB6F844eFE62948647968196257B7DcD2323beF0C
index.html:3025 ✅ Found address for index 1: 0xB6F844eFE62948647968196257B7DcD2323beF0C
index.html:3032 📊 User data for 0xB6F844eFE62948647968196257B7DcD2323beF0C: Proxy(Result) {0: 1n, 1: '0x0000000000000000000000000000000000000000', 2: '0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA', 3: '0x7695Fc2E069d86a8C4397f99E3C5aD0E98603072', 4: 10n, 5: 10n, 6: 0n, 7: 0n, 8: 1761512067n, 9: 1761512067n, 10: 83n, 11: 206n, 12: 1959089019116887505n, 13: 1761512067n, #names: Array(0)}
index.html:3043 📊 Vote status for 0xB6F844eFE62948647968196257B7DcD2323beF0C: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0xB6F844eFE62948647968196257B7DcD2323beF0C with num 1
index.html:3005 📊 Method 2 (numToAddress): Index 2 -> 0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA
index.html:3025 ✅ Found address for index 2: 0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA
index.html:3032 📊 User data for 0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA: Proxy(Result) {0: 2n, 1: '0xB6F844eFE62948647968196257B7DcD2323beF0C', 2: '0xD1E9D3502266677F9a58943D7264017036AFbDA6', 3: '0x8f41D78027C1D04C6C5ddd81D7f81b6B52a8AC32', 4: 5n, 5: 5n, 6: 0n, 7: 0n, 8: 1761512271n, 9: 1761512271n, 10: 64n, 11: 18n, 12: 1959304436616526231n, 13: 1761512271n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x034e3d5cd0a4688847D3F6dec9B1EffFb5C45AEA with num 2
index.html:3005 📊 Method 2 (numToAddress): Index 4 -> 0x133b2f3214a60B1cf579Fdc8A83C390A9C21f5D1
index.html:3025 ✅ Found address for index 4: 0x133b2f3214a60B1cf579Fdc8A83C390A9C21f5D1
index.html:3032 📊 User data for 0x133b2f3214a60B1cf579Fdc8A83C390A9C21f5D1: Proxy(Result) {0: 4n, 1: '0xD1E9D3502266677F9a58943D7264017036AFbDA6', 2: '0x053A195c859f18c2d53e76B9160302d3133c5609', 3: '0x3E521A2b8B98150F50aB1752886C82890349BFac', 4: 5n, 5: 5n, 6: 0n, 7: 0n, 8: 1761512303n, 9: 1761512303n, 10: 19n, 11: 30n, 12: 1959706034689232893n, 13: 1761512303n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x133b2f3214a60B1cf579Fdc8A83C390A9C21f5D1: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x133b2f3214a60B1cf579Fdc8A83C390A9C21f5D1 with num 4
index.html:3005 📊 Method 2 (numToAddress): Index 8 -> 0x95e60a827e8EA5954696c9e0430C0104F726f342
index.html:3025 ✅ Found address for index 8: 0x95e60a827e8EA5954696c9e0430C0104F726f342
index.html:3032 📊 User data for 0x95e60a827e8EA5954696c9e0430C0104F726f342: Proxy(Result) {0: 8n, 1: '0x5C6212244D7AD948b50b086ae7c14952824B92EE', 2: '0x8444aF9ef614eF5beC3d17FEfD231cB566148cd1', 3: '0x4edCb4d66D8005A8731058C5758CD4b85c47E185', 4: 2n, 5: 5n, 6: 0n, 7: 0n, 8: 1761512579n, 9: 1761512579n, 10: 0n, 11: 0n, 12: 1959843205585949038n, 13: 1761512579n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x95e60a827e8EA5954696c9e0430C0104F726f342: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x95e60a827e8EA5954696c9e0430C0104F726f342 with num 8
index.html:3005 📊 Method 2 (numToAddress): Index 16 -> 0xBDBc4353b879EE65b11e78829C3127C2629B0ECC
index.html:3025 ✅ Found address for index 16: 0xBDBc4353b879EE65b11e78829C3127C2629B0ECC
index.html:3032 📊 User data for 0xBDBc4353b879EE65b11e78829C3127C2629B0ECC: Proxy(Result) {0: 16n, 1: '0x1451483913CA969492A34b5a841223f561E5ea2B', 2: '0xDc6BB70F7c3D3902f9F291cfb36C05880c8C5C74', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761512713n, 9: 1761512713n, 10: 1n, 11: 0n, 12: 979853010289638398n, 13: 1761512713n, #names: Array(0)}
index.html:3043 📊 Vote status for 0xBDBc4353b879EE65b11e78829C3127C2629B0ECC: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0xBDBc4353b879EE65b11e78829C3127C2629B0ECC with num 16
index.html:3005 📊 Method 2 (numToAddress): Index 32 -> 0x66e3a97F244D78fEC2267B87AE386c6117554f6f
index.html:3025 ✅ Found address for index 32: 0x66e3a97F244D78fEC2267B87AE386c6117554f6f
index.html:3032 📊 User data for 0x66e3a97F244D78fEC2267B87AE386c6117554f6f: Proxy(Result) {0: 32n, 1: '0xf1234a7a300C745F6345Bf756b08162545CCDAA9', 2: '0x093d9364061897a15aBDD46CFBaEae5445A7876C', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761512939n, 9: 1761512939n, 10: 9n, 11: 0n, 12: 979696245565625044n, 13: 1761512939n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x66e3a97F244D78fEC2267B87AE386c6117554f6f: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x66e3a97F244D78fEC2267B87AE386c6117554f6f with num 32
index.html:3005 📊 Method 2 (numToAddress): Index 64 -> 0xb356F142CBa511dA4499F2e4A64e1a0105b3d118
index.html:3025 ✅ Found address for index 64: 0xb356F142CBa511dA4499F2e4A64e1a0105b3d118
index.html:3032 📊 User data for 0xb356F142CBa511dA4499F2e4A64e1a0105b3d118: Proxy(Result) {0: 64n, 1: '0xD1E9D3502266677F9a58943D7264017036AFbDA6', 2: '0xBA8B0FbBAa58e62e5abCF783c3bd20a318a66673', 3: '0x5DDaC406F1aDF4E62e73Ead067411A25720fA0ca', 4: 3n, 5: 5n, 6: 0n, 7: 0n, 8: 1761513473n, 9: 1761513473n, 10: 1n, 11: 0n, 12: 1958726407986220505n, 13: 1761513473n, #names: Array(0)}
index.html:3043 📊 Vote status for 0xb356F142CBa511dA4499F2e4A64e1a0105b3d118: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0xb356F142CBa511dA4499F2e4A64e1a0105b3d118 with num 64
index.html:3005 📊 Method 2 (numToAddress): Index 128 -> 0x039Abb163B1F404A875c0f569c2819D40Cbf3b51
index.html:3025 ✅ Found address for index 128: 0x039Abb163B1F404A875c0f569c2819D40Cbf3b51
index.html:3032 📊 User data for 0x039Abb163B1F404A875c0f569c2819D40Cbf3b51: Proxy(Result) {0: 128n, 1: '0xc85F65C0a6F2A870b35f318788EEE5Ce09E92424', 2: '0x6060A912e08660b0802D8Ef78F7c98A4017F3b28', 3: '0xad02D3857b1AD19734F8F3e8F1D3831452B96DB6', 4: 5n, 5: 5n, 6: 0n, 7: 0n, 8: 1761514505n, 9: 1761514505n, 10: 25n, 11: 53n, 12: 1957218783259654446n, 13: 1761514505n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x039Abb163B1F404A875c0f569c2819D40Cbf3b51: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x039Abb163B1F404A875c0f569c2819D40Cbf3b51 with num 128
index.html:3005 📊 Method 2 (numToAddress): Index 256 -> 0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8
index.html:3025 ✅ Found address for index 256: 0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8
index.html:3032 📊 User data for 0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8: Proxy(Result) {0: 256n, 1: '0x99fd7D6439Ee16199CE29d83eF93D66F68BB54D9', 2: '0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761517297n, 9: 1761517297n, 10: 6n, 11: 0n, 12: 977504171055214453n, 13: 1761517297n, #names: Array(0)}
index.html:3043 📊 Vote status for 0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8 with num 256
index.html:3005 📊 Method 2 (numToAddress): Index 512 -> 0x0000000000000000000000000000000000000000
index.html:3017 📊 Method 3 (getAddressByNumber): Index 512 -> 0x0000000000000000000000000000000000000000
index.html:3005 📊 Method 2 (numToAddress): Index 513 -> 0x0000000000000000000000000000000000000000
index.html:3017 📊 Method 3 (getAddressByNumber): Index 513 -> 0x0000000000000000000000000000000000000000
index.html:3005 📊 Method 2 (numToAddress): Index 257 -> 0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073
index.html:3025 ✅ Found address for index 257: 0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073
index.html:3032 📊 User data for 0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073: Proxy(Result) {0: 257n, 1: '0xC6cEF43761142593Fa7d26c3D9f81aeE19DE51F8', 2: '0x1F176CDE54caA09cee894B370751518681D5CbBE', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761517313n, 9: 1761517313n, 10: 5n, 11: 0n, 12: 977494396013482752n, 13: 1761517313n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073 with num 257
index.html:3005 📊 Method 2 (numToAddress): Index 514 -> 0x0000000000000000000000000000000000000000
index.html:3017 📊 Method 3 (getAddressByNumber): Index 514 -> 0x0000000000000000000000000000000000000000
index.html:3005 📊 Method 2 (numToAddress): Index 515 -> 0x0000000000000000000000000000000000000000
index.html:3017 📊 Method 3 (getAddressByNumber): Index 515 -> 0x0000000000000000000000000000000000000000
index.html:3005 📊 Method 2 (numToAddress): Index 129 -> 0x6060A912e08660b0802D8Ef78F7c98A4017F3b28
index.html:3025 ✅ Found address for index 129: 0x6060A912e08660b0802D8Ef78F7c98A4017F3b28
index.html:3032 📊 User data for 0x6060A912e08660b0802D8Ef78F7c98A4017F3b28: Proxy(Result) {0: 129n, 1: '0x039Abb163B1F404A875c0f569c2819D40Cbf3b51', 2: '0x496b552cFa5981DAD3abC60b5f2f24397f4744eD', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761514519n, 9: 1761514519n, 10: 29n, 11: 0n, 12: 978746396209600220n, 13: 1761514519n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x6060A912e08660b0802D8Ef78F7c98A4017F3b28: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x6060A912e08660b0802D8Ef78F7c98A4017F3b28 with num 129
index.html:3005 📊 Method 2 (numToAddress): Index 258 -> 0x1F176CDE54caA09cee894B370751518681D5CbBE
index.html:3025 ✅ Found address for index 258: 0x1F176CDE54caA09cee894B370751518681D5CbBE
index.html:3032 📊 User data for 0x1F176CDE54caA09cee894B370751518681D5CbBE: Proxy(Result) {0: 258n, 1: '0x7Bd3E26cc0215671241fAefd4CFa3Ef5d2Fd8073', 2: '0x53BECbfF598C10466deEbe284Fc1882ffe4a9ea2', 3: '0x0000000000000000000000000000000000000000', 4: 0n, 5: 5n, 6: 0n, 7: 0n, 8: 1761517325n, 9: 1761517325n, 10: 4n, 11: 0n, 12: 977484621069504717n, 13: 1761517325n, #names: Array(0)}
index.html:3043 📊 Vote status for 0x1F176CDE54caA09cee894B370751518681D5CbBE: Proxy(Result) {0: 0n, 1: 0n, 2: 0n, #names: Array(0)}
index.html:3067 ✅ Added user 0x1F176CDE54caA09cee894B370751518681D5CbBE with num 258
index.html:3005 📊 Method 2 (numToAddress): Index 516 -> 0x0000000000000000000000000000000000000000
index.html:3017 📊 Method 3 (getAddressByNumber): Index 516 -> 0x0000000000000000000000000000000000000000
index.html:3005 📊 Method 2 (numToAddress): Index 517 -> 0x0000000000000000000000000000000000000000
'; // New contract
// Use global DAI address from config to avoid redeclaration conflicts
const SWAP_DAI_ADDRESS = (typeof window !== 'undefined' && window.DAI_ADDRESS) ? window.DAI_ADDRESS : '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';

// Default to old contract
let SWAP_IAM_ADDRESS = IAM_ADDRESS_OLD;

// Use DAI_ABI from config.js to avoid redeclaration conflicts
let DAI_ABI = window.DAI_ABI;
if (!DAI_ABI) {
DAI_ABI = [
    {
        "inputs": [
            {"internalType": "address", "name": "owner", "type": "address"},
            {"internalType": "address", "name": "spender", "type": "address"}
        ],
        "name": "allowance",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "address", "name": "spender", "type": "address"},
            {"internalType": "uint256", "name": "value", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "decimals",
        "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "name",
        "outputs": [{"internalType": "string", "name": "", "type": "string"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "symbol",
        "outputs": [{"internalType": "string", "name": "", "type": "string"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "address", "name": "to", "type": "address"},
            {"internalType": "uint256", "name": "value", "type": "uint256"}
        ],
        "name": "transfer",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "address", "name": "from", "type": "address"},
            {"internalType": "address", "name": "to", "type": "address"},
            {"internalType": "uint256", "name": "value", "type": "uint256"}
        ],
        "name": "transferFrom",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "nonpayable",
        "type": "function"
    }
];
}
// Check if daiContract is initialized properly

// IAM ABI (minimal for swap functionality)
const IAM_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "daiAmount",
				"type": "uint256"
			}
		],
		"name": "buyTokens",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "allowance",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "needed",
				"type": "uint256"
			}
		],
		"name": "ERC20InsufficientAllowance",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "balance",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "needed",
				"type": "uint256"
			}
		],
		"name": "ERC20InsufficientBalance",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC20InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC20InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC20InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			}
		],
		"name": "ERC20InvalidSpender",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountIAM",
				"type": "uint256"
			}
		],
		"name": "Activated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "points",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "reward",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "BinaryPointsClaimed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPoints",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newCap",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "BinaryPointsUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPoolSize",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "BinaryPoolUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "claimer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "totalDistributed",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "claimerReward",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "BinaryRewardDistributed",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "claim",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "IndexOwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "IndexTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPointValue",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "totalClaimablePoints",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "contractTokenBalance",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "PointValueUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amountIAM",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "seller",
				"type": "address"
			}
		],
		"name": "purchase",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amountIAM",
				"type": "uint256"
			}
		],
		"name": "PurchaseKind",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "upper",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "upper",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "newUser",
				"type": "address"
			}
		],
		"name": "registerAndActivate",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenAmount",
				"type": "uint256"
			}
		],
		"name": "sellTokens",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "daiBalance",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenSupply",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "TokenPriceUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "daiAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenAmount",
				"type": "uint256"
			}
		],
		"name": "TokensBought",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "tokenAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "daiAmount",
				"type": "uint256"
			}
		],
		"name": "TokensSold",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "value",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferIndexOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "parent",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "upper",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "position",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "TreeStructureUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "upper",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "upper",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "depositedAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "UserRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "voter",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "target",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isLike",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "VoteSubmitted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "target",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isLike",
				"type": "bool"
			}
		],
		"name": "voteUser",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			}
		],
		"name": "allowance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "contractTotalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "daiToken",
		"outputs": [
			{
				"internalType": "contract IERC20",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "dislikeCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "daiAmount",
				"type": "uint256"
			}
		],
		"name": "estimateBuy",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenAmount",
				"type": "uint256"
			}
		],
		"name": "estimateSell",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractdaiBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getContractTokenBalance",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getLeftAddress",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getLeftChild",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getParent",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getPointUpgradeCost",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getPointValue",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getupper",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getRegPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getRightAddress",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getRightChild",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getTokenPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getUserTree",
		"outputs": [
			{
				"internalType": "address",
				"name": "left",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "right",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "binaryPoints",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "binaryPointCap",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "depositedAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "lastMonthlyClaim",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalMonthlyRewarded",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "refclimed",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "getVoteStatus",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "totalLikes",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalDislikes",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "userVoteStatus",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "indexToAddress",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "likeCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "MAX_BINARY_POINT_CAP",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalClaimableBinaryPoints",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalClaimablePoints",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "users",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "binaryPoints",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "binaryPointCap",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "binaryPointsClaimed",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalPurchasedKind",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "upgradeTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "lastClaimTime",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "leftPoints",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "rightPoints",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "lastMonthlyClaim",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "totalMonthlyRewarded",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "refclimed",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "depositedAmount",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "userVotes",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "wallets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

class SwapManager {
    constructor() {
        console.log('🏗️ Creating SwapManager instance...');
        
        this.tokenPrice = null;
        this.userBalances = { dai: 0, IAM: 0 };
        this.isSwapping = false;
        this.isRefreshing = false;
        this.provider = null;
        this.signer = null;
        this.contract = null;
        this.daiContract = null;
        this.selectedContract = 'old'; // Default to old contract
        
        console.log('✅ SwapManager created');
    }

    // Switch contract (supports both old and new contracts)
    async switchContract(contractType) {
        console.log('🔄 Switching to contract:', contractType);
        
        if (contractType === 'old') {
            SWAP_IAM_ADDRESS = IAM_ADDRESS_OLD;
            this.selectedContract = 'old';
            console.log('✅ Using old contract:', SWAP_IAM_ADDRESS);
        } else if (contractType === 'middle') {
            SWAP_IAM_ADDRESS = IAM_ADDRESS_MIDDLE;
            this.selectedContract = 'middle';
            console.log('✅ Using middle contract:', SWAP_IAM_ADDRESS);
        } else if (contractType === 'new') {
            SWAP_IAM_ADDRESS = IAM_ADDRESS_NEW;
            this.selectedContract = 'new';
            console.log('✅ Using new contract:', SWAP_IAM_ADDRESS);
        } else {
            console.warn('⚠️ Unknown contract type, defaulting to old contract');
            SWAP_IAM_ADDRESS = IAM_ADDRESS_OLD;
            this.selectedContract = 'old';
        }
        
        // Recreate contract instance if wallet is connected
        if (this.signer) {
            this.contract = new ethers.Contract(SWAP_IAM_ADDRESS, IAM_ABI, this.signer);
            console.log('✅ Contract instance recreated with:', SWAP_IAM_ADDRESS);
            
            // Refresh data with new contract
            await this.refreshSwapData();
        }
        
        // Update swap direction restrictions based on contract type
        this.updateSwapDirectionRestrictions();
    }
    
    // Update swap direction restrictions based on contract type
    updateSwapDirectionRestrictions() {
        const swapDirection = document.getElementById('swapDirection');
        if (!swapDirection) return;
        
        const daiToIamOption = swapDirection.querySelector('option[value="dai-to-IAM"]');
        const iamToDaiOption = swapDirection.querySelector('option[value="IAM-to-dai"]');
        
        if (this.selectedContract === 'old' || this.selectedContract === 'middle') {
            // For old and middle contracts, disable DAI to IAM option
            if (daiToIamOption) {
                daiToIamOption.disabled = true;
                daiToIamOption.style.color = '#666';
                daiToIamOption.style.opacity = '0.5';
            }
            
            // Ensure IAM to DAI is selected and enabled
            if (iamToDaiOption) {
                iamToDaiOption.disabled = false;
                iamToDaiOption.style.color = '#ffffff';
                iamToDaiOption.style.opacity = '1';
                swapDirection.value = 'IAM-to-dai';
            }
            
            console.log('🔒 Restricted to IAM → DAI for', this.selectedContract, 'contract');
        } else if (this.selectedContract === 'new') {
            // For new contract, enable both options
            if (daiToIamOption) {
                daiToIamOption.disabled = false;
                daiToIamOption.style.color = '#ffffff';
                daiToIamOption.style.opacity = '1';
            }
            
            if (iamToDaiOption) {
                iamToDaiOption.disabled = false;
                iamToDaiOption.style.color = '#ffffff';
                iamToDaiOption.style.opacity = '1';
            }
            
            console.log('🔓 Both swap directions enabled for new contract');
        }
    }

    // Connect to wallet and initialize contracts
    async connectWallet() {
        try {
            if (typeof window.ethereum === 'undefined') {
                throw new Error('MetaMask not detected');
            }

            console.log('🔗 Connecting to wallet...');
            
            // Request account access with error handling
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
            } catch (rpcError) {
                // Handle specific RPC errors gracefully
                if (rpcError.code === 4001) {
                    throw new Error('User rejected the connection request');
                } else if (rpcError.message && rpcError.message.includes('isDefaultWallet')) {
                    console.warn('⚠️ MetaMask RPC method not available, continuing...');
                    // Continue with connection attempt
                } else {
                    throw rpcError;
                }
            }
            
            // Create provider and signer
            this.provider = new ethers.providers.Web3Provider(window.ethereum);
            this.signer = await this.provider.getSigner();
            
            // Create contracts
            this.contract = new ethers.Contract(SWAP_IAM_ADDRESS, IAM_ABI, this.signer);
            this.daiContract = new ethers.Contract(SWAP_DAI_ADDRESS, DAI_ABI, this.signer);
            
            console.log('✅ Wallet connected successfully');
            return true;
        } catch (error) {
            console.error('❌ Error connecting wallet:', error);
            throw error;
        }
    }

    // Helper: Reading contract DAI balance as numeric (with decimals)
    async getContractDaiBalanceNum() {
        if (!this.daiContract) {
            console.warn('⚠️ DAI contract not initialized');
            return 0;
        }
        
        try {
            const daiBalance = await this.daiContract.balanceOf(SWAP_IAM_ADDRESS);
            return parseFloat(ethers.utils.formatUnits(daiBalance, 18));
        } catch (error) {
            console.warn('⚠️ Error getting contract DAI balance:', error);
            return 0;
        }
    }

    // Helper: Determine backing fee tier based on contract DAI balance
    getBackingFeePct(daiContractBalanceNum) {
        // Ranges based on contract logic: <=200k: 2%, <=500k: 2.5%, more: 3%
        if (daiContractBalanceNum <= 200000) return 0.02;
        if (daiContractBalanceNum <= 500000) return 0.025;
        return 0.03;
    }


    async initializeSwap() {
        try {
            console.log('🔄 Starting SwapManager initialization...');
            
            // Ensure DOM elements exist
            const requiredElements = ['swapForm', 'swapDirection', 'swapAmount', 'maxBtn', 'swapStatus'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            
            if (missingElements.length > 0) {
                console.warn('⚠️ The following elements were not found:', missingElements);
                console.log('🔄 Waiting for DOM elements to load...');
                // Wait a bit more for DOM to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check again
                const stillMissing = requiredElements.filter(id => !document.getElementById(id));
                if (stillMissing.length > 0) {
                    console.error('❌ Still missing elements after wait:', stillMissing);
                    return;
                }
            }
            
            console.log('✅ All DOM elements exist');
            
            // Setup event listeners
            this.setupEventListeners();
            console.log('✅ Event listeners configured');
            
            // Connect to wallet first
            await this.connectWallet();
            console.log('✅ Wallet connected');
            
            // Load data
            await this.loadSwapData();
            console.log('✅ Swap data loaded');
            
            // Update UI
            this.updateMaxAmount();
            this.updateContractSelectionUI();
            this.updateSwapDirectionRestrictions();
            
            console.log('✅ SwapManager successfully initialized');
            
        } catch (error) {
            console.error('❌ Error initializing SwapManager:', error);
            this.showStatus('Error loading swap: ' + error.message, 'error');
        }
    }



    // Function to convert USD to token (for USD field)
    convertSwapUsdToToken() {
        console.log('🔄 Converting USD to token...');
        
        const usdAmount = document.getElementById('swapUsdAmount');
        const swapAmount = document.getElementById('swapAmount');
        const direction = document.getElementById('swapDirection');
        
        if (!usdAmount || !swapAmount || !direction) {
            console.warn('⚠️ Required elements for USD conversion not found');
            return;
        }
        
        const usdValue = parseFloat(usdAmount.value);
        if (!usdValue || usdValue <= 0) {
            this.showStatus('Please enter a valid dollar amount (minimum $0.01)', 'error');
            return;
        }
        
        if (!this.tokenPrice || Number(this.tokenPrice) <= 0) {
            this.showStatus('Token price is currently unavailable. Please try again later.', 'error');
            return;
        }
        
        const tokenPrice = Number(this.tokenPrice);
        
        if (direction.value === 'dai-to-IAM') {
            // Convert USD to DAI (assuming 1 USD = 1 DAI)
            const daiAmount = usdValue;
            swapAmount.value = daiAmount.toFixed(2);
            console.log('✅ USD converted to DAI:', daiAmount);
        } else if (direction.value === 'IAM-to-dai') {
            // Convert USD to IAM
            const IAMAmount = usdValue / tokenPrice;
            swapAmount.value = IAMAmount.toFixed(6);
            console.log('✅ USD converted to IAM:', IAMAmount);
        }
        
        this.showStatus(`✅ Successfully converted $${usdValue} to token amount. You can now proceed with your transaction.`, 'success');
    }

    // Update dollar equivalent when token amount changes
    updateSwapUsdValue() {
        const swapAmount = document.getElementById('swapAmount');
        const swapUsdAmount = document.getElementById('swapUsdAmount');
        const direction = document.getElementById('swapDirection');
        
        if (!swapAmount || !swapUsdAmount || !direction) {
            return;
        }
        
        const tokenAmount = parseFloat(swapAmount.value) || 0;
        if (tokenAmount <= 0) {
            swapUsdAmount.value = '';
            return;
        }
        
        if (!this.tokenPrice || Number(this.tokenPrice) <= 0) {
            return;
        }
        
        const tokenPrice = Number(this.tokenPrice);
        
        if (direction.value === 'dai-to-IAM') {
            // DAI to USD (assuming 1 DAI = 1 USD)
            const usdValue = tokenAmount;
            swapUsdAmount.value = usdValue.toFixed(2);
        } else if (direction.value === 'IAM-to-dai') {
            // IAM to USD
            const usdValue = tokenAmount * tokenPrice;
            swapUsdAmount.value = usdValue.toFixed(2);
        }
    }

    // Show/hide USD field based on swap direction
    toggleSwapUsdConverter() {
        const direction = document.getElementById('swapDirection');
        const usdConverterRow = document.getElementById('swap-usd-converter-row');
        
        if (!direction || !usdConverterRow) {
            return;
        }
        
        if (direction.value === 'IAM-to-dai') {
            usdConverterRow.style.display = 'block';
        } else {
            usdConverterRow.style.display = 'none';
        }
    }

    // Update USD preview
    updateSwapUsdPreview() {
        const swapUsdAmount = document.getElementById('swapUsdAmount');
        const swapAmount = document.getElementById('swapAmount');
        const direction = document.getElementById('swapDirection');
        
        if (!swapUsdAmount || !swapAmount || !direction) {
            return;
        }
        
        const usdValue = parseFloat(swapUsdAmount.value) || 0;
        if (usdValue <= 0) {
            return;
        }
        
        if (!this.tokenPrice || Number(this.tokenPrice) <= 0) {
            return;
        }
        
        const tokenPrice = Number(this.tokenPrice);
        
        if (direction.value === 'IAM-to-dai') {
            const IAMAmount = usdValue / tokenPrice;
            swapAmount.value = IAMAmount.toFixed(6);
        }
    }



    // Update contract selection UI
    updateContractSelectionUI() {
        const contractSelector = document.getElementById('contractSelector');
        if (contractSelector) {
            // Update all contract options
            const oldOption = contractSelector.querySelector('option[value="old"]');
            const middleOption = contractSelector.querySelector('option[value="middle"]');
            const newOption = contractSelector.querySelector('option[value="new"]');
            
            if (oldOption) {
                oldOption.textContent = `Old Contract — ${IAM_ADDRESS_OLD.substring(0, 6)}...${IAM_ADDRESS_OLD.substring(38)}`;
            }
            
            if (middleOption) {
                middleOption.textContent = `Middle Contract — ${IAM_ADDRESS_MIDDLE.substring(0, 6)}...${IAM_ADDRESS_MIDDLE.substring(38)}`;
            }
            
            if (newOption) {
                newOption.textContent = `New Contract — ${IAM_ADDRESS_NEW.substring(0, 6)}...${IAM_ADDRESS_NEW.substring(38)}`;
            }
            
            contractSelector.value = this.selectedContract;
        }
        
        const contractInfo = document.getElementById('contractInfo');
        if (contractInfo) {
            let nameLabel, addressLabel, nameColor;
            
            if (this.selectedContract === 'old') {
                nameLabel = 'Old Contract';
                addressLabel = IAM_ADDRESS_OLD;
                nameColor = '#ff8c00'; // Orange for old contract
            } else if (this.selectedContract === 'middle') {
                nameLabel = 'Middle Contract';
                addressLabel = IAM_ADDRESS_MIDDLE;
                nameColor = '#ff6b6b'; // Red for middle contract
            } else {
                nameLabel = 'New Contract';
                addressLabel = IAM_ADDRESS_NEW;
                nameColor = '#00ff88'; // Green for new contract
            }
            
            contractInfo.innerHTML = `
                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 6px; padding: 0.5rem 0.6rem; margin-bottom: 0.4rem;">
                    <div style="display:flex; justify-content: space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                        <p style="margin: 0; color: ${nameColor}; font-size: 0.8rem; font-weight:700;">${nameLabel}</p>
                        <p style="margin: 0; color: #9ecbff; font-size: 0.75rem; word-break: break-all;">${addressLabel}</p>
                    </div>
                </div>
            `;
        }
    }

    // Call updateSwapLimitInfo on direction/amount change
    setupEventListeners() {
        console.log('🔄 Setting up event listeners...');
        
        const swapForm = document.getElementById('swapForm');
        const swapDirection = document.getElementById('swapDirection');
        const swapAmount = document.getElementById('swapAmount');
        const maxBtn = document.getElementById('maxBtn');
        const contractSelector = document.getElementById('contractSelector');

        if (swapForm) {
            swapForm.addEventListener('submit', (e) => {
                console.log('📝 Swap form submitted');
                this.handleSwap(e);
            });
            console.log('✅ Swap form event listener connected');
        } else {
            console.warn('⚠️ Swap form not found');
        }
        
        if (swapDirection) {
            swapDirection.addEventListener('change', async () => {
                console.log('🔄 Swap direction changed:', swapDirection.value);
                this.updateMaxAmount();
                
                // Show/hide USD field based on swap direction
                this.toggleSwapUsdConverter();
            });
            console.log('✅ Swap direction event listener connected');
        } else {
            console.warn('⚠️ Swap direction not found');
        }
        
        if (swapAmount) {
            swapAmount.addEventListener('input', async () => {
                console.log('📝 Swap amount changed:', swapAmount.value);
                // Allow decimals; no truncation
                // Real-time calculation of dollar equivalent when token amount changes
                this.updateSwapUsdValue();
            });
            console.log('✅ Swap amount event listener connected');
        } else {
            console.warn('⚠️ Swap amount not found');
        }
        
        if (maxBtn) {
            maxBtn.addEventListener('click', async (e) => {
                e.preventDefault(); // Prevent default button behavior
                e.stopPropagation(); // Stop event bubbling
                console.log('🔢 Max button clicked');
                try {
                    // Check if balances are loaded
                    if (!this.userBalances || (this.userBalances.dai === 0 && this.userBalances.IAM === 0)) {
                        console.log('🔄 Balances not loaded, loading now...');
                        await this.loadSwapData();
                    }
                    
                    await this.setMaxAmount();
                    // Don't show status message to avoid scrolling to Exchange Information section
                    // this.showStatus('✅ Maximum available amount has been set. You can now proceed with your transaction.', 'success');
                } catch (error) {
                    console.error('❌ Error in max button click:', error);
                    this.showStatus('Unable to set maximum amount. Please enter the amount manually.', 'error');
                }
            });
            console.log('✅ Max button event listener connected');
        } else {
            console.warn('⚠️ Max button not found');
        }
        
        if (contractSelector) {
            contractSelector.addEventListener('change', async (e) => {
                console.log('🔄 Contract selector changed to:', e.target.value);
                try {
                    await this.switchContract(e.target.value);
                    this.updateContractSelectionUI();
                    const contractName = e.target.value === 'old' ? 'Old' : 'New';
                    this.showStatus(`✅ Switched to ${contractName} contract`, 'success');
                } catch (error) {
                    console.error('❌ Error switching contract:', error);
                    this.showStatus('Error switching contract: ' + error.message, 'error');
                }
            });
            console.log('✅ Contract selector event listener connected');
        } else {
            console.warn('⚠️ Contract selector not found');
        }
        
        // Event listeners for USD converter
        const swapUsdConverterRow = document.getElementById('swap-usd-converter-row');
        const swapUsdAmount = document.getElementById('swapUsdAmount');
        const swapUsdToTokenBtn = document.getElementById('swapUsdToTokenBtn');
        
        if (swapUsdToTokenBtn) {
            swapUsdToTokenBtn.addEventListener('click', () => {
                this.convertSwapUsdToToken();
            });
            console.log('✅ USD convert button event listener connected');
        }
        
        if (swapUsdAmount) {
            // Enter key in USD field
            swapUsdAmount.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.convertSwapUsdToToken();
                }
            });
            
            // Real-time calculation when user types
            let swapUsdTimeout;
            swapUsdAmount.addEventListener('input', () => {
                clearTimeout(swapUsdTimeout);
                swapUsdTimeout = setTimeout(() => {
                    this.updateSwapUsdPreview();
                }, 500);
            });
            console.log('✅ USD field event listeners connected');
        }
        
        // Initial execution to set initial state
        this.toggleSwapUsdConverter();
        
        console.log('✅ All event listeners configured');
    }

    async loadSwapData() {
        try {
            console.log('🔄 Loading swap data...');
            
            // Check if wallet is connected
            if (!this.contract || !this.signer) {
                console.log('⏳ Wallet not connected, connecting now...');
                await this.connectWallet();
            }
            
            const address = await this.signer.getAddress();
            
            console.log('✅ Contract connection established');

            // Token price from contract
            console.log('🔄 Fetching token price...');
            try {
                const tokenPrice = await Promise.race([
                    this.contract.getTokenPrice(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Token price fetch timeout')), 10000))
                ]);
                this.tokenPrice = ethers.utils.formatUnits(tokenPrice, 18);
            console.log('✅ Token price received:', this.tokenPrice);
                console.log('🔍 this.tokenPrice set to:', this.tokenPrice);
            } catch (error) {
                console.warn('⚠️ Error fetching token price:', error);
                this.tokenPrice = null;
            }

            // IAM balance
            let IAMBalanceFormatted = '0';
            try {
                const IAMBalance = await Promise.race([
                    this.contract.balanceOf(address),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('IAM balance fetch timeout')), 10000))
                ]);
                IAMBalanceFormatted = ethers.utils.formatUnits(IAMBalance, 18);
            console.log('✅ IAM balance received:', IAMBalanceFormatted);
            } catch (error) {
                console.warn('⚠️ Error fetching IAM balance:', error);
            }

            // DAI balance
            let daiBalanceFormatted = '0';
            try {
                const daiBalance = await Promise.race([
                    this.daiContract.balanceOf(address),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('DAI balance fetch timeout')), 10000))
                ]);
                daiBalanceFormatted = ethers.utils.formatUnits(daiBalance, 18);
                console.log('✅ DAI balance received:', daiBalanceFormatted);
            } catch (error) {
                console.warn('⚠️ Error fetching DAI balance:', error);
            }

            // Function to shorten large numbers
            function formatLargeNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                } else {
                    return num.toFixed(2);
                }
            }
            
            // Calculate IAM dollar equivalent
            const IAMUsdValue = parseFloat(IAMBalanceFormatted) * parseFloat(this.tokenPrice);
            
            // Display balances
            const IAMBalanceEl = document.getElementById('IAMBalance');
            const daiBalanceEl = document.getElementById('daiBalance');
            if (IAMBalanceEl) {
                const fullIAMAmount = Number(IAMBalanceFormatted).toLocaleString('en-US', {maximumFractionDigits: 6});
                IAMBalanceEl.innerHTML = `
                    <span title="${fullIAMAmount} IAM">${formatLargeNumber(Number(IAMBalanceFormatted))} IAM</span>
                    <div style="font-size:0.8rem;color:#a786ff;margin-top:2px;">≈ $${formatLargeNumber(IAMUsdValue)}</div>
                `;
            }
            if (daiBalanceEl) {
                const fullDaiAmount = Number(daiBalanceFormatted).toLocaleString('en-US', {maximumFractionDigits: 6});
                daiBalanceEl.innerHTML = `<span title="${fullDaiAmount} DAI">${formatLargeNumber(Number(daiBalanceFormatted))} DAI</span>`;
            }

            // Save for max
            this.userBalances = {
                IAM: parseFloat(IAMBalanceFormatted),
                dai: parseFloat(daiBalanceFormatted)
            };
            
            console.log('✅ User balances saved:', this.userBalances);
            

            
        } catch (error) {
            console.error('❌ Error loading swap data:', error);
            this.tokenPrice = null;
            this.userBalances = { IAM: 0, dai: 0 };
            this.showStatus('Unable to load wallet balances. Please check your connection and try again.', 'error');
        }
    }





    updateMaxAmount() {
        const direction = document.getElementById('swapDirection');
        const amount = document.getElementById('swapAmount');
        
        if (!direction || !amount) {
            console.warn('⚠️ Required elements for updateMaxAmount not found');
            return;
        }
        
        // Remove all input field restrictions - allow unlimited input
        amount.max = '';
        console.log('✅ No input restrictions - unlimited amounts allowed');
    }

    async setMaxAmount() {
        const direction = document.getElementById('swapDirection');
        const amount = document.getElementById('swapAmount');
        
        if (!direction || !amount) {
            console.warn('⚠️ Required elements for setMaxAmount not found');
            return;
        }
        
        try {
            console.log('🔢 Setting maximum amount for direction:', direction.value);
            console.log('💰 Current user balances:', this.userBalances);
            
            if (direction.value === 'dai-to-IAM') {
                // For DAI to IAM (buying IAM)
                if (this.userBalances.dai <= 0) {
                    console.warn('⚠️ No DAI balance available');
                    this.showStatus('No DAI balance available. Please add DAI to your wallet to make purchases.', 'error');
                    return;
                }
                
                // Use 99.9% of DAI balance (allow decimals)
                const safeDaiAmount = parseFloat(this.userBalances.dai.toFixed(2)) * 0.999;
                amount.value = safeDaiAmount.toFixed(6);
                
                console.log('✅ Safe DAI amount set from balance card (99.9%):', {
                    userBalance: this.userBalances.dai.toFixed(2),
                    maxAmount: safeDaiAmount
                });
                
            } else if (direction.value === 'IAM-to-dai') {
                // For IAM to DAI (selling IAM) - Use 99.9% of balance
                if (this.userBalances.IAM <= 0) {
                    console.warn('⚠️ No IAM balance available');
                    this.showStatus('No IAM balance available. Please purchase IAM tokens first to make sales.', 'error');
                    return;
                }
                
                // Use 99.9% of IAM balance to ensure transaction succeeds (allow decimals)
                const safeIAMAmount = parseFloat(this.userBalances.IAM.toFixed(6)) * 0.999;
                amount.value = safeIAMAmount.toFixed(6);
                
                console.log('✅ Safe IAM amount set from balance card (99.9%):', {
                    userBalance: this.userBalances.IAM.toFixed(6),
                    maxAmount: safeIAMAmount
                });
            }
            
            console.log('✅ Exact maximum amount set successfully');
            
        } catch (error) {
            console.error('❌ Error setting maximum amount:', error);
            this.showStatus('Error setting maximum amount: ' + error.message, 'error');
            
            // Fallback: set to safe balance amounts
            try {
                if (direction.value === 'dai-to-IAM' && this.userBalances.dai > 0) {
                    // Use 99.9% of DAI balance to ensure transaction succeeds (allow decimals)
                    const safeDaiAmount = parseFloat(this.userBalances.dai.toFixed(2)) * 0.999;
                    amount.value = safeDaiAmount.toFixed(6);
                } else if (direction.value === 'IAM-to-dai' && this.userBalances.IAM > 0) {
                    // Use 99.9% of IAM balance to ensure transaction succeeds (allow decimals)
                    const safeIAMAmount = parseFloat(this.userBalances.IAM.toFixed(6)) * 0.999;
                    amount.value = safeIAMAmount.toFixed(6);
                }
            } catch (fallbackError) {
                console.error('❌ Fallback also failed:', fallbackError);
            }
        }
    }

    setUIBusy(busy) {
        console.log('🔄 Setting UI state:', busy ? 'busy' : 'ready');
        
        const submitBtn = document.querySelector('#swapForm button[type="submit"]');
        const inputs = document.querySelectorAll('#swapForm input, #swapForm select');
        
        if (submitBtn) {
            submitBtn.disabled = busy;
            submitBtn.textContent = busy ? '⏳ Processing...' : '💱 Swap';
            submitBtn.style.opacity = busy ? '0.7' : '1';
            submitBtn.style.cursor = busy ? 'not-allowed' : 'pointer';
            console.log('✅ Submit button configured');
        } else {
            console.warn('⚠️ Submit button not found');
        }
        
        inputs.forEach(input => {
            input.disabled = busy;
        });
        
        console.log(`✅ ${inputs.length} input elements configured`);
    }

    getErrorMessage(error) {
        console.log('🔍 Analyzing error:', error);
        
        if (error.code === 4001) return 'Transaction cancelled by user. Please try again when ready.';
        if (error.message && error.message.includes('insufficient funds')) return 'Insufficient balance. Please check your wallet and try again.';
        if (error.message && error.message.includes('exceeds buy limit')) return 'Purchase amount exceeds daily limit. Please reduce the amount.';
        if (error.message && error.message.includes('exceeds sell limit')) return 'Sale amount exceeds available liquidity. Please try a smaller amount.';
        if (error.message && error.message.includes('minimum')) return 'Amount is below minimum threshold. Please increase your transaction amount.';
        if (error.message && error.message.includes('allowance')) return 'DAI approval required. Please approve DAI spending first.';
        if (error.message && error.message.includes('cooldown')) return 'Please wait before making another transaction. Cooldown period active.';
        if (error.message && error.message.includes('user rejected')) return 'Transaction rejected by user. Please confirm the transaction to proceed.';
        if (error.message && error.message.includes('network')) return 'Network connection error. Please check your internet and try again.';
        if (error.message && error.message.includes('timeout')) return 'Transaction timeout. Please try again with higher gas fees.';
        if (error.message && error.message.includes('gas')) return 'Insufficient gas for transaction. Please increase gas limit.';
        if (error.message && error.message.includes('revert')) return 'Transaction failed. Please check your inputs and try again.';
        
        return error.message || 'An unexpected error occurred. Please try again.';
    }

    showStatus(message, type = 'info', txHash = null, scrollToMessage = true) {
        console.log('📢 Displaying message:', { message, type, txHash });
        
        const statusEl = document.getElementById('swapStatus');
        if (!statusEl) {
            console.warn('⚠️ swapStatus element not found');
            return;
        }
        
        let className = 'swap-status';
        let icon = '';
        
        switch(type) {
            case 'success':
                className += ' success';
                icon = '✅ ';
                break;
            case 'error':
                className += ' error';
                icon = '❌ ';
                break;
            case 'loading':
                className += ' loading';
                icon = '⏳ ';
                break;
            default:
                className += ' info';
                icon = 'ℹ️ ';
        }
        
        let html = `${icon}${message}`;
        if (txHash) {
            html += `<br><small style="color:#666;">Transaction: ${txHash}</small>`;
        }
        
        statusEl.className = className;
        statusEl.innerHTML = html;
        
        // Scroll to message only if requested
        if (scrollToMessage) {
            statusEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        console.log('✅ Message displayed');
    }

    // Show English popup with transaction details
    showEnglishPopup(message, type, transactionDetails = null) {
        console.log('📢 Showing English popup:', { message, type, transactionDetails });
        
        // Remove any existing popup
        const existingPopup = document.querySelector('.swap-popup-overlay');
        if (existingPopup) {
            existingPopup.remove();
        }
        
        // Create popup overlay
        const popupOverlay = document.createElement('div');
        popupOverlay.className = 'swap-popup-overlay';
        popupOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: 'Montserrat', 'Arial', sans-serif;
        `;
        
        // Create popup content
        const popupContent = document.createElement('div');
        popupContent.style.cssText = `
            background: linear-gradient(135deg, #1a1f2e, #2a3441);
            border: 2px solid ${type === 'success' ? '#00ff88' : type === 'error' ? '#ff4444' : '#a786ff'};
            border-radius: 15px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease-out;
        `;
        
        // Add animation keyframes
        if (!document.querySelector('#swap-popup-animations')) {
            const style = document.createElement('style');
            style.id = 'swap-popup-animations';
            style.textContent = `
                @keyframes popupSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px) scale(0.9);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Set icon and color based on type
        let icon = '';
        let titleColor = '';
        switch(type) {
            case 'success':
                icon = '✅';
                titleColor = '#00ff88';
                break;
            case 'error':
                icon = '❌';
                titleColor = '#ff4444';
                break;
            case 'loading':
                icon = '⏳';
                titleColor = '#a786ff';
                break;
            default:
                icon = 'ℹ️';
                titleColor = '#a786ff';
        }
        
        // Create popup HTML
        let popupHTML = `
            <div style="font-size: 2rem; margin-bottom: 1rem;">${icon}</div>
            <h3 style="color: ${titleColor}; margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 600;">${message}</h3>
        `;
        
        // Add transaction details for success popups
        if (type === 'success' && transactionDetails) {
            popupHTML += `
                <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; padding: 1rem; margin: 1rem 0; text-align: left;">
                    <h4 style="color: #00ff88; margin: 0 0 0.5rem 0; font-size: 1rem;">Transaction Details</h4>
                    <div style="font-size: 0.9rem; line-height: 1.4;">
                        <div style="margin-bottom: 0.3rem;"><strong>Type:</strong> ${transactionDetails.type}</div>
                        <div style="margin-bottom: 0.3rem;"><strong>Amount:</strong> ${transactionDetails.amount}</div>
                        <div style="margin-bottom: 0.3rem;"><strong>Direction:</strong> ${transactionDetails.direction}</div>
                        <div style="margin-bottom: 0.3rem;"><strong>Transaction Hash:</strong> 
                            <span style="font-family: monospace; color: #a786ff;">${transactionDetails.hash.substring(0, 10)}...${transactionDetails.hash.substring(transactionDetails.hash.length - 8)}</span>
                        </div>
                    </div>
                    <button id="copySwapHashBtn" style="
                        background: linear-gradient(135deg, #a786ff, #00ff88);
                        color: #0a0f1c;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 6px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-top: 0.5rem;
                        font-size: 0.8rem;
                    ">Copy Hash</button>
                </div>
            `;
        }
        
        // Add close button
        popupHTML += `
            <button id="closeSwapPopupBtn" style="
                background: linear-gradient(135deg, #ff4444, #cc3333);
                color: #ffffff;
                border: none;
                padding: 0.8rem 2rem;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                font-size: 0.9rem;
                margin-top: 1rem;
            ">Close</button>
        `;
        
        popupContent.innerHTML = popupHTML;
        popupOverlay.appendChild(popupContent);
        document.body.appendChild(popupOverlay);
        
        // Add event listeners
        const closeBtn = document.getElementById('closeSwapPopupBtn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                popupOverlay.remove();
            });
        }
        
        // Add copy hash functionality for success popups
        if (type === 'success' && transactionDetails) {
            const copyBtn = document.getElementById('copySwapHashBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(transactionDetails.hash);
                        copyBtn.textContent = 'Copied!';
                        copyBtn.style.background = 'linear-gradient(135deg, #00ff88, #00cc6a)';
                        setTimeout(() => {
                            copyBtn.textContent = 'Copy Hash';
                            copyBtn.style.background = 'linear-gradient(135deg, #a786ff, #00ff88)';
                        }, 2000);
                    } catch (error) {
                        console.error('Failed to copy hash:', error);
                    }
                });
            }
        }
        
        console.log('✅ English popup displayed');
    }

    // Get English error message
    getEnglishErrorMessage(error) {
        console.log('🔍 Analyzing error for English message:', error);
        
        if (error.code === 4001) return 'Transaction cancelled by user. Please try again when ready.';
        if (error.message && error.message.includes('insufficient funds')) return 'Insufficient balance. Please check your wallet and try again.';
        if (error.message && error.message.includes('exceeds buy limit')) return 'Purchase amount exceeds daily limit. Please reduce the amount.';
        if (error.message && error.message.includes('exceeds sell limit')) return 'Sale amount exceeds available liquidity. Please try a smaller amount.';
        if (error.message && error.message.includes('minimum')) return 'Amount is below minimum threshold. Please increase your transaction amount.';
        if (error.message && error.message.includes('allowance')) return 'DAI approval required. Please approve DAI spending first.';
        if (error.message && error.message.includes('cooldown')) return 'Please wait before making another transaction. Cooldown period active.';
        if (error.message && error.message.includes('user rejected')) return 'Transaction rejected by user. Please confirm the transaction to proceed.';
        if (error.message && error.message.includes('network')) return 'Network connection error. Please check your internet and try again.';
        if (error.message && error.message.includes('timeout')) return 'Transaction timeout. Please try again with higher gas fees.';
        if (error.message && error.message.includes('gas')) return 'Insufficient gas for transaction. Please increase gas limit.';
        if (error.message && error.message.includes('revert')) return 'Transaction failed. Please check your inputs and try again.';
        
        return error.message || 'An unexpected error occurred. Please try again.';
    }

    // Reset swap button state
    resetSwapButton(swapBtn, oldText) {
        if (swapBtn) {
            swapBtn.disabled = false;
            swapBtn.textContent = oldText;
            swapBtn.style.opacity = '1';
            swapBtn.style.cursor = 'pointer';
        }
    }

    // Main swap function
    async handleSwap(e) {
        e.preventDefault();
        console.log('🔄 Starting swap operation...');
        
        if (this.isSwapping) {
            console.log('⚠️ Swap operation in progress');
            return;
        }
        
        // Get swap button and store original text
        const swapBtn = document.querySelector('#swapForm button[type="submit"]');
        const originalText = swapBtn ? swapBtn.textContent : '💱 Swap';
        
        this.isSwapping = true;
        
        try {
            const amount = document.getElementById('swapAmount');
            const direction = document.getElementById('swapDirection');
            
            if (!amount || !direction) {
                throw new Error('Form incomplete - required elements not found');
            }
            
            const value = parseFloat(amount.value);
            if (!value || value <= 0) {
                throw new Error('Invalid amount - please enter a positive value');
            }
            
            // Allow decimal amounts (no integer-only restriction)
            
            console.log('📊 Swap information:', {
                direction: direction.value,
                amount: value,
                userBalances: this.userBalances
            });
            
            // Check balance
            if (direction.value === 'dai-to-IAM' && value > this.userBalances.dai) {
                throw new Error(`Insufficient DAI balance. You have ${this.userBalances.dai.toFixed(6)} DAI, but trying to spend ${value.toFixed(6)} DAI. Please reduce the amount.`);
            }
            if (direction.value === 'IAM-to-dai' && value > this.userBalances.IAM) {
                throw new Error(`Insufficient IAM balance. You have ${this.userBalances.IAM.toFixed(6)} IAM, but trying to sell ${value.toFixed(6)} IAM. Please reduce the amount.`);
            }

            // Keep no explicit minimum/maximum checks here

            // Disable button and show processing message
            if (swapBtn) {
                swapBtn.disabled = true;
                swapBtn.textContent = '⏳ Processing...';
                swapBtn.style.opacity = '0.7';
                swapBtn.style.cursor = 'not-allowed';
            }

            // Show processing popup
            this.showEnglishPopup('🚀 Starting swap transaction...', 'loading');

            // Execute swap operation
            let transactionHash = null;
            let transactionType = '';
            let transactionDirection = '';
            
            if (direction.value === 'dai-to-IAM') {
                console.log('🛒 Starting IAM purchase with DAI...');
                transactionType = 'Token Purchase';
                transactionDirection = 'DAI → IAM';
                transactionHash = await this.buyTokensWithDAI(value);
            } else if (direction.value === 'IAM-to-dai') {
                console.log('💰 Starting IAM sale and DAI receipt...');
                transactionType = 'Token Sale';
                transactionDirection = 'IAM → DAI';
                transactionHash = await this.sellTokensForDAI(value);
            } else {
                throw new Error('Invalid conversion type');
            }
            
            // Show success popup with transaction details
            const transactionDetails = {
                hash: transactionHash,
                amount: `${value} ${direction.value === 'dai-to-IAM' ? 'DAI' : 'IAM'}`,
                type: transactionType,
                direction: transactionDirection
            };
            
            this.showEnglishPopup('🎉 Swap completed successfully!', 'success', transactionDetails);
            await this.refreshSwapData();
            amount.value = '';
            
            // Save active tab
            // No caching - tab state is not persisted
            
            console.log('✅ Swap operation completed successfully');
            
        } catch (error) {
            console.error('❌ Error in swap operation:', error);
            const errorMessage = this.getEnglishErrorMessage(error);
            this.showEnglishPopup(errorMessage, 'error');
        } finally {
            // Reset button state
            this.resetSwapButton(swapBtn, originalText);
            this.isSwapping = false;
        }
    }

    // Buy IAM with DAI (with allowance management)
    async buyTokensWithDAI(daiAmount) {
        console.log('🛒 Starting IAM purchase with DAI:', daiAmount);
        
        try {
            if (!this.contract || !this.signer || !this.daiContract) {
                throw new Error('Contract connection not established');
            }
            
            const address = await this.signer.getAddress();
            
            const daiAmountWei = ethers.utils.parseUnits(daiAmount.toString(), 18);
            
            console.log('🔍 Checking allowance...');
            // Check allowance
            const allowance = await this.daiContract.allowance(address, SWAP_IAM_ADDRESS);
            console.log('📊 Current allowance:', ethers.utils.formatUnits(allowance, 18));
            
            if (allowance.lt(daiAmountWei)) {
                console.log('🔐 Need to approve DAI allowance...');
                this.showEnglishPopup('🔐 DAI approval required! Please approve DAI spending to continue with your purchase.', 'loading');
                
                const approveTx = await this.daiContract.approve(SWAP_IAM_ADDRESS, ethers.constants.MaxUint256);
                this.showEnglishPopup('⏳ DAI approval transaction submitted! Waiting for confirmation... This is a one-time setup.', 'loading');
                
                console.log('⏳ Waiting for approve confirmation...');
                await approveTx.wait();
                this.showEnglishPopup('✅ DAI approval successful! You can now proceed with your purchase.', 'success');
                console.log('✅ Approve confirmed');
            } else {
                console.log('✅ Allowance is sufficient');
            }
            
            // Buy IAM
            console.log('🛒 Starting IAM token purchase...');
            this.showEnglishPopup('🛒 Initiating IAM token purchase... Please wait while we process your transaction.', 'loading');
            
            const tx = await this.contract.buyTokens(daiAmountWei);
            this.showEnglishPopup('⏳ Transaction submitted! Waiting for blockchain confirmation... This may take a few moments.', 'loading');
            
            console.log('⏳ Waiting for purchase transaction confirmation...');
            await tx.wait();
            
            console.log('✅ Purchase completed successfully');
            return tx.hash; // Return transaction hash
            
        } catch (error) {
            console.error('❌ Error purchasing IAM:', error);
            throw error;
        }
    }

    // Sell IAM and receive DAI
    async sellTokensForDAI(IAMAmount) {
        console.log('💰 Starting IAM sale and DAI receipt:', IAMAmount);
        
        try {
            if (!this.contract) {
                throw new Error('Contract connection not established');
            }
            
            const IAMAmountWei = ethers.utils.parseUnits(IAMAmount.toString(), 18);
            
            console.log('💰 Starting IAM token sale...');
            this.showEnglishPopup('💰 Processing IAM token sale... Please wait while we execute your transaction.', 'loading');
            
            const tx = await this.contract.sellTokens(IAMAmountWei);
            this.showEnglishPopup('⏳ Sale transaction submitted! Waiting for blockchain confirmation... This may take a few moments.', 'loading');
            
            console.log('⏳ Waiting for sale transaction confirmation...');
            await tx.wait();
            
            console.log('✅ Sale completed successfully');
            return tx.hash; // Return transaction hash
            
        } catch (error) {
            console.error('❌ Error selling IAM:', error);
            throw error;
        }
    }

    async refreshSwapData() {
        // Prevent multiple simultaneous refresh calls
        if (this.isRefreshing) {
            console.log('🔄 Refresh already in progress, skipping...');
            return;
        }
        
        this.isRefreshing = true;
        console.log('🔄 Refreshing swap data...');
        
        try {
            await this.loadSwapData();
            
            console.log('✅ Swap data refreshed');
        } catch (error) {
            console.error('❌ Error refreshing swap data:', error);
        } finally {
            this.isRefreshing = false;
        }
    }
    

}

// Auto initialization removed - now done in index.html
// document.addEventListener('DOMContentLoaded', async function() {
//     window.swapManager = new SwapManager();
//     await window.swapManager.initializeSwap();
// });

// Hook for wallet connection
if (window.connectWallet) {
    const originalConnectWallet = window.connectWallet;
    window.connectWallet = async function() {
        const result = await originalConnectWallet();
        setTimeout(async () => {
            if (window.swapManager) {
                await window.swapManager.refreshSwapData();
            }
        }, 1000);
        return result;
    };
}

if (typeof module !== 'undefined' && module.exports) {
    module.exports = SwapManager;
} 
